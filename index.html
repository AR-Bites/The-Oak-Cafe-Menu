<!DOCTYPE html>
<html>
<head>
  <title>The Oak Cafe - Premium AR Dining</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --gold: #D4AF37;
      --dark-green: #1A3A2F;
      --light-cream: #F5F5DC;
      --red: #B22222;
      --bright-red: #FF3B30;
      --green: #32CD32;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    .overlay {
      background-color: rgba(26, 58, 47, 0.95);
      min-height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 10px 0;
      position: relative;
      text-align: center;
    }
    
    .header h1, 
    .header .tagline {
      text-align: center !important;
      width: 100%;
    }
    
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      padding: 5px;
    }
    
    .logo {
      height: 80px;
      filter: drop-shadow(0 2px 6px rgba(212, 175, 55, 0.3));
      max-width: 100%;
      animation: subtle-pulse 3s infinite alternate;
      transition: transform 0.3s ease;
    }
    
    @keyframes subtle-pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.03); }
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--gold);
      margin: 8px 0 4px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      line-height: 1.2;
    }
    
    .tagline {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.8rem;
      color: var(--light-cream);
      margin-bottom: 15px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    /* Category Selector */
    /* Category Container and Navigation - Enhanced for clarity */
    .category-container {
      display: flex;
      flex-direction: column;
      margin: 0 auto 20px;
      max-width: 650px;
      overflow: visible;
      background: rgba(26, 58, 47, 0.1);
      border-radius: 15px;
      padding: 15px 10px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .category-heading {
      text-align: center;
      margin-bottom: 10px;
      color: var(--gold);
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .main-categories {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .main-categories::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 1px;
      background: linear-gradient(to right, transparent, var(--gold), transparent);
    }
    
    .main-category-btn {
      padding: 12px 22px;
      background: rgba(26, 58, 47, 0.95);
      color: #fff;
      border: 2px solid var(--gold);
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      min-width: 110px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .main-category-btn::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 0;
      background-color: var(--gold);
      transition: width 0.3s ease;
    }
    
    .main-category-btn:hover {
      background: rgba(45, 89, 75, 0.95);
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    
    .main-category-btn:hover::before {
      width: 100%;
    }
    
    .main-category-btn.active {
      background: var(--gold);
      color: #1a3a2f;
      font-weight: 700;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .sub-categories {
      position: relative;
      padding-top: 5px;
    }
    
    .subcategory-label {
      text-align: center;
      font-size: 14px;
      color: var(--light-cream);
      margin-bottom: 8px;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .subcategory-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 10px 10px;
      max-width: 650px;
      position: relative;
    }
    
    .subcategory-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }
    
    /* Subcategory button styles with improved visibility */
    .category-btn {
      padding: 10px 18px;
      background: rgba(26, 58, 47, 0.85);
      color: #fff;
      border: 1px solid var(--gold);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
      min-width: 100px;
      text-align: center;
      white-space: nowrap;
    }
    
    .category-btn::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 2px;
      width: 0;
      background-color: var(--gold);
      transition: width 0.3s ease;
    }
    
    .category-btn:hover {
      background: rgba(45, 89, 75, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .category-btn:hover::before {
      width: 100%;
    }
    
    .category-btn.active {
      background: var(--gold);
      color: #1a3a2f;
      font-weight: 600;
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }
    
    /* RTL Support for category navigation */
    .rtl .category-container,
    .rtl .main-categories,
    .rtl .subcategory-group {
      direction: rtl;
    }
    
    .food-container {
      width: 100%;
      margin: 0 auto;
      background: rgba(245, 245, 220, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border: 1px solid var(--gold);
      flex-grow: 1;
      position: relative;
      z-index: 1;
    }
    
    /* 3D Model Viewer Enhancements */
    .model-container {
      position: relative;
      width: 100%;
      height: 250px;
      margin: 12px 0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    model-viewer {
      width: 100%;
      height: 220px;
      margin: 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background-color: rgba(26, 58, 47, 0.1);
      --poster-color: transparent;
      transition: opacity 0.3s ease;
    }
    
    .model-loading-indicator {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(26, 58, 47, 0.4);
      backdrop-filter: blur(2px);
      z-index: 5;
      border-radius: 10px;
      transition: opacity 0.3s ease;
    }
    
    .model-spinner {
      width: 35px;
      height: 35px;
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid var(--gold);
      border-right: 3px solid var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .model-hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .nav-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-areas: "prev add next";
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 25px auto;
      position: relative;
      z-index: 50;
      padding: 15px;
      background: rgba(26, 58, 47, 0.9);
      backdrop-filter: blur(8px);
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(212, 175, 55, 0.5);
      width: 95%;
      max-width: 500px;
    }
    
    /* Enhanced navigation arrow buttons */
    .nav-arrow-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: rgba(245, 245, 220, 0.1);
      color: var(--gold);
      border: 2px solid var(--gold);
      border-radius: 50px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 120px;
      min-height: 50px;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #prev-btn {
      grid-area: prev;
    }
    
    .add-to-cart {
      grid-area: add;
    }
    
    #next-btn {
      grid-area: next;
    }
    
    .nav-arrow-btn:hover {
      background: rgba(212, 175, 55, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    
    .nav-arrow-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .nav-arrow-container {
      display: flex;
      width: 100%;
      justify-content: space-between;
      gap: 15px;
    }
    
    .nav-arrow-btn i {
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    
    #prev-btn:hover i {
      transform: translateX(-3px);
    }
    
    #next-btn:hover i {
      transform: translateX(3px);
    }
    
    button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: none;
      padding: 10px 12px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .ar-button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%) !important;
      color: var(--dark-green) !important;
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 20px;
      font-weight: 700;
      animation: pulse 2s infinite;
      font-size: 1.05rem;
      width: calc(100% - 24px);
      max-width: 220px;
      border-radius: 25px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
      z-index: 10;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ar-button::before {
      content: '👓';
      font-size: 1.3rem;
      display: inline-block;
      margin-right: 5px;
      animation: subtle-wiggle 3s infinite;
    }
    
    @keyframes subtle-wiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(5deg); }
      75% { transform: rotate(-5deg); }
    }
    
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.03); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    .footer {
      margin-top: 20px;
      padding: 15px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 12px 12px 0 0;
      border-top: 2px solid var(--gold);
      position: relative;
      z-index: 1;
    }
    
    .footer::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 2px;
      background: var(--gold);
      border-radius: 2px;
    }
    
    .phone-link {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .phone-link:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .phone-link svg {
      width: 20px;
      height: 20px;
      fill: var(--gold);
    }
    
    .contact-info {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    
    .footer-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin: 0 auto;
    }
    
    .branding-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .powered-by {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .ar-bites-logo {
      height: 35px;
      transition: var(--transition);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .social-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .social-link {
      color: var(--gold);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    
    .instagram-icon {
      width: 20px;
      height: 20px;
    }
    
    .copyright {
      font-size: 0.75rem;
      margin-top: 15px;
      color: rgba(255,255,255,0.7);
    }
    
    /* Login Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .modal-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
    }
    
    .modal-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--light-cream);
      text-align: left;
      font-size: 0.85rem;
    }
    
    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: rgba(245, 245, 220, 0.1);
      color: white;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25);
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Staff Dashboard */
    .staff-dashboard {
      display: none;
      padding: 12px;
    }
    
    /* Staff header and role display */
    .staff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background-color: rgba(26, 58, 47, 0.7);
      padding: 12px 15px;
      border-radius: 10px;
      border-left: 4px solid var(--gold);
    }
    
    .staff-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .logout-btn {
      background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
    }
    
    .logout-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%);
      border-radius: 24px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .logout-btn:hover {
      background: linear-gradient(135deg, #ff7070 0%, #c62828 100%);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4), 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .logout-btn:hover::before {
      opacity: 1;
    }
    
    .logout-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .logout-btn i {
      font-size: 1rem;
    }
    
    #staff-name-display {
      font-weight: bold;
      font-size: 0.9rem;
      color: var(--light-cream);
    }
    
    #staff-role-badge {
      background-color: var(--gold);
      color: var(--dark-green);
      font-size: 0.7rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 12px;
      margin-top: 5px;
      text-transform: uppercase;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Role-specific badge styles */
    .role-server {
      background-color: #4CAF50 !important;
      color: white !important;
    }
    
    .role-chef {
      background-color: #FF5722 !important;
      color: white !important;
    }
    
    .role-manager {
      background-color: #2196F3 !important;
      color: white !important;
    }
    
    .admin-name {
      font-size: 0.65rem;
      opacity: 0.8;
      font-weight: normal;
      display: block;
      margin-top: 3px;
      color: var(--gold);
    }
    
    .orders-list {
      margin-top: 15px;
    }
    
    /* Assigned staff info styling */
    .assigned-staff-info {
      margin: 5px 0;
      padding: 5px 8px;
      background-color: rgba(33, 33, 33, 0.6);
      border-radius: 4px;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .staff-role-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.7rem;
      color: white;
      margin-left: 5px;
      text-transform: uppercase;
    }
    
    .order-card {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      border-left: 3px solid var(--gold);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }
    
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .status-preparing {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.3);
    }
    
    .status-ready {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .status-completed {
      background: rgba(158, 158, 158, 0.2);
      color: #9E9E9E;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(158, 158, 158, 0.2);
      border: 1px solid rgba(158, 158, 158, 0.3);
    }
    
    .status-cancelled {
      background: rgba(244, 67, 54, 0.1);
      color: #F44336;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    /* Style for cards when updating */
    .order-card.updating {
      position: relative;
      opacity: 0.8;
      transform: scale(0.99);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .order-card.updating::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.5) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38"><defs><linearGradient x1="8.042%" y1="0%" x2="65.682%" y2="23.865%" id="a"><stop stop-color="%23476eff" stop-opacity="0" offset="0%"/><stop stop-color="%23476eff" stop-opacity=".631" offset="63.146%"/><stop stop-color="%23476eff" offset="100%"/></linearGradient></defs><g fill="none" fill-rule="evenodd"><g transform="translate(1 1)"><path d="M36 18c0-9.94-8.06-18-18-18" stroke="url(%23a)" stroke-width="2" transform="rotate(319.489 18 18)"><animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/></path></g></g></svg>') center no-repeat;
      z-index: 2;
      border-radius: 10px;
    }
    
    .order-items {
      margin-bottom: 8px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }
    
    .order-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      min-width: 80px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s ease;
      background: linear-gradient(to bottom, #f7f7f7, #e8e8e8);
      color: #333;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:hover {
      background: linear-gradient(to bottom, #ffffff, #f0f0f0);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .action-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      background: #e8e8e8;
    }
    
    .action-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .action-btn:hover::after {
      opacity: 1;
    }
    
    /* User Type Selection */
    .user-type {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .user-btn {
      background: rgba(245, 245, 220, 0.1);
      color: white;
      border: 1px solid var(--gold);
      padding: 10px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      font-size: 0.85rem;
    }
    
    .user-btn.active {
      background: var(--gold);
      color: var(--dark-green);
    }
    
    /* Cart System */
    .add-to-cart {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(46, 125, 50, 0.3);
      font-size: 0.9rem;
    }
    
    .cart-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: 400px;
      background: rgba(26, 58, 47, 0.98);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      border: 1px solid var(--gold);
      z-index: 900;
      transform: translateX(120%);
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.1);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .cart-panel.active {
      transform: translateX(0);
      box-shadow: 0 8px 25px rgba(0,0,0,0.45);
    }
    
    @media (max-width: 480px) {
      .cart-panel {
        bottom: 0;
        right: 0;
        width: 100%;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        max-height: 85vh;
        padding-top: 25px;
      }
      
      .cart-panel.active {
        transform: translateY(0);
      }
      
      .cart-panel::before {
        content: '';
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
    }
    
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .cart-header h3 {
      margin: 0;
      color: var(--gold);
      font-size: 1rem;
    }
    
    .cart-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      max-height: 30vh;
      padding-right: 5px;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 15px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }
    
    .cart-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .cart-item:active {
      background: rgba(255, 255, 255, 0.08);
      transform: scale(0.99);
    }
    
    .cart-item-content {
      display: flex;
      width: 100%;
      gap: 12px;
    }
    
    .cart-item-model {
      width: 55px;
      height: 55px;
      position: relative;
      flex-shrink: 0;
      margin-right: 5px;
      overflow: hidden;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
    }
    
    .cart-item model-viewer {
      width: 100%;
      height: 100%;
      --poster-color: transparent;
      --progress-bar-color: var(--gold);
      --progress-mask: transparent;
    }
    
    .item-name {
      flex: 2;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.3;
    }
    
    .item-quantity {
      display: inline-block;
      background: rgba(212, 175, 55, 0.2);
      color: var(--gold);
      border-radius: 4px;
      padding: 1px 5px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 4px;
    }
    
    .item-extras {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 3px;
      font-style: italic;
    }
    
    .item-notes {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 4px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding: 4px 6px;
    }
    
    .item-price {
      flex: 1;
      text-align: right;
      font-weight: bold;
      color: var(--gold);
      white-space: nowrap;
      color: var(--gold);
      font-size: 0.85rem;
    }
    
    .remove-item {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border-radius: 50%;
      margin-left: 6px;
    }
    
    .remove-item:hover {
      color: var(--bright-red);
      background: rgba(255, 59, 48, 0.2);
    }
    
    .empty-cart-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 20px;
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
    }
    
    .empty-cart-message i {
      font-size: 2rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .empty-cart-message p {
      margin: 0 0 5px 0;
    }
    
    .empty-cart-subtext {
      font-size: 0.85rem;
      opacity: 0.7;
    }
    
    .cart-edit-hint {
      text-align: center;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      padding: 6px;
      margin-bottom: 10px;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 4px;
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      width: 100%;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      font-size: 0.9rem;
    }
    
    .checkout-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    /* Loading button styles */
    .checkout-loading {
      position: relative;
      pointer-events: none; /* Prevent any interactions during loading */
    }
    
    /* Hide the text content */
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    /* Clean loading spinner without overriding conflicts */
    .checkout-loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(26, 58, 47, 0.2);
      border-top-color: var(--dark-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      background: none;
      z-index: 1;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cart-toggle {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: var(--gold);
      color: var(--dark-green);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 800;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-origin: center;
    }
    
    .cart-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .cart-toggle:active {
      transform: scale(0.95);
    }
    
    .cart-toggle.has-items {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      animation: cart-pulse 2s infinite alternate;
    }
    
    @keyframes cart-pulse {
      0% {
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
      }
      100% {
        box-shadow: 0 4px 20px rgba(212, 175, 55, 0.6);
      }
    }
    
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--bright-red);
      color: white;
      min-width: 22px;
      height: 22px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      border: 2px solid var(--dark-green);
      transition: all 0.3s ease;
    }
    
    /* Order Status Notification - Enhanced for better visibility and experience on all devices */
    .order-status-notification {
      position: fixed;
      top: 20px; /* Centered at the top */
      left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: white;
      color: var(--dark-green);
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 3px 8px rgba(0,0,0,0.3);
      z-index: 9999; /* Ensure highest visibility */
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-left: 6px solid var(--gold);
      width: calc(100% - 40px);
      max-width: 420px;
      opacity: 0;
      text-align: left;
      animation: notification-pulse 3s infinite alternate;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    @keyframes notification-pulse {
      0% { box-shadow: 0 10px 35px rgba(0,0,0,0.4); }
      50% { box-shadow: 0 10px 35px rgba(212, 175, 55, 0.35); }
      100% { box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    }
    
    .order-status-notification.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .order-status-notification.success {
      border-left-color: var(--green);
      background: linear-gradient(to right, rgba(76, 175, 80, 0.1), white);
    }
    
    .order-status-notification.error {
      border-left-color: var(--bright-red);
      background: linear-gradient(to right, rgba(244, 67, 54, 0.1), white);
    }
    
    .order-status-notification.info {
      border-left-color: #2196F3;
      background: linear-gradient(to right, rgba(33, 150, 243, 0.1), white);
    }
    
    .status-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .order-status-notification.success .status-icon {
      color: #4CAF50;
    }
    
    .order-status-notification.error .status-icon {
      color: #F44336;
    }
    
    .order-status-notification.info .status-icon {
      color: #2196F3;
    }
    
    .status-content {
      flex: 1;
      text-align: left;
    }
    
    .status-title {
      font-weight: bold;
      margin-bottom: 4px;
      color: var(--dark-green);
      font-size: 1rem;
    }
    
    .status-message {
      font-size: 0.85rem;
      color: #333;
      line-height: 1.3;
    }
    
    .close-status {
      background: none;
      border: none;
      color: #666;
      font-size: 1.1rem;
      cursor: pointer;
      margin-left: 8px;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .close-status:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #333;
    }

    /* Client Order Status */
    .client-orders {
      display: none;
      margin-top: 15px;
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
    }

    .client-orders.active {
      display: block;
    }

    .client-orders h3 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .client-order {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .client-order:last-child {
      border-bottom: none;
    }

    .client-order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .client-order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }

    .client-order-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .client-order-status::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: currentColor;
      box-shadow: 0 0 3px currentColor;
    }

    .client-order-items {
      margin-bottom: 6px;
    }

    .client-order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      font-size: 0.8rem;
    }

    .view-orders-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px;
      font-size: 0.8rem;
    }

    /* Table Number Modal */
    .table-number-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      opacity: 1;
      transition: opacity 0.3s ease;
      padding: 15px;
      overflow-y: auto;
    }
    
    .table-number-content {
      background: rgba(26, 58, 47, 0.98);
      padding: 30px;
      border-radius: 16px;
      border: 2px solid var(--gold);
      width: 100%;
      max-width: 340px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      animation: modalFadeIn 0.5s ease;
      max-height: 85vh;
      overflow-y: auto;
      margin: auto;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .table-number-title {
      color: var(--gold);
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
    }
    
    .table-number-subtitle {
      color: var(--light-cream);
      margin-bottom: 20px;
      font-size: 0.95rem;
      text-align: center;
    }

    .table-number-help {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--gold);
      text-align: center;
    }
    
    .table-number-help i {
      color: var(--gold);
      font-size: 16px;
    }
    
    .table-number-input {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid rgba(212, 175, 55, 0.5);
      background: rgba(245, 245, 220, 0.1);
      color: white;
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .table-availability-indicator {
      height: 24px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .table-availability-indicator.available {
      color: var(--green);
    }
    
    .table-availability-indicator.occupied {
      color: var(--bright-red);
    }
    
    .table-availability-indicator i {
      font-size: 16px;
    }
    
    .table-number-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25);
    }
    
    .input-error {
      animation: shake 0.6s ease;
      border-color: var(--bright-red) !important;
      box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.25) !important;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    /* Notification Icon Animations */
    @keyframes pulse-success {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(76, 175, 80, 0.7); }
    }
    
    @keyframes pulse-error {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(244, 67, 54, 0.7); }
    }
    
    @keyframes pulse-info {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(33, 150, 243, 0.7); }
    }
    
    /* Mobile notification fixes */
    @media (max-width: 480px) {
      .order-status-notification {
        padding: 12px 16px;
        gap: 10px;
        width: calc(100% - 20px);
        max-width: none;
        border-radius: 12px;
      }
      
      .status-title {
        font-size: 0.9rem;
      }
      
      .status-message {
        font-size: 0.8rem;
      }
      
      .status-icon {
        width: 24px;
        height: 24px;
      }
    }
    
    .user-option-buttons {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      margin-bottom: 20px;
    }
    
    .guest-option, .staff-option {
      flex: 1;
      padding: 20px 14px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .guest-option {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      font-weight: 600;
      border: 2px solid transparent;
    }
    
    .guest-option::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0) 70%);
      transform: translateX(-100%);
      transition: all 0.6s ease;
    }
    
    .guest-option:hover::after {
      transform: translateX(100%);
    }
    
    .staff-option {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light-cream);
      border: 2px solid rgba(212, 175, 55, 0.3);
    }
    
    .staff-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.1) 50%, rgba(212, 175, 55, 0) 100%);
      transition: all 0.6s ease;
    }
    
    .staff-option:hover::before {
      left: 100%;
    }
    
    .staff-option-active {
      transform: scale(0.95);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .option-icon {
      display: block;
      margin: 0 auto 12px;
      font-size: 28px;
      animation: subtle-float 2s infinite alternate;
    }
    
    .option-description {
      font-size: 12px;
      margin-top: 8px;
      opacity: 0.85;
      line-height: 1.3;
      max-width: 120px;
      transition: all 0.3s ease;
    }
    
    .guest-option:hover .option-description,
    .staff-option:hover .option-description {
      opacity: 1;
    }
    
    @keyframes subtle-float {
      0% { transform: translateY(0); }
      100% { transform: translateY(-3px); }
    }
    
    .guest-option:hover, .staff-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    }
    
    .guest-option:active, .staff-option:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Selected state for options */
    .guest-option.option-selected, .staff-option.option-selected {
      background: rgba(255,255,255,0.25);
      transform: scale(1.03);
      border-color: var(--gold);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .guest-option.option-selected .option-icon,
    .staff-option.option-selected .option-icon {
      color: white;
      text-shadow: 0 0 10px rgba(255,223,112,0.7);
    }
    
    /* Success pulse animation for staff recognition */
    .option-success-pulse {
      animation: success-pulse 1.2s cubic-bezier(0.19, 1, 0.22, 1);
    }
    
    @keyframes success-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        background: rgba(76, 175, 80, 0.3);
      }
      50% {
        background: rgba(76, 175, 80, 0.5);
      }
      70% {
        box-shadow: 0 0 0 15px rgba(76, 175, 80, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
        background: rgba(255,255,255,0.25);
      }
    }
    
    /* Back button styling */
    .back-btn {
      margin-bottom: 15px;
      background: rgba(0,0,0,0.2);
      border: none;
      color: rgba(255,255,255,0.8);
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .back-btn:hover {
      background: rgba(0,0,0,0.3);
      color: white;
    }
    
    /* Embedded login form */
    .embedded-login-form {
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .embedded-login-form .input-group {
      margin-bottom: 15px;
    }
    
    .embedded-login-form .input-label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255,255,255,0.9);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .embedded-login-form .input-field {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    
    .embedded-login-form .input-field:focus {
      background: rgba(255,255,255,0.2);
      border-color: var(--gold);
      outline: none;
      box-shadow: 0 0 0 2px rgba(255,223,112,0.3);
    }
    
    .embedded-login-form .input-field::placeholder {
      color: rgba(255,255,255,0.5);
    }
    
    /* Staff/Guest icon standalone for login screen */
    .staff-icon-standalone,
    .guest-icon-standalone {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      animation: fadeInDown 0.5s ease;
    }
    
    .staff-icon-standalone i,
    .guest-icon-standalone i {
      font-size: 42px;
      color: var(--gold);
      margin-bottom: 10px;
      animation: subtle-float 2s infinite alternate;
    }
    
    .staff-icon-standalone .staff-title,
    .guest-icon-standalone .guest-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--light-cream);
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes subtle-float {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-5px);
      }
    }
    
    /* Table Grid */
    .tables-section {
      margin-top: 15px;
      padding: 15px;
      background: rgba(245, 245, 220, 0.05);
      border-radius: 12px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .table-item {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 10px 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .table-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .table-item.occupied {
      background: rgba(178, 34, 34, 0.8);
      border: 2px solid var(--bright-red);
      box-shadow: 0 0 15px rgba(255, 59, 48, 0.5);
      transform: translateY(-2px);
      position: relative;
      overflow: hidden;
    }
    
    .table-item.occupied::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 59, 48, 0) 0%, rgba(255, 59, 48, 0.3) 50%, rgba(255, 59, 48, 0) 100%);
      animation: shine 2s infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%); }
      60%, 100% { transform: translateX(100%); }
    }
    
    .table-status-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-top: 5px;
      position: relative;
    }
    
    .status-free {
      background: var(--green);
      box-shadow: 0 0 8px rgba(39, 174, 96, 0.4);
    }
    
    .status-occupied {
      background: var(--bright-red);
      box-shadow: 0 0 8px rgba(255, 59, 48, 0.6);
      animation: pulse-occupied 1.5s infinite;
    }
    
    @keyframes pulse-occupied {
      0% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 59, 48, 0.6); }
      50% { transform: scale(1.15); box-shadow: 0 0 12px rgba(255, 59, 48, 0.8); }
      100% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 59, 48, 0.6); }
    }
    
    .table-number {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .table-details {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .table-details-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 360px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .table-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      padding-bottom: 10px;
    }

    /* Enhanced Loading Animation */
    /* Modern & Visually Appealing Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(26, 58, 47, 0.98) 0%, rgba(16, 48, 37, 0.99) 100%);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      transition: opacity 0.5s ease;
      overflow: hidden;
    }
    
    .loading-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='rgba(255,255,255,0.05)' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.8;
      pointer-events: none;
    }
    
    .loading-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      max-width: 90%;
      padding: 30px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .loading-logo {
      width: 200px;
      height: auto;
      margin-bottom: 30px;
      animation: logo-pulse 3s infinite ease-in-out;
      filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
      transform-origin: center center;
      z-index: 2;
      position: relative;
    }
    
    /* Modern logo pulse animation */
    @keyframes logo-pulse {
      0% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.5)); }
      50% { transform: scale(1.1); filter: drop-shadow(0 0 30px rgba(212, 175, 55, 1)); }
      100% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.5)); }
    }
    
    /* Modern cube grid loading animation */
    .loading-cube-grid {
      width: 60px;
      height: 60px;
      margin: 20px auto;
      position: relative;
    }
    
    .loading-cube {
      width: 33%;
      height: 33%;
      background-color: var(--gold);
      float: left;
      animation: cube-grid-scale-delay 1.3s infinite ease-in-out;
      border-radius: 2px;
    }
    
    .loading-cube.cube1 { animation-delay: 0.2s; }
    .loading-cube.cube2 { animation-delay: 0.3s; }
    .loading-cube.cube3 { animation-delay: 0.4s; }
    .loading-cube.cube4 { animation-delay: 0.1s; }
    .loading-cube.cube5 { animation-delay: 0.2s; }
    .loading-cube.cube6 { animation-delay: 0.3s; }
    .loading-cube.cube7 { animation-delay: 0.0s; }
    .loading-cube.cube8 { animation-delay: 0.1s; }
    .loading-cube.cube9 { animation-delay: 0.2s; }
    
    @keyframes cube-grid-scale-delay {
      0%, 70%, 100% { transform: scale3D(0.5, 0.5, 1); opacity: 0.6; }
      35% { transform: scale3D(1, 1, 1); opacity: 1; }
    }
    
    .loading-model-status {
      color: rgba(212, 175, 55, 0.7);
      font-size: 0.85rem;
      text-align: center;
      margin-top: 15px;
      font-style: italic;
    }
    
    /* Dynamic background animation */
    .loading-overlay::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(26, 58, 47, 0.85) 0%, rgba(26, 58, 47, 0.98) 70%);
      opacity: 0.8;
      animation: bg-pulse 4s ease-in-out infinite;
      z-index: 1;
    }
    
    @keyframes bg-pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    
    /* Improved spinner with gold accents */
    .loading-spinner {
      width: 60px;
      height: 60px;
      position: relative;
      margin-bottom: 25px;
      z-index: 2;
    }
    
    .loading-spinner::before,
    .loading-spinner::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .loading-spinner::before {
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid var(--gold);
      border-right: 3px solid var(--gold);
      animation: spin 0.8s linear infinite;
    }
    
    .loading-spinner::after {
      border: 3px solid transparent;
      border-bottom: 3px solid rgba(212, 175, 55, 0.5);
      border-left: 3px solid rgba(212, 175, 55, 0.5);
      animation: spin-reverse 1.2s ease-in-out infinite;
    }
    
    @keyframes spin-reverse {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }
    
    .loading-text {
      color: var(--gold);
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
      z-index: 2;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      animation: text-fade 2s infinite alternate;
    }
    
    @keyframes text-fade {
      0% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .loading-progress {
      width: 220px;
      height: 6px;
      background: rgba(26, 58, 47, 0.5);
      border-radius: 8px;
      margin-top: 5px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2), inset 0 0 5px rgba(0, 0, 0, 0.2);
      z-index: 2;
      position: relative;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold) 0%, #E8C547 70%, #FFDF70 100%);
      width: 0%;
      transition: width 0.3s ease-out;
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.7);
      position: relative;
      animation: bar-glow 2s infinite alternate;
    }
    
    @keyframes bar-glow {
      0% { box-shadow: 0 0 8px rgba(212, 175, 55, 0.5); }
      100% { box-shadow: 0 0 16px rgba(212, 175, 55, 0.9); }
    }
    
    /* Rating Modal */
    .rating-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .rating-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
    }
    
    .rating-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    .rating-star {
      font-size: 1.5rem;
      color: #ccc;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .rating-star:hover, .rating-star.active {
      color: var(--gold);
    }
    
    /* Rating system animation */
    @keyframes pulse-attention {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .rating-stars.pulse-attention {
      animation: pulse-attention 0.5s ease-in-out 2;
    }
    
    /* Item Customization Modal (Talabat-style) */
    .customize-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1200;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
      transition: all 0.3s ease;
    }
    
    .customize-content {
      background: var(--dark-green);
      margin: 0 auto;
      width: 100%;
      max-width: 500px;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      animation: slide-up 0.4s ease;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slide-up {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .customize-header {
      background: var(--gold);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .customize-title {
      color: var(--dark-green);
      font-size: 1.2rem;
      margin: 0;
      font-weight: 600;
    }
    
    .close-customize-btn {
      background: none;
      border: none;
      color: var(--dark-green);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .close-customize-btn:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    
    .food-customize-image {
      width: 100%;
      height: 180px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1a2a20;
    }
    
    .food-customize-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .customize-price-container {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      color: white;
    }
    
    .base-price {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: line-through;
    }
    
    .total-price {
      font-size: 1.3rem;
      color: var(--gold);
      font-weight: bold;
    }
    
    .customize-sections {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .customize-section {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 20px;
    }
    
    .section-header {
      margin-bottom: 15px;
    }
    
    .section-header h3 {
      color: var(--gold);
      font-size: 1rem;
      margin: 0 0 5px 0;
    }
    
    .section-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.8rem;
    }
    
    .extras-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .extra-option {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .extra-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0) 100%);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    
    .extra-option:hover::before {
      transform: translateX(100%);
    }
    
    .extra-option:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      border-color: rgba(212, 175, 55, 0.4);
    }
    
    .extra-option.selected {
      background: rgba(212, 175, 55, 0.25);
      border-color: var(--gold);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
    }
    
    .extra-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .extra-option.selected .extra-checkbox {
      border-color: var(--gold);
      background: var(--gold);
      color: var(--dark-green);
    }
    
    .extra-option.selected .extra-checkbox::after {
      content: '✓';
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .extra-details {
      flex: 1;
    }
    
    .extra-name {
      color: white;
      font-size: 0.9rem;
      margin-bottom: 3px;
    }
    
    .extra-price {
      color: var(--gold);
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .special-instructions-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      padding: 12px;
      min-height: 80px;
      resize: vertical;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .special-instructions-input:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
    }
    
    .special-instructions-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .quantity-selector {
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.2);
    }
    
    #quantity-label {
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .quantity-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    .quantity-btn:active {
      transform: scale(0.95);
    }
    
    #quantity-value {
      font-size: 1.1rem;
      color: white;
      font-weight: 600;
      min-width: 30px;
      text-align: center;
    }
    
    .customize-actions {
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      position: sticky;
      bottom: 0;
    }
    
    .add-to-cart-customize-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-transform: uppercase;
    }
    
    .add-to-cart-customize-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    
    .add-to-cart-customize-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive styles for customize modal */
    @media screen and (max-width: 768px) {
      .customize-content {
        max-width: 100%;
      }
      
      .extras-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Admin Dashboard */
    .admin-dashboard {
      display: none;
      padding: 15px;
    }
    
    /* Admin Tabs - Enhanced Modern Design */
    .admin-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid rgba(212, 175, 55, 0.4);
      margin-bottom: 25px;
      padding-bottom: 2px;
      overflow-x: auto;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }
    
    .admin-tab {
      background: rgba(26, 58, 47, 0.5);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      padding: 14px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      position: relative;
      white-space: nowrap;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .admin-tab:hover {
      background: rgba(26, 58, 47, 0.8);
      transform: translateY(-3px);
      box-shadow: 0 -3px 8px rgba(0,0,0,0.1);
    }
    
    .admin-tab.active {
      background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(26, 58, 47, 0.9));
      color: var(--gold);
      border: 1px solid rgba(212, 175, 55, 0.6);
      border-bottom: none;
      position: relative;
      z-index: 1;
      transform: translateY(-3px);
    }
    
    .admin-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: var(--dark-green);
    }
    
    .admin-tab-content {
      display: none;
      animation: fadeEffect 0.5s ease;
    }
    
    .admin-tab-content.active {
      display: block;
    }
    
    @keyframes fadeEffect {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    
    .admin-panel {
      background: rgba(245, 245, 220, 0.05);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .admin-panel-title {
      color: var(--gold);
      font-size: 1rem;
      margin-bottom: 10px;
      text-align: left;
      font-weight: 600;
    }
    
    /* Advanced Analytics Styles */
    .analytics-dashboard {
      width: 100%;
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .analytics-header h3 {
      color: var(--gold);
      margin: 0;
      font-size: 1.3rem;
    }
    
    .time-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .time-filter label {
      color: var(--light-cream);
    }
    
    .time-filter select {
      background: rgba(26, 58, 47, 0.7);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.4);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    .analytics-card {
      background: rgba(26, 58, 47, 0.7);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(212, 175, 55, 0.2);
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border-color: rgba(212, 175, 55, 0.4);
    }
    
    .analytics-card.wide {
      grid-column: span 3;
    }
    
    .analytics-card-header {
      background: rgba(245, 245, 220, 0.1);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .analytics-card-header h4 {
      margin: 0;
      color: var(--gold);
      font-size: 1rem;
    }
    
    .analytics-actions {
      display: flex;
      gap: 8px;
    }
    
    .analytics-card-body {
      padding: 15px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .analytics-insight {
      background: rgba(245, 245, 220, 0.05);
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .analytics-insight i {
      color: var(--gold);
    }
    
    .analytics-insight span {
      font-size: 0.85rem;
      color: var(--light-cream);
      line-height: 1.4;
    }
    
    /* Staff Management Styles */
    .staff-management-panel {
      display: flex;
      flex-direction: column;
    }
    
    .staff-accounts-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .staff-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .staff-account-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .staff-account-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .staff-account-info {
      flex: 1;
    }
    
    .staff-account-name {
      font-weight: bold;
      font-size: 0.95rem;
      color: var(--gold);
      margin-bottom: 4px;
    }
    
    .staff-account-username {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .staff-account-role {
      font-size: 0.8rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 5px;
      display: inline-block;
    }
    
    .staff-account-actions {
      display: flex;
      gap: 8px;
    }
    
    .staff-action-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .edit-staff-btn:hover {
      color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }
    
    .delete-staff-btn:hover {
      color: var(--bright-red);
      background: rgba(255, 59, 48, 0.1);
    }
    
    .add-staff-form, .new-assignment-form {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .add-staff-form h4, .new-assignment-form h4 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1rem;
    }
    
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    
    .staff-table-assignments {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .table-assignment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .table-assignment-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .table-assignment-staff {
      font-weight: bold;
      color: var(--gold);
    }
    
    .table-assignment-range {
      font-size: 0.9rem;
    }
    
    .delete-assignment-btn {
      background: transparent;
      border: none;
      color: var(--bright-red);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .delete-assignment-btn:hover {
      background: rgba(255, 59, 48, 0.1);
    }
    
    /* Analytics Action Buttons */
    .action-btn {
      background: rgba(26, 58, 47, 0.7);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.4);
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background: rgba(26, 58, 47, 0.9);
      border-color: var(--gold);
      transform: translateY(-2px);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .stat-card {
      background: rgba(26, 58, 47, 0.7);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--gold);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--light-cream);
      text-align: center;
    }
    
    .admin-orders {
      margin-top: 10px;
    }
    
    /* Enhanced Button Styles */
    .confirm-btn, .cancel-btn, .checkout-btn, .apply-btn {
      padding: 14px 18px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .confirm-btn, .checkout-btn, .apply-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: 1px solid rgba(212, 175, 55, 0.6);
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      color: white;
      border: 1px solid rgba(244, 67, 54, 0.6);
    }
    
    .confirm-btn::after, .cancel-btn::after, .checkout-btn::after, .apply-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 70%);
      z-index: -1;
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    
    .confirm-btn:hover, .cancel-btn:hover, .checkout-btn:hover, .apply-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }
    
    .confirm-btn:hover::after, .cancel-btn:hover::after, .checkout-btn:hover::after, .apply-btn:hover::after {
      transform: translateX(100%);
    }
    
    .confirm-btn:active, .cancel-btn:active, .checkout-btn:active, .apply-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Button loading state */
    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .button-loading::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: button-loading-spinner 0.8s linear infinite;
      left: calc(50% - 10px);
      top: calc(50% - 10px);
    }
    
    @keyframes button-loading-spinner {
      from {
        transform: rotate(0turn);
      }
      to {
        transform: rotate(1turn);
      }
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
    }
    
    .apply-btn {
      background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
      color: white;
    }
    
    /* Specific button styles overrides */
    .checkout-btn {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
    }
    
    .apply-btn {
      background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
      color: white;
    }
    
    /* Media Queries - Enhanced for Better Mobile Experience */
    @media (max-width: 480px) {
      .header {
        padding: 12px 0;
      }
      
      .logo {
        height: 65px;
      }
      
      h1 {
        font-size: 1.6rem;
        margin: 8px 0 4px;
      }
      
      .tagline {
        font-size: 0.8rem;
        margin-bottom: 10px;
      }
      
      /* Improved navigation for mobile with larger tap targets */
      .nav-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 15px;
        width: 100%;
        max-width: none;
      }
      
      .nav-buttons button {
        font-size: 1rem;
        padding: 15px;
        border-radius: 12px;
        min-width: 60px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      /* Better layout for mobile navigation */
      .add-to-cart {
        width: 100%;
        padding: 16px;
        font-size: 1.1rem;
        margin-bottom: 5px;
        border-radius: 15px;
        background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        order: -1;
        min-height: 56px;
      }
      
      /* Style for the navigation arrow container */
      .nav-arrow-container {
        display: flex;
        width: 100%;
        justify-content: space-between;
        gap: 10px;
      }
      
      /* Position prev/next buttons in the container */
      #prev-btn, #next-btn {
        flex: 1;
        margin-top: 5px;
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Add visual feedback for touch */
      #prev-btn:active, #next-btn:active {
        transform: scale(0.98);
        background: rgba(245, 245, 220, 0.2);
      }
      
      /* Make the navigation buttons more visible on mobile */
      .nav-arrow-btn {
        padding: 14px 18px;
        font-size: 0.95rem;
        min-width: 100px;
        border-width: 2px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      }
      
      /* Enhanced button feedback on mobile */
      .nav-buttons button:active {
        transform: scale(0.97);
      }
      
      .nav-buttons button.active {
        box-shadow: 0 0 0 2px var(--gold), 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
      }
      
      /* Make primary actions more prominent */
      .add-to-cart {
        order: -1;
        width: 100%;
        margin-bottom: 12px;
        padding: 14px;
        font-size: 1rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      /* Better spacing for content */
      .food-container {
        padding: 20px 15px;
        margin-top: 15px;
        border-radius: 15px;
      }
      
      /* Improved model viewer */
      model-viewer {
        height: 230px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
      }
      
      /* Make the AR button more visible and intuitive on mobile */
      .ar-button {
        font-size: 1rem !important;
        padding: 12px 18px !important;
        bottom: 20px !important;
        border-radius: 30px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
      }
      
      /* Improve form elements on mobile */
      .input-group input, .input-group select, .input-group textarea {
        font-size: 16px; /* Prevents iOS zoom on focus */
        padding: 12px 15px;
        border-radius: 10px;
      }
      
      /* Enhanced cart experience on mobile */
      .cart-toggle {
        padding: 12px;
        right: 15px;
        bottom: 15px;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      }
      
      /* Better cart panel for mobile */
      .cart-panel {
        max-width: none;
        width: 100%;
        right: 0;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        padding-top: 25px;
        padding-bottom: 25px;
        box-shadow: 0 -5px 25px rgba(0,0,0,0.3);
      }
      
      /* Improved table options for mobile */
      .user-option-buttons {
        flex-direction: column;
        gap: 15px;
      }
      
      .guest-option, .staff-option {
        width: 100%;
        padding: 18px 15px;
        border-radius: 12px;
      }
      
      /* Enhance table number input for mobile */
      .table-number-input {
        padding: 15px;
        font-size: 18px;
        border-radius: 12px;
      }
      
      /* Improved modal buttons for better touch targets */
      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-buttons button {
        width: 100%;
        padding: 14px;
        font-size: 1rem;
        border-radius: 12px;
      }
      
      /* Improved notification styling for mobile */
      .order-status-notification {
        width: 90%;
        left: 5%;
        border-radius: 15px;
        padding: 15px;
      }
      
      /* Analytics Mobile Adjustments */
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-card.wide {
        grid-column: span 1;
      }
      
      .analytics-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .admin-tabs {
        flex-wrap: wrap;
      }
      
      .admin-tab {
        font-size: 0.8rem;
        padding: 10px 12px;
      }
      
      /* Enhanced footer for mobile */
      .footer {
        padding: 20px 15px;
      }
      
      .copyright {
        text-align: center;
        font-size: 0.8rem;
        padding: 10px 0;
      }
    }
    
    @media (min-width: 481px) and (max-width: 767px) {
      model-viewer {
        height: 250px;
      }
      
      .nav-buttons {
        gap: 10px;
      }
      
      /* Better spacing for medium-sized devices */
      .food-container {
        padding: 15px;
      }
      
      /* Analytics Tablet Adjustments */
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .analytics-card.wide {
        grid-column: span 2;
      }
      
      .admin-tabs {
        gap: 3px;
      }
      
      .admin-tab {
        padding: 10px 14px;
      }
    }
    
    @media (min-width: 768px) {
      .footer-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .admin-panels {
        grid-template-columns: 1fr 1fr;
      }
      
      model-viewer {
        height: 300px;
      }
      
      .food-container {
        max-width: 600px;
        margin: 0 auto;
      }
      
      .cart-panel {
        max-width: 380px;
      }
    }
    
    /* RTL Support for Arabic */
    .rtl {
      direction: rtl;
      text-align: right;
    }
    
    .rtl .input-group label {
      text-align: right;
    }
    
    .rtl .item-name {
      text-align: right;
    }
    
    .rtl h1#title, .rtl .tagline, .rtl .table-number-title, .rtl .table-number-subtitle {
      text-align: center !important;
    }
    
    /* Additional RTL fixes for table input modal */
    .rtl .table-number-help span,
    .rtl #guest-option-text,
    .rtl #staff-option-text,
    .rtl .option-description {
      text-align: center !important;
    }
    
    .rtl .table-number-input {
      text-align: center !important;
      direction: ltr; /* Numbers are always LTR */
    }
    
    .rtl .item-price {
      text-align: left;
    }
    
    .rtl .social-link {
      flex-direction: row-reverse;
    }
    
    /* RTL Support for navigation buttons */
    .rtl #prev-btn i {
      transform: rotate(180deg);
    }
    
    .rtl #next-btn i {
      transform: rotate(180deg);
    }
    
    .rtl #prev-btn:hover i {
      transform: rotate(180deg) translateX(3px);
    }
    
    .rtl #next-btn:hover i {
      transform: rotate(180deg) translateX(-3px);
    }
    
    .rtl .order-id {
      text-align: right;
    }
    
    .rtl .admin-panel-title {
      text-align: right;
    }
    
    .rtl .status-content {
      text-align: right;
    }
    
    /* RTL Support for Analytics */
    .rtl .analytics-header {
      flex-direction: row-reverse;
    }
    
    .rtl .analytics-card-header {
      flex-direction: row-reverse;
    }
    
    .rtl .analytics-insight {
      flex-direction: row-reverse;
    }
    
    .rtl .admin-tabs {
      direction: rtl;
    }
    
    .rtl .time-filter {
      direction: rtl;
    }
    
    /* RTL fixes for table number modal */
    .rtl .table-number-help {
      flex-direction: row-reverse;
      border-left: none;
      border-right: 3px solid var(--gold);
    }
    
    .rtl .modal-buttons {
      justify-content: center;
    }
    
    .rtl .user-option-buttons {
      flex-direction: row-reverse;
    }

    /* Language Toggle */
    .language-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(26, 58, 47, 0.8);
      border: 1px solid var(--gold);
      border-radius: 20px;
      padding: 5px 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      z-index: 10;
    }
    
    /* Connection Status Toast */
    .connection-toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 8px;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      max-width: 90%;
      border-left: 4px solid var(--gold);
    }
    
    .connection-toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .connection-toast.error {
      border-left-color: #ff5252;
    }
    
    .connection-toast.success {
      border-left-color: #4caf50;
    }
    
    .toast-icon {
      font-size: 20px;
      color: var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .connection-toast.error .toast-icon {
      color: #ff5252;
    }
    
    .connection-toast.success .toast-icon {
      color: #4caf50;
    }
    
    .toast-message {
      font-size: 14px;
      color: var(--light-cream);
      flex: 1;
    }
    
    /* Staff Ratings List */
    .staff-ratings-list {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 10px;
    }
    
    .rating-item {
      background: rgba(40, 40, 40, 0.5);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid var(--gold);
    }
    
    .rating-item.low-rating {
      border-left-color: var(--red);
    }
    
    .rating-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .rating-staff-name {
      font-weight: bold;
      color: var(--gold);
    }
    
    .rating-stars-display {
      color: var(--gold);
    }
    
    .rating-stars-display.low-rating {
      color: var(--red);
    }
    
    .rating-feedback {
      font-style: italic;
      color: var(--light-cream);
      font-size: 0.9em;
      margin-top: 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 5px;
    }
    
    .rating-meta {
      font-size: 0.8em;
      color: var(--light-cream);
      opacity: 0.7;
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    
    /* Table Action Buttons */
    .table-action-btn {
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    .free-table-btn {
      background-color: #4caf50;
      color: white;
    }
    
    .free-table-btn:hover {
      background-color: #2e7d32;
    }
    
    .occupy-table-btn {
      background-color: #d4af37;
      color: #2c1e0f;
    }
    
    .occupy-table-btn:hover {
      background-color: #b8941f;
    }
    
    /* Occupied Tables Count */
    .occupied-tables-count {
      margin-bottom: 15px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="header">
      <div class="logo-container">
        <img src="images-removebg-preview (1).png" alt="The Oak Cafe Logo" class="logo" />
      </div>
      <h1 id="title">The Oak Cafe</h1>
      <p class="tagline" id="tagline">Experience dining in augmented reality</p>
      <div class="language-toggle" onclick="toggleLanguage()">
        <span id="current-lang">EN</span>
      </div>
      <div class="user-type">
        <button class="user-btn active" id="guest-btn" onclick="switchUserType('guest')">GUEST</button>
        <button class="user-btn" id="staff-login-btn" onclick="showLoginModal()">LOGIN</button>
      </div>
    </div>
    
    <!-- Guest View -->
    <div class="guest-view" id="guest-view">
      <div class="category-container">
        <div class="category-heading">Main Categories</div>
        <div class="main-categories" id="main-categories">
          <button class="main-category-btn active" data-maincategory="all" id="all-main-category-btn" onclick="changeMainCategory('all')">
            <span>All</span>
          </button>
          <button class="main-category-btn" data-maincategory="food" id="food-main-category-btn" onclick="changeMainCategory('food')">
            <span>Food</span>
          </button>
          <button class="main-category-btn" data-maincategory="drinks" id="drinks-main-category-btn" onclick="changeMainCategory('drinks')">
            <span>Drinks</span>
          </button>
          <button class="main-category-btn" data-maincategory="desserts" id="desserts-main-category-btn" onclick="changeMainCategory('desserts')">
            <span>Desserts</span>
          </button>
        </div>
        
        <div class="sub-categories" id="sub-categories">
          <!-- Food subcategories -->
          <div class="subcategory-group" id="food-subcategories">
            <div class="subcategory-label">Food Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-food" data-parent="food" id="all-food-btn" onclick="changeCategory('all-food')">All Food</button>
              <button class="category-btn" data-category="pizza" data-parent="food" id="pizza-category-btn" onclick="changeCategory('pizza')">Pizza</button>
              <button class="category-btn" data-category="pasta" data-parent="food" id="pasta-category-btn" onclick="changeCategory('pasta')">Pasta</button>
              <button class="category-btn" data-category="salads" data-parent="food" id="salads-category-btn" onclick="changeCategory('salads')">Salads</button>
              <button class="category-btn" data-category="burgers" data-parent="food" id="burgers-category-btn" onclick="changeCategory('burgers')">Burgers</button>
            </div>
          </div>
          
          <!-- Drinks subcategories -->
          <div class="subcategory-group" id="drinks-subcategories" style="display: none;">
            <div class="subcategory-label">Beverage Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-drinks" data-parent="drinks" id="all-drinks-btn" onclick="changeCategory('all-drinks')">All Drinks</button>
              <button class="category-btn" data-category="hot-drinks" data-parent="drinks" id="hot-drinks-category-btn" onclick="changeCategory('hot-drinks')">Hot Drinks</button>
              <button class="category-btn" data-category="cold-drinks" data-parent="drinks" id="cold-drinks-category-btn" onclick="changeCategory('cold-drinks')">Cold Drinks</button>
              <button class="category-btn" data-category="smoothies" data-parent="drinks" id="smoothies-category-btn" onclick="changeCategory('smoothies')">Smoothies</button>
            </div>
          </div>
          
          <!-- Desserts subcategories -->
          <div class="subcategory-group" id="desserts-subcategories" style="display: none;">
            <div class="subcategory-label">Dessert Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-desserts" data-parent="desserts" id="all-desserts-btn" onclick="changeCategory('all-desserts')">All Desserts</button>
              <button class="category-btn" data-category="cakes" data-parent="desserts" id="cakes-category-btn" onclick="changeCategory('cakes')">Cakes</button>
              <button class="category-btn" data-category="ice-cream" data-parent="desserts" id="ice-cream-category-btn" onclick="changeCategory('ice-cream')">Ice Cream</button>
            </div>
          </div>
        </div>
      </div>
      <div class="food-container">
        <h2 id="food-name">Margherita Pizza</h2>
        <div class="model-container">
          <model-viewer 
            id="food-model-viewer" 
            src="/models/Margherita Pizza.glb" 
            alt="3D Food Model" 
            ar 
            ar-modes="quick-look scene-viewer webxr" 
            camera-controls 
            auto-rotate 
            shadow-intensity="1.2" 
            exposure="1.1"
            ar-scale="auto" 
            ar-placement="floor"
          >
            <button slot="ar-button" class="ar-button" id="ar-button">VIEW IN AR</button>
            <div class="model-loading-indicator" id="model-loading-indicator">
              <div class="loading-spinner model-spinner"></div>
            </div>
          </model-viewer>
        </div>
        <p id="food-description">Fresh mozzarella, tomatoes, and basil on a thin crust, baked to perfection.</p>
        <p id="food-price">Price: $14.99</p>
        
        <div class="nav-buttons">
          <button onclick="addToCart()" class="add-to-cart" id="add-cart-btn">+ ADD TO CART</button>
          <div class="nav-arrow-container">
            <button onclick="showPreviousItem()" id="prev-btn" class="nav-arrow-btn">
              <i class="fas fa-chevron-left"></i> PREV
            </button>
            <button onclick="showNextItem()" id="next-btn" class="nav-arrow-btn">
              NEXT <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <!-- Old extras section removed in favor of the new customize modal -->
        <div class="extras-section" style="display: none;">
          <div class="input-group">
            <label for="extras-select" id="extras-label">ADD EXTRAS</label>
            <select id="extras-select" disabled>
              <option value="">No extras</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="item-notes" id="notes-label">SPECIAL INSTRUCTIONS</label>
            <textarea id="item-notes" disabled rows="2" placeholder="Please use the customize modal instead"></textarea>
          </div>
        </div>
      </div>
      
      <div class="client-orders" id="client-orders">
        <h3 id="your-orders-title">YOUR ORDERS</h3>
        <div id="client-orders-list"></div>
      </div>
      
      <button class="view-orders-btn" id="view-orders-btn" onclick="toggleClientOrders()">VIEW MY ORDERS</button>
    </div>
    
    <!-- Staff Dashboard -->
    <div class="staff-dashboard" id="staff-dashboard">
      <div class="staff-header">
        <h2 id="staff-dashboard-title">STAFF DASHBOARD</h2>
        <button onclick="logoutStaff()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> <span id="staff-logout-btn-text">LOGOUT</span>
        </button>
        <div class="staff-info">
          <span id="staff-name-display">Staff Member</span>
          <span id="staff-role-badge">Role</span>
        </div>
      </div>
      
      <div class="estimated-time-section">
        <p id="staff-estimated-time-label">ESTIMATED WAIT TIME:</p>
        <p id="staff-estimated-time">15 minutes</p>
      </div>
      
      <div class="tables-section">
        <h3 id="occupied-tables-title">OCCUPIED TABLES</h3>
        <div class="tables-grid" id="tables-grid">
          <!-- Tables will appear here -->
        </div>
      </div>
      
      <div class="orders-list" id="orders-list">
        <!-- Orders will appear here -->
      </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="admin-dashboard">
      <div class="admin-header">
        <h2 id="admin-dashboard-title">ADMIN DASHBOARD</h2>
        <button onclick="logoutStaff()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> <span id="admin-logout-btn-text">LOGOUT</span>
        </button>
      </div>
      
      <!-- Admin Navigation Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab active" id="dashboard-tab" onclick="switchAdminTab('dashboard')">DASHBOARD</button>
        <button class="admin-tab" id="analytics-tab" onclick="switchAdminTab('analytics')">ADVANCED ANALYTICS</button>
        <button class="admin-tab" id="management-tab" onclick="switchAdminTab('management')">MANAGEMENT</button>
      </div>
      
      <!-- Main Dashboard Tab Content -->
      <div class="admin-tab-content active" id="dashboard-content">
        <div class="admin-panels">
          <div class="admin-panel">
            <h3 id="statistics-title">STATISTICS</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="total-orders">0</div>
                <div class="stat-label" id="total-orders-title">TOTAL ORDERS</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="avg-rating">0.0</div>
                <div class="stat-label" id="avg-rating-title">AVG RATING</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="low-ratings">0</div>
                <div class="stat-label" id="low-ratings-title">LOW RATINGS</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="active-staff">0</div>
                <div class="stat-label" id="active-staff-title">ACTIVE STAFF</div>
              </div>
            </div>
          </div>
          
          <div class="admin-panel">
            <h3 id="orders-title">ORDERS</h3>
            <canvas id="orders-chart" height="200"></canvas>
          </div>
          
          <div class="admin-panel">
            <h3 id="ratings-title">RATINGS</h3>
            <canvas id="ratings-chart" height="200"></canvas>
            
            <!-- Staff Ratings List -->
            <div class="staff-ratings-list" id="staff-ratings-list">
              <!-- Staff ratings will be displayed here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Advanced Analytics Tab Content -->
      <div class="admin-tab-content" id="analytics-content">
        <div class="analytics-dashboard">
          <div class="analytics-header">
            <h3 id="analytics-title">ADVANCED ANALYTICS DASHBOARD</h3>
            <div class="time-filter">
              <label for="time-range">Time Range:</label>
              <select id="time-range" onchange="updateAnalytics()">
                <option value="day">Today</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
          </div>
          
          <div class="analytics-grid">
            <!-- Sales Performance -->
            <div class="analytics-card wide">
              <div class="analytics-card-header">
                <h4>Sales Performance</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('sales')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                  <button onclick="toggleChartView('sales')" class="action-btn">
                    <i class="fas fa-chart-line"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="sales-performance-chart" height="250"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="sales-insight">Sales are up 12% compared to last week with peak hours between 12-2pm.</span>
              </div>
            </div>
            
            <!-- Menu Item Performance -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Top Menu Items</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('menu')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="menu-performance-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="menu-insight">Margherita Pizza is your top seller with 24% of sales.</span>
              </div>
            </div>
            
            <!-- Customer Satisfaction -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Customer Satisfaction</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('satisfaction')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="satisfaction-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="satisfaction-insight">85% of customers rated their experience 4+ stars.</span>
              </div>
            </div>
            
            <!-- Table Turnover -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Table Utilization</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('tables')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="table-utilization-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="table-insight">Tables 5-8 have highest turnover rate at 3.2 hours avg.</span>
              </div>
            </div>
            
            <!-- Staff Performance -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Staff Performance</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('staff')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="staff-performance-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="staff-insight">Sarah has the highest customer satisfaction score at 4.9/5.</span>
              </div>
            </div>
            
            <!-- Marketing Effectiveness -->
            <div class="analytics-card wide">
              <div class="analytics-card-header">
                <h4>Order Sources</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('marketing')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="marketing-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="marketing-insight">AR menu visualization increases average order value by 18%.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Management Tab Content -->
      <div class="admin-tab-content" id="management-content">
        <div class="admin-panels">
          <div class="admin-panel staff-management-panel">
            <h3 id="staff-management-title" class="admin-panel-title">STAFF MANAGEMENT</h3>
            
            <div class="staff-accounts-container">
              <h4 id="staff-accounts-title">STAFF ACCOUNTS</h4>
              <div class="staff-list" id="staff-accounts-list">
                <!-- Staff accounts will appear here -->
              </div>
              
              <div class="add-staff-form">
                <h4 id="add-staff-title">ADD NEW STAFF</h4>
                <div class="input-group">
                  <label for="new-staff-username">USERNAME</label>
                  <input type="text" id="new-staff-username" placeholder="Enter username">
                </div>
                <div class="input-group">
                  <label for="new-staff-name">FULL NAME</label>
                  <input type="text" id="new-staff-name" placeholder="Enter staff name">
                </div>
                <div class="input-group">
                  <label for="new-staff-password">PASSWORD</label>
                  <input type="password" id="new-staff-password" placeholder="Enter password">
                </div>
                <div class="input-group">
                  <label for="new-staff-role">ROLE</label>
                  <select id="new-staff-role">
                    <option value="server">Server</option>
                    <option value="chef">Chef</option>
                    <option value="manager">Manager</option>
                    <option value="staff">General Staff</option>
                  </select>
                </div>
                <button onclick="addStaffAccount()" id="add-staff-btn" class="confirm-btn">ADD STAFF</button>
              </div>
            </div>
          </div>

          <div class="admin-panel">
            <h3 id="staff-assignment-title">TABLE ASSIGNMENTS</h3>
            <div class="staff-table-assignments" id="staff-table-assignments">
              <!-- Table assignments will appear here -->
            </div>
            
            <div class="new-assignment-form">
              <h4 id="new-assignment-title">NEW TABLE ASSIGNMENT</h4>
              <div class="input-grid">
                <div class="input-group">
                  <label for="staff-assignment" id="staff-assignment-label">SELECT STAFF</label>
                  <select id="staff-assignment">
                    <option value="">Select staff member</option>
                  </select>
                </div>
                <div class="input-group">
                  <label for="table-range-start">TABLE RANGE START</label>
                  <input type="number" id="table-range-start" min="1" value="1">
                </div>
                <div class="input-group">
                  <label for="table-range-end">TABLE RANGE END</label>
                  <input type="number" id="table-range-end" min="1" value="20">
                </div>
              </div>
              <button onclick="assignTableRange()" id="assign-staff-btn" class="confirm-btn">ASSIGN TABLES</button>
            </div>
          </div>
          
          <div class="admin-panel">
            <h3 id="discount-management-title">DISCOUNT MANAGEMENT</h3>
            <div class="input-group">
              <label for="discount-code-input">DISCOUNT CODE</label>
              <input type="text" id="discount-code-input" placeholder="Enter discount code">
            </div>
            <div class="input-group">
              <label for="discount-percent">DISCOUNT PERCENTAGE</label>
              <input type="number" id="discount-percent" min="5" max="50" value="10">
            </div>
            <button onclick="applyDiscount()" id="apply-discount-btn" class="confirm-btn">CREATE DISCOUNT</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-grid">
        <div class="branding-section">
          <div class="powered-by">
            <span id="powered-by-text">Powered by AR Bites</span>
            <img src="ar-bites-logo.png" alt="AR Bites" class="ar-bites-logo" />
          </div>
        </div>
        <div class="contact-info">
          <span id="contact-us-text">Contact Us</span>
          <a href="tel:+962790753376" class="phone-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            <span id="phone-text">+962790753376</span>
          </a>
        </div>
        <div class="social-links">
          <a href="https://www.instagram.com/ar.bitesjo?igsh=ajhmd3ZvbjJhamJh" target="_blank" rel="noopener noreferrer" class="social-link">
            <svg class="instagram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            <span id="instagram-text">Follow AR Bites on Instagram</span>
          </a>
        </div>
      </div>
      <div class="copyright" id="copyright-text">© 2025 AR Bites. All rights reserved.</div>
    </div>
  </div>
  
  <!-- Cart System -->
  <div class="cart-toggle" id="cart-toggle" onclick="toggleCart()">
    <i class="fas fa-shopping-cart"></i>
    <div class="cart-count" id="cart-count">0</div>
  </div>
  
  <div class="cart-panel" id="cart-panel">
    <div class="cart-header">
      <h3 id="cart-title">YOUR CART</h3>
      <button onclick="toggleCart()" style="background: none; color: white; border: none;">&times;</button>
    </div>
    
    <div class="cart-items" id="cart-items">
      <!-- Cart items will appear here -->
    </div>
    
    <div class="total-section">
      <div id="total-breakdown"></div>
      <p id="estimated-time-label">Estimated Wait Time: <span id="estimated-time">15 minutes</span></p>
    </div>
    
    <div class="input-group" style="margin-top: 10px;">
      <label for="discount-code" id="discount-label">DISCOUNT CODE</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="discount-code" placeholder="Enter code...">
        <button id="apply-discount" onclick="applyDiscount()" class="apply-btn">APPLY</button>
      </div>
    </div>
    
    <button class="checkout-btn" id="checkout-btn" onclick="checkout()">
      <span class="checkout-text" id="checkout-text">CHECKOUT</span>
    </button>
  </div>
  
  <!-- Order Status Notification -->
  <div class="order-status-notification" id="status-notification">
    <div class="status-icon" id="status-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="status-content">
      <div class="status-title" id="status-title">Order Status</div>
      <div class="status-message" id="status-message">Your order has been received.</div>
    </div>
    <button class="close-status" onclick="closeNotification()">&times;</button>
  </div>
  
  <!-- Login Modal -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <h2 class="modal-title" id="login-title">ACCOUNT LOGIN</h2>
      <div class="input-group">
        <label for="username" id="username-label">USERNAME</label>
        <input type="text" id="username" placeholder="Enter username">
      </div>
      <div class="input-group">
        <label for="password" id="password-label">PASSWORD</label>
        <input type="password" id="password" placeholder="Enter password">
      </div>
      <div class="modal-buttons">
        <button onclick="loginUser()" class="confirm-btn" id="login-btn">LOGIN</button>
        <button onclick="closeModal()" class="cancel-btn" id="cancel-login-btn">CANCEL</button>
      </div>
    </div>
  </div>
  
  <!-- Table Number Modal -->
  <div class="table-number-modal" id="table-number-modal">
    <div class="table-number-content">
      <h2 class="table-number-title" id="table-number-title">YOUR TABLE NUMBER</h2>
      <p class="table-number-subtitle" id="table-number-subtitle">Please select your role or enter your table number to continue</p>
      
      <div class="user-option-buttons">
        <div class="guest-option" onclick="showGuestOption()">
          <i class="fas fa-utensils option-icon"></i>
          <span id="guest-option-text">I'm a Guest</span>
          <div class="option-description" id="guest-option-desc">Select this if you're dining in and need to place an order from your table</div>
        </div>
        <div class="staff-option" onclick="handleStaffBypass()">
          <i class="fas fa-user-tie option-icon"></i>
          <span id="staff-option-text">I'm Staff</span>
          <div class="option-description" id="staff-option-desc">Restaurant staff access - manage orders, tables, and kitchen operations</div>
        </div>
      </div>
      
      <div id="table-number-input-container" style="display: none;">
        <div class="table-number-help">
          <i class="fas fa-info-circle"></i>
          <span id="table-number-help-text">Your table number is displayed on the QR code at your table</span>
        </div>
        <input type="number" class="table-number-input" id="table-number-input" placeholder="Enter table number" min="1">
        <div class="table-availability-indicator" id="table-availability-indicator"></div>
        <div class="modal-buttons">
          <button onclick="confirmTableNumber()" class="confirm-btn" id="confirm-table-btn">
            <i class="fas fa-check-circle"></i> <span>CONFIRM</span>
          </button>
          <button onclick="closeTableModal(true)" class="cancel-btn" id="cancel-table-btn">
            <i class="fas fa-times-circle"></i> <span>CANCEL</span>
          </button>
        </div>
        <div class="staff-bypass-section" id="staff-bypass-section" style="display: none; margin-top: 15px; text-align: center;">
          <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
          <button onclick="bypassTableSelection()" class="staff-bypass-btn" style="
            padding: 10px 15px;
            background: linear-gradient(135deg, #4a6741 0%, #5a7d53 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-user-shield"></i> <span>STAFF BYPASS - SKIP TABLE SELECTION</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="rating-modal" id="rating-modal">
    <div class="rating-content">
      <h2 class="rating-title" id="rating-title">RATE YOUR EXPERIENCE</h2>
      <div class="rating-stars">
        <i class="fas fa-star rating-star" data-rating="1"></i>
        <i class="fas fa-star rating-star" data-rating="2"></i>
        <i class="fas fa-star rating-star" data-rating="3"></i>
        <i class="fas fa-star rating-star" data-rating="4"></i>
        <i class="fas fa-star rating-star" data-rating="5"></i>
      </div>
      <div class="input-group">
        <label for="rating-feedback" id="rating-feedback-label">FEEDBACK (OPTIONAL)</label>
        <textarea id="rating-feedback" rows="3" placeholder="Tell us about your experience..."></textarea>
      </div>
      <div class="modal-buttons">
        <button onclick="submitRating()" class="confirm-btn" id="submit-rating-btn">SUBMIT</button>
        <button onclick="closeRatingModal()" class="cancel-btn" id="cancel-rating-btn">CANCEL</button>
      </div>
    </div>
  </div>
  
  <!-- Table Details Modal -->
  <div class="table-details" id="table-details">
    <div class="table-details-content">
      <div class="table-details-header">
        <h2 class="modal-title" id="table-details-title">TABLE 1</h2>
        <button onclick="closeTableDetails()" style="background: none; color: white; border: none;">&times;</button>
      </div>
      
      <!-- Staff assignment information -->
      <div id="table-staff-info">
        <!-- Assigned staff info will appear here -->
      </div>
      
      <div id="table-orders-list">
        <!-- Table orders will appear here -->
      </div>
      
      <!-- Table action buttons for staff (mark as free/occupied) -->
      <div id="table-action-buttons">
        <!-- Table management buttons will appear here for staff -->
      </div>
      
      <button id="close-details" onclick="closeTableDetails()" class="confirm-btn" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>
  
  <!-- Enhanced Loading Animation -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-container">
      <img src="ar-bites-logo.png" alt="AR Bites Logo" class="loading-logo" />
      <div class="loading-cube-grid">
        <div class="loading-cube cube1"></div>
        <div class="loading-cube cube2"></div>
        <div class="loading-cube cube3"></div>
        <div class="loading-cube cube4"></div>
        <div class="loading-cube cube5"></div>
        <div class="loading-cube cube6"></div>
        <div class="loading-cube cube7"></div>
        <div class="loading-cube cube8"></div>
        <div class="loading-cube cube9"></div>
      </div>
      <p class="loading-text" id="loading-text">Loading Augmented Reality Experience...</p>
      <div class="loading-progress">
        <div class="loading-bar" id="loading-bar"></div>
      </div>
      <div class="loading-model-status">Preloading 3D Models...</div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    
    // Firebase configuration with better error handling
    const firebaseApiKey = "{{FIREBASE_API_KEY}}";
    const firebaseConfig = {
      apiKey: firebaseApiKey || "AIzaSyD5bF7rsIhlJ0-EBdRTHH67quCzjOFCRdQ", 
      authDomain: "the-oak-cafe.firebaseapp.com", 
      projectId: "the-oak-cafe",
      storageBucket: "the-oak-cafe.firebasestorage.app",
      messagingSenderId: "871343311823",
      appId: "1:871343311823:web:eb6724643e10cafde9e0ba",
      measurementId: "G-G83C83HXWR"
    };
    
    // Initialize Firebase with better error handling for demo and production modes
    let db;
    let isOfflineMode = false; // Use Firebase by default
    
    // Show a temporary toast notification
    function showConnectionToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `connection-toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">
          ${type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>'}
        </div>
        <div class="toast-message">${message}</div>
      `;
      document.body.appendChild(toast);
      
      // Animate in
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 5000);
    }
    
    try {
      firebase.initializeApp(firebaseConfig);
      
      try {
        firebase.analytics();
      } catch (analyticsError) {
        console.log("Analytics not available:", analyticsError);
      }
      
      db = firebase.firestore();
      
      // Define staff accounts early for initialization
      const accounts = [
        { username: 'admin', name: 'Restaurant Administrator', password: '123456', role: 'admin' },
        { username: 'ahmad', name: 'Ahmad Mohammed', password: '123456', role: 'manager' },
        { username: 'john', name: 'John Smith', password: '123456', role: 'chef' },
        { username: 'sarah', name: 'Sarah Johnson', password: '123456', role: 'server' },
        { username: 'staff', name: 'General Staff', password: '123456', role: 'staff' }
      ];
      
      // Initialize collections and data
      const initializeFirebase = async () => {
        try {
          console.log("Setting up Firebase collections and data...");
          
          // Load table assignments from Firebase to sync with local array
          const loadTableAssignments = async () => {
            try {
              const assignmentsRef = db.collection('tableAssignments');
              const snapshot = await assignmentsRef.get();
              
              // Clear existing assignments to be replaced with Firebase data
              tableAssignments = [];
              
              if (!snapshot.empty) {
                snapshot.forEach(doc => {
                  const data = doc.data();
                  tableAssignments.push({
                    id: doc.id,
                    staffUsername: data.staffUsername,
                    startTable: data.startTable,
                    endTable: data.endTable
                  });
                });
                console.log("Loaded table assignments from Firebase:", tableAssignments);
              } else {
                // If no assignments exist, create default ones
                console.log("No table assignments found, creating defaults");
                
                // Create default assignments if needed
                const defaultAssignments = [
                  { staffUsername: 'sarah', startTable: 1, endTable: 5 },
                  { staffUsername: 'john', startTable: 6, endTable: 10 },
                  { staffUsername: 'ahmad', startTable: 11, endTable: 16 }
                ];
                
                // Save to Firebase and update local array
                for (const assignment of defaultAssignments) {
                  const docRef = await assignmentsRef.add({
                    staffUsername: assignment.staffUsername,
                    startTable: assignment.startTable,
                    endTable: assignment.endTable,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  
                  tableAssignments.push({
                    id: docRef.id,
                    ...assignment
                  });
                }
                
                console.log("Created default table assignments");
              }
            } catch (err) {
              console.error("Error loading table assignments:", err);
              // Keep the default assignments in memory even if Firebase fails
            }
          };
          
          // Load and create staff accounts if needed
          const setupStaffAccounts = async () => {
            try {
              const staffRef = db.collection('staff');
              
              // Check for each staff account
              for (const acc of accounts) {
                const staffQuery = await staffRef.where('username', '==', acc.username).limit(1).get();
                
                if (staffQuery.empty) {
                  await staffRef.add({
                    username: acc.username,
                    name: acc.name || acc.username,
                    role: acc.role || 'staff',
                    password: acc.password, // Note: In a real app, never store plaintext passwords
                    active: true,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  console.log(`Staff account created for ${acc.username}`);
                } else {
                  console.log(`Staff account already exists for ${acc.username}`);
                }
              }
            } catch (err) {
              console.error("Error setting up staff accounts:", err);
            }
          };
          
          // Setup listeners for orders
          const setupOrdersCollection = async () => {
            try {
              // Ensure the orders collection exists
              const ordersRef = db.collection('orders');
              await ordersRef.limit(1).get();
              
              // Setup real-time listener for occupied tables based on orders
              ordersRef.onSnapshot(snapshot => {
                try {
                  if (!snapshot.empty) {
                    // Update occupiedTables based on orders
                    const tableMap = new Map();
                    
                    snapshot.forEach(doc => {
                      const orderData = doc.data();
                      const tableNum = orderData.tableNumber;
                      
                      if (tableNum) {
                        // Add to occupied tables
                        occupiedTables.add(tableNum);
                        
                        // Update table details
                        if (!tableDetails[tableNum]) {
                          tableDetails[tableNum] = { orders: [] };
                        }
                        
                        // Add order to table details if not already there
                        const orderExists = tableDetails[tableNum].orders.some(o => o.id === doc.id);
                        if (!orderExists) {
                          tableDetails[tableNum].orders.push({
                            id: doc.id,
                            status: orderData.status,
                            items: orderData.items || [],
                            timestamp: orderData.timestamp?.toDate() || new Date(),
                            total: orderData.total || 0,
                            assignedStaff: orderData.assignedStaff
                          });
                          
                          // Sort orders by timestamp (newest first)
                          tableDetails[tableNum].orders.sort((a, b) => 
                            b.timestamp.getTime() - a.timestamp.getTime()
                          );
                        }
                        
                        // Map tables to their assigned staff
                        if (orderData.assignedStaff) {
                          tableMap.set(tableNum, orderData.assignedStaff);
                        }
                      }
                    });
                    
                    console.log("Updated occupied tables from Firebase:", Array.from(occupiedTables));
                    
                    // Update tables display if we're in staff mode
                    if (userType === 'staff' || userType === 'admin') {
                      updateTablesDisplay();
                    }
                  }
                } catch (err) {
                  console.error("Error processing orders snapshot:", err);
                }
              }, err => {
                console.error("Error in orders snapshot listener:", err);
              });
              
            } catch (err) {
              console.error("Error setting up orders collection:", err);
            }
          };
          
          // Execute all initialization tasks
          await Promise.all([
            loadTableAssignments(),
            setupStaffAccounts(),
            setupOrdersCollection()
          ]);
          
          console.log("Firebase initialization completed");
        } catch (err) {
          console.error("Error in Firebase initialization:", err);
        }
      };
      
      // Initialize Firebase collections and data
      initializeFirebase();
      
      // Monitor online/offline status
      firebase.firestore().enableNetwork()
        .then(() => {
          console.log("Firebase connection successful");
          isOfflineMode = false;
        })
        .catch(err => {
          console.error("Network connection error:", err);
          // Only set offline mode on actual network errors
          console.error("Firebase connection error:", err.code);
        });
    } catch (firebaseError) {
      console.log("Firebase initialization error:", firebaseError);
      isOfflineMode = true;
      
      // Removed notifications during loading as requested
      console.log("Firebase initialization failed, using demo mode");
      
      // Create a mock database for demo purposes when Firebase is unavailable
      db = {
        collection: (collectionName) => {
          return {
            doc: (id) => {
              return {
                get: () => Promise.resolve({
                  exists: true,
                  data: () => {
                    // Return mock data based on collection and document ID
                    if (collectionName === 'orders') {
                      return {
                        tableNumber: parseInt(id) || 1,
                        items: [{name: 'Margherita Pizza', price: 14.99}],
                        status: 'pending',
                        timestamp: new Date(),
                        userId: 'guest'
                      };
                    }
                    return {};
                  }
                }),
                set: (data) => Promise.resolve(data),
                update: (data) => Promise.resolve(data)
              };
            },
            where: () => ({
              get: () => Promise.resolve({
                empty: false,
                docs: [{
                  id: '1',
                  data: () => ({
                    tableNumber: 1,
                    status: 'pending'
                  })
                }]
              })
            }),
            add: (data) => Promise.resolve({ id: 'mockId' }),
            onSnapshot: (callback) => {
              // Call immediately with mock data
              callback({
                docs: [
                  {
                    id: '1',
                    data: () => ({
                      tableNumber: 1,
                      status: 'pending',
                      items: [{name: 'Margherita Pizza', price: 14.99}],
                      timestamp: new Date(),
                      userId: 'guest'
                    })
                  }
                ]
              });
              // Return unsubscribe function
              return () => {};
            },
            get: () => Promise.resolve({
              size: 5,
              empty: false,
              docs: Array(5).fill(0).map((_, i) => ({
                id: String(i+1),
                data: () => ({
                  tableNumber: i+1,
                  status: ['pending', 'preparing', 'ready', 'completed', 'cancelled'][i % 5],
                  rating: Math.floor(Math.random() * 5) + 1,
                  timestamp: new Date(),
                  userId: 'guest'
                })
              }))
            })
          };
        }
      };
      
      // Removed notifications during loading as requested
      console.log("Demo mode active with sample data");
      
      // Pre-populate some demo data for tables
      window.setTimeout(() => {
        // Add mock occupied tables
        for (let tableNum of [2, 5, 8]) {
          occupiedTables.add(tableNum);
          
          // Create mock details for staff view
          tableDetails[tableNum] = {
            orders: [
              {
                id: `order-${tableNum}-1`,
                status: ['pending', 'preparing', 'ready'][Math.floor(Math.random() * 3)],
                items: [
                  { name: 'Margherita Pizza', price: 14.99, totalPrice: 14.99 },
                  { name: 'Alfredo Pasta', price: 13.99, totalPrice: 13.99 }
                ],
                timestamp: new Date(Date.now() - Math.random() * 3600000),
                total: 28.98
              }
            ]
          };
        }
        
        // Basic implementation of updateTablesDisplay for demo mode
        function updateTablesDisplay() {
          console.log("Updating tables display in demo mode");
          const tablesContainer = document.getElementById('occupied-tables-container');
          if (!tablesContainer) return;
          
          // Clear existing content
          tablesContainer.innerHTML = '';
          
          // Display occupied tables
          for (const tableNum of occupiedTables) {
            const tableCard = document.createElement('div');
            tableCard.className = 'table-card';
            tableCard.dataset.tableNumber = tableNum;
            
            const statusClass = 'status-occupied'; // Default to occupied
            
            tableCard.innerHTML = `
              <div class="table-card-header">
                <h3>TABLE ${tableNum}</h3>
                <span class="table-status ${statusClass}">
                  ${currentLanguage === 'ar' ? 'مشغولة' : 'OCCUPIED'}
                </span>
              </div>
              <div class="table-card-content">
                <div class="table-info">
                  <p>${currentLanguage === 'ar' ? 'الطلبات' : 'Orders'}: 
                    <span>1</span>
                  </p>
                  <p>${currentLanguage === 'ar' ? 'آخر تحديث' : 'Last Updated'}: 
                    <span>5 ${currentLanguage === 'ar' ? 'دقائق' : 'mins'} ${currentLanguage === 'ar' ? 'مضت' : 'ago'}</span>
                  </p>
                </div>
                <button class="view-table-details-btn" onclick="viewTableDetails(${tableNum})">
                  ${currentLanguage === 'ar' ? 'عرض التفاصيل' : 'VIEW DETAILS'}
                </button>
              </div>
            `;
            
            tablesContainer.appendChild(tableCard);
          }
        }
        
        // Update tables display for staff view
        updateTablesDisplay();
        
        // Add some mock orders for guest mode
        if (clientOrdersList) {
          // Add this without the offline mode check
      if (clientOrdersList.childElementCount === 0) {
            addDemoOrderToClientList({
              id: 'demo-order-1',
              status: 'preparing',
              items: [{ name: 'Margherita Pizza', price: 14.99, totalPrice: 14.99 }],
              timestamp: new Date(Date.now() - 900000), // 15 minutes ago
              tableNumber: 3
            });
          }
        }
      }, 500);
    }
    
    // Global Variables
    let currentFoodIndex = 0;
    let currentCategory = "all";
    let currentMainCategory = "all";
    let filteredFoodItems = [];
    let cart = [];
    let estimatedTime = 15; // in minutes
    let currentLanguage = 'en';
    let userType = "guest"; // guest, staff, admin
    let currentStaff = null;
    let clientId = localStorage.getItem('clientId') || 
                  'CL-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    let occupiedTables = new Set(); // Track occupied tables
    let tableNumber = null; // Current table number for all users
    let userTableNumber = null; // Specifically for guest users to track their own table
    let tableNumberExpiry = null; // When the table number expires
    let tableDetails = {}; // Store table details for staff view
    let currentRating = 0;
    let currentOrderForRating = null;
    
    // Food catalog
    const foodItems = [
      // FOOD - Pizza items
      {
        name: "Margherita Pizza",
        nameAr: "بيتزا مارجريتا",
        modelSrc: "./models/Margherita Pizza.glb",
        description: "Fresh mozzarella, tomatoes, and basil on a thin crust, baked to perfection.",
        descriptionAr: "جبنة موزاريلا طازجة، طماطم، وريحان على عجينة رقيقة، مخبوزة بشكل مثالي.",
        price: 14.99,
        category: "pizza",
        mainCategory: "food"
      },
      {
        name: "Pepperoni Pizza",
        nameAr: "بيتزا ببروني",
        modelSrc: "models/Pepperoni Pizza.glb",
        description: "Classic pepperoni with cheese and our signature tomato sauce.",
        descriptionAr: "ببروني كلاسيكي مع الجبن وصلصة الطماطم المميزة لدينا.",
        price: 15.99,
        category: "pizza",
        mainCategory: "food"
      },
      {
        name: "Vegetarian Pizza",
        nameAr: "بيتزا نباتية",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Fresh bell peppers, mushrooms, onions, and olives on our signature crust.",
        descriptionAr: "فلفل حلو طازج، فطر، بصل، وزيتون على عجينتنا المميزة.",
        price: 16.99,
        category: "pizza",
        mainCategory: "food"
      },
      
      // FOOD - Pasta items
      {
        name: "Alfredo Pasta",
        nameAr: "باستا ألفريدو",
        modelSrc: "models/Fettuccine Alfredo.glb", // Updated to match actual file name
        description: "Creamy Alfredo sauce with fettuccine pasta, garnished with parsley.",
        descriptionAr: "صلصة ألفريدو كريمية مع معكرونة فيتوتشيني، مزينة بالبقدونس.",
        price: 13.99,
        category: "pasta",
        mainCategory: "food"
      },
      {
        name: "Spaghetti Bolognese",
        nameAr: "سباغيتي بولونيز",
        modelSrc: "models/Rose Pasta.glb", // Updated to match actual file name
        description: "Spaghetti with a rich, slow-cooked meat sauce and parmesan cheese.",
        descriptionAr: "سباغيتي مع صلصة لحم غنية مطبوخة ببطء وجبنة بارميزان.",
        price: 14.99,
        category: "pasta",
        mainCategory: "food"
      },
      {
        name: "Pesto Pasta",
        nameAr: "باستا بيستو",
        modelSrc: "models/Pesto Pasta.glb", // Updated to match actual file name
        description: "Linguine pasta with basil pesto, pine nuts, and freshly grated parmesan.",
        descriptionAr: "معكرونة لينجويني مع صلصة البيستو بالريحان والصنوبر وجبنة بارميزان مبشورة طازجة.",
        price: 14.49,
        category: "pasta",
        mainCategory: "food"
      },
      
      // FOOD - Salad items
      {
        name: "Caesar Salad",
        nameAr: "سلطة سيزر",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Crisp romaine lettuce with Caesar dressing, croutons, and parmesan cheese.",
        descriptionAr: "خس روماني مقرمش مع صلصة سيزر، قطع خبز محمصة، وجبنة بارميزان.",
        price: 9.99,
        category: "salads",
        mainCategory: "food"
      },
      {
        name: "Greek Salad",
        nameAr: "سلطة يونانية",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Fresh cucumbers, tomatoes, olives, feta cheese, and red onions with olive oil dressing.",
        descriptionAr: "خيار طازج، طماطم، زيتون، جبنة فيتا، وبصل أحمر مع صلصة زيت الزيتون.",
        price: 10.99,
        category: "salads",
        mainCategory: "food"
      },
      
      // FOOD - Burger items
      {
        name: "Classic Cheeseburger",
        nameAr: "تشيزبرجر كلاسيكي",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Juicy beef patty with cheddar cheese, lettuce, tomato, and our special sauce.",
        descriptionAr: "قطعة لحم بقري عصيرية مع جبنة شيدر، خس، طماطم، وصلصتنا الخاصة.",
        price: 12.99,
        category: "burgers",
        mainCategory: "food"
      },
      {
        name: "Veggie Burger",
        nameAr: "برجر نباتي",
        modelSrc: "models/Fettuccine Alfredo.glb", // Updated to correct model filename
        description: "Plant-based patty with avocado, grilled onions, and chipotle mayo.",
        descriptionAr: "قطعة برجر نباتية مع أفوكادو، بصل مشوي، ومايونيز تشيبوتلي.",
        price: 13.99,
        category: "burgers",
        mainCategory: "food"
      },
      
      // DRINKS - Hot Drinks
      {
        name: "Hot Chocolate",
        modelSrc: "models/Rose Pasta.glb", // Updated to correct model filename
        description: "Rich and creamy hot chocolate topped with marshmallows and whipped cream.",
        price: 3.99,
        category: "hot-drinks",
        mainCategory: "drinks"
      },
      {
        name: "Cappuccino",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Espresso with steamed milk and a silky microfoam.",
        price: 4.49,
        category: "hot-drinks",
        mainCategory: "drinks"
      },
      
      // DRINKS - Cold Drinks
      {
        name: "Iced Mocha",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Chilled espresso with chocolate, milk, and ice, topped with whipped cream.",
        price: 4.99,
        category: "cold-drinks",
        mainCategory: "drinks"
      },
      {
        name: "Lemonade",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Freshly squeezed lemons with sparkling water and a touch of sweetness.",
        price: 3.49,
        category: "cold-drinks",
        mainCategory: "drinks"
      },
      
      // DRINKS - Smoothies
      {
        name: "Berry Blast Smoothie",
        modelSrc: "models/Fettuccine Alfredo.glb", // Updated to correct model filename
        description: "Mixed berries, yogurt, and honey blended with ice for a refreshing treat.",
        price: 5.99,
        category: "smoothies",
        mainCategory: "drinks"
      },
      {
        name: "Tropical Paradise Smoothie",
        modelSrc: "models/Rose Pasta.glb", // Updated to correct model filename
        description: "Mango, pineapple, and banana blended with coconut milk and ice.",
        price: 6.49,
        category: "smoothies",
        mainCategory: "drinks"
      },
      
      // DESSERTS - Cakes
      {
        name: "Chocolate Cake",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Decadent chocolate cake with a rich chocolate ganache and berries.",
        price: 6.99,
        category: "cakes",
        mainCategory: "desserts"
      },
      {
        name: "Red Velvet Cake",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Moist red velvet cake with cream cheese frosting and white chocolate shavings.",
        price: 7.49,
        category: "cakes",
        mainCategory: "desserts"
      },
      
      // DESSERTS - Ice Cream
      {
        name: "Vanilla Bean Ice Cream",
        modelSrc: "models/Fettuccine Alfredo.glb", // Updated to correct model filename
        description: "Creamy vanilla bean ice cream served with a wafer cookie.",
        price: 4.99,
        category: "ice-cream",
        mainCategory: "desserts"
      },
      {
        name: "Tiramisu",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Classic Italian dessert with layers of coffee-soaked ladyfingers and mascarpone cream.",
        price: 7.99,
        category: "cakes",
        mainCategory: "desserts"
      }
    ];
    
    // DOM Elements
    const overlay = document.querySelector('.overlay');
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingBar = document.getElementById("loading-bar");
    const loadingText = document.getElementById("loading-text");
    const foodName = document.getElementById("food-name");
    const foodDescription = document.getElementById("food-description");
    const foodPrice = document.getElementById("food-price");
    const modelViewer = document.getElementById("food-model-viewer");
    const cartToggle = document.getElementById("cart-toggle");
    const cartPanel = document.getElementById("cart-panel");
    const cartItems = document.getElementById("cart-items");
    const cartCount = document.getElementById("cart-count");
    const cartTitle = document.getElementById("cart-title");
    const loginModal = document.getElementById("login-modal");
    const loginTitle = document.getElementById("login-title");
    const usernameLabel = document.getElementById("username-label");
    const passwordLabel = document.getElementById("password-label");
    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const cancelLoginBtn = document.getElementById("cancel-login-btn");
    const guestView = document.getElementById("guest-view");
    const staffDashboard = document.getElementById("staff-dashboard");
    const adminDashboard = document.getElementById("admin-dashboard");
    const guestBtn = document.getElementById("guest-btn");
    const staffBtn = document.getElementById("staff-btn");
    const adminBtn = document.getElementById("admin-btn");
    const staffDashboardTitle = document.getElementById("staff-dashboard-title");
    const checkoutText = document.getElementById("checkout-text");
    const checkoutBtn = document.getElementById("checkout-btn");
    const discountLabel = document.getElementById("discount-label");
    const applyDiscountBtn = document.getElementById("apply-discount");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const addCartBtn = document.getElementById("add-cart-btn");
    const arButton = document.getElementById("ar-button");
    const extrasLabel = document.getElementById("extras-label");
    const notesLabel = document.getElementById("notes-label");
    const statusNotification = document.getElementById("status-notification");
    const statusTitle = document.getElementById("status-title");
    const statusMessage = document.getElementById("status-message");
    const title = document.getElementById("title");
    const tagline = document.getElementById("tagline");
    const poweredByText = document.getElementById("powered-by-text");
    const currentLang = document.getElementById("current-lang");
    const instagramText = document.getElementById("instagram-text");
    const copyrightText = document.getElementById("copyright-text");
    const estimatedTimeLabel = document.getElementById("estimated-time-label");
    const yourOrdersTitle = document.getElementById("your-orders-title");
    const viewOrdersBtn = document.getElementById("view-orders-btn");
    const clientOrdersList = document.getElementById("client-orders-list");
    const clientOrders = document.getElementById("client-orders");
    const tableNumberModal = document.getElementById("table-number-modal");
    const tableNumberInput = document.getElementById("table-number-input");
    const tableNumberInputContainer = document.getElementById("table-number-input-container");
    const tableNumberTitle = document.getElementById("table-number-title");
    const tableNumberSubtitle = document.getElementById("table-number-subtitle");
    const guestOptionText = document.getElementById("guest-option-text");
    const staffOptionText = document.getElementById("staff-option-text");
    const itemNotes = document.getElementById("item-notes");
    const extrasSelect = document.getElementById("extras-select");
    const discountCodeInput = document.getElementById("discount-code");
    const totalBreakdown = document.getElementById("total-breakdown");
    const estimatedTimeEl = document.getElementById("estimated-time");
    const staffEstimatedTimeEl = document.getElementById("staff-estimated-time");
    const tablesGrid = document.getElementById("tables-grid");
    const tableDetailsModal = document.getElementById("table-details");
    const tableDetailsTitle = document.getElementById("table-details-title");
    const tableOrdersList = document.getElementById("table-orders-list");
    const closeDetailsBtn = document.getElementById("close-details");
    const ratingModal = document.getElementById("rating-modal");
    const ratingStars = document.querySelectorAll(".rating-star");
    const ratingFeedback = document.getElementById("rating-feedback");
    const ratingFeedbackLabel = document.getElementById("rating-feedback-label");
    const submitRatingBtn = document.getElementById("submit-rating-btn");
    const staffAssignment = document.getElementById("staff-assignment");
    const totalOrdersEl = document.getElementById("total-orders");
    const staffEstimatedTimeLabel = document.getElementById("staff-estimated-time-label");
    const occupiedTablesTitle = document.getElementById("occupied-tables-title");
    const adminDashboardTitle = document.getElementById("admin-dashboard-title");
    const totalOrdersTitle = document.getElementById("total-orders-title");
    const avgRatingTitle = document.getElementById("avg-rating-title");
    const lowRatingsTitle = document.getElementById("low-ratings-title");
    const activeStaffTitle = document.getElementById("active-staff-title");
    const statisticsTitle = document.getElementById("statistics-title");
    const ordersTitle = document.getElementById("orders-title");
    const ratingsTitle = document.getElementById("ratings-title");
    const staffAssignmentTitle = document.getElementById("staff-assignment-title");
    const staffAssignmentLabel = document.getElementById("staff-assignment-label");
    const assignStaffBtn = document.getElementById("assign-staff-btn");
    const confirmTableBtn = document.getElementById("confirm-table-btn");
    const cancelTableBtn = document.getElementById("cancel-table-btn");
    const ratingTitle = document.getElementById("rating-title");
    const cancelRatingBtn = document.getElementById("cancel-rating-btn");
    
    // Constants
    const USER_TYPE_KEY = "userType";
    const STAFF_TOKEN = "staffToken";
    const ADMIN_TOKEN = "adminToken";
    const TABLE_NUMBER_KEY = "tableNumber";
    const TABLE_EXPIRY_KEY = "tableExpiry";
    const LANGUAGE_KEY = "language";
    const CLIENT_ID_KEY = "clientId";
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', async function() {
      // Load language preference
      currentLanguage = localStorage.getItem(LANGUAGE_KEY) || 'en';
      updateLanguage();
      
      // Retrieve authentication status
      userType = localStorage.getItem(USER_TYPE_KEY) || "guest";
      currentStaff = localStorage.getItem(STAFF_TOKEN);
      checkAuthState();
      
      // Manually add event listener for the Add to Cart button in customization modal
      // This ensures the event is properly captured regardless of event bubbling
      // We'll handle this through the onclick attribute in the HTML
      
      // Set up enter key for password field
      const passwordField = document.getElementById('password');
      if (passwordField) {
        passwordField.addEventListener('keyup', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            loginUser();
          }
        });
      }
      
      // FORCE CLEAR any existing table number for testing
      localStorage.removeItem(TABLE_NUMBER_KEY);
      localStorage.removeItem(TABLE_EXPIRY_KEY);
      tableNumber = null;
      tableNumberExpiry = null;
      
      // Check for expired table number - should always be null now for testing
      const savedTableNumber = localStorage.getItem(TABLE_NUMBER_KEY);
      const savedUserTableNumber = localStorage.getItem('userTableNumber');
      const expiry = localStorage.getItem(TABLE_EXPIRY_KEY);
      
      console.log("Table number in storage:", savedTableNumber);
      console.log("User table number in storage:", savedUserTableNumber);
      
      if (savedTableNumber && expiry && new Date(expiry) > new Date()) {
        tableNumber = parseInt(savedTableNumber, 10);
        tableNumberExpiry = new Date(expiry);
      }
      
      // Load user table number for guests regardless of expiry
      if (savedUserTableNumber) {
        userTableNumber = parseInt(savedUserTableNumber, 10);
      }
      
      // Set client ID for tracking orders
      localStorage.setItem(CLIENT_ID_KEY, clientId);
      
      // Check if the user is already logged in as staff or admin
      const staffLoggedIn = localStorage.getItem(STAFF_TOKEN);
      const adminLoggedIn = localStorage.getItem(ADMIN_TOKEN);
      
      if (staffLoggedIn || adminLoggedIn) {
        console.log("Staff/Admin already logged in, bypassing table modal");
        // Set user type based on existing token
        userType = adminLoggedIn ? 'admin' : 'staff';
        localStorage.setItem(USER_TYPE_KEY, userType);
        checkAuthState();
      } else {
        // Force showing the table number modal on initialization for guests
        console.log("Initialization: Forcing table modal display");
        // Delay slightly to ensure it's fully visible
        setTimeout(() => {
          showTableModal();
        }, 500);
      }
      
      // Set initial category to "All" by default
      currentCategory = 'all';
      currentMainCategory = 'all';
      
      // Set "All" main category button as active
      const allMainCategoryBtn = document.getElementById('all-main-category-btn');
      if (allMainCategoryBtn) {
        document.querySelectorAll('.main-category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        allMainCategoryBtn.classList.add('active');
      }
      
      // Hide subcategories when "All" is selected
      const subCategoriesContainer = document.getElementById('sub-categories');
      if (subCategoriesContainer) {
        subCategoriesContainer.style.display = 'none';
      }
      
      // Filter food items and display the first one
      filterFoodItems();
      updateFoodDisplay();
      
      // Start preloading all 3D models
      setTimeout(() => {
        preloadModels();
      }, 2000);
      
      // Start the loading animation
      simulateLoading();
      
      // Listen for rating stars
      ratingStars.forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.getAttribute('data-rating'));
          currentRating = rating;
          
          // Update stars visually
          ratingStars.forEach(s => {
            if (parseInt(s.getAttribute('data-rating')) <= rating) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        });
      });
      
      // Fetch occupied tables initially
      await fetchOrders();
      
      // Set up real-time listeners for orders
      setupOrderListeners();
      
      // Update table number modal placeholder
      tableNumberInput.placeholder = currentLanguage === 'ar' ? 'أدخل رقم الطاولة' : 'Enter table number';
      
      // Set up charts for admin dashboard
      setupCharts();
    });
    
    // Enhanced loading animation with faster load time and silently preloading 3D models
    function simulateLoading() {
      // Make sure overlay is visible first
      loadingOverlay.style.display = 'flex';
      loadingOverlay.style.opacity = '1';
      
      // Initialize progress and track loaded assets
      let progress = 0;
      let modelLoaded = false;
      let initialModelsPreloaded = false;
      
      // Get the loading model status element
      const loadingModelStatus = document.querySelector('.loading-model-status');
      
      // Start with initial loading text
      loadingText.textContent = currentLanguage === 'ar' ? 'تحميل التجربة...' : 'Loading AR Experience...';
      loadingModelStatus.textContent = currentLanguage === 'ar' ? 'جارٍ التحضير للنماذج ثلاثية الأبعاد...' : 'Preparing 3D Models...';
      
      // Start silently preloading 3D models in the background
      setTimeout(() => {
        preloadModels();
        loadingModelStatus.textContent = currentLanguage === 'ar' ? 'جارٍ تحميل النماذج ثلاثية الأبعاد...' : 'Loading 3D Models...';
      }, 500);
      
      // Update loading text based on progress with animated transitions
      function updateLoadingText(progress) {
        let newText = '';
        let modelStatusText = '';
        
        if (progress <= 35) {
          newText = currentLanguage === 'ar' ? 'تجهيز الواجهة المعززة...' : 'Preparing AR Interface...';
          modelStatusText = currentLanguage === 'ar' ? 'جارٍ تحميل النماذج ثلاثية الأبعاد...' : 'Loading 3D Models...';
        } else if (progress <= 65) {
          newText = currentLanguage === 'ar' ? 'تحميل العناصر...' : 'Loading Elements...';
          modelStatusText = currentLanguage === 'ar' ? 'جارٍ معالجة النماذج ثلاثية الأبعاد...' : 'Processing 3D Models...';
        } else if (progress <= 90) {
          newText = currentLanguage === 'ar' ? 'الاتصال بقاعدة البيانات...' : 'Connecting to Database...';
          modelStatusText = currentLanguage === 'ar' ? 'جارٍ تهيئة العرض ثلاثي الأبعاد...' : 'Initializing AR Viewer...';
        } else {
          newText = currentLanguage === 'ar' ? 'جاهز تقريبًا...' : 'Almost Ready...';
          modelStatusText = currentLanguage === 'ar' ? 'اكتمل تحميل النماذج ثلاثية الأبعاد' : '3D Models Ready';
        }
        
        // Only update if text has changed (reduces unnecessary DOM operations)
        if (loadingText.textContent !== newText) {
          // Animate text change
          loadingText.style.opacity = '0';
          setTimeout(() => {
            loadingText.textContent = newText;
            loadingText.style.opacity = '1';
          }, 200);
        }
        
        // Update model status text with animation if it has changed
        if (loadingModelStatus.textContent !== modelStatusText) {
          loadingModelStatus.style.opacity = '0';
          setTimeout(() => {
            loadingModelStatus.textContent = modelStatusText;
            loadingModelStatus.style.opacity = '1';
          }, 300);
        }
      }
      
      // Enhanced model loading detection
      if (modelViewer) {
        modelViewer.addEventListener('load', () => {
          modelLoaded = true;
          console.log("Model loaded successfully");
          // Accelerate loading once model is ready
          progress = Math.max(progress, 80);
        });
        
        modelViewer.addEventListener('error', () => {
          console.log("Model failed to load, continuing anyway");
          modelLoaded = true; // Treat as loaded so we can continue
        });
      } else {
        // If no model viewer, assume models are loaded
        modelLoaded = true;
      }
      
      // Faster, more dynamic progress increments
      const interval = setInterval(() => {
        // Dynamic progress increment - faster overall
        let increment;
        
        if (progress < 35) {
          increment = 6 + Math.random() * 4; // Very fast initial loading
        } else if (progress < 75) {
          increment = 4 + Math.random() * 3; // Fast middle loading
        } else {
          // Final portion still waits for model but moves faster
          if (modelLoaded) {
            increment = 6 + Math.random() * 4; // Very fast final push
          } else {
            increment = 1 + Math.random() * 1; // Slow if waiting for model
          }
        }
        
        progress += increment;
        
        // Cap at 99% until everything is truly ready
        if (progress >= 99) {
          if (modelLoaded) {
            progress = 100;
            clearInterval(interval);
            
            // Complete the loading with animated progress bar
            loadingBar.style.width = '100%';
            loadingBar.style.transition = 'width 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
            
            // Show success message with enhanced animations
            loadingText.style.opacity = '0';
            
            // Add a scaling effect to the cube grid animation
            const cubeGrid = document.querySelector('.loading-cube-grid');
            if (cubeGrid) {
              cubeGrid.style.transform = 'scale(1.2)';
              cubeGrid.style.transition = 'transform 0.5s ease-out';
            }
            
            setTimeout(() => {
              loadingText.textContent = currentLanguage === 'ar' ? 'مرحبًا بك!' : 'Welcome!';
              loadingText.style.opacity = '1';
              loadingText.style.fontSize = '1.3rem';
              loadingText.style.color = '#FFDF70';
              loadingText.style.textShadow = '0 0 20px rgba(255, 223, 112, 0.7)';
              
              // Add a pulsing effect to model status text
              if (loadingModelStatus) {
                loadingModelStatus.textContent = currentLanguage === 'ar' ? 'تم تحميل التجربة بنجاح!' : 'Experience Loaded Successfully!';
                loadingModelStatus.style.color = 'rgba(212, 175, 55, 0.9)';
                loadingModelStatus.style.animation = 'text-fade 1s infinite alternate';
              }
            }, 200);
            
            // Hide loading overlay with a slightly faster transition
            setTimeout(() => {
              loadingOverlay.style.opacity = '0';
              setTimeout(() => {
                loadingOverlay.style.display = 'none';
                
                // Make sure all components are visible
                document.querySelector('.overlay').style.visibility = 'visible';
                if (modelViewer) modelViewer.style.visibility = 'visible';
                
                // Show table number modal immediately after loading
                // But skip it for logged in staff/admin
                console.log("Checking tableNumber value:", tableNumber);
                console.log("User type on completion:", userType);
                
                // Check if we have a staff/admin token and skip the modal if we do
                if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
                  console.log("Staff/Admin already logged in, not showing table modal");
                } else {
                  // Force showing the table modal for guests
                  console.log("Showing table modal for guests");
                  showTableModal();
                }
              }, 200); // Faster transition out
            }, 150); // Show success message briefly
          } else {
            progress = 99; // Stay at 99% until model loads
          }
        }
        
        // Update progress bar and text
        loadingBar.style.width = `${progress}%`;
        updateLoadingText(progress);
        
      }, 100); // Update at faster 100ms intervals
      
      // Shorter failsafe: Ensure loading screen closes even if there are errors
      setTimeout(() => {
        if (loadingOverlay.style.display !== 'none') {
          console.log("Loading timeout reached, forcing completion");
          clearInterval(interval);
          loadingBar.style.width = '100%';
          
          // Animated text update with enhanced animations
          loadingText.style.opacity = '0';
          
          // Add a scaling effect to the cube grid animation
          const cubeGrid = document.querySelector('.loading-cube-grid');
          if (cubeGrid) {
            cubeGrid.style.transform = 'scale(1.2)';
            cubeGrid.style.transition = 'transform 0.5s ease-out';
          }
          
          setTimeout(() => {
            loadingText.textContent = currentLanguage === 'ar' ? 'مرحبًا بك!' : 'Welcome!';
            loadingText.style.opacity = '1';
            loadingText.style.fontSize = '1.3rem';
            loadingText.style.color = '#FFDF70';
            loadingText.style.textShadow = '0 0 20px rgba(255, 223, 112, 0.7)';
            
            // Add a pulsing effect to model status text
            const loadingModelStatus = document.querySelector('.loading-model-status');
            if (loadingModelStatus) {
              loadingModelStatus.textContent = currentLanguage === 'ar' ? 'تم تحميل التجربة بنجاح!' : 'Experience Loaded Successfully!';
              loadingModelStatus.style.color = 'rgba(212, 175, 55, 0.9)';
              loadingModelStatus.style.animation = 'text-fade 1s infinite alternate';
            }
          }, 200);
          
          setTimeout(() => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
              
              // Ensure visibility of components
              document.querySelector('.overlay').style.visibility = 'visible';
              if (modelViewer) modelViewer.style.visibility = 'visible';
              
              // Check if we need to display the table modal in failsafe
              console.log("Failsafe: Checking if we need to show table modal");
              
              // Skip for logged in staff/admin
              if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
                console.log("Failsafe: Staff/Admin already logged in, not showing table modal");
              } else {
                // Force showing the table modal for guests
                console.log("Failsafe: Showing table modal for guests");
                showTableModal();
              }
            }, 200);
          }, 150);
        }
      }, 3500); // Reduced to 3.5 seconds max load time
    }
    
    // Language support
    function toggleLanguage() {
      currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
      localStorage.setItem(LANGUAGE_KEY, currentLanguage);
      updateLanguage();
    }
    
    // Logout staff or admin user with improved login path
    function logoutStaff() {
      // Store the current user type for reference after logout
      const previousUserType = userType;
      
      // Add a smooth animation effect for logout
      const dashboardElement = userType === 'admin' 
        ? document.getElementById('admin-dashboard')
        : document.getElementById('staff-dashboard');
      
      // Add fade-out effect
      dashboardElement.style.transition = 'opacity 0.3s ease';
      dashboardElement.style.opacity = '0';
      
      // Wait for animation before clearing everything
      setTimeout(() => {
        // Clear auth tokens
        localStorage.removeItem(STAFF_TOKEN);
        localStorage.removeItem(ADMIN_TOKEN);
        localStorage.removeItem("staffName");
        localStorage.removeItem("staffRole");
        localStorage.removeItem(TABLE_NUMBER_KEY);
        
        // Set user type back to initial state
        userType = null;
        localStorage.removeItem(USER_TYPE_KEY);
        
        // Hide all user interfaces
        document.getElementById('guest-interface').style.display = 'none';
        document.getElementById('staff-dashboard').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'none';
        
        // Reset table number modal to show the initial selection UI
        const tableNumberModal = document.getElementById('table-number-modal');
        const tableTitle = document.getElementById('table-number-title');
        const tableSubtitle = document.getElementById('table-number-subtitle');
        const optionButtons = document.querySelector('.user-option-buttons');
        const tableNumberInputContainer = document.getElementById('table-number-input-container');
        
        // Get option elements
        const guestOption = document.querySelector('.guest-option');
        const staffOption = document.querySelector('.staff-option');
        
        // Reset option selections and styles
        guestOption.classList.remove('option-selected');
        staffOption.classList.remove('option-selected');
        staffOption.classList.remove('staff-option-active');
        
        // Reset style properties that may have been added
        [guestOption, staffOption].forEach(el => {
          if (el) {
            el.style.opacity = '1';
            el.style.pointerEvents = 'auto';
            el.style.width = '';
            el.style.maxWidth = '';
            el.style.margin = '';
            el.style.display = 'block';
          }
        });
        
        // Reset any embedded login form
        const embeddedLoginForm = document.getElementById('embedded-login-form');
        if (embeddedLoginForm) {
          embeddedLoginForm.remove();
        }
        
        // Reset any back button
        const backButton = document.getElementById('back-to-options-btn');
        if (backButton) {
          backButton.remove();
        }
        
        // If the previous user was staff or admin, show login directly
        if (previousUserType === 'admin' || previousUserType === 'staff') {
          // Set title and subtitle for staff login
          tableTitle.textContent = currentLanguage === 'ar' ? 'تسجيل الدخول' : 'STAFF LOGIN';
          tableSubtitle.textContent = currentLanguage === 'ar' 
            ? 'يرجى تسجيل الدخول للوصول إلى لوحة التحكم'
            : 'Please log in to access your dashboard';
          
          // Hide role options and display staff login immediately
          optionButtons.style.display = 'none';
          tableNumberInputContainer.style.display = 'none';
          
          // Create login form directly in the modal to skip role selection
          createEmbeddedStaffLoginForm(tableNumberModal);
          
          // Add a "Back to Role Selection" button
          const backButton = document.createElement('button');
          backButton.id = 'back-to-options-btn';
          backButton.className = 'back-to-options-btn';
          backButton.innerHTML = `<i class="fas fa-arrow-left"></i> ${currentLanguage === 'ar' ? 'العودة إلى اختيار الدور' : 'Back to Role Selection'}`;
          backButton.onclick = function() {
            resetTableNumberModal();
          };
          tableNumberModal.appendChild(backButton);
        } else {
          // Standard behavior for guest users
          // Set title and subtitle back to initial
          tableTitle.textContent = currentLanguage === 'ar' ? 'اختر دورك' : 'YOUR ROLE';
          tableSubtitle.textContent = currentLanguage === 'ar' 
            ? 'يرجى تحديد دورك للمتابعة' 
            : 'Please select your role to continue';
          
          // Reset UI elements
          optionButtons.style.display = 'flex';
          optionButtons.style.opacity = '1';
          tableNumberInputContainer.style.display = 'none';
        }
        
        // Display the modal with a nice fade-in effect
        tableNumberModal.style.opacity = '0';
        tableNumberModal.style.display = 'flex';
        
        // Clean up any remaining cart items or session data
        clearCart();
        
        // Fade in the modal
        setTimeout(() => {
          tableNumberModal.style.opacity = '1';
        }, 50);
        
        // Show success notification
        showNotification(
          currentLanguage === 'ar' ? 'تم تسجيل الخروج بنجاح' : 'Successfully Logged Out',
          currentLanguage === 'ar' 
            ? (previousUserType === 'admin' || previousUserType === 'staff' ? 'يمكنك الآن تسجيل الدخول مرة أخرى' : 'يمكنك الآن اختيار دور آخر')
            : (previousUserType === 'admin' || previousUserType === 'staff' ? 'You can now log in again' : 'You can now choose another role'),
          'success'
        );
      }, 300);
    }
    
    // Creates an embedded login form directly in the table number modal for staff login
    function createEmbeddedStaffLoginForm(container) {
      // Check if form already exists
      let existingForm = document.getElementById('embedded-login-form');
      if (existingForm) {
        existingForm.remove();
      }
      
      // Create the form container
      const loginFormContainer = document.createElement('div');
      loginFormContainer.id = 'embedded-login-form';
      loginFormContainer.className = 'embedded-login-form';
      
      // Form HTML with improved styling for direct integration
      loginFormContainer.innerHTML = `
        <div class="login-fields">
          <div class="login-field">
            <label for="embedded-username">${currentLanguage === 'ar' ? 'اسم المستخدم' : 'USERNAME'}</label>
            <input type="text" id="embedded-username" placeholder="${currentLanguage === 'ar' ? 'أدخل اسم المستخدم' : 'Enter username'}" autocomplete="username">
          </div>
          <div class="login-field">
            <label for="embedded-password">${currentLanguage === 'ar' ? 'كلمة المرور' : 'PASSWORD'}</label>
            <input type="password" id="embedded-password" placeholder="${currentLanguage === 'ar' ? 'أدخل كلمة المرور' : 'Enter password'}" autocomplete="current-password">
          </div>
        </div>
        <div class="embedded-login-actions">
          <button id="embedded-login-btn" class="embedded-login-btn">${currentLanguage === 'ar' ? 'تسجيل الدخول' : 'LOGIN'}</button>
        </div>
        <div id="embedded-login-error" class="login-error"></div>
      `;
      
      container.appendChild(loginFormContainer);
      
      // Focus on username field
      setTimeout(() => {
        document.getElementById('embedded-username').focus();
      }, 100);
      
      // Add login handler
      document.getElementById('embedded-login-btn').addEventListener('click', async () => {
        const usernameField = document.getElementById('embedded-username');
        const passwordField = document.getElementById('embedded-password');
        const errorField = document.getElementById('embedded-login-error');
        
        // Validate fields
        if (!usernameField.value.trim()) {
          errorField.textContent = currentLanguage === 'ar' ? 'يرجى إدخال اسم المستخدم' : 'Please enter your username';
          usernameField.focus();
          return;
        }
        
        if (!passwordField.value.trim()) {
          errorField.textContent = currentLanguage === 'ar' ? 'يرجى إدخال كلمة المرور' : 'Please enter your password';
          passwordField.focus();
          return;
        }
        
        // Show loading state
        const loginBtn = document.getElementById('embedded-login-btn');
        const originalBtnText = loginBtn.textContent;
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
          // Authenticate staff
          const result = await authenticateStaff(usernameField.value, passwordField.value);
          
          if (result.success) {
            // Hide login form with animation
            container.style.opacity = '0';
            
            // Successful login, show appropriate dashboard
            setTimeout(() => {
              // Hide the table number modal
              document.getElementById('table-number-modal').style.display = 'none';
              
              // Reset opacity for next time
              container.style.opacity = '1';
              
              // Show success notification
              showNotification(
                currentLanguage === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Login Successful',
                currentLanguage === 'ar' 
                  ? `مرحبًا، ${result.name}!` 
                  : `Welcome, ${result.name}!`,
                'success'
              );
              
              // Initialize appropriate dashboard
              if (result.role === 'admin') {
                initAdminDashboard();
              } else {
                initStaffDashboard(result.role);
              }
            }, 500);
          } else {
            // Show error message
            errorField.textContent = currentLanguage === 'ar' 
              ? 'اسم المستخدم أو كلمة المرور غير صحيحة' 
              : 'Invalid username or password';
            
            // Reset button
            loginBtn.disabled = false;
            loginBtn.textContent = originalBtnText;
          }
        } catch (error) {
          console.error("Login error:", error);
          errorField.textContent = currentLanguage === 'ar' 
            ? 'حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.' 
            : 'An error occurred during login. Please try again.';
          
          // Reset button
          loginBtn.disabled = false;
          loginBtn.textContent = originalBtnText;
        }
      });
      
      // Add additional style for embedded login form
      const style = document.createElement('style');
      style.textContent = `
        .embedded-login-form {
          width: 100%;
          max-width: 320px;
          margin: 20px auto;
          padding: 20px;
          background: rgba(0,0,0,0.1);
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .embedded-login-form .login-fields {
          display: flex;
          flex-direction: column;
          gap: 15px;
          margin-bottom: 20px;
        }
        
        .embedded-login-form .login-field {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }
        
        .embedded-login-form label {
          font-size: 14px;
          font-weight: 500;
          color: #fff;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        
        .embedded-login-form input {
          padding: 12px;
          border: none;
          border-radius: 8px;
          background: rgba(255,255,255,0.9);
          color: #333;
          font-size: 16px;
          transition: all 0.3s ease;
        }
        
        .embedded-login-form input:focus {
          background: #ffffff;
          box-shadow: 0 0 0 2px var(--gold);
          outline: none;
        }
        
        .embedded-login-actions {
          display: flex;
          justify-content: center;
        }
        
        .embedded-login-btn {
          width: 100%;
          padding: 12px;
          background: linear-gradient(135deg, var(--gold) 0%, #ffd966 100%);
          color: #333;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          letter-spacing: 1px;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
        }
        
        .embedded-login-btn:hover {
          background: linear-gradient(135deg, #ffd966 0%, var(--gold) 100%);
          transform: translateY(-2px);
        }
        
        .login-error {
          color: #ff5252;
          font-size: 14px;
          margin-top: 10px;
          text-align: center;
          min-height: 18px;
        }
      `;
      document.head.appendChild(style);
    }
    
    // Function to reset the table number modal back to the initial role selection state
    function resetTableNumberModal() {
      // Get required elements
      const tableNumberModal = document.getElementById('table-number-modal');
      const tableTitle = document.getElementById('table-number-title');
      const tableSubtitle = document.getElementById('table-number-subtitle');
      const optionButtons = document.querySelector('.user-option-buttons');
      const tableNumberInputContainer = document.getElementById('table-number-input-container');
      
      // Reset title and subtitle
      tableTitle.textContent = currentLanguage === 'ar' ? 'اختر دورك' : 'YOUR ROLE';
      tableSubtitle.textContent = currentLanguage === 'ar' 
        ? 'يرجى تحديد دورك للمتابعة' 
        : 'Please select your role to continue';
      
      // Get option elements and reset them
      const guestOption = document.querySelector('.guest-option');
      const staffOption = document.querySelector('.staff-option');
      
      // Reset option selections and styles
      guestOption.classList.remove('option-selected');
      staffOption.classList.remove('option-selected');
      staffOption.classList.remove('staff-option-active');
      
      // Reset style properties
      [guestOption, staffOption].forEach(el => {
        if (el) {
          el.style.opacity = '1';
          el.style.pointerEvents = 'auto';
          el.style.width = '';
          el.style.maxWidth = '';
          el.style.margin = '';
          el.style.display = 'block';
        }
      });
      
      // Remove any embedded login form
      const embeddedLoginForm = document.getElementById('embedded-login-form');
      if (embeddedLoginForm) {
        embeddedLoginForm.remove();
      }
      
      // Remove any back button
      const backButton = document.getElementById('back-to-options-btn');
      if (backButton) {
        backButton.remove();
      }
      
      // Show role options, hide other containers
      optionButtons.style.display = 'flex';
      optionButtons.style.opacity = '1';
      tableNumberInputContainer.style.display = 'none';
      
      // Return to initial state with animation
      tableNumberModal.style.opacity = '0.95'; 
      setTimeout(() => {
        tableNumberModal.style.opacity = '1';
      }, 50);
    }
    
    function updateLanguage() {
      const translations = {
        en: {
          title: "The Oak Cafe",
          tagline: "Experience dining in augmented reality",
          yourCart: "YOUR CART",
          checkout: "CHECKOUT",
          cancel: "CANCEL",
          confirm: "CONFIRM",
          yourTableNumber: "YOUR TABLE NUMBER",
          tableNumberSubtitle: "Please select your role or enter your table number to continue",
          tableNumberHelp: "Your table number is displayed on the QR code at your table",
          guestOptionDesc: "Select this if you're dining in and need to place an order from your table",
          staffOptionDesc: "Restaurant staff access - manage orders, tables, and kitchen operations",
          guestOption: "I'm a Guest",
          staffOption: "I'm Staff",
          login: "LOGIN",
          accountLogin: "ACCOUNT LOGIN",
        staffLogin: "STAFF LOGIN",
          username: "USERNAME",
          password: "PASSWORD",
          addToCart: "+ ADD TO CART",
          prev: "← PREV",
          next: "NEXT →",
          viewInAr: "VIEW IN AR",
          addExtras: "ADD EXTRAS",
          specialInstructions: "SPECIAL INSTRUCTIONS",
          discountCode: "DISCOUNT CODE",
          apply: "APPLY",
          estimatedWaitTime: "Estimated Wait Time:",
          yourOrders: "YOUR ORDERS",
          viewMyOrders: "VIEW MY ORDERS",
          staffDashboard: "STAFF DASHBOARD",
          occupiedTables: "OCCUPIED TABLES",
          adminDashboard: "ADMIN DASHBOARD",
          statistics: "STATISTICS",
          orders: "ORDERS",
          ratings: "RATINGS",
          totalOrders: "TOTAL ORDERS",
          avgRating: "AVG RATING",
          lowRatings: "LOW RATINGS",
          activeStaff: "ACTIVE STAFF",
          staffManagement: "STAFF MANAGEMENT",
          staffAccounts: "STAFF ACCOUNTS", 
          addNewStaff: "ADD NEW STAFF",
          staffAssignment: "TABLE ASSIGNMENTS",
          assignStaff: "ASSIGN TABLES",
          editStaff: "EDIT STAFF",
          deleteStaff: "DELETE STAFF",
          confirmDelete: "CONFIRM DELETE",
          cancel: "CANCEL",
          username: "USERNAME",
          password: "PASSWORD",
          fullName: "FULL NAME",
          role: "ROLE",
          tableRange: "TABLE RANGE",
          tableRangeStart: "START TABLE",
          tableRangeEnd: "END TABLE",
          noAssignments: "NO ASSIGNMENTS",
          logout: "LOGOUT",
          rateYourExperience: "RATE YOUR EXPERIENCE",
          feedback: "FEEDBACK (OPTIONAL)",
          submit: "SUBMIT",
          poweredBy: "Powered by",
          followInstagram: "Follow us on Instagram",
          contact: "Contact Us",
          copyright: "© 2025 AR Bites. All rights reserved.",
          loadingText: "Loading Augmented Reality Experience...",
          // Category buttons
          allItems: "All Items",
          hotFood: "Hot Food",
          coldFood: "Cold Food",
          drinks: "Drinks",
          desserts: "Desserts"
        },
        ar: {
          title: "ذا أوك كافيه",
          tagline: "استمتع بتجربة تناول الطعام بالواقع المعزز",
          yourCart: "سلة التسوق",
          checkout: "إتمام الطلب",
          cancel: "إلغاء",
          confirm: "تأكيد",
          yourTableNumber: "رقم الطاولة",
          tableNumberSubtitle: "يرجى تحديد دورك أو إدخال رقم الطاولة للمتابعة",
          tableNumberHelp: "رقم الطاولة الخاص بك مُظهر على رمز QR الموجود على طاولتك",
          guestOptionDesc: "حدد هذا إذا كنت تتناول الطعام وتحتاج إلى طلب من طاولتك",
          staffOptionDesc: "وصول طاقم المطعم - إدارة الطلبات والطاولات وعمليات المطبخ",
          guestOption: "أنا ضيف",
          staffOption: "أنا موظف",
          login: "تسجيل الدخول",
          accountLogin: "تسجيل الدخول للحساب",
          staffLogin: "تسجيل دخول الموظفين",
          username: "اسم المستخدم",
          password: "كلمة المرور",
          addToCart: "+ إضافة إلى السلة",
          prev: "← السابق",
          next: "التالي →",
          viewInAr: "عرض بالواقع المعزز",
          addExtras: "إضافات",
          specialInstructions: "تعليمات خاصة",
          discountCode: "رمز الخصم",
          apply: "تطبيق",
          estimatedWaitTime: "وقت الانتظار التقريبي:",
          yourOrders: "طلباتك",
          viewMyOrders: "عرض طلباتي",
          staffDashboard: "لوحة تحكم الموظفين",
          occupiedTables: "الطاولات المشغولة",
          adminDashboard: "لوحة المدير",
          statistics: "إحصائيات",
          orders: "الطلبات",
          ratings: "التقييمات",
          totalOrders: "إجمالي الطلبات",
          avgRating: "متوسط التقييم",
          lowRatings: "التقييمات المنخفضة",
          activeStaff: "الموظفين النشطين",
          staffManagement: "إدارة الموظفين",
          staffAccounts: "حسابات الموظفين", 
          addNewStaff: "إضافة موظف جديد",
          staffAssignment: "تعيين الطاولات",
          assignStaff: "تعيين الطاولات",
          editStaff: "تعديل الموظف",
          deleteStaff: "حذف الموظف",
          confirmDelete: "تأكيد الحذف",
          cancel: "إلغاء",
          username: "اسم المستخدم",
          password: "كلمة المرور",
          fullName: "الاسم الكامل",
          role: "المنصب",
          tableRange: "نطاق الطاولات",
          tableRangeStart: "بداية النطاق",
          tableRangeEnd: "نهاية النطاق",
          noAssignments: "لا يوجد تعيينات",
          logout: "تسجيل الخروج",
          rateYourExperience: "قيم تجربتك",
          feedback: "تعليقات (اختياري)",
          submit: "إرسال",
          poweredBy: "مقدم بواسطة",
          followInstagram: "تابعنا على إنستغرام",
          contact: "اتصل بنا",
          copyright: "© 2025 إيه آر بايتس. جميع الحقوق محفوظة.",
          loadingText: "جاري تحميل تجربة الواقع المعزز...",
          // Category buttons
          allItems: "جميع العناصر",
          hotFood: "طعام ساخن",
          coldFood: "طعام بارد",
          drinks: "مشروبات",
          desserts: "حلويات",
          // Advanced Analytics translations
          advancedAnalytics: "تحليلات متقدمة",
          analyticsTitle: "لوحة التحليلات المتقدمة",
          managementTab: "الإدارة",
          dashboardTab: "لوحة المعلومات",
          timeRange: "النطاق الزمني:",
          todayOption: "اليوم",
          weekOption: "هذا الأسبوع",
          monthOption: "هذا الشهر",
          yearOption: "هذا العام",
          salesPerformance: "أداء المبيعات",
          topMenuItems: "أفضل عناصر القائمة",
          customerSatisfaction: "رضا العملاء",
          tableUtilization: "استخدام الطاولة",
          staffPerformance: "أداء الموظفين",
          orderSources: "مصادر الطلبات",
          exportData: "تصدير البيانات",
          discountManagement: "إدارة الخصومات",
          discountCode: "رمز الخصم",
          discountPercentage: "نسبة الخصم",
          createDiscount: "إنشاء خصم",
          // Category buttons
          allItems: "جميع العناصر",
          pizza: "بيتزا",
          pasta: "معكرونة",
          salads: "سلطات",
          drinks: "مشروبات",
          desserts: "حلويات"
        }
      };
      
      const t = translations[currentLanguage];
      
      // Update UI text
      title.textContent = t.title;
      tagline.textContent = t.tagline;
      cartTitle.textContent = t.yourCart;
      checkoutText.textContent = t.checkout;
      prevBtn.textContent = t.prev;
      nextBtn.textContent = t.next;
      addCartBtn.textContent = t.addToCart;
      arButton.textContent = t.viewInAr;
      extrasLabel.textContent = t.addExtras;
      notesLabel.textContent = t.specialInstructions;
      discountLabel.textContent = t.discountCode;
      applyDiscountBtn.textContent = t.apply;
      estimatedTimeLabel.textContent = t.estimatedWaitTime;
      yourOrdersTitle.textContent = t.yourOrders;
      viewOrdersBtn.textContent = t.viewMyOrders;
      tableNumberTitle.textContent = t.yourTableNumber;
      tableNumberSubtitle.textContent = t.tableNumberSubtitle;
      guestOptionText.textContent = t.guestOption;
      staffOptionText.textContent = t.staffOption;
      loginTitle.textContent = t.accountLogin;
      usernameLabel.textContent = t.username;
      passwordLabel.textContent = t.password;
      loginBtn.textContent = t.login;
      cancelLoginBtn.textContent = t.cancel;
      confirmTableBtn.textContent = t.confirm;
      cancelTableBtn.textContent = t.cancel;
      staffDashboardTitle.textContent = t.staffDashboard;
      loadingText.textContent = t.loadingText;
      poweredByText.textContent = t.poweredBy;
      instagramText.textContent = t.followInstagram;
      copyrightText.textContent = t.copyright;
      
      // Update table number help text
      const tableNumberHelpText = document.getElementById('table-number-help-text');
      if (tableNumberHelpText) {
        tableNumberHelpText.textContent = t.tableNumberHelp;
      }
      
      // Update role option descriptions
      const guestOptionDesc = document.getElementById('guest-option-desc');
      const staffOptionDesc = document.getElementById('staff-option-desc');
      if (guestOptionDesc) {
        guestOptionDesc.textContent = t.guestOptionDesc;
      }
      if (staffOptionDesc) {
        staffOptionDesc.textContent = t.staffOptionDesc;
      }
      
      currentLang.textContent = currentLanguage.toUpperCase();
      ratingTitle.textContent = t.rateYourExperience;
      ratingFeedbackLabel.textContent = t.feedback;
      submitRatingBtn.textContent = t.submit;
      cancelRatingBtn.textContent = t.cancel;
      staffEstimatedTimeLabel.textContent = t.estimatedWaitTime;
      
      if (occupiedTablesTitle) {
        occupiedTablesTitle.textContent = t.occupiedTables;
      }
      
      // Update admin view
      // Update logout buttons
      const staffLogoutBtnText = document.getElementById('staff-logout-btn-text');
      const adminLogoutBtnText = document.getElementById('admin-logout-btn-text');
      
      if (staffLogoutBtnText) {
        staffLogoutBtnText.textContent = t.logout;
      }
      
      if (adminLogoutBtnText) {
        adminLogoutBtnText.textContent = t.logout;
      }
      
      if (adminDashboard) {
        // Make sure all text is in English in English mode
        if (currentLanguage === 'en') {
          document.querySelectorAll('#admin-dashboard h3, #admin-dashboard h4, #admin-dashboard button, #admin-dashboard label').forEach(el => {
            el.style.fontFamily = '"Poppins", sans-serif';
          });
        }
        
        adminDashboardTitle.textContent = t.adminDashboard;
        statisticsTitle.textContent = t.statistics;
        ordersTitle.textContent = t.orders;
        ratingsTitle.textContent = t.ratings;
        totalOrdersTitle.textContent = t.totalOrders;
        avgRatingTitle.textContent = t.avgRating;
        lowRatingsTitle.textContent = t.lowRatings;
        activeStaffTitle.textContent = t.activeStaff;
        
        // Update staff management section titles
        const staffManagementTitle = document.getElementById('staff-management-title');
        const staffAccountsTitle = document.getElementById('staff-accounts-title');
        const addStaffTitle = document.getElementById('add-staff-title');
        const staffAssignmentTitle = document.getElementById('staff-assignment-title');
        const newAssignmentTitle = document.getElementById('new-assignment-title');
        const addStaffBtn = document.getElementById('add-staff-btn');
        const staffAssignmentLabel = document.getElementById('staff-assignment-label');
        const assignStaffBtn = document.getElementById('assign-staff-btn');
        
        if (staffManagementTitle) staffManagementTitle.textContent = t.staffManagement;
        if (staffAccountsTitle) staffAccountsTitle.textContent = t.staffAccounts;
        if (addStaffTitle) addStaffTitle.textContent = t.addNewStaff;
        if (staffAssignmentTitle) staffAssignmentTitle.textContent = t.staffAssignment;
        if (newAssignmentTitle) newAssignmentTitle.textContent = t.addNewStaff;
        if (addStaffBtn) addStaffBtn.textContent = t.addNewStaff;
        if (staffAssignmentLabel) staffAssignmentLabel.textContent = t.assignStaff;
        if (assignStaffBtn) assignStaffBtn.textContent = t.assignStaff;
        
        // Update Advanced Analytics tab
        const analyticsTab = document.getElementById('analytics-tab');
        if (analyticsTab) {
          analyticsTab.textContent = t.advancedAnalytics;
        }
        
        // Update Management tab
        const managementTab = document.getElementById('management-tab');
        if (managementTab) {
          managementTab.textContent = t.managementTab;
        }
        
        // Update Dashboard tab
        const dashboardTab = document.getElementById('dashboard-tab');
        if (dashboardTab) {
          dashboardTab.textContent = t.dashboardTab;
        }
        
        // Update analytics dashboard title
        const analyticsTitle = document.getElementById('analytics-title');
        if (analyticsTitle) {
          analyticsTitle.textContent = t.analyticsTitle;
        }
        
        // Update time range label
        const timeRangeLabel = document.querySelector('.time-filter label');
        if (timeRangeLabel) {
          timeRangeLabel.textContent = t.timeRange;
        }
        
        // Update time range options
        const timeRangeSelect = document.getElementById('time-range');
        if (timeRangeSelect) {
          const dayOption = timeRangeSelect.querySelector('option[value="day"]');
          const weekOption = timeRangeSelect.querySelector('option[value="week"]');
          const monthOption = timeRangeSelect.querySelector('option[value="month"]');
          const yearOption = timeRangeSelect.querySelector('option[value="year"]');
          
          if (dayOption) dayOption.textContent = t.todayOption;
          if (weekOption) weekOption.textContent = t.weekOption;
          if (monthOption) monthOption.textContent = t.monthOption;
          if (yearOption) yearOption.textContent = t.yearOption;
        }
        
        // Update analytics card headers
        document.querySelectorAll('.analytics-card-header h4').forEach(header => {
          if (header.textContent === 'Sales Performance') header.textContent = t.salesPerformance;
          if (header.textContent === 'Top Menu Items') header.textContent = t.topMenuItems;
          if (header.textContent === 'Customer Satisfaction') header.textContent = t.customerSatisfaction;
          if (header.textContent === 'Table Utilization') header.textContent = t.tableUtilization;
          if (header.textContent === 'Staff Performance') header.textContent = t.staffPerformance;
          if (header.textContent === 'Order Sources') header.textContent = t.orderSources;
        });
        
        // Update discount management section
        const discountManagementTitle = document.getElementById('discount-management-title');
        if (discountManagementTitle) {
          discountManagementTitle.textContent = t.discountManagement;
        }
        
        // Update discount code input label
        const discountCodeInputLabel = document.querySelector('label[for="discount-code-input"]');
        if (discountCodeInputLabel) {
          discountCodeInputLabel.textContent = t.discountCode;
        }
        
        // Update discount percentage label
        const discountPercentLabel = document.querySelector('label[for="discount-percent"]');
        if (discountPercentLabel) {
          discountPercentLabel.textContent = t.discountPercentage;
        }
        
        // Update create discount button
        const applyDiscountBtn = document.getElementById('apply-discount-btn');
        if (applyDiscountBtn) {
          applyDiscountBtn.textContent = t.createDiscount;
        }
      }
      
      // Apply RTL for Arabic
      document.body.classList.toggle('rtl', currentLanguage === 'ar');
      
      // Update main category buttons
      const allMainCategoryBtn = document.getElementById('all-main-category-btn');
      const foodMainCategoryBtn = document.getElementById('food-main-category-btn');
      const drinksMainCategoryBtn = document.getElementById('drinks-main-category-btn');
      const dessertsMainCategoryBtn = document.getElementById('desserts-main-category-btn');
      
      if (allMainCategoryBtn) {
        const allBtn = allMainCategoryBtn.querySelector('span');
        if (allBtn) allBtn.textContent = currentLanguage === 'ar' ? 'الكل' : 'All';
      }
      if (foodMainCategoryBtn) {
        const foodBtn = foodMainCategoryBtn.querySelector('span');
        if (foodBtn) foodBtn.textContent = currentLanguage === 'ar' ? 'الطعام' : 'Food';
      }
      if (drinksMainCategoryBtn) {
        const drinksBtn = drinksMainCategoryBtn.querySelector('span');
        if (drinksBtn) drinksBtn.textContent = currentLanguage === 'ar' ? 'المشروبات' : 'Drinks';
      }
      if (dessertsMainCategoryBtn) {
        const dessertsBtn = dessertsMainCategoryBtn.querySelector('span');
        if (dessertsBtn) dessertsBtn.textContent = currentLanguage === 'ar' ? 'الحلويات' : 'Desserts';
      }
      
      // Update subcategory labels
      const foodSubcategoryLabel = document.querySelector('#food-subcategories .subcategory-label');
      const drinksSubcategoryLabel = document.querySelector('#drinks-subcategories .subcategory-label');
      const dessertsSubcategoryLabel = document.querySelector('#desserts-subcategories .subcategory-label');
      
      if (foodSubcategoryLabel) foodSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'أنواع الطعام' : 'Food Types';
      if (drinksSubcategoryLabel) drinksSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'أنواع المشروبات' : 'Beverage Types';
      if (dessertsSubcategoryLabel) dessertsSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'أنواع الحلويات' : 'Dessert Types';

      // Update food subcategory buttons
      const allFoodBtn = document.getElementById('all-food-btn');
      const pizzaCategoryBtn = document.getElementById('pizza-category-btn');
      const pastaCategoryBtn = document.getElementById('pasta-category-btn');
      const saladsCategoryBtn = document.getElementById('salads-category-btn');
      const burgersCategoryBtn = document.getElementById('burgers-category-btn');
      
      if (allFoodBtn) allFoodBtn.textContent = currentLanguage === 'ar' ? 'كل الطعام' : 'All Food';
      if (pizzaCategoryBtn) pizzaCategoryBtn.textContent = currentLanguage === 'ar' ? 'بيتزا' : 'Pizza';
      if (pastaCategoryBtn) pastaCategoryBtn.textContent = currentLanguage === 'ar' ? 'باستا' : 'Pasta';
      if (saladsCategoryBtn) saladsCategoryBtn.textContent = currentLanguage === 'ar' ? 'سلطات' : 'Salads';
      if (burgersCategoryBtn) burgersCategoryBtn.textContent = currentLanguage === 'ar' ? 'برجر' : 'Burgers';
      
      // Update drinks subcategory buttons
      const allDrinksBtn = document.getElementById('all-drinks-btn');
      const hotDrinksCategoryBtn = document.getElementById('hot-drinks-category-btn');
      const coldDrinksCategoryBtn = document.getElementById('cold-drinks-category-btn');
      const smoothiesCategoryBtn = document.getElementById('smoothies-category-btn');
      
      if (allDrinksBtn) allDrinksBtn.textContent = currentLanguage === 'ar' ? 'كل المشروبات' : 'All Drinks';
      if (hotDrinksCategoryBtn) hotDrinksCategoryBtn.textContent = currentLanguage === 'ar' ? 'مشروبات ساخنة' : 'Hot Drinks';
      if (coldDrinksCategoryBtn) coldDrinksCategoryBtn.textContent = currentLanguage === 'ar' ? 'مشروبات باردة' : 'Cold Drinks';
      if (smoothiesCategoryBtn) smoothiesCategoryBtn.textContent = currentLanguage === 'ar' ? 'عصائر' : 'Smoothies';
      
      // Update desserts subcategory buttons
      const allDessertsBtn = document.getElementById('all-desserts-btn');
      const cakesCategoryBtn = document.getElementById('cakes-category-btn');
      const iceCreamCategoryBtn = document.getElementById('ice-cream-category-btn');
      
      if (allDessertsBtn) allDessertsBtn.textContent = currentLanguage === 'ar' ? 'كل الحلويات' : 'All Desserts';
      if (cakesCategoryBtn) cakesCategoryBtn.textContent = currentLanguage === 'ar' ? 'كيك' : 'Cakes';
      if (iceCreamCategoryBtn) iceCreamCategoryBtn.textContent = currentLanguage === 'ar' ? 'آيس كريم' : 'Ice Cream';
      
      // Also update the current food item in case it has translations
      updateFoodDisplay();
      
      // Update table input placeholder
      tableNumberInput.placeholder = currentLanguage === 'ar' ? 'أدخل رقم الطاولة' : 'Enter table number';
      
      // Update special instructions placeholder
      itemNotes.placeholder = currentLanguage === 'ar' ? 'أي طلبات خاصة...' : 'Any special requests...';
    }
    
    // Food catalog display
    // Model cache for preloaded models
    const modelCache = {};
    
    // Preload all 3D models
    function preloadModels() {
      // List of available models (from the models folder)
      const availableModels = [
        'Fettuccine Alfredo.glb',
        'Margherita Pizza.glb',
        'Pepperoni Pizza.glb',
        'Pesto Pasta.glb',
        'Rose Pasta.glb',
        'Sea Food Pasta.glb'
      ];
      
      // Map menu items to their models (if available)
      foodItems.forEach(item => {
        // Check if there's an exact match with an available model name
        const itemName = item.name.replace(/\s+/g, ' ').trim();
        const exactModelMatch = availableModels.find(model => 
          model === `${itemName}.glb` || model.toLowerCase() === `${itemName.toLowerCase()}.glb`
        );
        
        if (exactModelMatch) {
          // Set the model path to the exact match
          item.modelSrc = `/models/${exactModelMatch}`;
          console.log(`Mapped ${item.name} to exact model: ${item.modelSrc}`);
        } else {
          // No exact match found, clear model src
          item.modelSrc = null;
          console.log(`No model available for: ${item.name}`);
        }
      });
      
      // Create a single hidden container for preloading
      const preloadContainer = document.createElement('div');
      preloadContainer.style.position = 'absolute';
      preloadContainer.style.left = '-9999px';
      preloadContainer.style.width = '1px';
      preloadContainer.style.height = '1px';
      preloadContainer.style.overflow = 'hidden';
      document.body.appendChild(preloadContainer);
      
      // Preload only available models
      availableModels.forEach(modelName => {
        const modelPath = `/models/${modelName}`;
        console.log(`Preloading model: ${modelPath}`);
        
        const preloader = document.createElement('model-viewer');
        preloader.setAttribute('src', modelPath);
        preloader.setAttribute('preload', '');
        
        // Simpler event handling
        preloader.addEventListener('load', () => {
          console.log(`Model ${modelPath} preloaded successfully`);
          // Store in simple lookup for quick reference
          modelCache[modelPath] = true;
        });
        
        // Basic error handling
        preloader.addEventListener('error', (e) => {
          console.error(`Error preloading model ${modelPath}:`, e);
        });
        
        preloadContainer.appendChild(preloader);
      });
    }
    
    // Main category selection
    function changeMainCategory(mainCategory) {
      // Update active button in main categories
      document.querySelectorAll('.main-category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.main-category-btn[data-maincategory="${mainCategory}"]`).classList.add('active');
      
      // Hide all subcategory groups first
      document.querySelectorAll('.subcategory-group').forEach(group => {
        group.style.display = 'none';
      });
      
      // Hide the sub-categories container completely when "All" is selected
      const subCategoriesContainer = document.getElementById('sub-categories');
      if (mainCategory === 'all') {
        // If "All" is selected, hide the subcategories section
        subCategoriesContainer.style.display = 'none';
        currentCategory = 'all';
        currentMainCategory = 'all';
        filterFoodItems();
        updateFoodDisplay();
      } else {
        // Show the subcategories container
        subCategoriesContainer.style.display = 'block';
        
        // Show corresponding subcategory group
        const subcategoryGroup = document.getElementById(`${mainCategory}-subcategories`);
        if (subcategoryGroup) {
          subcategoryGroup.style.display = 'flex';
          
          // Set default subcategory as "All [MainCategory]"
          currentMainCategory = mainCategory;
          currentCategory = `all-${mainCategory}`;
          
          // Update active button in subcategory
          document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          document.querySelector(`.category-btn[data-category="all-${mainCategory}"]`).classList.add('active');
          
          // Filter items and update display
          filterFoodItems();
          updateFoodDisplay();
        }
      }
    }
    
    // Subcategory selection
    function changeCategory(category) {
      // Update active button in subcategories
      const parentGroup = document.querySelector(`.category-btn[data-category="${category}"]`).closest('.subcategory-group');
      
      if (parentGroup) {
        parentGroup.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      } else {
        // Fallback for when category structure is simple
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
      
      document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
      
      // Set current category and reset index
      currentCategory = category;
      currentFoodIndex = 0;
      
      // Filter and update display
      filterFoodItems();
      updateFoodDisplay();
    }
    
    // Filter food items based on categories
    function filterFoodItems() {
      if (currentCategory === 'all') {
        // Show all items
        filteredFoodItems = [...foodItems];
      } else if (currentCategory.startsWith('all-')) {
        // Show all items from a main category (e.g., "all-food")
        const mainCat = currentCategory.replace('all-', '');
        
        if (mainCat === 'food') {
          // For food category, include pizza, pasta, salads, burgers
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'pizza' || 
            item.category === 'pasta' || 
            item.category === 'salads' || 
            item.category === 'burgers');
        } else if (mainCat === 'drinks') {
          // For drinks category, include hot-drinks, cold-drinks, smoothies
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'hot-drinks' || 
            item.category === 'cold-drinks' || 
            item.category === 'smoothies' ||
            item.category === 'drinks');
        } else if (mainCat === 'desserts') {
          // For dessert category, include cakes, ice-cream
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'cakes' || 
            item.category === 'ice-cream' ||
            item.category === 'desserts');
        } else {
          // Fallback to simple filtering by the main category
          filteredFoodItems = foodItems.filter(item => item.category === mainCat);
        }
      } else {
        // Filter by specific subcategory
        filteredFoodItems = foodItems.filter(item => item.category === currentCategory);
      }
      
      // Reset index if it's out of bounds for the filtered items
      if (currentFoodIndex >= filteredFoodItems.length) {
        currentFoodIndex = 0;
      }
      
      return filteredFoodItems;
    }
    
    function updateFoodDisplay() {
      // Make sure we have filtered items
      if (filteredFoodItems.length === 0) {
        filterFoodItems();
      }
      
      const item = filteredFoodItems[currentFoodIndex];
      const modelLoadingIndicator = document.getElementById('model-loading-indicator');
      
      // Show loading indicator
      modelLoadingIndicator.style.display = 'flex';
      
      // Get model viewer element 
      const modelViewer = document.getElementById('food-model-viewer');
      console.log("Updating model viewer with new item");
      
      // Update text content first (for perceived speed)
      // Use Arabic name and description if available and language is Arabic
      foodName.textContent = (currentLanguage === 'ar' && item.nameAr) ? item.nameAr : item.name;
      foodDescription.textContent = (currentLanguage === 'ar' && item.descriptionAr) ? item.descriptionAr : item.description;
      
      // Format price according to language
      if (currentLanguage === 'ar') {
        foodPrice.textContent = `السعر: ${item.price.toFixed(2)} $`;
      } else {
        foodPrice.textContent = `Price: $${item.price.toFixed(2)}`;
      }
      
      // Ensure model container is visible
      const modelContainer = document.querySelector('.model-container');
      if (modelContainer) {
        modelContainer.style.display = 'block';
      }
      
      // Enable auto-rotate and camera controls for interactive experience
      modelViewer.setAttribute('auto-rotate', '');
      modelViewer.setAttribute('camera-controls', '');
      modelViewer.setAttribute('ar', '');
      modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
      modelViewer.setAttribute('camera-orbit', '-20deg 75deg 2m');
      modelViewer.setAttribute('exposure', '1');
      
      // Check if this item has a model assigned during preloading
      if (item.modelSrc) {
        // Show the model container
        modelContainer.style.display = 'block';
        modelLoadingIndicator.style.display = 'flex';
        
        console.log(`Loading model for ${item.name}: ${item.modelSrc}`);
        
        // Set the model source
        modelViewer.src = item.modelSrc;
        
        // Add basic event handlers
        modelViewer.addEventListener('load', () => {
          console.log("Model loaded successfully");
          modelLoadingIndicator.style.display = 'none';
        });
        
        modelViewer.addEventListener('error', (e) => {
          console.error("Error loading model:", item.modelSrc, e);
          modelLoadingIndicator.style.display = 'none';
          // Hide the model container if there's an error
          modelContainer.style.display = 'none';
        });
        
        // Failsafe: Hide loading indicator after 3 seconds
        setTimeout(() => {
          modelLoadingIndicator.style.display = 'none';
        }, 3000);
      } else {
        // No matching model found, hide the model container
        console.log(`No model available for ${item.name}, hiding 3D viewer`);
        modelContainer.style.display = 'none';
        modelLoadingIndicator.style.display = 'none';
      }
      
      // Clear existing extras
      extrasSelect.innerHTML = '';
      
      // Add default "No extras" option
      const noExtrasOption = document.createElement('option');
      noExtrasOption.value = '';
      noExtrasOption.textContent = currentLanguage === 'ar' ? 'بدون إضافات' : 'No extras';
      extrasSelect.appendChild(noExtrasOption);
      
      // Add dynamic extras based on food category
      if (item.category === 'pizza') {
        const extras = [
          { value: 'extra_cheese', text: currentLanguage === 'ar' ? 'جبنة إضافية (+$2.00)' : 'Extra Cheese (+$2.00)' },
          { value: 'extra_toppings', text: currentLanguage === 'ar' ? 'إضافات إضافية (+$3.00)' : 'Extra Toppings (+$3.00)' },
          { value: 'garlic_bread', text: currentLanguage === 'ar' ? 'خبز بالثوم (+$4.00)' : 'Garlic Bread Side (+$4.00)' }
        ];
        
        extras.forEach(extra => {
          const option = document.createElement('option');
          option.value = extra.value;
          option.textContent = extra.text;
          extrasSelect.appendChild(option);
        });
      } else if (item.category === 'pasta') {
        const extras = [
          { value: 'extra_sauce', text: currentLanguage === 'ar' ? 'صلصة إضافية (+$1.50)' : 'Extra Sauce (+$1.50)' },
          { value: 'garlic_bread', text: currentLanguage === 'ar' ? 'خبز بالثوم (+$4.00)' : 'Garlic Bread Side (+$4.00)' },
          { value: 'parmesan', text: currentLanguage === 'ar' ? 'جبنة بارميزان إضافية (+$2.00)' : 'Extra Parmesan (+$2.00)' }
        ];
        
        extras.forEach(extra => {
          const option = document.createElement('option');
          option.value = extra.value;
          option.textContent = extra.text;
          extrasSelect.appendChild(option);
        });
      }
      
      // Clear any previous notes
      itemNotes.value = '';
    }
    
    function showPreviousItem() {
      currentFoodIndex = (currentFoodIndex - 1 + filteredFoodItems.length) % filteredFoodItems.length;
      updateFoodDisplay();
    }
    
    function showNextItem() {
      currentFoodIndex = (currentFoodIndex + 1) % filteredFoodItems.length;
      updateFoodDisplay();
    }
    
    // Cart System
    // Global variables for customization
    let currentCustomizeItem = null;
    let selectedExtras = [];
    let itemQuantity = 1;
    
    function addToCart() {
      // If no table number set, show modal with a clear message
      if (userType === "guest" && !tableNumber) {
        // Show notification to explain the user needs to enter a table number
        showNotification(
          currentLanguage === 'ar' 
            ? 'يرجى إدخال رقم الطاولة لإضافة عناصر إلى سلة التسوق' 
            : 'Please enter your table number to add items to cart', 
          'warning'
        );
        
        setTimeout(() => {
          // Show table modal with a flag to show extended message
          showTableModal(true);
        }, 500);
        return;
      }
      
      // Get the current item and show customization modal
      const item = filteredFoodItems[currentFoodIndex];
      showCustomizeModal(item);
    }
    
    // Show the customization modal for the current item
    function showCustomizeModal(item) {
      // Reset customization state
      currentCustomizeItem = item;
      selectedExtras = [];
      itemQuantity = 1;
      
      // Update modal content
      document.getElementById('customize-item-name').textContent = item.name;
      
      // Set item image - for demo we'll use a placeholder or the model viewer image
      const itemImage = document.getElementById('customize-item-image');
      
      // Try to get a screenshot from the model viewer if available
      try {
        if (modelViewer && modelViewer.toDataURL) {
          itemImage.src = modelViewer.toDataURL('image/png');
        } else {
          // Use a category-based placeholder
          if (item.category === 'hot_food') {
            itemImage.src = 'https://i.ibb.co/k6v5sfh/hot-food-placeholder.jpg';
          } else if (item.category === 'cold_food') {
            itemImage.src = 'https://i.ibb.co/0j2C7Vq/cold-food-placeholder.jpg';
          } else if (item.category === 'drinks') {
            itemImage.src = 'https://i.ibb.co/YZNt0Y4/drinks-placeholder.jpg';
          } else if (item.category === 'desserts') {
            itemImage.src = 'https://i.ibb.co/RYst42D/desserts-placeholder.jpg';
          } else {
            itemImage.src = 'https://i.ibb.co/YhBWmd1/food-placeholder.jpg';
          }
        }
      } catch (e) {
        console.error("Error setting image:", e);
        itemImage.src = 'https://i.ibb.co/YhBWmd1/food-placeholder.jpg';
      }
      
      // Set price
      document.getElementById('customize-base-price').textContent = `$${item.price.toFixed(2)}`;
      document.getElementById('customize-total-price').textContent = `$${item.price.toFixed(2)}`;
      
      // Reset quantity
      document.getElementById('quantity-value').textContent = '1';
      
      // Clear special instructions
      document.getElementById('special-instructions').value = '';
      
      // Generate extras options based on item category
      const extrasGrid = document.getElementById('extras-options');
      extrasGrid.innerHTML = '';
      
      // Define extras based on item category
      let availableExtras = [];
      
      if (item.category === 'hot_food' && item.name.toLowerCase().includes('pizza')) {
        availableExtras = [
          { id: 'extra_cheese', name: currentLanguage === 'ar' ? 'جبنة إضافية' : 'Extra Cheese', price: 2.00 },
          { id: 'pepperoni', name: currentLanguage === 'ar' ? 'بيبروني' : 'Pepperoni', price: 2.50 },
          { id: 'mushrooms', name: currentLanguage === 'ar' ? 'فطر' : 'Mushrooms', price: 1.50 },
          { id: 'olives', name: currentLanguage === 'ar' ? 'زيتون' : 'Olives', price: 1.00 },
          { id: 'garlic_bread', name: currentLanguage === 'ar' ? 'خبز بالثوم' : 'Garlic Bread Side', price: 4.00 }
        ];
      } else if (item.category === 'hot_food' && item.name.toLowerCase().includes('pasta')) {
        availableExtras = [
          { id: 'parmesan', name: currentLanguage === 'ar' ? 'جبنة بارميزان' : 'Parmesan Cheese', price: 2.00 },
          { id: 'garlic_bread', name: currentLanguage === 'ar' ? 'خبز بالثوم' : 'Garlic Bread Side', price: 4.00 },
          { id: 'extra_sauce', name: currentLanguage === 'ar' ? 'صلصة إضافية' : 'Extra Sauce', price: 1.50 },
          { id: 'chicken', name: currentLanguage === 'ar' ? 'دجاج إضافي' : 'Extra Chicken', price: 3.00 }
        ];
      } else if (item.category === 'drinks') {
        availableExtras = [
          { id: 'ice', name: currentLanguage === 'ar' ? 'ثلج إضافي' : 'Extra Ice', price: 0.00 },
          { id: 'lemon', name: currentLanguage === 'ar' ? 'ليمون' : 'Lemon Slice', price: 0.50 },
          { id: 'mint', name: currentLanguage === 'ar' ? 'نعناع' : 'Fresh Mint', price: 1.00 },
          { id: 'whipped_cream', name: currentLanguage === 'ar' ? 'كريمة مخفوقة' : 'Whipped Cream', price: 1.00 }
        ];
      } else if (item.category === 'desserts') {
        availableExtras = [
          { id: 'ice_cream', name: currentLanguage === 'ar' ? 'آيس كريم' : 'Ice Cream Scoop', price: 2.00 },
          { id: 'chocolate_sauce', name: currentLanguage === 'ar' ? 'صوص شوكولاتة' : 'Chocolate Sauce', price: 1.00 },
          { id: 'whipped_cream', name: currentLanguage === 'ar' ? 'كريمة مخفوقة' : 'Whipped Cream', price: 1.00 },
          { id: 'berries', name: currentLanguage === 'ar' ? 'توت طازج' : 'Fresh Berries', price: 2.50 }
        ];
      } else {
        availableExtras = [
          { id: 'extra_sauce', name: currentLanguage === 'ar' ? 'صلصة إضافية' : 'Extra Sauce', price: 1.50 },
          { id: 'side_salad', name: currentLanguage === 'ar' ? 'سلطة جانبية' : 'Side Salad', price: 3.00 }
        ];
      }
      
      // Create extra options in the grid
      availableExtras.forEach(extra => {
        const extraElement = document.createElement('div');
        extraElement.className = 'extra-option';
        extraElement.dataset.id = extra.id;
        extraElement.dataset.price = extra.price;
        
        extraElement.innerHTML = `
          <div class="extra-checkbox"></div>
          <div class="extra-details">
            <div class="extra-name">${extra.name}</div>
            <div class="extra-price">${extra.price > 0 ? '+$' + extra.price.toFixed(2) : currentLanguage === 'ar' ? 'مجاني' : 'Free'}</div>
          </div>
        `;
        
        extraElement.addEventListener('click', () => toggleExtra(extraElement, extra));
        extrasGrid.appendChild(extraElement);
      });
      
      // Localize UI elements based on current language
      updateCustomizeModalLanguage();
      
      // Show the modal
      const customizeModal = document.getElementById('customize-modal');
      customizeModal.style.display = 'block';
      
      // Focus on instructions field for better UX
      setTimeout(() => {
        document.getElementById('special-instructions').focus();
      }, 500);
    }
    
    // Toggle extra selection and update total price
    function toggleExtra(element, extra) {
      element.classList.toggle('selected');
      
      if (element.classList.contains('selected')) {
        // Add to selected extras
        selectedExtras.push(extra);
      } else {
        // Remove from selected extras
        selectedExtras = selectedExtras.filter(e => e.id !== extra.id);
      }
      
      // Update total price
      updateTotalPrice();
    }
    
    // Update total price based on selected extras and quantity
    function updateTotalPrice() {
      if (!currentCustomizeItem) return;
      
      // Calculate extras cost
      const extrasCost = selectedExtras.reduce((total, extra) => total + extra.price, 0);
      
      // Calculate total price with quantity
      const totalPrice = (currentCustomizeItem.price + extrasCost) * itemQuantity;
      
      // Update display
      document.getElementById('customize-total-price').textContent = `$${totalPrice.toFixed(2)}`;
      
      // If there are extras or quantity > 1, show the base price as well
      const basePrice = document.getElementById('customize-base-price');
      if (extrasCost > 0 || itemQuantity > 1) {
        basePrice.textContent = `$${currentCustomizeItem.price.toFixed(2)}`;
        basePrice.style.display = 'block';
      } else {
        basePrice.style.display = 'none';
      }
    }
    
    // Change item quantity
    function changeQuantity(change) {
      const quantityDisplay = document.getElementById('quantity-value');
      let newQuantity = parseInt(quantityDisplay.textContent) + change;
      
      // Ensure quantity is between 1 and 10
      newQuantity = Math.max(1, Math.min(10, newQuantity));
      
      // Update display
      quantityDisplay.textContent = newQuantity;
      itemQuantity = newQuantity;
      
      // Update total price
      updateTotalPrice();
      
      // Disable decrease button if at minimum
      document.getElementById('decrease-quantity').disabled = newQuantity <= 1;
      
      // Add a visual indication that we've reached min/max
      if (newQuantity === 1 || newQuantity === 10) {
        quantityDisplay.classList.add('quantity-limit');
        setTimeout(() => {
          quantityDisplay.classList.remove('quantity-limit');
        }, 300);
      }
    }
    
    // Close the customization modal
    function closeCustomizeModal() {
      const customizeModal = document.getElementById('customize-modal');
      
      // Add fade-out animation
      customizeModal.style.opacity = '0';
      
      setTimeout(() => {
        customizeModal.style.display = 'none';
        customizeModal.style.opacity = '1';
        
        // Reset state
        currentCustomizeItem = null;
        selectedExtras = [];
        itemQuantity = 1;
      }, 300);
    }
    
    // Add the customized item to cart
    function addCustomizedItemToCart() {
      if (!currentCustomizeItem) return;
      
      // Get selected extras
      const extrasLabels = selectedExtras.map(extra => extra.name);
      const extrasCost = selectedExtras.reduce((total, extra) => total + extra.price, 0);
      
      // Get special instructions
      const specialInstructions = document.getElementById('special-instructions').value.trim();
      
      // Calculate total price for a single item
      const singleItemPrice = currentCustomizeItem.price + extrasCost;
      
      // Create cart item with 3D model info
      const cartItem = {
        name: currentCustomizeItem.name,
        price: currentCustomizeItem.price,
        extras: extrasLabels.length > 0 ? extrasLabels.join(', ') : null,
        extrasCost: extrasCost,
        notes: specialInstructions,
        quantity: itemQuantity,
        totalPrice: singleItemPrice * itemQuantity,
        model: currentCustomizeItem.modelSrc // Use the standardized model path
      };
      
      console.log("Adding item to cart:", cartItem);
      
      // Add to cart
      cart.push(cartItem);
      
      // Persist cart to localStorage for recovery
      try {
        localStorage.setItem('arBitesCart', JSON.stringify(cart));
      } catch (e) {
        console.error("Error saving cart to localStorage:", e);
      }
      
      // Update cart display and UI
      updateCartDisplay();
      
      // Verify the checkout button is enabled
      checkoutBtn.disabled = false;
      
      // Store a reference to the item name and quantity before closing the modal
      const itemName = currentCustomizeItem.name;
      const itemQty = itemQuantity;
      
      // Show confirmation notification
      showNotification(
        currentLanguage === 'ar' ? 'تمت الإضافة' : 'Added to Cart',
        currentLanguage === 'ar' 
          ? `تم إضافة ${itemQty > 1 ? itemQty + 'x ' : ''}${itemName} إلى سلة التسوق` 
          : `${itemQty > 1 ? itemQty + 'x ' : ''}${itemName} has been added to your cart`,
        'success'
      );
    }
    
    // Update customization modal text based on current language
    function updateCustomizeModalLanguage() {
      if (currentLanguage === 'ar') {
        document.getElementById('extras-section-title').textContent = 'إضافات';
        document.getElementById('extras-subtitle').textContent = 'اختر الإضافات أو المكونات الجانبية';
        document.getElementById('instructions-section-title').textContent = 'تعليمات خاصة';
        document.getElementById('instructions-subtitle').textContent = 'أي طلبات خاصة لطلبك؟';
        document.getElementById('quantity-label').textContent = 'الكمية';
        document.getElementById('add-to-cart-text').textContent = 'إضافة إلى السلة';
        document.getElementById('special-instructions').placeholder = 'مثال: مقرمش إضافي، بدون بصل، معلومات الحساسية، إلخ.';
      } else {
        document.getElementById('extras-section-title').textContent = 'ADD EXTRAS';
        document.getElementById('extras-subtitle').textContent = 'Select additional toppings or sides';
        document.getElementById('instructions-section-title').textContent = 'SPECIAL INSTRUCTIONS';
        document.getElementById('instructions-subtitle').textContent = 'Any special requests for your order?';
        document.getElementById('quantity-label').textContent = 'QUANTITY';
        document.getElementById('add-to-cart-text').textContent = 'ADD TO CART';
        document.getElementById('special-instructions').placeholder = 'Ex: Extra crispy, No onions, Allergy information, etc.';
      }
    }
    
    function updateCartDisplay() {
      // Count total items including quantities
      const totalItems = cart.reduce((count, item) => count + (item.quantity || 1), 0);
      cartCount.textContent = totalItems;
      
      // Clear cart items
      cartItems.innerHTML = '';
      
      // Calculate total
      let subtotal = 0;
      
      // Empty cart message
      if (cart.length === 0) {
        const emptyCart = document.createElement('div');
        emptyCart.className = 'empty-cart-message';
        emptyCart.innerHTML = `
          <i class="fas fa-shopping-cart"></i>
          <p>${currentLanguage === 'ar' ? 'سلة التسوق فارغة' : 'Your cart is empty'}</p>
          <p class="empty-cart-subtext">${currentLanguage === 'ar' 
            ? 'أضف بعض العناصر اللذيذة!' 
            : 'Add some delicious items!'}</p>
        `;
        cartItems.appendChild(emptyCart);
      } else {
        // Add a hint that cart items are clickable for editing
        if (!document.getElementById('cart-edit-hint')) {
          const hintText = document.createElement('div');
          hintText.id = 'cart-edit-hint';
          hintText.className = 'cart-edit-hint';
          hintText.textContent = currentLanguage === 'ar' 
            ? 'انقر على عنصر لتعديله' 
            : 'Tap an item to edit';
          cartItems.appendChild(hintText);
        }
      }
      
      // Generate cart item elements
      cart.forEach((item, index) => {
        subtotal += item.totalPrice;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        
        // Create content wrapper for better layout control
        const cartItemContent = document.createElement('div');
        cartItemContent.className = 'cart-item-content';
        
        // Add 3D model viewer for menu items that have models
        const modelContainer = document.createElement('div');
        modelContainer.className = 'cart-item-model';
        
        // Use the model directly from the cart item if available, otherwise find it
        if (item.model) {
          const modelViewer = document.createElement('model-viewer');
          // Use absolute path to model with error handling
          const modelPath = item.model.startsWith('/') ? item.model : `/models/${item.model.split('/').pop()}`;
          console.log("Setting cart model path to:", modelPath);
          modelViewer.addEventListener('error', (e) => {
            console.error("Error loading cart model:", modelPath, e);
          });
          modelViewer.setAttribute('src', modelPath);
          modelViewer.setAttribute('ar', '');
          modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
          modelViewer.setAttribute('camera-controls', '');
          modelViewer.setAttribute('auto-rotate', '');
          modelViewer.setAttribute('rotation-per-second', '30deg');
          modelViewer.setAttribute('shadow-intensity', '1');
          modelViewer.setAttribute('camera-orbit', '0deg 75deg 2m');
          modelViewer.setAttribute('alt', item.name);
          modelViewer.setAttribute('style', 'width: 100%; height: 100%;');
          modelContainer.appendChild(modelViewer);
        } else {
          // If model not directly on cart item, try to find it from food items
          const foodItem = filteredFoodItems.find(f => f.name === item.name);
          if (foodItem && foodItem.modelSrc) {
            const modelViewer = document.createElement('model-viewer');
            // Use absolute path to model with error handling
            const modelPath = foodItem.modelSrc.startsWith('/') ? foodItem.modelSrc : `/models/${foodItem.modelSrc.split('/').pop()}`;
            console.log("Setting cart foodItem model path to:", modelPath);
            modelViewer.addEventListener('error', (e) => {
              console.error("Error loading cart foodItem model:", modelPath, e);
            });
            modelViewer.setAttribute('src', modelPath);
            modelViewer.setAttribute('ar', '');
            modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
            modelViewer.setAttribute('camera-controls', '');
            modelViewer.setAttribute('auto-rotate', '');
            modelViewer.setAttribute('rotation-per-second', '30deg');
            modelViewer.setAttribute('shadow-intensity', '1');
            modelViewer.setAttribute('camera-orbit', '0deg 75deg 2m');
            modelViewer.setAttribute('alt', item.name);
            modelViewer.setAttribute('style', 'width: 100%; height: 100%;');
            modelContainer.appendChild(modelViewer);
          } else {
            // Fallback for items without 3D models
            modelContainer.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-utensils" style="color:var(--gold);opacity:0.5;font-size:20px;"></i></div>';
          }
        }
        
        const itemName = document.createElement('div');
        itemName.className = 'item-name';
        
        // Create item name with quantity if more than 1
        let nameText = '';
        if (item.quantity && item.quantity > 1) {
          nameText = `<span class="item-quantity">${item.quantity}×</span> ${item.name}`;
        } else {
          nameText = item.name;
        }
        
        // Add extras if present
        if (item.extras) {
          nameText += `<div class="item-extras">${item.extras}</div>`;
        }
        
        // Add notes if present
        if (item.notes) {
          nameText += `<div class="item-notes">${item.notes}</div>`;
        }
        
        itemName.innerHTML = nameText;
        
        // Price display
        const itemPrice = document.createElement('div');
        itemPrice.className = 'item-price';
        itemPrice.textContent = `$${item.totalPrice.toFixed(2)}`;
        
        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-item';
        removeBtn.innerHTML = '&times;';
        removeBtn.setAttribute('aria-label', currentLanguage === 'ar' ? 'إزالة العنصر' : 'Remove item');
        removeBtn.onclick = function(e) {
          e.stopPropagation(); // Prevent item click when removing
          removeCartItem(index);
        };
        
        // Build cart item with improved layout
        cartItemContent.appendChild(modelContainer);
        cartItemContent.appendChild(itemName);
        
        cartItem.appendChild(cartItemContent);
        cartItem.appendChild(itemPrice);
        cartItem.appendChild(removeBtn);
        
        // Add edit functionality - clicking on item opens customization
        cartItem.addEventListener('click', () => {
          // Find the original food item to customize
          const foodItem = filteredFoodItems.find(f => f.name === item.name);
          if (foodItem) {
            // Store current index to replace item later
            cartItem.dataset.editIndex = index;
            showCustomizeModal(foodItem);
            
            // Pre-fill with existing customizations if possible
            setTimeout(() => {
              // Pre-fill quantity
              if (item.quantity) {
                document.getElementById('quantity-value').textContent = item.quantity;
                itemQuantity = item.quantity;
                updateTotalPrice();
              }
              
              // Pre-fill notes
              if (item.notes) {
                document.getElementById('special-instructions').value = item.notes;
              }
              
              // Try to pre-select extras
              if (item.extras) {
                const extraNames = item.extras.split(', ');
                const extraOptions = document.querySelectorAll('.extra-option');
                
                extraOptions.forEach(option => {
                  const extraName = option.querySelector('.extra-name').textContent;
                  if (extraNames.includes(extraName)) {
                    // Simulate a click to select this extra
                    option.click();
                  }
                });
              }
            }, 300);
          }
        });
        
        cartItems.appendChild(cartItem);
      });
      
      // Calculate tax (assuming 8%)
      const tax = subtotal * 0.08;
      
      // Calculate total
      const total = subtotal + tax;
      
      // Update total breakdown
      totalBreakdown.innerHTML = `
        <p style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>${currentLanguage === 'ar' ? 'المجموع الفرعي' : 'Subtotal'}</span>
          <span>$${subtotal.toFixed(2)}</span>
        </p>
        <p style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>${currentLanguage === 'ar' ? 'الضريبة (8%)' : 'Tax (8%)'}</span>
          <span>$${tax.toFixed(2)}</span>
        </p>
        <p style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
          <span>${currentLanguage === 'ar' ? 'الإجمالي' : 'Total'}</span>
          <span>$${total.toFixed(2)}</span>
        </p>
      `;
      
      // Update cart icon based on whether there are items
      const cartIconElement = document.querySelector('.cart-icon');
      if (cart.length > 0 && cartIconElement) {
        cartIconElement.classList.add('has-items');
      } else if (cartIconElement) {
        cartIconElement.classList.remove('has-items');
      }
      
      // Disable checkout if cart is empty
      checkoutBtn.disabled = cart.length === 0;
    }
    
    function removeCartItem(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }
    
    function toggleCart() {
      cartPanel.classList.toggle('active');
    }
    
    // Authentication
    function showLoginModal() {
      // Clear previous values
      username.value = '';
      password.value = '';
      
      // Show the modal with a fade-in effect
      loginModal.style.opacity = '0';
      loginModal.style.display = 'flex';
      
      // Apply fade-in animation
      setTimeout(() => {
        loginModal.style.opacity = '1';
      }, 50);
      
      // Set focus to username field after a short delay
      setTimeout(() => {
        username.focus();
      }, 300);
    }
    
    function closeModal() {
      // Fade out effect
      loginModal.style.opacity = '0';
      
      // Hide after animation completes
      setTimeout(() => {
        loginModal.style.display = 'none';
        loginModal.style.opacity = '1'; // Reset for next time
      }, 300);
    }
    
    // Initialize staff and admin accounts
    const accounts = [
      { username: 'admin', name: 'Restaurant Administrator', password: '123456', role: 'admin' },
      { username: 'ahmad', name: 'Ahmad Mohammed', password: '123456', role: 'manager' },
      { username: 'john', name: 'John Smith', password: '123456', role: 'chef' },
      { username: 'sarah', name: 'Sarah Johnson', password: '123456', role: 'server' },
      { username: 'staff', name: 'General Staff', password: '123456', role: 'staff' }
    ];
    
    // Authentication function for staff login
    async function authenticateStaff(username, password) {
      console.log("Authenticating staff with username:", username);
      
      // Find matching account
      const account = accounts.find(acc => acc.username === username && acc.password === password);
      
      if (account) {
        console.log("Staff authentication successful for:", account.name);
        
        // Set localStorage values
        if (account.role === 'admin') {
          localStorage.setItem(ADMIN_TOKEN, 'true');
          localStorage.setItem('adminName', account.name);
          userType = 'admin';
          localStorage.setItem(USER_TYPE_KEY, 'admin');
        } else {
          localStorage.setItem(STAFF_TOKEN, 'true');
          localStorage.setItem('staffName', account.name);
          localStorage.setItem('staffRole', account.role);
          userType = 'staff';
          localStorage.setItem(USER_TYPE_KEY, 'staff');
        }
        
        return { 
          success: true, 
          name: account.name, 
          role: account.role 
        };
      } else {
        console.log("Staff authentication failed");
        return { success: false };
      }
    }
    
    // Initialize table assignments
    const tableAssignments = [
      { staffUsername: 'sarah', startTable: 1, endTable: 20 },
      { staffUsername: 'john', startTable: 21, endTable: 40 },
      { staffUsername: 'staff', startTable: 41, endTable: 60 }
    ];
    
    // Helper function to get staff assigned to a specific table
    function getStaffForTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      const assignment = tableAssignments.find(a => 
        tableNumber >= a.startTable && tableNumber <= a.endTable
      );
      
      if (!assignment) return null;
      
      // Get staff details from accounts
      const staffMember = accounts.find(acc => acc.username === assignment.staffUsername);
      if (!staffMember) return null;
      
      return {
        name: staffMember.name || staffMember.username,
        role: staffMember.role || 'staff',
        username: staffMember.username
      };
    }
    
    // Function to create orders with proper Firebase integration
    async function createOrderInFirebase(orderData) {
      if (!orderData || !orderData.tableNumber) {
        console.error("Invalid order data for Firebase");
        return null;
      }
      
      try {
        // Minimal logging to improve performance
        console.log("Creating order for table:", orderData.tableNumber);
        
        // Check database connection first
        if (!db || typeof db.collection !== 'function') {
          console.error("Firebase database not initialized");
          throw new Error("Database not connected");
        }
        
        // Ensure table number is an integer
        const tableNumber = parseInt(orderData.tableNumber);
        if (isNaN(tableNumber)) {
          console.error("Invalid table number in order data:", orderData.tableNumber);
          throw new Error("Invalid table number");
        }
        orderData.tableNumber = tableNumber;
        
        // Get assigned staff for this table
        const assignedStaff = getStaffForTable(tableNumber);
        if (assignedStaff) {
          console.log(`Table ${tableNumber} is assigned to staff member: ${assignedStaff.name} (${assignedStaff.role})`);
          
          // Add staff information to order
          orderData.assignedStaff = {
            name: assignedStaff.name,
            username: assignedStaff.username,
            role: assignedStaff.role
          };
        } else {
          console.log(`No staff assigned to table ${tableNumber}`);
        }
        
        // Add timestamps
        if (firebase && firebase.firestore) {
          orderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          orderData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
          // Fallback for offline mode
          orderData.createdAt = new Date();
          orderData.updatedAt = new Date();
        }
        
        let orderId;
        
        // Check if we're in offline/demo mode
        if (isOfflineMode || !db || typeof db.collection !== 'function') {
          console.log("In offline mode, creating order locally");
          // Generate a random ID for the order in offline mode
          orderId = 'offline-' + Math.floor(Math.random() * 1000000);
        } else {
          // Add to Firebase with improved error handling
          try {
            // First, try to check if the table is still available
            const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
            const tableStatus = await tableStatusRef.get();
            
            // If the table is already marked as occupied in Firebase, we may want to warn the user
            if (tableStatus.exists && tableStatus.data().status === 'occupied') {
              console.warn(`Table ${tableNumber} is already marked as occupied in Firebase. Continuing anyway.`);
            }
            
            // Prepare a batched write to update both the order and table status atomically
            const batch = db.batch();
            
            // Create new order document
            const orderRef = db.collection('orders').doc();
            batch.set(orderRef, orderData);
            
            // Update table status to occupied
            batch.set(tableStatusRef, {
              status: 'occupied',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              orderId: orderRef.id,
              updatedBy: {
                username: orderData.assignedStaff?.username || 'system',
                role: orderData.assignedStaff?.role || 'system'
              }
            });
            
            // Commit the batch
            await batch.commit();
            
            orderId = orderRef.id;
            console.log("Order created successfully with ID:", orderId);
            
          } catch (dbError) {
            console.error("Firebase error creating order:", dbError);
            
            // Try a simpler approach - just add the order without the batch
            try {
              console.log("Trying fallback approach - adding order without batch");
              const docRef = await db.collection('orders').add(orderData);
              orderId = docRef.id;
              console.log("Order created via fallback with ID:", orderId);
            } catch (fallbackError) {
              console.error("Even fallback order creation failed:", fallbackError);
              // Ultimate fallback - create order ID locally
              orderId = 'fallback-' + Math.floor(Math.random() * 1000000);
              console.log("Using local fallback order ID:", orderId);
            }
          }
        }
        
        // Update local tables data regardless of Firebase status
        occupiedTables.add(tableNumber);
        
        // Prepare order for table details
        const orderForTable = {
          id: orderId,
          status: orderData.status,
          items: orderData.items,
          timestamp: new Date(),
          total: orderData.total,
          assignedStaff: orderData.assignedStaff
        };
        
        // Update table details
        if (!tableDetails[tableNumber]) {
          tableDetails[tableNumber] = { orders: [] };
        }
        
        // Add to beginning of orders array
        tableDetails[tableNumber].orders.unshift(orderForTable);
        
        // Update staff view if needed
        if (userType === 'staff' || userType === 'admin') {
          updateTablesDisplay();
        }
        
        return orderId;
      } catch (error) {
        console.error("Error creating order in Firebase:", error);
        // Last resort fallback - generate a local ID
        const fallbackId = 'error-' + Math.floor(Math.random() * 1000000);
        console.log("Using fallback order ID:", fallbackId);
        return fallbackId;
      }
    }
    
    function loginUser() {
      const user = username.value;
      const pass = password.value;
      
      console.log("Login attempt:", user);
      
      // Find user in accounts array
      const account = accounts.find(acc => acc.username === user && acc.password === pass);
      
      if (!account) {
        showNotification(
          currentLanguage === 'ar' ? 'خطأ في تسجيل الدخول' : 'Login Error',
          currentLanguage === 'ar' 
            ? "اسم المستخدم أو كلمة المرور غير صحيحة" 
            : "Invalid username or password",
          'error'
        );
        return;
      }
      
      // Handle different account types (admin vs staff)
      if (account.role === 'admin') {
        userType = "admin";
        localStorage.setItem(USER_TYPE_KEY, "admin");
        localStorage.setItem(ADMIN_TOKEN, "true");
        localStorage.setItem("adminName", account.name);
        closeModal();
        checkAuthState();
        showNotification(
          currentLanguage === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Successfully Logged In',
          currentLanguage === 'ar' 
            ? "تم تسجيل الدخول كمسؤول" 
            : "Logged in as Administrator",
          'success'
        );
      } else {
        userType = "staff";
        localStorage.setItem(USER_TYPE_KEY, "staff");
        localStorage.setItem(STAFF_TOKEN, "true");
        localStorage.setItem("staffName", account.name);
        localStorage.setItem("staffRole", account.role);
        localStorage.setItem("username", account.username);  // Store username for table assignment lookups
        closeModal();
        checkAuthState();
        showNotification(
          currentLanguage === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Successfully Logged In',
          currentLanguage === 'ar' 
            ? `تم تسجيل الدخول كـ ${account.name}`
            : `Logged in as ${account.name} (${account.role})`,
          'success'
        );
      }
    }
    
    function checkAuthState() {
      console.log("Checking auth state. Current userType:", userType);
      console.log("Staff token:", localStorage.getItem(STAFF_TOKEN));
      console.log("Admin token:", localStorage.getItem(ADMIN_TOKEN));
      
      // Reset UI
      guestBtn.classList.remove('active');
      const staffLoginBtn = document.getElementById('staff-login-btn');
      if (staffLoginBtn) staffLoginBtn.classList.remove('active');
      
      // Hide all views
      guestView.style.display = 'none';
      staffDashboard.style.display = 'none';
      adminDashboard.style.display = 'none';
      
      // Update login button text based on auth state
      if (staffLoginBtn) {
        if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
          // If logged in, show the user type
          staffLoginBtn.textContent = localStorage.getItem(ADMIN_TOKEN) ? 'ADMIN' : 'STAFF';
        } else {
          // If not logged in, show "LOGIN"
          staffLoginBtn.textContent = currentLanguage === 'ar' ? 'تسجيل الدخول' : 'LOGIN';
        }
      }
      
      // Hide role selection buttons if user has selected a role
      const userTypeContainer = document.querySelector('.user-type');
      if (userTypeContainer && userType) {
        userTypeContainer.style.display = 'none';
      }
      
      // Show appropriate view
      if (userType === "guest") {
        guestBtn.classList.add('active');
        guestView.style.display = 'block';
      } else if (userType === "staff") {
        if (staffLoginBtn) staffLoginBtn.classList.add('active');
        staffDashboard.style.display = 'block';
        
        // Display staff name and role from localStorage
        const staffNameDisplay = document.getElementById('staff-name-display');
        const staffRoleBadge = document.getElementById('staff-role-badge');
        
        if (staffNameDisplay && staffRoleBadge) {
          const staffName = localStorage.getItem('staffName') || 'Staff Member';
          const staffRole = localStorage.getItem('staffRole') || 'staff';
          
          staffNameDisplay.textContent = staffName;
          staffRoleBadge.textContent = staffRole;
          
          // Add color coding based on role
          staffRoleBadge.className = '';
          staffRoleBadge.classList.add('role-' + staffRole.toLowerCase());
        }
        
        renderOrders();
        renderTablesOverview();
      } else if (userType === "admin") {
        if (staffLoginBtn) staffLoginBtn.classList.add('active');
        adminDashboard.style.display = 'block';
        
        // Display admin name if available
        const adminName = localStorage.getItem('adminName') || 'Administrator';
        
        // Update admin dashboard title to include name
        const adminDashboardTitle = document.getElementById('admin-dashboard-title');
        if (adminDashboardTitle) {
          adminDashboardTitle.innerHTML = `ADMIN DASHBOARD <span class="admin-name">${adminName}</span>`;
        }
        
        renderAdminDashboard();
      }
    }
    
    function switchUserType(type) {
      // If user already authenticated as staff or admin, switch to that view
      if (type === "staff" && localStorage.getItem(STAFF_TOKEN)) {
        userType = "staff";
        localStorage.setItem(USER_TYPE_KEY, "staff");
        checkAuthState();
        return;
      }
      
      if (type === "admin" && localStorage.getItem(ADMIN_TOKEN)) {
        userType = "admin";
        localStorage.setItem(USER_TYPE_KEY, "admin");
        checkAuthState();
        return;
      }
      
      // For guest view
      if (type === "guest") {
        userType = "guest";
        localStorage.setItem(USER_TYPE_KEY, "guest");
        checkAuthState();
        return;
      }
      
      // If clicked on login button, show the unified login modal
      showLoginModal();
    }
    
    // Load table number if valid
    function showTableModal(fromCartAction = false) {
      tableNumberModal.style.display = 'flex';
      
      // Enhanced message if coming from cart action
      if (fromCartAction) {
        const tableNumberTitle = document.getElementById('table-number-title');
        if (tableNumberTitle) {
          tableNumberTitle.innerHTML = currentLanguage === 'ar' 
            ? '<strong>أدخل رقم الطاولة لإتمام الطلب</strong>' 
            : '<strong>Enter Table Number to Complete Order</strong>';
        }
        
        // Show input field immediately when called from cart
        document.querySelector('.user-option-buttons').style.display = 'none';
        tableNumberInputContainer.style.display = 'block';
        
        // Add a back button to cancel table input and return to order
        const tableActionButtons = document.querySelector('.table-action-buttons');
        
        // Update button text to make it clearer
        if (tableActionButtons) {
          const confirmButton = document.getElementById('confirm-table-btn');
          const cancelButton = document.getElementById('cancel-table-btn');
          
          if (confirmButton) {
            confirmButton.textContent = currentLanguage === 'ar' ? 'تأكيد وإتمام الطلب' : 'CONFIRM & PLACE ORDER';
          }
          
          if (cancelButton) {
            cancelButton.textContent = currentLanguage === 'ar' ? 'إلغاء وعودة' : 'CANCEL & GO BACK';
            cancelButton.style.display = 'inline-block';
          }
        }
        
        // Focus the input field
        setTimeout(() => {
          tableNumberInput.focus();
        }, 100);
      } else {
        // Reset the input container (hidden initially)
        tableNumberInputContainer.style.display = 'none';
      }
      
      // Check if staff login is active
      const staffBypassSection = document.getElementById('staff-bypass-section');
      const staffToken = localStorage.getItem(STAFF_TOKEN);
      const adminToken = localStorage.getItem(ADMIN_TOKEN);
      
      if (staffToken || adminToken) {
        // Show staff bypass option
        staffBypassSection.style.display = 'block';
      } else {
        // Hide staff bypass for regular users
        staffBypassSection.style.display = 'none';
      }
    }
    
    // This function is redefined below
    
    function bypassTableSelection() {
      // Set user type to staff/admin if not already
      if (userType !== 'staff' && userType !== 'admin') {
        userType = localStorage.getItem(STAFF_TOKEN) ? 'staff' : 'admin';
        localStorage.setItem(USER_TYPE_KEY, userType);
      }
      
      // Close the table modal
      closeTableModal();
      
      // Show success notification
      showNotification(
        currentLanguage === 'ar' ? 'تم تجاوز اختيار الطاولة' : 'Table Selection Bypassed',
        currentLanguage === 'ar' 
          ? 'تم تجاوز اختيار الطاولة بنجاح. يمكنك الآن الوصول إلى لوحة التحكم.' 
          : 'Table selection bypassed successfully. You can now access the dashboard.',
        'success'
      );
      
      // Update UI to reflect staff/admin mode
      checkAuthState();
    }
    
    function showGuestOption() {
      // Set user type
      userType = "guest";
      localStorage.setItem(USER_TYPE_KEY, "guest");
      
      const optionButtons = document.querySelector('.user-option-buttons');
      
      // Change modal title to reflect guest mode
      const tableTitle = document.getElementById('table-number-title');
      tableTitle.textContent = currentLanguage === 'ar' ? 'إدخال رقم الطاولة' : 'ENTER TABLE NUMBER';
      
      // Fade out entire options container for a clean transition
      optionButtons.style.opacity = '0';
      
      setTimeout(() => {
        // Completely remove options from DOM
        optionButtons.parentNode.removeChild(optionButtons);
        
        // Create a guest icon indicator
        const modalContent = document.querySelector('.table-number-content');
        const guestIcon = document.createElement('div');
        guestIcon.className = 'guest-icon-standalone';
        guestIcon.innerHTML = `<i class="fas fa-utensils"></i>
                            <div class="guest-title">${currentLanguage === 'ar' ? 'وضع الضيف' : 'GUEST MODE'}</div>`;
        
        // Add the icon if it doesn't already exist
        if (!document.querySelector('.guest-icon-standalone')) {
          modalContent.insertBefore(guestIcon, modalContent.firstChild);
        }
        
        // Show the table number input with a nice fade-in
        tableNumberInputContainer.style.display = 'block';
        tableNumberInputContainer.style.opacity = '0';
        
        setTimeout(() => {
          tableNumberInputContainer.style.opacity = '1';
          tableNumberInput.focus();
          
          // Clear the availability indicator
          const availabilityIndicator = document.getElementById('table-availability-indicator');
          availabilityIndicator.innerHTML = '';
          availabilityIndicator.className = 'table-availability-indicator';
          
          // Scroll to the input if needed
          tableNumberInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 50);
      }, 300);
      
      // Add real-time table availability check if not already added
      tableNumberInput.removeEventListener('input', checkTableAvailabilityRealtime);
      tableNumberInput.addEventListener('input', checkTableAvailabilityRealtime);
      
      // We no longer add the back button as we want options to be completely gone
    }
    
    function resetTableSelectionModal() {
      // Hide the table input and back button
      tableNumberInputContainer.style.opacity = '0';
      const backButton = document.getElementById('back-to-options-btn');
      if (backButton) backButton.style.opacity = '0';
      
      // Remove any staff/guest standalone icons
      const staffIcon = document.querySelector('.staff-icon-standalone');
      if (staffIcon) staffIcon.style.opacity = '0';
      
      const guestIcon = document.querySelector('.guest-icon-standalone');
      if (guestIcon) guestIcon.style.opacity = '0';
      
      // Remove any login form
      const loginForm = document.getElementById('embedded-login-form');
      if (loginForm) loginForm.style.opacity = '0';
      
      setTimeout(() => {
        // Hide/remove elements
        tableNumberInputContainer.style.display = 'none';
        if (backButton) backButton.remove();
        if (staffIcon) staffIcon.remove();
        if (guestIcon) guestIcon.remove();
        if (loginForm) loginForm.style.display = 'none';
        
        // Reset modal title
        const tableTitle = document.getElementById('table-number-title');
        tableTitle.textContent = currentLanguage === 'ar' ? 'رقم الطاولة الخاص بك' : 'YOUR TABLE NUMBER';
        
        // Get the modal content container
        const modalContent = document.querySelector('.table-number-content');
        
        // Check if option buttons exist, if not, recreate them
        let optionButtons = document.querySelector('.user-option-buttons');
        if (!optionButtons) {
          // Create new option buttons container
          optionButtons = document.createElement('div');
          optionButtons.className = 'user-option-buttons';
          
          // Create guest option
          const guestOption = document.createElement('div');
          guestOption.className = 'guest-option';
          guestOption.onclick = function() { showGuestOption(); };
          guestOption.innerHTML = `
            <i class="fas fa-utensils option-icon"></i>
            <span id="guest-option-text">${currentLanguage === 'ar' ? 'أنا ضيف' : 'I\'m a Guest'}</span>
            <div class="option-description" id="guest-option-desc">
              ${currentLanguage === 'ar' 
                ? 'حدد هذا إذا كنت تتناول الطعام وتحتاج إلى طلب من طاولتك' 
                : 'Select this if you\'re dining in and need to place an order from your table'}
            </div>
          `;
          
          // Create staff option
          const staffOption = document.createElement('div');
          staffOption.className = 'staff-option';
          staffOption.onclick = function() { handleStaffBypass(); };
          staffOption.innerHTML = `
            <i class="fas fa-user-tie option-icon"></i>
            <span id="staff-option-text">${currentLanguage === 'ar' ? 'أنا موظف' : 'I\'m Staff'}</span>
            <div class="option-description" id="staff-option-desc">
              ${currentLanguage === 'ar'
                ? 'وصول موظفي المطعم - إدارة الطلبات والطاولات وعمليات المطبخ'
                : 'Restaurant staff access - manage orders, tables, and kitchen operations'}
            </div>
          `;
          
          // Add options to container
          optionButtons.appendChild(guestOption);
          optionButtons.appendChild(staffOption);
          
          // Add container to modal
          modalContent.insertBefore(optionButtons, tableNumberInputContainer);
        } else {
          // If they exist, just show them
          optionButtons.style.display = 'flex';
        }
        
        // Fade in the options
        optionButtons.style.opacity = '0';
        setTimeout(() => {
          optionButtons.style.opacity = '1';
        }, 50);
      }, 200);
    }
    
    // Real-time table availability check as the user types
    async function checkTableAvailabilityRealtime() {
      const tableNumberInt = parseInt(tableNumberInput.value, 10);
      const availabilityIndicator = document.getElementById('table-availability-indicator');
      
      // Clear the indicator if input is empty or invalid
      if (isNaN(tableNumberInt) || tableNumberInt <= 0) {
        availabilityIndicator.innerHTML = '';
        availabilityIndicator.className = 'table-availability-indicator';
        return;
      }
      
      // Show checking message
      availabilityIndicator.className = 'table-availability-indicator';
      availabilityIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
      
      // Check if table is available
      const isAvailable = await checkTableAvailability(tableNumberInt);
      
      if (isAvailable) {
        availabilityIndicator.className = 'table-availability-indicator available';
        availabilityIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Table available';
      } else {
        availabilityIndicator.className = 'table-availability-indicator occupied';
        availabilityIndicator.innerHTML = '<i class="fas fa-times-circle"></i> Table currently occupied';
      }
    }
    
    function handleStaffBypass() {
      // Set user type temporarily - will be updated after authentication
      userType = "staff";
      localStorage.setItem(USER_TYPE_KEY, "staff");
      
      const optionButtons = document.querySelector('.user-option-buttons');
      
      // Change modal title to reflect staff mode
      const tableTitle = document.getElementById('table-number-title');
      tableTitle.textContent = currentLanguage === 'ar' ? 'تسجيل دخول الموظفين' : 'STAFF LOGIN';
      
      // Fade out entire options container for a clean transition
      optionButtons.style.opacity = '0';
      
      // Switch to staff view without entering table number
      if (localStorage.getItem(STAFF_TOKEN) === "true" || localStorage.getItem(ADMIN_TOKEN) === "true") {
        // If already authenticated as staff or admin
        const role = localStorage.getItem(ADMIN_TOKEN) === "true" ? "admin" : "staff";
        userType = role;
        localStorage.setItem(USER_TYPE_KEY, role);
        
        // Completely remove the options container from DOM
        setTimeout(() => {
          optionButtons.parentNode.removeChild(optionButtons);
          
          closeTableModal();
          checkAuthState();
          
          // Show feedback to user
          showNotification(
            currentLanguage === 'ar' ? 'تم تجاوز' : 'Staff Access',
            currentLanguage === 'ar' ? 'تم تجاوز حاجز اختيار الطاولة' : 'Welcome back! You are now in staff mode',
            'success'
          );
        }, 300);
      } else {
        // Need to authenticate first - prepare login form
        setTimeout(() => {
          // Completely remove options container from DOM
          optionButtons.parentNode.removeChild(optionButtons);
          
          // Show staff option as a standalone element above the login form
          const modalContent = document.querySelector('.table-number-content');
          
          // Create a standalone staff icon
          const staffIcon = document.createElement('div');
          staffIcon.className = 'staff-icon-standalone';
          staffIcon.innerHTML = `<i class="fas fa-user-tie"></i>
                                <div class="staff-title">${currentLanguage === 'ar' ? 'تسجيل دخول الموظفين' : 'STAFF LOGIN'}</div>`;
          
          // Add the icon if it doesn't already exist
          if (!document.querySelector('.staff-icon-standalone')) {
            modalContent.insertBefore(staffIcon, modalContent.firstChild);
          }
          
          // Check if we already have an embedded login form
          if (!document.getElementById('embedded-login-form')) {
            // Create login form container
            const loginForm = document.createElement('div');
            loginForm.id = 'embedded-login-form';
            loginForm.className = 'embedded-login-form';
            loginForm.style.opacity = '0';
            
            // Add username field
            const usernameGroup = document.createElement('div');
            usernameGroup.className = 'input-group';
            
            const usernameLabel = document.createElement('label');
            usernameLabel.htmlFor = 'embedded-username';
            usernameLabel.textContent = currentLanguage === 'ar' ? 'اسم المستخدم' : 'USERNAME';
            usernameLabel.className = 'input-label';
            
            const usernameInput = document.createElement('input');
            usernameInput.type = 'text';
            usernameInput.id = 'embedded-username';
            usernameInput.placeholder = currentLanguage === 'ar' ? 'أدخل اسم المستخدم' : 'Enter username';
            usernameInput.className = 'input-field';
            
            usernameGroup.appendChild(usernameLabel);
            usernameGroup.appendChild(usernameInput);
            
            // Add password field
            const passwordGroup = document.createElement('div');
            passwordGroup.className = 'input-group';
            
            const passwordLabel = document.createElement('label');
            passwordLabel.htmlFor = 'embedded-password';
            passwordLabel.textContent = currentLanguage === 'ar' ? 'كلمة المرور' : 'PASSWORD';
            passwordLabel.className = 'input-label';
            
            const passwordInput = document.createElement('input');
            passwordInput.type = 'password';
            passwordInput.id = 'embedded-password';
            passwordInput.placeholder = currentLanguage === 'ar' ? 'أدخل كلمة المرور' : 'Enter password';
            passwordInput.className = 'input-field';
            
            passwordGroup.appendChild(passwordLabel);
            passwordGroup.appendChild(passwordInput);
            
            // Add buttons
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'modal-buttons';
            
            const loginButton = document.createElement('button');
            loginButton.className = 'confirm-btn';
            loginButton.id = 'embedded-login-btn';
            loginButton.textContent = currentLanguage === 'ar' ? 'تسجيل الدخول' : 'LOGIN';
            
            const backButton = document.createElement('button');
            backButton.className = 'cancel-btn';
            backButton.id = 'embedded-back-btn';
            backButton.textContent = currentLanguage === 'ar' ? 'رجوع' : 'BACK';
            
            // Add login button handler
            loginButton.onclick = function() {
              // Show loading state
              loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
              loginButton.disabled = true;
              
              // Get username and password
              const embUsername = document.getElementById('embedded-username').value;
              const embPassword = document.getElementById('embedded-password').value;
              
              // Authenticate staff
              authenticateStaff(embUsername, embPassword)
                .then(result => {
                  if (result.success) {
                    // Success animation
                    loginButton.innerHTML = '<i class="fas fa-check-circle"></i>';
                    loginButton.style.background = 'linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%)';
                    
                    // Close modal after brief delay
                    setTimeout(() => {
                      closeTableModal();
                      
                      // Show success notification
                      showNotification(
                        currentLanguage === 'ar' ? 'تم تسجيل الدخول بنجاح' : 'Login Successful',
                        currentLanguage === 'ar' 
                          ? `مرحبًا ${result.name}! تم تسجيل دخولك بنجاح.`
                          : `Welcome ${result.name}! You have successfully logged in.`,
                        'success'
                      );
                      
                      // Update UI to reflect staff mode
                      checkAuthState();
                    }, 800);
                  } else {
                    // Error animation
                    loginButton.innerHTML = '<i class="fas fa-times-circle"></i>';
                    loginButton.style.background = 'linear-gradient(135deg, #c62828 0%, #f44336 100%)';
                    
                    // Reset button after delay
                    setTimeout(() => {
                      loginButton.innerHTML = currentLanguage === 'ar' ? 'تسجيل الدخول' : 'LOGIN';
                      loginButton.style.background = '';
                      loginButton.disabled = false;
                      
                      // Show error notification
                      showNotification(
                        currentLanguage === 'ar' ? 'فشل تسجيل الدخول' : 'Login Failed',
                        currentLanguage === 'ar'
                          ? 'اسم المستخدم أو كلمة المرور غير صحيحة'
                          : 'Invalid username or password',
                        'error'
                      );
                      
                      // Focus username field
                      document.getElementById('embedded-username').focus();
                    }, 1000);
                  }
                });
            };
            
            // Add back button handler
            backButton.onclick = resetTableSelectionModal;
            
            // Add keypress handler for password field
            passwordInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                loginButton.click();
              }
            });
            
            buttonGroup.appendChild(loginButton);
            buttonGroup.appendChild(backButton);
            
            // Assemble form
            loginForm.appendChild(usernameGroup);
            loginForm.appendChild(passwordGroup);
            loginForm.appendChild(buttonGroup);
            
            // Add to modal
            modalContent.appendChild(loginForm);
            
            // Fade in the form
            setTimeout(() => {
              loginForm.style.opacity = '1';
              // Focus username field
              usernameInput.focus();
            }, 50);
          } else {
            // Show existing form
            const loginForm = document.getElementById('embedded-login-form');
            loginForm.style.display = 'block';
            loginForm.style.opacity = '0';
            
            setTimeout(() => {
              loginForm.style.opacity = '1';
              // Focus username field
              document.getElementById('embedded-username').focus();
            }, 50);
          }
        }, 300);
      }
    }
    
    function confirmTableNumber() {
      const tableNumberInt = parseInt(tableNumberInput.value, 10);
      const confirmBtn = document.getElementById('confirm-table-btn');
      
      // If staff option is selected, allow bypassing table number selection
      const isStaffOptionSelected = document.querySelector('.staff-option.staff-option-active');
      
      if ((isNaN(tableNumberInt) || tableNumberInt <= 0) && !isStaffOptionSelected) {
        showNotification(
          currentLanguage === 'ar' ? "خطأ في الطاولة" : "Invalid Table",
          currentLanguage === 'ar' ? "الرجاء إدخال رقم طاولة صحيح" : "Please enter a valid table number",
          'error'
        );
        
        // Shake the input to indicate error
        tableNumberInput.classList.add('input-error');
        setTimeout(() => {
          tableNumberInput.classList.remove('input-error');
        }, 600);
        
        return;
      }
      
      // Add loading effect to button
      const originalBtnContent = confirmBtn.innerHTML;
      confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>VERIFYING</span>';
      confirmBtn.disabled = true;
      
      // Check if the table is already occupied
      checkTableAvailability(tableNumberInt).then(isAvailable => {
        if (!isAvailable) {
          // Show error notification instead of alert
          showNotification(
            currentLanguage === 'ar' ? "خطأ في الطاولة" : "Table Unavailable",
            currentLanguage === 'ar' 
              ? `الطاولة ${tableNumberInt} مشغولة. يرجى اختيار طاولة أخرى.`
              : `Table ${tableNumberInt} is occupied. Please choose another table.`,
            'error'
          );
          
          // Reset button
          confirmBtn.innerHTML = originalBtnContent;
          confirmBtn.disabled = false;
          
          // Focus the input for another try
          tableNumberInput.focus();
          return;
        }
        
        // Success animation
        confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> <span>CONFIRMED</span>';
        confirmBtn.style.background = 'linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%)';
        
        // Save table number with 1 hour expiry
        tableNumber = tableNumberInt;
        userTableNumber = tableNumberInt; // For guest users specifically
        tableNumberExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour
        
        localStorage.setItem(TABLE_NUMBER_KEY, tableNumber.toString());
        localStorage.setItem('userTableNumber', tableNumber.toString()); // Store separately for guests
        localStorage.setItem(TABLE_EXPIRY_KEY, tableNumberExpiry.toString());
        
        // Check which staff member is assigned to this table
        const assignedStaff = getStaffForTable(tableNumberInt);
        
        // Store assigned staff information
        if (assignedStaff) {
          localStorage.setItem('assignedStaffName', assignedStaff.name);
          localStorage.setItem('assignedStaffUsername', assignedStaff.username);
          localStorage.setItem('assignedStaffRole', assignedStaff.role);
          console.log(`Table ${tableNumberInt} is assigned to ${assignedStaff.name} (${assignedStaff.role})`);
        } else {
          localStorage.removeItem('assignedStaffName');
          localStorage.removeItem('assignedStaffUsername');
          localStorage.removeItem('assignedStaffRole');
          console.log(`No staff assigned to table ${tableNumberInt}`);
        }
        
        // Close modal after a short delay to show success state
        setTimeout(() => {
          closeTableModal();
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? "تم تعيين الطاولة" : "Table Assigned",
            currentLanguage === 'ar' 
              ? `تم تعيين الطاولة ${tableNumberInt} بنجاح`
              : `You've been successfully assigned to Table ${tableNumberInt}`,
            'success'
          );
          
          // Reset button state for next use
          setTimeout(() => {
            confirmBtn.innerHTML = originalBtnContent;
            confirmBtn.style.background = '';
            confirmBtn.disabled = false;
          }, 500);
        }, 1000);
      });
    }
    
    // Check if a table is available
    async function checkTableAvailability(tableNum) {
      try {
        // Parse table number to ensure it's a number
        const tableNumInt = parseInt(tableNum);
        if (isNaN(tableNumInt)) {
          console.error("Invalid table number:", tableNum);
          return false;
        }
        
        // Check if table is already occupied in memory
        if (occupiedTables.has(tableNumInt)) {
          console.log(`Table ${tableNumInt} is already marked as occupied locally`);
          return false;
        }
        
        // Check if we are in offline/demo mode
        if (isOfflineMode || !db || typeof db.collection !== 'function') {
          console.log(`In offline mode, assuming table ${tableNumInt} is available`);
          return true;
        }
        
        // Double check with database
        console.log(`Checking Firebase for table ${tableNumInt} availability`);
        try {
          const querySnapshot = await db.collection("orders")
            .where("tableNumber", "==", tableNumInt)
            .where("status", "in", ["pending", "preparing", "ready"])
            .get();
          
          const isAvailable = querySnapshot.empty;
          console.log(`Table ${tableNumInt} is ${isAvailable ? 'available' : 'occupied'} according to Firebase`);
          return isAvailable;
        } catch (dbError) {
          console.error("Error querying Firebase for table availability:", dbError);
          // If we can't check the database, assume it's available to avoid blocking users
          return true;
        }
      } catch (error) {
        console.error("Error checking table availability:", error);
        return true; // Assume available if there's an error to avoid blocking users
      }
    }
    
    // Release a table (used when order is completed or cancelled)
    function releaseTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      console.log(`Attempting to release table ${tableNumber}`);
      
      if (isNaN(tableNumber)) {
        console.error('Invalid table number for release');
        return false;
      }
      
      // For non-staff/admin users, we need to verify they're authorized to release tables
      if (userType !== 'staff' && userType !== 'admin') {
        // Only allow guest to release a table if it's their table
        if (userType === 'guest' && tableNumber !== parseInt(userTableNumber)) {
          console.error('Guests can only release their own table');
          return false;
        }
      } else {
        // For staff, check if they're authorized to manage this table
        const currentStaffUsername = localStorage.getItem('username');
        const staffRole = localStorage.getItem('staffRole');
        console.log('Current staff username:', currentStaffUsername, 'Role:', staffRole);
        
        // Admins and managers can manage any table
        let canManageTable = userType === 'admin' || staffRole === 'manager';
        
        if (userType === 'staff' && currentStaffUsername && !canManageTable) {
          const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
          console.log('Staff assignments for current user:', staffAssignments);
          
          // Check if this table is in any of the assigned ranges
          canManageTable = staffAssignments.some(assignment => {
            const inRange = tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
            console.log(`Checking if table ${tableNumber} is in range ${assignment.startTable}-${assignment.endTable}: ${inRange}`);
            return inRange;
          });
        }
        
        console.log(`Can manage table: ${canManageTable}`);
        
        if (!canManageTable) {
          showNotification(
            currentLanguage === 'ar' ? 'غير مسموح' : 'Not Authorized',
            currentLanguage === 'ar' 
              ? 'لا يمكنك إدارة هذه الطاولة لأنها ليست مخصصة لك' 
              : 'You cannot manage this table as it is not assigned to you',
            'error'
          );
          return false;
        }
      }
      
      if (occupiedTables.has(tableNumber)) {
        // Show loading state in UI first to prevent lag appearance
        showNotification(
          currentLanguage === 'ar' ? 'جارٍ التحديث' : 'Updating',
          currentLanguage === 'ar' 
            ? 'جارٍ تحرير الطاولة...' 
            : 'Freeing table...',
          'info',
          2000 // Auto-close after 2s
        );
        
        // Remove from local tracking immediately for responsive UI
        occupiedTables.delete(tableNumber);
        
        // Remove table details if they exist
        if (tableDetails[tableNumber]) {
          delete tableDetails[tableNumber];
        }
        
        // Update UI immediately for responsive experience
        if (userType === 'staff' || userType === 'admin') {
          updateTablesDisplay();
          renderTablesOverview();
        }
        
        // If we have Firebase connection, perform the backend updates in background
        if (db && typeof db.collection === 'function') {
          // Use a batch operation for all Firebase updates to improve consistency
          const batch = db.batch();
          
          // First get all orders for this table, regardless of status
          return db.collection('orders')
            .where('tableNumber', '==', tableNumber)
            .get()
            .then((orderDocs) => {
              if (!orderDocs.empty) {
                console.log(`Found ${orderDocs.docs.length} orders for table ${tableNumber}`);
                
                // Categorize orders by status
                let pendingOrdersFound = false;
                
                orderDocs.forEach(doc => {
                  const orderData = doc.data();
                  console.log(`Processing order ${doc.id} with status: ${orderData.status}`);
                  
                  if (['pending', 'preparing', 'ready'].includes(orderData.status)) {
                    // For active orders, delete them completely instead of just marking as cancelled
                    // This helps prevent database clutter and improves performance
                    batch.delete(doc.ref);
                    pendingOrdersFound = true;
                    console.log(`Marked order ${doc.id} for deletion (active order)`);
                  } else if (orderData.status === 'completed') {
                    // Delete completed orders
                    batch.delete(doc.ref);
                    console.log(`Marked order ${doc.id} for deletion (completed order)`);
                  }
                });
                
                // Update table status
                const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
                batch.set(tableStatusRef, {
                  status: 'free',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedBy: {
                    username: localStorage.getItem('username') || 'system',
                    role: localStorage.getItem('staffRole') || 'system'
                  }
                });
                
                // Commit all changes in one batch
                return batch.commit().then(() => {
                  console.log('All Firebase updates completed for table release');
                  
                  // Only show a success notification if we actually canceled any pending orders
                  if (pendingOrdersFound) {
                    showNotification(
                      currentLanguage === 'ar' ? 'تم تحديث الطلبات' : 'Orders Removed',
                      currentLanguage === 'ar' 
                        ? 'تم حذف جميع الطلبات النشطة' 
                        : 'All active orders were deleted',
                      'success'
                    );
                  }
                  return true;
                });
              } else {
                // Just update the table status if no orders found
                const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
                batch.set(tableStatusRef, {
                  status: 'free',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedBy: {
                    username: localStorage.getItem('username') || 'system',
                    role: localStorage.getItem('staffRole') || 'system'
                  }
                });
                
                return batch.commit().then(() => {
                  console.log('Table status updated in Firebase');
                  return true;
                });
              }
            })
            .catch((error) => {
              console.error('Error during table release:', error);
              
              // Show error but don't block UI
              showNotification(
                currentLanguage === 'ar' ? 'تحذير' : 'Warning',
                currentLanguage === 'ar' 
                  ? 'تم تحرير الطاولة محليًا ولكن قد لا تتم مزامنة التغييرات مع الخادم'
                  : 'Table freed locally but changes may not sync with server',
                'warning'
              );
            });
        }
        
        return true;
      } else {
        console.log(`Table ${tableNumber} not found in occupied tables`);
        return false;
      }
    }
    
    function occupyTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      
      if (!tableNumber || isNaN(tableNumber)) {
        console.error('Invalid table number');
        return false;
      }
      
      // Check if user is a staff member
      if (userType !== 'staff' && userType !== 'admin') {
        console.error('Only staff can mark tables as occupied');
        return false;
      }
      
      // Check if this staff member is assigned to this table
      const currentStaffUsername = localStorage.getItem('username');
      const staffRole = localStorage.getItem('staffRole');
      console.log('Current staff username:', currentStaffUsername, 'Role:', staffRole);
      
      // Admins and managers can manage any table
      let canManageTable = userType === 'admin' || staffRole === 'manager';
      
      if (userType === 'staff' && currentStaffUsername && !canManageTable) {
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        console.log('Staff assignments for current user:', staffAssignments);
        
        // Check if this table is in any of the assigned ranges
        canManageTable = staffAssignments.some(assignment => {
          const inRange = tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
          console.log(`Checking if table ${tableNumber} is in range ${assignment.startTable}-${assignment.endTable}: ${inRange}`);
          return inRange;
        });
      }
      
      console.log(`Can manage table: ${canManageTable}`);
      
      if (!canManageTable) {
        showNotification(
          currentLanguage === 'ar' ? 'غير مسموح' : 'Not Authorized',
          currentLanguage === 'ar' 
            ? 'لا يمكنك إدارة هذه الطاولة لأنها ليست مخصصة لك' 
            : 'You cannot manage this table as it is not assigned to you',
          'error'
        );
        return false;
      }
      
      // Show a notification to indicate the action is in progress
      showNotification(
        currentLanguage === 'ar' ? 'جارٍ التحديث' : 'Updating',
        currentLanguage === 'ar' 
          ? `جارٍ تحديث حالة الطاولة ${tableNumber}...` 
          : `Updating table ${tableNumber} status...`,
        'info',
        1500 // Auto-close after 1.5 seconds
      );
      
      // Immediately update the UI for better responsiveness
      occupiedTables.add(tableNumber);
      
      // Initialize table details if they don't exist
      if (!tableDetails[tableNumber]) {
        tableDetails[tableNumber] = { orders: [] };
      }
      
      // Update UI immediately
      updateTablesDisplay();
      renderTablesOverview();
      
      // If the app is in Firebase mode, update the table status in Firebase
      if (db && typeof db.collection === 'function') {
        // Check first if the table is already marked as occupied in Firebase
        db.collection('tableStatus').doc(tableNumber.toString()).get()
          .then(doc => {
            // Create a batch for atomic updates
            const batch = db.batch();
            
            // Update the table status
            const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
            batch.set(tableStatusRef, {
              status: 'occupied',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: {
                username: currentStaffUsername || 'system',
                role: localStorage.getItem('staffRole') || 'system'
              }
            });
            
            // If the table was already occupied, we might want to check for existing orders
            if (doc.exists && doc.data().status === 'occupied') {
              // We'll just update the status without modifying any orders
              console.log(`Table ${tableNumber} was already marked as occupied in Firebase`);
            }
            
            // Commit all changes
            return batch.commit();
          })
          .then(() => {
            // Show success notification
            showNotification(
              currentLanguage === 'ar' ? 'تم تحديث حالة الطاولة' : 'Table Status Updated',
              currentLanguage === 'ar' 
                ? `تم تعيين الطاولة ${tableNumber} كمشغولة` 
                : `Table ${tableNumber} is now marked as Occupied`,
              'success'
            );
          })
          .catch(error => {
            console.error('Error updating table status in Firebase:', error);
            
            // Show warning that the local state was updated but the server might be out of sync
            showNotification(
              currentLanguage === 'ar' ? 'تحذير' : 'Warning',
              currentLanguage === 'ar' 
                ? 'تم تحديث الطاولة محليًا ولكن قد لا تتم مزامنة التغييرات مع الخادم'
                : 'Table marked as occupied locally but changes may not sync with server',
              'warning'
            );
          });
      } else {
        // If no Firebase, just show a success notification
        showNotification(
          currentLanguage === 'ar' ? 'تم تحديث حالة الطاولة' : 'Table Status Updated',
          currentLanguage === 'ar' 
            ? `تم تعيين الطاولة ${tableNumber} كمشغولة` 
            : `Table ${tableNumber} is now marked as Occupied`,
          'success'
        );
      }
      
      return true;
    }
    
    function closeTableModal(fromCancel = false) {
      // Fade out effect for smoother transition
      tableNumberModal.style.opacity = '0';
      
      // Reset UI elements after a short delay
      setTimeout(() => {
        tableNumberModal.style.display = 'none';
        tableNumberModal.style.opacity = '1'; // Reset opacity for next time
        
        // Reset input field and buttons
        tableNumberInput.value = '';
        
        // If this was called from cancel button in checkout flow, show feedback
        if (fromCancel) {
          showNotification(
            currentLanguage === 'ar' ? 'تم الإلغاء' : 'Cancelled',
            currentLanguage === 'ar' ? 'تم إلغاء عملية إدخال رقم الطاولة' : 'Table number entry cancelled',
            'info'
          );
        }
        
        // Reset button states
        const confirmButton = document.getElementById('confirm-table-btn');
        if (confirmButton) {
          confirmButton.textContent = currentLanguage === 'ar' ? 'تأكيد' : 'CONFIRM';
          confirmButton.disabled = false;
          confirmButton.style.background = '';
        }
      }, 300);
    }
    
    // Checkout
    // Track if an order is being processed to prevent duplicates
    let isOrderBeingProcessed = false;
    
    async function checkout() {
      // Prevent duplicate order submissions
      if (isOrderBeingProcessed) {
        console.log("Order submission already in progress, preventing duplicate");
        return;
      }
      if (cart.length === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'سلة فارغة' : 'Empty Cart',
          currentLanguage === 'ar' 
            ? 'الرجاء إضافة أصناف إلى سلتك أولاً'
            : 'Please add items to your cart first',
          'info'
        );
        return;
      }
      
      // For guest users, we'll use their specific userTableNumber
      const orderTableNumber = userTableNumber || tableNumber;
      
      // Verify table number exists
      if (!orderTableNumber) {
        showNotification(
          currentLanguage === 'ar' ? 'رقم الطاولة مطلوب' : 'Table Number Required',
          currentLanguage === 'ar' 
            ? 'الرجاء إدخال رقم الطاولة الخاص بك أولاً'
            : 'Please enter your table number first',
          'warning'
        );
        
        // Show table number input modal
        setTimeout(() => {
          showTableModal(true);
        }, 500);
        return;
      }
      
      // Check if table is still available
      try {
        const isAvailable = await checkTableAvailability(orderTableNumber);
        if (!isAvailable) {
          // Table is occupied, show error and ask for new table
          showNotification(
            currentLanguage === 'ar' ? "خطأ في الطاولة" : "Table Unavailable",
            currentLanguage === 'ar' 
              ? `الطاولة ${orderTableNumber} مشغولة. يرجى اختيار طاولة أخرى.`
              : `Table ${orderTableNumber} is occupied. Please choose another table.`,
            'error'
          );
          
          // Show table modal after a slight delay
          setTimeout(() => {
            showTableModal(true);
          }, 500);
          return;
        }
      } catch (error) {
        console.error("Error checking table availability:", error);
        // Continue with order process - we'll let createOrderInFirebase handle table validation again
      }
      
      // Set checkout button to loading state with visual feedback
      checkoutBtn.classList.add('checkout-loading');
      checkoutBtn.disabled = true;
      
      // Set flag to prevent duplicate submissions
      isOrderBeingProcessed = true;
      
      try {
        // Calculate total
        let subtotal = 0;
        cart.forEach(item => {
          subtotal += item.totalPrice;
        });
        
        const tax = subtotal * 0.08;
        const total = subtotal + tax;
        
        // Generate unique order identifier to help prevent duplicates
        const uniqueOrderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        
        // Prepare the order data
        const order = {
          clientId: clientId,
          items: JSON.parse(JSON.stringify(cart)), // Create deep copy to prevent mutation issues
          subtotal: subtotal,
          tax: tax,
          total: total,
          status: 'pending',
          tableNumber: orderTableNumber, // Use the order-specific table number
          estimatedTime: estimatedTime,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          uniqueId: uniqueOrderId, // Add unique identifier
          orderedTime: new Date().toISOString() // Add ISO string date for additional uniqueness
        };
        
        // Show processing notification to improve perceived responsiveness
        showNotification(
          currentLanguage === 'ar' ? 'جارٍ المعالجة' : 'Processing',
          currentLanguage === 'ar' 
            ? 'جارٍ معالجة طلبك...' 
            : 'Processing your order...',
          'info',
          3000
        );
        
        // Create the order in Firebase
        const orderId = await createOrderInFirebase(order);
        
        if (!orderId) {
          // If order creation failed
          throw new Error("Failed to create order in Firebase");
        }
        
        // Mark table as occupied locally for immediate feedback
        occupiedTables.add(orderTableNumber);
        
        // Update estimated time for next order (kitchen load simulation)
        estimatedTime = Math.min(estimatedTime + 5, 60); // Increase by 5 mins, max 60
        updateEstimatedTime();
        
        // Show success notification
        showNotification(
          currentLanguage === 'ar' ? 'تم الطلب بنجاح' : 'Order Placed',
          currentLanguage === 'ar' 
            ? `تم تقديم طلبك بنجاح!` 
            : `Your order has been successfully placed!`,
          'success'
        );
        
        // Clear cart
        cart = [];
        updateCartDisplay();
        
        // Close cart panel
        toggleCart();
        
        // Auto show the client orders panel with a slight delay for better UX
        setTimeout(() => {
          clientOrders.classList.add('active');
          renderClientOrders();
        }, 800);
        
      } catch (error) {
        console.error('Error placing order:', error);
        // Show detailed error notification
        showNotification(
          currentLanguage === 'ar' ? 'خطأ في الطلب' : 'Order Error',
          currentLanguage === 'ar' 
            ? 'حدث خطأ أثناء تقديم طلبك. يرجى المحاولة مرة أخرى.'
            : error.message || 'There was an error placing your order. Please try again.',
          'error'
        );
      } finally {
        // Reset checkout button state and order processing flag
        checkoutBtn.classList.remove('checkout-loading');
        checkoutBtn.disabled = false;
        isOrderBeingProcessed = false;
      }
    }
    
    function updateEstimatedTime() {
      estimatedTimeEl.textContent = `${estimatedTime} ${currentLanguage === 'ar' ? 'دقائق' : 'minutes'}`;
      staffEstimatedTimeEl.textContent = `${estimatedTime} ${currentLanguage === 'ar' ? 'دقائق' : 'minutes'}`;
    }
    
    // Order Management
    function setupOrderListeners() {
      // Listen for orders in real-time
      db.collection('orders')
        .onSnapshot((snapshot) => {
          // Track which tables are occupied
          const newOccupiedTables = new Set();
          const newTableDetails = {};
          
          snapshot.forEach(doc => {
            const orderData = doc.data();
            
            // We only care about current client's orders for the client view
            if (orderData.clientId === clientId) {
              // Render client orders if needed
              if (clientOrders.classList.contains('active')) {
                renderClientOrders();
              }
              
              // Show notifications for status changes
              if (orderData.status === 'preparing') {
                showNotification(
                  currentLanguage === 'ar' ? 'طلبك قيد التحضير' : 'Order Preparing',
                  currentLanguage === 'ar' 
                    ? `طلبك رقم ${orderData.id} قيد التحضير الآن` 
                    : `Your order #${orderData.id} is now being prepared`,
                  'info'
                );
              } else if (orderData.status === 'ready') {
                showNotification(
                  currentLanguage === 'ar' ? 'طلبك جاهز' : 'Order Ready',
                  currentLanguage === 'ar' 
                    ? `طلبك رقم ${orderData.id} جاهز للاستلام` 
                    : `Your order #${orderData.id} is ready for pickup`,
                  'success'
                );
              } else if (orderData.status === 'completed' && !orderData.rated) {
                // Show rating modal for completed orders that haven't been rated
                currentOrderForRating = orderData.id;
                showRatingModal();
              }
            }
            
            // Track occupied tables for pending/preparing/ready orders
            if (orderData.tableNumber && typeof orderData.tableNumber === 'number' && 
                ['pending', 'preparing', 'ready'].includes(orderData.status)) {
              newOccupiedTables.add(orderData.tableNumber);
              
              // Build table details for staff view
              if (!newTableDetails[orderData.tableNumber]) {
                newTableDetails[orderData.tableNumber] = [];
              }
              
              newTableDetails[orderData.tableNumber].push({
                id: orderData.id,
                status: orderData.status,
                items: orderData.items,
                total: orderData.total,
                createdAt: orderData.createdAt
              });
            }
          });
          
          // Update occupied tables
          occupiedTables = newOccupiedTables;
          tableDetails = newTableDetails;
          
          if (userType === "staff") {
            renderOrders();
            renderTablesOverview();
          } else if (userType === "admin") {
            renderAdminDashboard();
          }
        }, (error) => {
          console.error("Error setting up order listener:", error);
        });
    }
    
    async function fetchOrders() {
      try {
        // Fetch all pending/preparing/ready orders to track occupied tables
        const ordersSnapshot = await db.collection('orders')
          .where('status', 'in', ['pending', 'preparing', 'ready'])
          .get();
        
        const occupiedTablesSet = new Set();
        const tableDetailsObj = {};
        
        ordersSnapshot.forEach(doc => {
          const orderData = doc.data();
          
          if (orderData.tableNumber && typeof orderData.tableNumber === 'number') {
            occupiedTablesSet.add(orderData.tableNumber);
            
            // Build table details for staff view
            if (!tableDetailsObj[orderData.tableNumber]) {
              tableDetailsObj[orderData.tableNumber] = [];
            }
            
            tableDetailsObj[orderData.tableNumber].push({
              id: orderData.id,
              status: orderData.status,
              items: orderData.items,
              total: orderData.total,
              createdAt: orderData.createdAt
            });
          }
        });
        
        occupiedTables = occupiedTablesSet;
        tableDetails = tableDetailsObj;
        
      } catch (error) {
        console.error("Error fetching orders:", error);
      }
    }
    
    function renderOrders(retryAttempt = 0) {
      console.log(`Rendering orders (retry attempt: ${retryAttempt})`);
      const ordersList = document.getElementById('orders-list');
      
      // Show loading indicator
      ordersList.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--light-cream);"></i>
          <p style="margin-top: 10px; color: var(--light-cream);">${currentLanguage === 'ar' ? 'جاري تحميل الطلبات...' : 'Loading orders...'}</p>
        </div>
      `;
      
      // Verify Firebase connection before proceeding
      if (!db || typeof db.collection !== 'function') {
        console.error("Firebase database not initialized");
        ordersList.innerHTML = `
          <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'خطأ: قاعدة البيانات غير متصلة' : 'Error: Database not connected'}</p>
          <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'إعادة المحاولة' : 'Retry'}
          </button>
        `;
        return;
      }
      
      // Maximum retry attempts
      const MAX_RETRIES = 3;
      
      try {
        // Define a function to fetch orders with fallback for missing index errors
        const fetchOrders = async () => {
          try {
            // Get the current staff username
            const staffUsername = localStorage.getItem('username');
            console.log("Current staff username for tables:", staffUsername);
            
            // For manager role - show all orders
            if (localStorage.getItem('staffRole') === 'manager' || userType === 'admin') {
              // Manager sees all orders
              return await db.collection('orders')
                .where('status', 'in', ['pending', 'preparing', 'ready'])
                .get();
            } 
            
            // For other staff - get their assigned tables
            const assignedTables = [];
            tableAssignments.forEach(assignment => {
              if (assignment.staffUsername === staffUsername) {
                // Add all tables in their range
                for (let i = assignment.startTable; i <= assignment.endTable; i++) {
                  assignedTables.push(i);
                }
              }
            });
            
            console.log("Staff assigned tables:", assignedTables);
            
            // Get orders that are active, then we'll filter for staff's tables
            // This works without a composite index
            const allActiveOrders = await db.collection('orders')
              .where('status', 'in', ['pending', 'preparing', 'ready'])
              .get();
              
            // We need to manually filter for the staff's assigned tables
            if (assignedTables.length > 0) {
              // Create a filtered snapshot like object
              const filteredDocs = [];
              
              allActiveOrders.forEach(doc => {
                const data = doc.data();
                if (assignedTables.includes(data.tableNumber)) {
                  filteredDocs.push(doc);
                }
              });
              
              return {
                empty: filteredDocs.length === 0,
                docs: filteredDocs,
                forEach: callback => filteredDocs.forEach(callback)
              };
            }
            
            return allActiveOrders;
          } catch (error) {
            // Check if it's a missing index error
            if (error.code === 'failed-precondition') {
              console.log("Missing composite index for orders. Using fallback method.");
              
              // Fallback approach: get all orders and filter in memory
              const allOrders = await db.collection('orders').get();
              
              // Filter the documents manually
              const filteredDocs = [];
              
              allOrders.forEach(doc => {
                const data = doc.data();
                if (data.status === 'pending' || data.status === 'preparing' || data.status === 'ready') {
                  filteredDocs.push(doc);
                }
              });
              
              // Sort by creation date if available
              filteredDocs.sort((a, b) => {
                const aData = a.data();
                const bData = b.data();
                
                if (aData.createdAt && bData.createdAt) {
                  return bData.createdAt.seconds - aData.createdAt.seconds;
                }
                return 0;
              });
              
              // Create a snapshot-like object
              return {
                empty: filteredDocs.length === 0,
                docs: filteredDocs,
                forEach: callback => filteredDocs.forEach(callback)
              };
            }
            
            // For other errors, just re-throw
            throw error;
          }
        };
        
        // Use our fetchOrders function
        fetchOrders().then((querySnapshot) => {
            if (querySnapshot.empty) {
              ordersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'لا توجد طلبات نشطة' : 'No active orders'}</p>`;
              return;
            }
          
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            // Make sure order has an ID from the document
            order.id = doc.id;
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.dataset.orderId = doc.id; // Add data attribute for order ID
            
            // Format timestamp
            let timestampStr = '';
            if (order.createdAt) {
              const timestamp = order.createdAt.toDate();
              timestampStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Generate status class and text
            let statusClass = '';
            let statusText = '';
            
            switch (order.status) {
              case 'pending':
                statusClass = 'status-pending';
                statusText = currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending';
                break;
              case 'preparing':
                statusClass = 'status-preparing';
                statusText = currentLanguage === 'ar' ? 'قيد التحضير' : 'Preparing';
                break;
              case 'ready':
                statusClass = 'status-ready';
                statusText = currentLanguage === 'ar' ? 'جاهز' : 'Ready';
                break;
            }
            
            // Create HTML for order items
            let itemsHtml = '';
            order.items.forEach(item => {
              itemsHtml += `
                <div class="order-item">
                  <span>${item.name} ${item.extras ? `(${item.extras})` : ''}</span>
                  <span>$${item.totalPrice.toFixed(2)}</span>
                </div>
              `;
            });
            
            // Check for assigned staff - first check if order has assignedStaff object
            // Then check for direct properties, then check table assignments
            let assignedStaffName = null;
            let assignedStaffRole = null;
            
            // Check different ways staff might be assigned to the order
            if (order.assignedStaff) {
              // Get from new assignedStaff object
              assignedStaffName = order.assignedStaff.name;
              assignedStaffRole = order.assignedStaff.role;
            } else if (order.assignedStaffName) {
              // Get from older direct properties
              assignedStaffName = order.assignedStaffName;
              assignedStaffRole = order.assignedStaffRole;
            } else if (order.tableNumber) {
              // As a fallback, check table assignments
              const tableStaff = getStaffForTable(order.tableNumber);
              if (tableStaff) {
                assignedStaffName = tableStaff.name;
                assignedStaffRole = tableStaff.role;
              }
            }
            
            // Create assigned staff info HTML if available
            const assignedStaffHtml = assignedStaffName ? `
              <div class="assigned-staff-info">
                <span style="color: #ffc107;">
                  <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'الموظف المسؤول' : 'Assigned Staff'}:
                </span>
                <span>${assignedStaffName} 
                  ${assignedStaffRole ? `<span class="staff-role-badge role-${assignedStaffRole}">${assignedStaffRole}</span>` : ''}
                </span>
              </div>
            ` : '';
            
            // Create HTML for the order card
            orderCard.innerHTML = `
              <div class="order-header">
                <div class="order-id">${currentLanguage === 'ar' ? 'طلب' : 'Order'} #${order.id.slice(-4).toUpperCase()} - ${currentLanguage === 'ar' ? 'طاولة' : 'Table'} ${order.tableNumber}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
              </div>
              <div class="order-time">${timestampStr}</div>
              ${assignedStaffHtml}
              <div class="order-items">
                ${itemsHtml}
              </div>
              <div class="order-total" style="text-align: right; font-weight: bold; margin-top: 5px;">
                ${currentLanguage === 'ar' ? 'الإجمالي' : 'Total'}: $${order.total.toFixed(2)}
              </div>
              <div class="order-actions">
                ${order.status === 'pending' ? `
                  <button class="action-btn" style="background: #2196F3; color: white;" onclick="updateOrderStatus('${order.id}', 'preparing')">
                    ${currentLanguage === 'ar' ? 'بدء التحضير' : 'Start Preparing'}
                  </button>
                ` : ''}
                ${order.status === 'preparing' ? `
                  <button class="action-btn" style="background: #4CAF50; color: white;" onclick="updateOrderStatus('${order.id}', 'ready')">
                    ${currentLanguage === 'ar' ? 'تحديد كجاهز' : 'Mark Ready'}
                  </button>
                ` : ''}
                ${order.status === 'ready' ? `
                  <button class="action-btn" style="background: #9E9E9E; color: white;" onclick="updateOrderStatus('${order.id}', 'completed')">
                    ${currentLanguage === 'ar' ? 'إكمال' : 'Complete'}
                  </button>
                ` : ''}
                <button class="action-btn" style="background: #FF5722; color: white;" onclick="cancelOrder('${order.id}')">
                  ${currentLanguage === 'ar' ? 'إلغاء' : 'Cancel'}
                </button>
              </div>
            `;
            
            ordersList.appendChild(orderCard);
          });
        })
        .catch((error) => {
          console.error("Error fetching orders:", error);
          
          // If this is not the final retry attempt, try again
          if (retryAttempt < MAX_RETRIES) {
            console.log(`Retrying order fetch (attempt ${retryAttempt + 1} of ${MAX_RETRIES})...`);
            setTimeout(() => {
              renderOrders(retryAttempt + 1);
            }, 1000); // Wait 1 second before retrying
            return;
          }
          
          // Show error with retry button
          ordersList.innerHTML = `
            <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'خطأ في تحميل الطلبات' : 'Error loading orders'}</p>
            <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'إعادة المحاولة' : 'Retry'}
            </button>
          `;
        });
      } catch (error) {
        console.error("Fatal error in renderOrders:", error);
        
        // Show error with retry button
        ordersList.innerHTML = `
          <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'خطأ في تحميل الطلبات' : 'Error loading orders'}</p>
          <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'إعادة المحاولة' : 'Retry'}
          </button>
        `;
      }
    }
    
    function renderTablesOverview() {
      // Clear the existing grid
      tablesGrid.innerHTML = '';
      
      // Get current staff username if we're in staff view
      const currentStaffUsername = userType === 'staff' ? localStorage.getItem('username') : null;
      console.log("Current staff username for tables:", currentStaffUsername);
      
      // Filter for tables assigned to current staff member if we're in staff view
      let tablesToShow = [];
      
      if (userType === 'staff' && currentStaffUsername) {
        // Get table assignments for this staff member
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        
        // Create an array of all table numbers assigned to this staff member
        const assignedTables = [];
        staffAssignments.forEach(assignment => {
          for (let t = assignment.startTable; t <= assignment.endTable; t++) {
            assignedTables.push(t);
          }
        });
        
        // Filter occupied tables to only show those assigned to this staff
        tablesToShow = Array.from(occupiedTables).filter(tableNum => 
          assignedTables.includes(parseInt(tableNum))
        ).sort((a, b) => a - b);
      } else {
        // For admin view, show all occupied tables
        tablesToShow = Array.from(occupiedTables).sort((a, b) => a - b);
      }
      
      if (tablesToShow.length === 0) {
        tablesGrid.innerHTML = `<p style="grid-column: 1 / -1; color: var(--light-cream);">${
          currentLanguage === 'ar' ? 'لا توجد طاولات مشغولة' : 
          (userType === 'staff' ? 'No occupied tables assigned to you' : 'No occupied tables')
        }</p>`;
        return;
      }
      
      // Show the tables
      tablesToShow.forEach(tableNum => {
        const tableData = tableDetails[tableNum];
        const tableEl = document.createElement('div');
        tableEl.className = `table-item ${tableData ? 'occupied' : ''}`;
        tableEl.onclick = () => showTableDetails(tableNum);
        
        let statusText = currentLanguage === 'ar' ? 'متاحة' : 'Available';
        let statusClass = '';
        
        if (tableData) {
          statusText = currentLanguage === 'ar' ? 'مشغولة' : 'Occupied';
          statusClass = 'status-occupied';
        }
        
        tableEl.innerHTML = `
          <div class="table-number">${tableNum}</div>
          <div class="table-status-indicator ${statusClass}"></div>
        `;
        
        tablesGrid.appendChild(tableEl);
      });
    }
    
    function showTableDetails(tableNum) {
      tableDetailsTitle.textContent = `${currentLanguage === 'ar' ? 'الطاولة' : 'TABLE'} ${tableNum}`;
      
      // Check if this table has an assigned staff member
      const assignedStaff = getStaffForTable(tableNum);
      let staffInfoHtml = '';
      
      if (assignedStaff) {
        staffInfoHtml = `
          <div style="margin-bottom: 10px; text-align: center; padding: 8px; background: rgba(33, 33, 33, 0.5); border-radius: 8px;">
            <div style="font-size: 0.85rem; color: #ffc107;">
              <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'الموظف المسؤول' : 'Assigned Staff'}:
            </div>
            <div style="font-weight: bold;">
              ${assignedStaff.name} 
              <span class="staff-role-badge role-${assignedStaff.role}">${assignedStaff.role}</span>
            </div>
          </div>
        `;
      }
      
      // Add staff info to the modal
      const tableStaffInfo = document.getElementById('table-staff-info');
      if (tableStaffInfo) {
        tableStaffInfo.innerHTML = staffInfoHtml;
      }
      
      // Add table status management controls for staff
      const isStaffOrAdmin = userType === 'staff' || userType === 'admin';
      const tableActionButtons = document.getElementById('table-action-buttons');
      
      if (tableActionButtons && isStaffOrAdmin) {
        // Check if the current staff member is assigned to this table
        const currentStaffUsername = localStorage.getItem('username');
        let canManageTable = userType === 'admin'; // Admins can manage any table
        
        if (userType === 'staff' && currentStaffUsername) {
          const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
          
          // Check if this table is in any of the assigned ranges
          canManageTable = staffAssignments.some(assignment => 
            parseInt(tableNum) >= assignment.startTable && parseInt(tableNum) <= assignment.endTable
          );
        }
        
        // Only show management controls if staff is assigned to this table
        if (canManageTable) {
          const isOccupied = occupiedTables.has(parseInt(tableNum));
          tableActionButtons.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button 
                onclick="markTableStatus(${tableNum}, '${isOccupied ? 'free' : 'occupied'}')" 
                class="table-action-btn ${isOccupied ? 'free-table-btn' : 'occupy-table-btn'}">
                <i class="fas fa-${isOccupied ? 'check-circle' : 'utensils'}"></i>
                ${isOccupied 
                  ? (currentLanguage === 'ar' ? 'تحرير الطاولة' : 'MARK AS FREE') 
                  : (currentLanguage === 'ar' ? 'تعيين كمشغولة' : 'MARK AS OCCUPIED')}
              </button>
            </div>
          `;
        } else {
          tableActionButtons.innerHTML = '';
        }
      } else if (tableActionButtons) {
        tableActionButtons.innerHTML = '';
      }
      
      const orders = tableDetails[tableNum] || { orders: [] };
      
      if (!orders.orders || orders.orders.length === 0) {
        tableOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'لا توجد طلبات' : 'No orders'}</p>`;
      } else {
        tableOrdersList.innerHTML = '';
        
        orders.orders.forEach(order => {
          const orderEl = document.createElement('div');
          orderEl.className = 'order-card';
          
          // Generate status class and text
          let statusClass = '';
          let statusText = '';
          
          switch (order.status) {
            case 'pending':
              statusClass = 'status-pending';
              statusText = currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending';
              break;
            case 'preparing':
              statusClass = 'status-preparing';
              statusText = currentLanguage === 'ar' ? 'قيد التحضير' : 'Preparing';
              break;
            case 'ready':
              statusClass = 'status-ready';
              statusText = currentLanguage === 'ar' ? 'جاهز' : 'Ready';
              break;
          }
          
          // Create HTML for order items
          let itemsHtml = '';
          order.items.forEach(item => {
            itemsHtml += `
              <div class="order-item">
                <span>${item.name} ${item.extras ? `(${item.extras})` : ''}</span>
                <span>$${item.totalPrice.toFixed(2)}</span>
              </div>
            `;
          });
          
          orderEl.innerHTML = `
            <div class="order-header">
              <div class="order-id">${currentLanguage === 'ar' ? 'طلب' : 'Order'} #${order.id.slice(-4).toUpperCase()}</div>
              <div class="order-status ${statusClass}">${statusText}</div>
            </div>
            <div class="order-items">
              ${itemsHtml}
            </div>
            <div class="order-total" style="text-align: right; font-weight: bold; margin-top: 5px;">
              ${currentLanguage === 'ar' ? 'الإجمالي' : 'Total'}: $${order.total.toFixed(2)}
            </div>
          `;
          
          tableOrdersList.appendChild(orderEl);
        });
      }
      
      tableDetailsModal.style.display = 'flex';
    }
    
    function closeTableDetails() {
      tableDetailsModal.style.display = 'none';
    }
    
    // Special function just for cancelling orders to make it more direct and reliable
    async function cancelOrder(orderId) {
      console.log(`Explicitly cancelling order ${orderId}`);
      
      // Get UI elements
      const targetCardElement = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if (targetCardElement) {
        targetCardElement.classList.add('updating');
      }
      
      // Show immediate notification
      showNotification(
        currentLanguage === 'ar' ? 'جارٍ الإلغاء' : 'Cancelling',
        currentLanguage === 'ar' 
          ? `جارٍ إلغاء الطلب...` 
          : `Cancelling order...`,
        'info',
        1500
      );
      
      try {
        // Verify Firebase connection
        if (!db || typeof db.collection !== 'function') {
          throw new Error("Firebase database not connected");
        }
        
        // Get the order document
        const orderRef = db.collection('orders').doc(orderId);
        const orderDoc = await orderRef.get();
        
        if (!orderDoc.exists) {
          throw new Error(`Order ${orderId} not found in database`);
        }
        
        const orderData = orderDoc.data();
        const tableNum = orderData.tableNumber;
        
        // No need for auth check for now - just cancel it
        
        // Delete the order directly
        await orderRef.delete();
        console.log(`Order ${orderId} has been deleted from the database`);
        
        // Remove from UI
        if (targetCardElement && targetCardElement.parentNode) {
          // Apply fade out animation
          targetCardElement.style.opacity = '0';
          targetCardElement.style.transform = 'scale(0.95)';
          
          // After animation, remove from DOM
          setTimeout(() => {
            if (targetCardElement.parentNode) {
              targetCardElement.parentNode.removeChild(targetCardElement);
            }
          }, 300);
        }
        
        // Check if we need to release the table
        releaseTable(tableNum);
        
        // Show success message
        showNotification(
          currentLanguage === 'ar' ? 'تم إلغاء الطلب' : 'Order Cancelled',
          currentLanguage === 'ar' 
            ? `تم إلغاء الطلب #${orderId.slice(-4).toUpperCase()} بنجاح` 
            : `Order #${orderId.slice(-4).toUpperCase()} has been cancelled successfully`,
          'success'
        );
        
        // Refresh orders
        setTimeout(() => {
          if (userType === 'staff' || userType === 'admin') {
            renderOrders();
          } else {
            renderClientOrders();
          }
        }, 800);
        
      } catch (error) {
        console.error("Error cancelling order:", error);
        
        // Show error message
        showNotification(
          currentLanguage === 'ar' ? 'خطأ في إلغاء الطلب' : 'Cancellation Failed',
          currentLanguage === 'ar' 
            ? `حدث خطأ أثناء إلغاء الطلب: ${error.message}` 
            : `Error cancelling order: ${error.message}`,
          'error'
        );
        
        // Reset card UI
        if (targetCardElement) {
          targetCardElement.classList.remove('updating');
        }
      }
    }
    
    async function updateOrderStatus(orderId, newStatus) {
      console.log(`Updating order ${orderId} to status: ${newStatus}`);
      
      // Immediately show "updating" notification to give feedback
      const targetCardElement = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if (targetCardElement) {
        targetCardElement.classList.add('updating');
      }
      
      // Get temporary status label for immediate feedback
      let tempStatusText = currentLanguage === 'ar' ? 
        getStatusTranslation(newStatus) : newStatus;
      
      // Show immediate notification of status change
      if (newStatus === 'cancelled') {
        showNotification(
          currentLanguage === 'ar' ? 'جارٍ الإلغاء' : 'Cancelling',
          currentLanguage === 'ar' 
            ? `جارٍ إلغاء الطلب...` 
            : `Cancelling order...`,
          'info',
          1500 // Auto-hide after 1.5 seconds
        );
      } else {
        showNotification(
          currentLanguage === 'ar' ? 'جارٍ التحديث' : 'Updating',
          currentLanguage === 'ar' 
            ? `جارٍ تحديث حالة الطلب إلى ${tempStatusText}...` 
            : `Updating order to ${tempStatusText}...`,
          'info',
          1500 // Auto-hide after 1.5 seconds
        );
      }
      
      try {
        // Verify Firebase connection
        if (!db || typeof db.collection !== 'function') {
          throw new Error("Firebase database not connected");
        }
        
        // Find the order to get table number and staff info
        const orderRef = db.collection('orders').doc(orderId);
        const orderDoc = await orderRef.get();
        
        if (!orderDoc.exists) {
          throw new Error(`Order ${orderId} not found in database`);
        }
        
        const orderData = orderDoc.data();
          
        if (!orderData) {
          console.error("Order not found");
          return;
        }
          
        // Get current staff role and username
        const staffRole = localStorage.getItem('staffRole');
        const staffUsername = localStorage.getItem('username');
        const isAdmin = userType === 'admin';
        const isManager = staffRole === 'manager';
          
        // Get staff info for the table and check table assignments
        const tableStaff = getStaffForTable(orderData.tableNumber);
        const tableNumber = parseInt(orderData.tableNumber);
          
        console.log('Checking permission for order update. Staff:', staffUsername, 'Role:', staffRole, 'Table:', tableNumber);
          
        // Admins and managers can update any order
        let canManageTable = isAdmin || isManager;
          
        if (userType === 'staff' && staffUsername && !canManageTable) {
          const staffAssignments = tableAssignments.filter(a => a.staffUsername === staffUsername);
          console.log('Staff assignments for current user:', staffAssignments);
            
          // Check if this table is in any of the assigned ranges
          canManageTable = staffAssignments.some(assignment => {
            const inRange = tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
            console.log(`Checking if table ${tableNumber} is in range ${assignment.startTable}-${assignment.endTable}: ${inRange}`);
            return inRange;
          });
        }
          
        console.log(`Can manage order: ${canManageTable}`);
          
        if (!canManageTable) {
          // If not authorized, revert UI changes
          if (targetCardElement) {
            targetCardElement.classList.remove('updating');
          }
              
          showNotification(
            currentLanguage === 'ar' ? 'ليس لديك صلاحية' : 'Not Authorized',
            currentLanguage === 'ar' 
              ? 'فقط الموظف المعين أو المدير يمكنه تغيير حالة هذا الطلب' 
              : 'Only the assigned staff or manager can change this order status',
            'error'
          );
          return;
        }
          
          // Update local display immediately for better UX
          if (targetCardElement) {
            const statusElement = targetCardElement.querySelector('.order-status');
            if (statusElement) {
              // Update the class
              statusElement.className = `order-status status-${newStatus}`;
              // Update the text
              statusElement.textContent = tempStatusText;
            }
            
            // Hide actions that don't make sense anymore
            if (newStatus === 'cancelled' || newStatus === 'completed') {
              const actionsElement = targetCardElement.querySelector('.order-actions');
              if (actionsElement) {
                actionsElement.innerHTML = `<div class="order-status-info">${
                  currentLanguage === 'ar' ? 
                    (newStatus === 'cancelled' ? 'تم إلغاء الطلب' : 'تم إكمال الطلب') :
                    (newStatus === 'cancelled' ? 'Order cancelled' : 'Order completed')
                }</div>`;
              }
            }
            
            // Remove the updating style
            targetCardElement.classList.remove('updating');
          }
          
          // Check if the order already has the new assignedStaff structure
          const updateData = {
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            staffId: currentStaff
          };
          
          // Add assigned staff info to the update
          if (tableStaff) {
            if (orderData.assignedStaff) {
              // Use the new structure if it exists
              updateData.assignedStaff = {
                name: tableStaff.name,
                username: tableStaff.username,
                role: tableStaff.role
              };
            } else {
              // Fallback to old structure for compatibility
              updateData.assignedStaffName = tableStaff.name;
              updateData.assignedStaffUsername = tableStaff.username;
              updateData.assignedStaffRole = tableStaff.role;
            }
          }
          
          // If order is completed, add completion time to calculate deletion time
          if (newStatus === 'completed') {
            updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
            // For completed orders, we need to show rating for users
            if (orderData.tableNumber === tableNumber) {
              // If this is the user's table, show rating dialog after status update
              setTimeout(() => {
                showRatingDialog(orderId);
              }, 1000);
            }
          }
          
          // For cancelled orders, actually delete them rather than just updating status
          if (newStatus === 'cancelled') {
            // Delete the order completely
            await db.collection('orders').doc(orderId).delete();
            
            console.log(`Order ${orderId} has been deleted from the database`);
            
            // Remove from local UI if needed
            if (targetCardElement && targetCardElement.parentNode) {
              // Apply fade out animation
              targetCardElement.style.opacity = '0';
              targetCardElement.style.transform = 'scale(0.95)';
              
              // After animation, remove from DOM
              setTimeout(() => {
                if (targetCardElement.parentNode) {
                  targetCardElement.parentNode.removeChild(targetCardElement);
                }
              }, 300);
            }
            
            // Release the table
            releaseTable(orderData.tableNumber);
          } else {
            // For other statuses, just update the order
            await db.collection('orders').doc(orderId).update(updateData);
            
            // If order is completed, release the table
            if (newStatus === 'completed') {
              // No need to wait for this, let it happen in background
              releaseTable(orderData.tableNumber);
            }
          }
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? 'تم تحديث الطلب' : 'Order Updated',
            currentLanguage === 'ar' 
              ? `تم تحديث حالة الطلب #${orderId.slice(-4).toUpperCase()} إلى ${getStatusTranslation(newStatus)}` 
              : `Order #${orderId.slice(-4).toUpperCase()} updated to ${newStatus}`,
            'success'
          );
        } catch (error) {
          console.error("Error updating order:", error);
          showNotification(
            currentLanguage === 'ar' ? 'خطأ في تحديث الطلب' : 'Order Update Failed',
            currentLanguage === 'ar' ? "حدث خطأ أثناء تحديث الطلب" : "There was an error while updating the order: " + error.message,
            'error'
          );
          
          // Reset the card if there was an error
          if (targetCardElement) {
            targetCardElement.classList.remove('updating');
          }
        } finally {
          // Refresh the orders display after update regardless of success/failure
          setTimeout(() => {
            if (userType === 'staff' || userType === 'admin') {
              renderOrders();
            } else {
              renderClientOrders();
            }
          }, 800);
        }
    }
    
    function getStatusTranslation(status) {
      if (currentLanguage === 'ar') {
        switch (status) {
          case 'pending': return 'قيد الانتظار';
          case 'preparing': return 'قيد التحضير';
          case 'ready': return 'جاهز';
          case 'completed': return 'مكتمل';
          case 'cancelled': return 'ملغي';
          default: return status;
        }
      }
      return status;
    }
    
    // Function to mark a table as free or occupied
    function markTableStatus(tableNum, status) {
      const tableNumber = parseInt(tableNum);
      
      if (isNaN(tableNumber)) {
        console.error('Invalid table number');
        return;
      }
      
      console.log(`Attempting to mark table ${tableNumber} as ${status}`);
      
      // Check if the current staff is assigned to this table
      const currentStaffUsername = localStorage.getItem('username');
      const staffRole = localStorage.getItem('staffRole');
      console.log('Current staff username:', currentStaffUsername, 'Role:', staffRole);
      
      // Admins and managers can manage any table
      let canManageTable = userType === 'admin' || staffRole === 'manager';
      
      if (userType === 'staff' && currentStaffUsername && !canManageTable) {
        console.log('Table assignments:', tableAssignments);
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        console.log('Staff assignments for current user:', staffAssignments);
        
        // Check if this table is in any of the assigned ranges
        canManageTable = staffAssignments.some(assignment => {
          const inRange = tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
          console.log(`Checking if table ${tableNumber} is in range ${assignment.startTable}-${assignment.endTable}: ${inRange}`);
          return inRange;
        });
      }
      
      console.log(`Can manage table: ${canManageTable}`);
      
      if (!canManageTable) {
        showNotification(
          currentLanguage === 'ar' ? 'غير مسموح' : 'Not Authorized',
          currentLanguage === 'ar' 
            ? 'لا يمكنك إدارة هذه الطاولة لأنها ليست مخصصة لك' 
            : 'You cannot manage this table as it is not assigned to you',
          'error'
        );
        return;
      }
      
      // Update table status based on the requested action
      if (status === 'free') {
        console.log(`Releasing table ${tableNumber}`);
        if (releaseTable(tableNumber)) {
          showNotification(
            currentLanguage === 'ar' ? 'تم تحديث حالة الطاولة' : 'Table Status Updated',
            currentLanguage === 'ar' 
              ? `تم تحرير الطاولة ${tableNumber}` 
              : `Table ${tableNumber} is now marked as Free`,
            'success'
          );
        } else {
          console.log(`Failed to release table ${tableNumber}`);
        }
      } else if (status === 'occupied') {
        console.log(`Occupying table ${tableNumber}`);
        if (occupyTable(tableNumber)) {
          showNotification(
            currentLanguage === 'ar' ? 'تم تحديث حالة الطاولة' : 'Table Status Updated',
            currentLanguage === 'ar' 
              ? `تم تعيين الطاولة ${tableNumber} كمشغولة` 
              : `Table ${tableNumber} is now marked as Occupied`,
            'success'
          );
        } else {
          console.log(`Failed to occupy table ${tableNumber}`);
        }
      }
      
      // Close the table details modal
      closeTableDetails();
      
      // Update displays
      updateTablesDisplay();
      renderTablesOverview();
    }
    
    // Rating system functions
    // currentRating is already declared above, so we're not redeclaring it
    
    function showRatingDialog(orderId) {
      // Get order details to fetch staff name
      db.collection('orders').doc(orderId).get()
        .then(doc => {
          if (!doc.exists) {
            console.error("Order not found for rating");
            return;
          }
          
          const orderData = doc.data();
          let staffName = '';
          
          // Check different ways staff might be assigned
          if (orderData.assignedStaff) {
            staffName = orderData.assignedStaff.name;
          } else if (orderData.assignedStaffName) {
            staffName = orderData.assignedStaffName;
          }
          
          // Reset any previous rating
          currentRating = 0;
          
          // Reset rating stars
          const ratingStars = document.querySelectorAll(".rating-star");
          ratingStars.forEach(star => star.classList.remove('active'));
          
          // Hide feedback container initially
          document.getElementById('feedback-container').style.display = 'none';
          
          // Store order ID and staff name in hidden fields
          document.getElementById('rating-order-id').value = orderId;
          document.getElementById('rating-staff-name').value = staffName;
          
          // Update text labels based on language
          document.getElementById('rating-title').textContent = 
            currentLanguage === 'ar' ? 'قيم تجربتك' : 'RATE YOUR EXPERIENCE';
          
          document.getElementById('feedback-label').textContent = 
            currentLanguage === 'ar' ? 'تعليقات (اختياري)' : 'FEEDBACK (OPTIONAL)';
          
          document.getElementById('submit-rating-btn').textContent = 
            currentLanguage === 'ar' ? 'إرسال' : 'SUBMIT';
          
          document.getElementById('cancel-rating-btn').textContent = 
            currentLanguage === 'ar' ? 'إلغاء' : 'CANCEL';
          
          // Setup rating star event handlers
          ratingStars.forEach(star => {
            star.addEventListener('click', () => {
              const rating = parseInt(star.getAttribute('data-rating'));
              currentRating = rating;
              
              // Update stars visually
              ratingStars.forEach(s => {
                if (parseInt(s.getAttribute('data-rating')) <= rating) {
                  s.classList.add('active');
                } else {
                  s.classList.remove('active');
                }
              });
              
              // If rating is 3 or less, show feedback container
              const feedbackContainer = document.getElementById('feedback-container');
              if (rating <= 3) {
                feedbackContainer.style.display = 'block';
                // Clear previous feedback
                document.getElementById('feedback-text').value = '';
              } else {
                feedbackContainer.style.display = 'none';
              }
            });
          });
          
          // Show the rating modal
          const ratingModal = document.getElementById('rating-modal');
          ratingModal.style.display = 'flex';
        })
        .catch(error => {
          console.error("Error getting order for rating:", error);
        });
    }
    
    function closeRatingDialog() {
      document.getElementById('rating-modal').style.display = 'none';
    }
    
    function submitRating() {
      if (currentRating === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'تقييم مطلوب' : 'Rating Required',
          currentLanguage === 'ar' ? 'يرجى تحديد تقييم قبل الإرسال' : 'Please select a rating before submitting',
          'warning'
        );
        return;
      }
      
      const orderId = document.getElementById('rating-order-id').value;
      const staffName = document.getElementById('rating-staff-name').value;
      const feedback = document.getElementById('feedback-text').value;
      
      // Create rating object
      const ratingData = {
        orderId: orderId,
        rating: currentRating,
        staffName: staffName,
        feedback: feedback || '', // Send empty string if no feedback
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        tableNumber: tableNumber,
        fromLanguage: currentLanguage
      };
      
      // Save to ratings collection in Firebase
      db.collection('ratings').add(ratingData)
        .then(() => {
          // Update order with rating info
          return db.collection('orders').doc(orderId).update({
            rated: true,
            rating: currentRating
          });
        })
        .then(() => {
          // Close the rating dialog
          closeRatingDialog();
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? 'شكراً على تقييمك' : 'Thank You for Your Rating',
            currentLanguage === 'ar' ? 'تم تسجيل تقييمك بنجاح' : 'Your feedback has been recorded successfully',
            'success'
          );
        })
        .catch(error => {
          console.error("Error saving rating:", error);
          
          showNotification(
            currentLanguage === 'ar' ? 'خطأ في التقييم' : 'Rating Error',
            currentLanguage === 'ar' ? 'حدث خطأ أثناء حفظ تقييمك' : 'There was an error saving your rating',
            'error'
          );
        });
    }
    
    // Function to clean up old completed orders (delete after 6 hours)
    async function cleanupCompletedOrders() {
      if (!db || typeof db.collection !== 'function') {
        console.warn("Database not available, skipping order cleanup");
        return;
      }

      console.log("Running cleanup of completed orders and fixing stuck orders");
      
      try {
        // Calculate cutoff times
        const sixHoursAgo = new Date();
        sixHoursAgo.setHours(sixHoursAgo.getHours() - 6);
        
        const twoHoursAgo = new Date();
        twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);
        
        // Create a batched write for efficiency
        const batch = db.batch();
        let documentCount = 0;
        const BATCH_LIMIT = 495; // Firestore limit is 500
        let hasDeletions = false;
        
        // CLEANUP TASK 1: Delete completed orders older than 6 hours
        try {
          const completedOrdersQuery = await db.collection('orders')
            .where('status', '==', 'completed')
            .get();
          
          completedOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if completedAt exists and is older than six hours
            if (data.completedAt && data.completedAt.toDate && data.completedAt.toDate() < sixHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.delete(doc.ref);
                documentCount++;
                hasDeletions = true;
              }
            }
          });
          
          console.log(`Found ${documentCount} old completed orders to delete`);
        } catch (error) {
          console.error("Error querying completed orders:", error);
          // Continue with other tasks
        }
        
        // CLEANUP TASK 2: Mark stale "pending" orders as cancelled after 2 hours
        try {
          const stuckPendingOrdersQuery = await db.collection('orders')
            .where('status', '==', 'pending')
            .get();
          
          let stuckPendingCount = 0;
          stuckPendingOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if the pending order is older than 2 hours
            if (data.createdAt && data.createdAt.toDate && data.createdAt.toDate() < twoHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.update(doc.ref, {
                  status: 'cancelled',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  systemCancelled: true,
                  cancellationReason: 'Automatically cancelled after 2 hours in pending state'
                });
                documentCount++;
                stuckPendingCount++;
              }
            }
          });
          
          console.log(`Found ${stuckPendingCount} stuck pending orders to auto-cancel`);
        } catch (error) {
          console.error("Error processing stuck pending orders:", error);
        }
        
        // CLEANUP TASK 3: Clean up cancelled orders older than 12 hours
        try {
          const twelvehHoursAgo = new Date();
          twelvehHoursAgo.setHours(twelvehHoursAgo.getHours() - 12);
          
          const cancelledOrdersQuery = await db.collection('orders')
            .where('status', '==', 'cancelled')
            .get();
          
          let cancelledCount = 0;
          cancelledOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if the cancelled order is older than 12 hours
            if (data.updatedAt && data.updatedAt.toDate && data.updatedAt.toDate() < twelvehHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.delete(doc.ref);
                documentCount++;
                cancelledCount++;
                hasDeletions = true;
              }
            }
          });
          
          console.log(`Found ${cancelledCount} old cancelled orders to delete`);
        } catch (error) {
          console.error("Error cleaning up cancelled orders:", error);
        }
        
        // Commit changes if any documents were processed
        if (documentCount > 0) {
          await batch.commit();
          console.log(`Database cleanup successful: Processed ${documentCount} documents`);
          
          // If we deleted orders, check if any tables can be released
          if (hasDeletions) {
            checkAndReleaseEmptyTables();
          }
        } else {
          console.log("No documents needed cleanup");
        }
        
      } catch (error) {
        console.error("Error during orders cleanup process:", error);
      }
    }
    
    // Check for tables that can be released (no active orders)
    async function checkAndReleaseEmptyTables() {
      try {
        // First get all occupied tables
        const tableStatusQuery = await db.collection('tableStatus')
          .where('status', '==', 'occupied')
          .get();
        
        // For each occupied table, check if it still has active orders
        tableStatusQuery.forEach(async (tableDoc) => {
          const tableNumber = tableDoc.id;
          
          try {
            // Check for any active orders for this table
            const activeOrdersQuery = await db.collection('orders')
              .where('tableNumber', '==', parseInt(tableNumber))
              .where('status', 'in', ['pending', 'preparing', 'ready'])
              .get();
            
            // If no active orders, release the table
            if (activeOrdersQuery.empty) {
              await db.collection('tableStatus').doc(tableNumber).update({
                status: 'free',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: { username: 'system', role: 'system' }
              });
              
              console.log(`Released table ${tableNumber} as it has no active orders`);
            }
          } catch (error) {
            console.error(`Error checking orders for table ${tableNumber}:`, error);
          }
        });
      } catch (error) {
        console.error("Error in checkAndReleaseEmptyTables:", error);
      }
    }
    
    // Run cleanup process every hour
    setInterval(cleanupCompletedOrders, 60 * 60 * 1000);
    
    // Client Orders
    // Flag to track if we're currently rendering client orders to prevent duplicate calls
    let isRenderingClientOrders = false;
    
    function renderClientOrders() {
      // Prevent multiple simultaneous renders
      if (isRenderingClientOrders) {
        console.log("Client orders already being rendered, skipping duplicate render");
        return;
      }
      
      // Set the flag to prevent duplicate renders
      isRenderingClientOrders = true;
      
      // Initial loading state - but only if there's no content already
      if (!clientOrdersList.querySelector('.client-order')) {
        clientOrdersList.innerHTML = `
          <div style="text-align: center; padding: 10px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 1rem; color: var(--light-cream);"></i>
            <p style="margin-top: 10px; color: var(--light-cream);">${currentLanguage === 'ar' ? 'جارٍ تحميل الطلبات...' : 'Loading orders...'}</p>
          </div>
        `;
      }
      
      // If we don't have a table number yet, don't show any orders
      if (!tableNumber) {
        clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'الرجاء تحديد رقم الطاولة أولاً' : 'Please select a table number first'}</p>`;
        isRenderingClientOrders = false;
        return;
      }
      
      // Verify Firebase connection
      if (!db || typeof db.collection !== 'function') {
        console.error("Firebase database not initialized");
        clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'خطأ: قاعدة البيانات غير متصلة' : 'Error: Database not connected'}</p>`;
        isRenderingClientOrders = false;
        return;
      }
      
      console.log(`Fetching orders for client ${clientId} at table ${tableNumber}`);
      
      // Track existing order elements to update them instead of recreating
      const existingOrderElements = {};
      document.querySelectorAll('.client-order').forEach(el => {
        const orderId = el.dataset.orderId;
        if (orderId) {
          existingOrderElements[orderId] = el;
        }
      });
      
      // Use a simpler query to get all orders for this client and table
      db.collection('orders')
        .where('tableNumber', '==', tableNumber)
        .where('clientId', '==', clientId)
        .get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'لا توجد طلبات نشطة' : 'No active orders'}</p>`;
            isRenderingClientOrders = false;
            return;
          }
          
          // Clear all existing messages first if we have orders
          const loadingMessage = clientOrdersList.querySelector('p');
          if (loadingMessage) {
            loadingMessage.remove();
          }
          
          // Keep track of order IDs we find and process to avoid duplicates
          const foundOrderIds = new Set();
          
          // First update existing order elements or create new ones as needed
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            order.id = doc.id; // Make sure the id is set
            foundOrderIds.add(doc.id);
            
            // Check if we already have this order in the UI
            let orderEl = existingOrderElements[doc.id];
            let isNewOrder = false;
            
            if (!orderEl) {
              // If not, create a new element
              isNewOrder = true;
              orderEl = document.createElement('div');
              orderEl.className = 'client-order order-card'; // Add order-card class for unified styling
              orderEl.dataset.orderId = doc.id; // Set dataset for easier selection
            }
            
            // Generate status class and text
            let statusClass = '';
            let statusText = '';
            
            switch (order.status) {
              case 'pending':
                statusClass = 'status-pending';
                statusText = currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending';
                break;
              case 'preparing':
                statusClass = 'status-preparing';
                statusText = currentLanguage === 'ar' ? 'قيد التحضير' : 'Preparing';
                break;
              case 'ready':
                statusClass = 'status-ready';
                statusText = currentLanguage === 'ar' ? 'جاهز' : 'Ready';
                break;
              case 'completed':
                statusClass = 'status-completed';
                statusText = currentLanguage === 'ar' ? 'مكتمل' : 'Completed';
                break;
              case 'cancelled':
                statusClass = 'status-cancelled';
                statusText = currentLanguage === 'ar' ? 'ملغي' : 'Cancelled';
                break;
            }
            
            // Format timestamp
            let timestampStr = '';
            if (order.createdAt) {
              const timestamp = order.createdAt.toDate();
              timestampStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Create HTML for order items
            let itemsHtml = '';
            order.items.forEach(item => {
              itemsHtml += `
                <div class="client-order-item">
                  <span>${item.name}</span>
                  <span>$${item.totalPrice.toFixed(2)}</span>
                </div>
              `;
            });
            
            // Check for assigned staff - handle both new and old format
            let assignedStaffName = null;
            let assignedStaffRole = null;
            
            // Check different ways staff might be assigned to the order
            if (order.assignedStaff) {
              // Get from new assignedStaff object
              assignedStaffName = order.assignedStaff.name;
              assignedStaffRole = order.assignedStaff.role;
            } else if (order.assignedStaffName) {
              // Get from older direct properties
              assignedStaffName = order.assignedStaffName;
              assignedStaffRole = order.assignedStaffRole;
            }
            
            // Create staff info HTML if available
            const assignedStaffHtml = assignedStaffName ? `
              <div style="margin: 8px 0; padding: 5px; background: rgba(50, 50, 50, 0.3); border-radius: 4px; font-size: 0.8rem;">
                <span style="color: #ffc107;">
                  <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'الموظف المسؤول' : 'Your Server'}:
                </span>
                <span>${assignedStaffName}</span>
              </div>
            ` : '';
            
            // Create simplified display of order number (just use last 4 chars and format nicely)
            const orderNumber = order.id.slice(-4).toUpperCase();
            
            // Create HTML for the order - simpler and more user-friendly display
            orderEl.innerHTML = `
              <div class="client-order-header">
                <div class="client-order-id">${currentLanguage === 'ar' ? 'طلب' : 'Order'} #${orderNumber}</div>
                <div class="client-order-status ${statusClass}">${statusText}</div>
              </div>
              <div style="font-size: 0.8rem; margin-bottom: 8px; color: var(--light-cream);">${timestampStr}</div>
              ${assignedStaffHtml}
              <div class="client-order-items">
                ${itemsHtml}
              </div>
              <div style="text-align: right; font-weight: bold; font-size: 0.85rem;">
                ${currentLanguage === 'ar' ? 'الإجمالي' : 'Total'}: $${order.total.toFixed(2)}
              </div>
              ${order.status === 'pending' ? `
                <button onclick="cancelOrder('${order.id}')" style="background: var(--red); margin-top: 8px; width: 100%;">
                  ${currentLanguage === 'ar' ? 'إلغاء الطلب' : 'CANCEL ORDER'}
                </button>
              ` : ''}
            `;
            
            // If it's a new order, add it to the DOM
            if (isNewOrder) {
              clientOrdersList.appendChild(orderEl);
            }
          });
          
          // Now remove any elements that are not in the current data
          Object.keys(existingOrderElements).forEach(id => {
            if (!foundOrderIds.has(id)) {
              // This order is no longer in the database, remove the element
              const elementToRemove = existingOrderElements[id];
              if (elementToRemove && elementToRemove.parentNode) {
                // Animate the removal
                elementToRemove.style.opacity = '0';
                elementToRemove.style.transform = 'scale(0.95)';
                
                // Remove after animation completes
                setTimeout(() => {
                  if (elementToRemove.parentNode) {
                    elementToRemove.parentNode.removeChild(elementToRemove);
                  }
                }, 300);
              }
            }
          });
          
          // If after processing there are no orders, show "no orders" message
          setTimeout(() => {
            if (clientOrdersList.children.length === 0) {
              clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'لا توجد طلبات نشطة' : 'No active orders'}</p>`;
            }
          }, 350); // Wait a bit longer than the animation to make sure all removals have completed
        })
        .catch((error) => {
          console.error("Error fetching client orders:", error);
          clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'خطأ في تحميل الطلبات' : 'Error loading orders'}</p>`;
        })
        .finally(() => {
          // Reset the rendering flag when done, regardless of success or failure
          setTimeout(() => {
            isRenderingClientOrders = false;
          }, 500); // Short delay to prevent too frequent re-renders
        });
    }
    
    function toggleClientOrders() {
      clientOrders.classList.toggle('active');
      if (clientOrders.classList.contains('active')) {
        renderClientOrders();
      }
    }
    
    // This client-side cancelOrder function now uses the main cancelOrder function
    // defined earlier in the code
    
    // Enhanced Notifications with better visibility and handling
    function showNotification(title, message, type = 'info') {
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      
      // Clear any existing notification timeout
      if (window.notificationTimeout) {
        clearTimeout(window.notificationTimeout);
        window.notificationTimeout = null;
      }
      
      // Reset previous classes
      statusNotification.classList.remove('success', 'error', 'info');
      
      // Add appropriate class based on type
      statusNotification.classList.add(type);
      
      // Enhanced icons with animated effects
      const statusIcon = document.getElementById('status-icon');
      if (type === 'success') {
        statusIcon.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50; animation: pulse-success 2s infinite;"></i>';
      } else if (type === 'error') {
        statusIcon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #F44336; animation: pulse-error 2s infinite;"></i>';
      } else {
        statusIcon.innerHTML = '<i class="fas fa-info-circle" style="color: #2196F3; animation: pulse-info 2s infinite;"></i>';
      }
      
      // Ensure the notification is visible
      statusNotification.style.display = 'flex';
      
      // Improved animation handling - always reset first
      if (statusNotification.classList.contains('active')) {
        statusNotification.classList.remove('active');
        
        // Use a small delay for better visual transition
        setTimeout(() => {
          statusNotification.classList.add('active');
          setupAutoHide();
        }, 150);
      } else {
        // Show notification with slight delay for better attention grab
        setTimeout(() => {
          statusNotification.classList.add('active');
          setupAutoHide();
        }, 50);
      }
      
      // Function to handle auto-hide with extended timeout
      function setupAutoHide() {
        // Auto hide after 8 seconds for better visibility (increased from 5 seconds)
        setTimeout(() => {
          closeNotification();
        }, 8000);
      }
    }
    
    function closeNotification() {
      statusNotification.classList.remove('active');
    }
    
    // Rating System
    function showRatingModal() {
      // Reset stars
      ratingStars.forEach(star => star.classList.remove('active'));
      currentRating = 0;
      
      // Clear feedback
      ratingFeedback.value = '';
      
      // Show modal
      ratingModal.style.display = 'flex';
    }
    
    function closeRatingModal() {
      ratingModal.style.display = 'none';
    }
    
    async function submitRating() {
      if (currentRating === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'تقييم مطلوب' : 'Rating Required',
          currentLanguage === 'ar' ? "الرجاء تحديد تقييم قبل الإرسال" : "Please select a rating before submitting",
          'error'
        );
        // Add focus animation to the rating stars
        const starsContainer = document.querySelector('.rating-stars');
        starsContainer.classList.add('pulse-attention');
        setTimeout(() => starsContainer.classList.remove('pulse-attention'), 1000);
        return;
      }
      
      try {
        // Update order with rating
        await db.collection('orders').doc(currentOrderForRating).update({
          rating: currentRating,
          feedback: ratingFeedback.value.trim(),
          rated: true,
          ratedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Show notification
        showNotification(
          currentLanguage === 'ar' ? 'شكراً لك!' : 'Thank You!',
          currentLanguage === 'ar' 
            ? 'شكراً لتقييمك. نقدر ملاحظاتك!' 
            : 'Thanks for your rating. We appreciate your feedback!',
          'success'
        );
        
        closeRatingModal();
      } catch (error) {
        console.error("Error submitting rating:", error);
        showNotification(
          currentLanguage === 'ar' ? 'خطأ في التقييم' : 'Rating Error',
          currentLanguage === 'ar' ? "حدث خطأ أثناء تقديم التقييم" : "There was an error while submitting your rating",
          'error'
        );
      }
    }
    
    // Admin Dashboard
    function renderAdminDashboard() {
      // Load staff accounts and table assignments
      loadStaffAccounts();
      loadTableAssignments();
      
      // Fetch stats and render charts
      db.collection('orders').get().then(snapshot => {
        const totalOrders = snapshot.size;
        let totalRating = 0;
        let ratedOrders = 0;
        let lowRatings = 0;
        
        // Prepare data for charts
        const orderStatusData = {
          pending: 0,
          preparing: 0,
          ready: 0,
          completed: 0,
          cancelled: 0
        };
        
        const ratingDistribution = [0, 0, 0, 0, 0]; // 1-5 stars
        
        snapshot.forEach(doc => {
          const order = doc.data();
          
          // Count by status
          if (orderStatusData.hasOwnProperty(order.status)) {
            orderStatusData[order.status]++;
          }
          
          // Track ratings
          if (order.rating) {
            totalRating += order.rating;
            ratedOrders++;
            
            // Count low ratings (1-2 stars)
            if (order.rating <= 2) {
              lowRatings++;
            }
            
            // Update rating distribution
            if (order.rating >= 1 && order.rating <= 5) {
              ratingDistribution[order.rating - 1]++;
            }
          }
        });
        
        // Calculate average rating
        const avgRating = ratedOrders > 0 ? (totalRating / ratedOrders).toFixed(1) : '0.0';
        
        // Update stats display
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('avg-rating').textContent = avgRating;
        document.getElementById('low-ratings').textContent = lowRatings;
        
        // Count active staff
        db.collection('staff')
          .where('active', '==', true)
          .get()
          .then(staffSnapshot => {
            document.getElementById('active-staff').textContent = staffSnapshot.size;
          });
        
        // Update charts
        updateOrdersChart(orderStatusData);
        updateRatingsChart(ratingDistribution);
      });
    }
    
    function setupCharts() {
      // Orders chart
      const ordersCtx = document.getElementById('orders-chart').getContext('2d');
      window.ordersChart = new Chart(ordersCtx, {
        type: 'bar',
        data: {
          labels: ['Pending', 'Preparing', 'Ready', 'Completed', 'Cancelled'],
          datasets: [{
            label: 'Orders by Status',
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(255, 193, 7, 0.6)',
              'rgba(33, 150, 243, 0.6)',
              'rgba(76, 175, 80, 0.6)',
              'rgba(158, 158, 158, 0.6)',
              'rgba(244, 67, 54, 0.6)'
            ],
            borderColor: [
              'rgba(255, 193, 7, 1)',
              'rgba(33, 150, 243, 1)',
              'rgba(76, 175, 80, 1)',
              'rgba(158, 158, 158, 1)',
              'rgba(244, 67, 54, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Ratings chart
      const ratingsCtx = document.getElementById('ratings-chart').getContext('2d');
      window.ratingsChart = new Chart(ratingsCtx, {
        type: 'doughnut',
        data: {
          labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
          datasets: [{
            label: 'Rating Distribution',
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(244, 67, 54, 0.6)',
              'rgba(255, 152, 0, 0.6)',
              'rgba(255, 235, 59, 0.6)',
              'rgba(156, 204, 101, 0.6)',
              'rgba(76, 175, 80, 0.6)'
            ],
            borderColor: [
              'rgba(244, 67, 54, 1)',
              'rgba(255, 152, 0, 1)',
              'rgba(255, 235, 59, 1)',
              'rgba(156, 204, 101, 1)',
              'rgba(76, 175, 80, 1)'
            ],
            borderWidth: 1
          }]
        }
      });
    }
    
    function updateOrdersChart(data) {
      if (window.ordersChart) {
        window.ordersChart.data.datasets[0].data = [
          data.pending,
          data.preparing,
          data.ready,
          data.completed,
          data.cancelled
        ];
        window.ordersChart.update();
      }
    }
    
    function updateRatingsChart(data) {
      if (window.ratingsChart) {
        window.ratingsChart.data.datasets[0].data = data;
        window.ratingsChart.update();
      }
    }
    
    // Load and display staff ratings feedback in the admin dashboard
    function loadStaffRatings() {
      const staffRatingsList = document.getElementById('staff-ratings-list');
      if (!staffRatingsList) return;
      
      // Clear existing content
      staffRatingsList.innerHTML = '';
      
      // Fetch ratings from Firebase, order by timestamp (newest first)
      db.collection('ratings')
        .orderBy('timestamp', 'desc')
        .limit(20) // Limit to most recent 20 ratings
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            staffRatingsList.innerHTML = '<div class="no-ratings">No customer ratings available yet.</div>';
            return;
          }
          
          snapshot.forEach(doc => {
            const rating = doc.data();
            const isLowRating = rating.rating <= 3;
            
            // Format timestamp
            let timeStr = '';
            if (rating.timestamp) {
              const timestamp = rating.timestamp.toDate();
              timeStr = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Generate star icons based on rating
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
              const starClass = i <= rating.rating ? 'fas fa-star' : 'far fa-star';
              starsHtml += `<i class="${starClass}"></i>`;
            }
            
            // Create the rating item HTML
            const ratingEl = document.createElement('div');
            ratingEl.className = `rating-item ${isLowRating ? 'low-rating' : ''}`;
            
            ratingEl.innerHTML = `
              <div class="rating-header">
                <span class="rating-staff-name">${rating.staffName || 'N/A'}</span>
                <span class="rating-stars-display ${isLowRating ? 'low-rating' : ''}">${starsHtml}</span>
              </div>
              ${rating.feedback ? `<div class="rating-feedback">"${rating.feedback}"</div>` : ''}
              <div class="rating-meta">
                <span>Table #${rating.tableNumber || 'N/A'}</span>
                <span>${timeStr}</span>
              </div>
            `;
            
            staffRatingsList.appendChild(ratingEl);
          });
        })
        .catch(error => {
          console.error("Error loading staff ratings:", error);
          staffRatingsList.innerHTML = '<div class="no-ratings">Error loading ratings. Please try again.</div>';
        });
    }
    
    // Add call to loadStaffRatings in renderAdminDashboard function
    function renderAdminDashboard() {
      // Load staff accounts and table assignments
      loadStaffAccounts();
      loadTableAssignments();
      loadStaffRatings(); // Load staff ratings
      
      // Fetch stats and render charts
      db.collection('orders').get().then(snapshot => {
        const totalOrders = snapshot.size;
        let totalRating = 0;
        let ratedOrders = 0;
        let lowRatings = 0;
        
        // Prepare data for charts
        const orderStatusData = {
          pending: 0,
          preparing: 0,
          ready: 0,
          completed: 0,
          cancelled: 0
        };
        
        const ratingDistribution = [0, 0, 0, 0, 0]; // 1-5 stars
        
        snapshot.forEach(doc => {
          const order = doc.data();
          
          // Count by status
          if (orderStatusData.hasOwnProperty(order.status)) {
            orderStatusData[order.status]++;
          }
          
          // Track ratings
          if (order.rating) {
            totalRating += order.rating;
            ratedOrders++;
            
            // Count low ratings (1-2 stars)
            if (order.rating <= 2) {
              lowRatings++;
            }
            
            // Update rating distribution
            if (order.rating >= 1 && order.rating <= 5) {
              ratingDistribution[order.rating - 1]++;
            }
          }
        });
        
        // Calculate average rating
        const avgRating = ratedOrders > 0 ? (totalRating / ratedOrders).toFixed(1) : '0.0';
        
        // Update stats display
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('avg-rating').textContent = avgRating;
        document.getElementById('low-ratings').textContent = lowRatings;
        
        // Count active staff
        db.collection('staff')
          .where('active', '==', true)
          .get()
          .then(staffSnapshot => {
            document.getElementById('active-staff').textContent = staffSnapshot.size;
          });
        
        // Update charts
        updateOrdersChart(orderStatusData);
        updateRatingsChart(ratingDistribution);
      });
    }
    
    // Load staff accounts into the UI
    function loadStaffAccounts() {
      const staffListElement = document.getElementById('staff-accounts-list');
      const staffDropdown = document.getElementById('staff-assignment');
      
      if (staffListElement) {
        staffListElement.innerHTML = '';
        
        accounts.forEach(staff => {
          if (staff.role !== 'admin') { // Don't show admin in the list
            const staffItem = document.createElement('div');
            staffItem.className = 'staff-account-item';
            staffItem.innerHTML = `
              <div class="staff-account-info">
                <div class="staff-account-name">${staff.name}</div>
                <div class="staff-account-username">@${staff.username}</div>
                <div class="staff-account-role">${staff.role.toUpperCase()}</div>
              </div>
              <div class="staff-account-actions">
                <button class="staff-action-btn edit-staff-btn" onclick="editStaffAccount('${staff.username}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="staff-action-btn delete-staff-btn" onclick="deleteStaffAccount('${staff.username}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            `;
            staffListElement.appendChild(staffItem);
          }
        });
      }
      
      if (staffDropdown) {
        // Clear all options except the first one
        while (staffDropdown.options.length > 1) {
          staffDropdown.remove(1);
        }
        
        // Add staff options to dropdown
        accounts.forEach(staff => {
          if (staff.role !== 'admin') { // Don't include admin in assignments
            const option = document.createElement('option');
            option.value = staff.username;
            option.textContent = `${staff.name} (${staff.role})`;
            staffDropdown.appendChild(option);
          }
        });
      }
    }
    
    // Function to load table assignments into the UI
    function loadTableAssignments() {
      const tableAssignmentsElement = document.getElementById('staff-table-assignments');
      
      if (tableAssignmentsElement) {
        tableAssignmentsElement.innerHTML = '';
        
        if (tableAssignments.length === 0) {
          tableAssignmentsElement.innerHTML = '<div class="no-assignments">No table assignments found</div>';
          return;
        }
        
        tableAssignments.forEach((assignment, index) => {
          const staffInfo = accounts.find(staff => staff.username === assignment.staffUsername);
          if (!staffInfo) return;
          
          const assignmentItem = document.createElement('div');
          assignmentItem.className = 'table-assignment-item';
          assignmentItem.innerHTML = `
            <div>
              <span class="table-assignment-staff">${staffInfo.name}</span>
              <span class="table-assignment-range">Tables ${assignment.startTable}-${assignment.endTable}</span>
            </div>
            <button class="delete-assignment-btn" onclick="deleteTableAssignment(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          tableAssignmentsElement.appendChild(assignmentItem);
        });
      }
    }
    
    // Function to add a new staff account
    function addStaffAccount() {
      const username = document.getElementById('new-staff-username').value.trim();
      const name = document.getElementById('new-staff-name').value.trim();
      const password = document.getElementById('new-staff-password').value.trim();
      const role = document.getElementById('new-staff-role').value;
      
      if (!username || !name || !password) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Check if username already exists
      if (accounts.some(staff => staff.username === username)) {
        showNotification('Username already exists', 'error');
        return;
      }
      
      // Add new staff account
      accounts.push({ username, name, password, role });
      
      // Update UI
      loadStaffAccounts();
      
      // Clear form
      document.getElementById('new-staff-username').value = '';
      document.getElementById('new-staff-name').value = '';
      document.getElementById('new-staff-password').value = '';
      
      showNotification('Staff account added successfully', 'success');
    }
    
    // Function to edit a staff account
    function editStaffAccount(username) {
      const staff = accounts.find(staff => staff.username === username);
      if (!staff) return;
      
      // Currently just show a notification - could be replaced with proper modal edit functionality
      showNotification('Edit staff feature coming soon', 'info');
    }
    
    // Function to delete a staff account
    function deleteStaffAccount(username) {
      const confirmDelete = confirm(`Are you sure you want to delete the staff account for ${username}?`);
      if (!confirmDelete) return;
      
      // Remove from accounts array
      const index = accounts.findIndex(staff => staff.username === username);
      if (index !== -1) {
        accounts.splice(index, 1);
      }
      
      // Remove any table assignments for this staff
      for (let i = tableAssignments.length - 1; i >= 0; i--) {
        if (tableAssignments[i].staffUsername === username) {
          tableAssignments.splice(i, 1);
        }
      }
      
      // Update UI
      loadStaffAccounts();
      loadTableAssignments();
      
      showNotification('Staff account deleted successfully', 'success');
    }
    
    // Function to assign a table range to a staff member
    function assignTableRange() {
      const staffUsername = document.getElementById('staff-assignment').value;
      const startTable = parseInt(document.getElementById('table-range-start').value);
      const endTable = parseInt(document.getElementById('table-range-end').value);
      
      if (!staffUsername) {
        showNotification('Please select a staff member', 'error');
        return;
      }
      
      if (isNaN(startTable) || isNaN(endTable) || startTable < 1 || endTable < startTable) {
        showNotification('Please enter a valid table range', 'error');
        return;
      }
      
      // Check for overlapping table ranges
      const hasOverlap = tableAssignments.some(assignment => {
        return (
          (startTable >= assignment.startTable && startTable <= assignment.endTable) ||
          (endTable >= assignment.startTable && endTable <= assignment.endTable) ||
          (startTable <= assignment.startTable && endTable >= assignment.endTable)
        );
      });
      
      if (hasOverlap) {
        showNotification('Table range overlaps with an existing assignment', 'error');
        return;
      }
      
      // Add new assignment
      tableAssignments.push({ staffUsername, startTable, endTable });
      
      // Update UI
      loadTableAssignments();
      
      showNotification('Table range assigned successfully', 'success');
    }
    
    // Function to delete a table assignment
    function deleteTableAssignment(index) {
      const assignment = tableAssignments[index];
      if (!assignment) return;
      
      const staffInfo = accounts.find(staff => staff.username === assignment.staffUsername);
      const confirmDelete = confirm(`Are you sure you want to remove table assignment (Tables ${assignment.startTable}-${assignment.endTable}) from ${staffInfo ? staffInfo.name : assignment.staffUsername}?`);
      
      if (!confirmDelete) return;
      
      tableAssignments.splice(index, 1);
      loadTableAssignments();
      
      showNotification('Table assignment removed successfully', 'success');
    }
    
    // Function to check which staff member is assigned to a table
    // This function is a duplicate and has been merged with the earlier implementation
    
    // Function to update tables display in staff view
    function updateTablesDisplay() {
      console.log("Updating tables display");
      const tablesContainer = document.getElementById('occupied-tables-container');
      if (!tablesContainer) return;
      
      // Clear existing content
      tablesContainer.innerHTML = '';
      
      // Create an element to show total number of occupied tables
      const occupiedTablesCount = document.createElement('div');
      occupiedTablesCount.className = 'occupied-tables-count';
      occupiedTablesCount.innerHTML = `
        <span style="font-weight: bold; margin-bottom: 10px; display: block; text-align: center; color: var(--light-cream); background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">
          <i class="fas fa-utensils"></i> ${currentLanguage === 'ar' ? 'الطاولات المشغولة' : 'Occupied Tables'}: 
          <span style="color: var(--gold);">${occupiedTables.size}</span>
        </span>
      `;
      tablesContainer.appendChild(occupiedTablesCount);
      
      // Get current staff username if we're in staff view
      const currentStaffUsername = userType === 'staff' ? localStorage.getItem('username') : null;
      
      // Filter for tables assigned to current staff member if we're in staff view
      let tablesToShow = [];
      
      if (userType === 'staff' && currentStaffUsername) {
        // Get table assignments for this staff member
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        
        // Create an array of all table numbers assigned to this staff member
        const assignedTables = [];
        staffAssignments.forEach(assignment => {
          for (let t = assignment.startTable; t <= assignment.endTable; t++) {
            assignedTables.push(t);
          }
        });
        
        // Filter occupied tables to only show those assigned to this staff
        tablesToShow = Array.from(occupiedTables).filter(tableNum => 
          assignedTables.includes(parseInt(tableNum))
        ).sort((a, b) => a - b);
        
        // Show message if no tables assigned
        if (tablesToShow.length === 0) {
          const noTablesMsg = document.createElement('div');
          noTablesMsg.className = 'no-tables-message';
          noTablesMsg.innerHTML = `
            <p style="text-align: center; color: var(--light-cream); padding: 20px;">
              ${currentLanguage === 'ar' ? 'لا توجد طاولات مشغولة مخصصة لك' : 'No occupied tables assigned to you'}
            </p>
          `;
          tablesContainer.appendChild(noTablesMsg);
          return;
        }
      } else {
        // For admin view, show all occupied tables
        tablesToShow = Array.from(occupiedTables).sort((a, b) => a - b);
        
        // Show message if no tables occupied
        if (tablesToShow.length === 0) {
          const noTablesMsg = document.createElement('div');
          noTablesMsg.className = 'no-tables-message';
          noTablesMsg.innerHTML = `
            <p style="text-align: center; color: var(--light-cream); padding: 20px;">
              ${currentLanguage === 'ar' ? 'لا توجد طاولات مشغولة' : 'No occupied tables'}
            </p>
          `;
          tablesContainer.appendChild(noTablesMsg);
          return;
        }
      }
      
      // Display tables
      tablesToShow.forEach(tableNum => {
        const tableCard = document.createElement('div');
        tableCard.className = 'table-card';
        tableCard.dataset.tableNumber = tableNum;
        
        // Get table details
        const details = tableDetails[tableNum] || { orders: [] };
        const hasOrders = details.orders && details.orders.length > 0;
        
        // Get staff assigned to this table
        const assignedStaff = getStaffForTable(tableNum);
        const staffInfo = assignedStaff ? 
          `<p class="assigned-staff">
            <span class="staff-label">${currentLanguage === 'ar' ? 'الموظف:' : 'Staff:'}</span>
            <span class="staff-name ${assignedStaff.role}">${assignedStaff.name}</span>
          </p>` : '';
        
        // Get status based on orders
        let statusText = currentLanguage === 'ar' ? 'مشغولة' : 'OCCUPIED';
        let statusClass = 'status-occupied';
        
        if (hasOrders) {
          const latestOrder = details.orders[0];
          if (latestOrder.status === 'ready') {
            statusText = currentLanguage === 'ar' ? 'جاهز للتقديم' : 'READY TO SERVE';
            statusClass = 'status-ready';
          } else if (latestOrder.status === 'preparing') {
            statusText = currentLanguage === 'ar' ? 'قيد التحضير' : 'PREPARING';
            statusClass = 'status-preparing';
          }
        }
        
        tableCard.innerHTML = `
          <div class="table-card-header">
            <h3>TABLE ${tableNum}</h3>
            <span class="table-status ${statusClass}">
              ${statusText}
            </span>
          </div>
          <div class="table-card-content">
            <div class="table-info">
              <p>${currentLanguage === 'ar' ? 'الطلبات' : 'Orders'}: 
                <span>${hasOrders ? details.orders.length : 0}</span>
              </p>
              ${staffInfo}
              <p>${currentLanguage === 'ar' ? 'آخر تحديث' : 'Last Updated'}: 
                <span>${hasOrders ? '5 ' + (currentLanguage === 'ar' ? 'دقائق' : 'mins') + ' ' + (currentLanguage === 'ar' ? 'مضت' : 'ago') : '-'}</span>
              </p>
            </div>
            <button class="view-table-details-btn" onclick="viewTableDetails(${tableNum})">
              ${currentLanguage === 'ar' ? 'عرض التفاصيل' : 'VIEW DETAILS'}
            </button>
          </div>
        `;
        
        tablesContainer.appendChild(tableCard);
      });
    }
    
    // Apply discount
    function applyDiscount() {
      const code = discountCodeInput.value.trim();
      
      if (!code) {
        showNotification(
          currentLanguage === 'ar' ? 'رمز مطلوب' : 'Code Required',
          currentLanguage === 'ar' ? "الرجاء إدخال رمز الخصم قبل التطبيق" : "Please enter a discount code before applying",
          'error'
        );
        
        // Add focus animation on the input
        discountCodeInput.classList.add('input-error');
        setTimeout(() => discountCodeInput.classList.remove('input-error'), 600);
        discountCodeInput.focus();
        return;
      }
      
      // In a real application, this would validate the code and apply discount
      // For demo, we'll just show a notification
      showNotification(
        currentLanguage === 'ar' ? 'تم تطبيق الخصم' : 'Discount Applied',
        currentLanguage === 'ar' 
          ? `تم تطبيق رمز الخصم ${code} بنجاح` 
          : `Discount code ${code} has been applied successfully`,
        'success'
      );
    }
    
    // Admin Tabs Navigation
    function switchAdminTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`${tabName}-content`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // If analytics tab is selected, initialize the analytics charts
      if (tabName === 'analytics') {
        initializeAnalytics();
      }
    }
    
    // Initialize Advanced Analytics Dashboard
    function initializeAnalytics() {
      // Draw all charts
      drawSalesChart();
      drawMenuPerformanceChart();
      drawSatisfactionChart();
      drawTableUtilizationChart();
      drawStaffPerformanceChart();
      drawMarketingChart();
      
      // Get insights from data
      updateAnalyticsInsights();
    }
    
    // Update analytics based on selected time range
    function updateAnalytics() {
      const timeRange = document.getElementById('time-range').value;
      console.log(`Updating analytics for time range: ${timeRange}`);
      
      // Redraw all charts with the new time range
      drawSalesChart(timeRange);
      drawMenuPerformanceChart(timeRange);
      drawSatisfactionChart(timeRange);
      drawTableUtilizationChart(timeRange);
      drawStaffPerformanceChart(timeRange);
      drawMarketingChart(timeRange);
      
      // Update insights based on new data
      updateAnalyticsInsights(timeRange);
      
      // Show notification that data has been updated
      showNotification(
        'Analytics Updated',
        `Data has been refreshed for ${timeRange === 'day' ? 'today' : 
          timeRange === 'week' ? 'this week' : 
          timeRange === 'month' ? 'this month' : 'this year'}`,
        'info'
      );
    }
    
    // Export analytics data to CSV
    function exportAnalyticsData(dataType) {
      console.log(`Exporting ${dataType} data`);
      
      // Show notification that export is in progress
      showNotification(
        'Export Started',
        `Preparing ${dataType} data for export. Download will begin shortly.`,
        'info'
      );
      
      // Simulate download delay
      setTimeout(() => {
        // In a real application, this would generate and download a CSV file
        // For demo purposes, we'll just show a notification
        showNotification(
          'Export Complete',
          `${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data has been exported successfully.`,
          'success'
        );
      }, 1500);
    }
    
    // Toggle between different chart views (line/bar/pie)
    function toggleChartView(chartType) {
      console.log(`Toggling chart view for ${chartType}`);
      
      // Simulate chart type change
      showNotification(
        'Chart View Changed',
        `Chart visualization has been updated.`,
        'info'
      );
      
      // In a real implementation, this would change the chart type
      // For demo, we'll just redraw the current chart
      if (chartType === 'sales') {
        drawSalesChart();
      }
    }
    
    // Draw Sales Performance Chart
    function drawSalesChart(timeRange = 'week') {
      const ctx = document.getElementById('sales-performance-chart').getContext('2d');
      
      // Get data based on time range
      const labels = getTimeLabels(timeRange);
      const data = generateRandomData(labels.length, 500, 1500);
      
      if (window.salesChart) {
        window.salesChart.destroy();
      }
      
      window.salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sales ($)',
            data: data,
            fill: true,
            backgroundColor: 'rgba(212, 175, 55, 0.2)',
            borderColor: 'rgba(212, 175, 55, 1)',
            tension: 0.4,
            pointBackgroundColor: 'rgba(212, 175, 55, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: 'rgba(245, 245, 220, 0.8)'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              borderColor: 'rgba(212, 175, 55, 0.5)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            },
            x: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Menu Performance Chart
    function drawMenuPerformanceChart(timeRange = 'week') {
      const ctx = document.getElementById('menu-performance-chart').getContext('2d');
      
      // Menu items data
      const data = {
        labels: ['Margherita Pizza', 'Pepperoni Pizza', 'Fettuccine Alfredo', 'Caesar Salad', 'Tiramisu'],
        values: [24, 19, 15, 12, 8]
      };
      
      if (window.menuChart) {
        window.menuChart.destroy();
      }
      
      window.menuChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              'rgba(212, 175, 55, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(245, 245, 220, 0.8)',
                padding: 10,
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}%`;
                }
              }
            }
          }
        }
      });
    }
    
    // Draw Customer Satisfaction Chart
    function drawSatisfactionChart(timeRange = 'week') {
      const ctx = document.getElementById('satisfaction-chart').getContext('2d');
      
      // Rating distribution
      const data = {
        labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
        values: [65, 20, 10, 3, 2]
      };
      
      if (window.satisfactionChart) {
        window.satisfactionChart.destroy();
      }
      
      window.satisfactionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Ratings',
            data: data.values,
            backgroundColor: [
              'rgba(46, 125, 50, 0.8)',
              'rgba(56, 142, 60, 0.8)',
              'rgba(251, 192, 45, 0.8)',
              'rgba(245, 124, 0, 0.8)',
              'rgba(211, 47, 47, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.parsed.x}% of ratings`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            },
            y: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Table Utilization Chart
    function drawTableUtilizationChart(timeRange = 'week') {
      const ctx = document.getElementById('table-utilization-chart').getContext('2d');
      
      // Table utilization data
      const data = {
        labels: ['Table 1-4', 'Table 5-8', 'Table 9-12', 'Table 13-16'],
        values: [70, 90, 60, 40]
      };
      
      if (window.tableChart) {
        window.tableChart.destroy();
      }
      
      window.tableChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Utilization %',
            data: data.values,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)',
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Staff Performance Chart
    function drawStaffPerformanceChart(timeRange = 'week') {
      const ctx = document.getElementById('staff-performance-chart').getContext('2d');
      
      // Staff performance data
      const data = {
        labels: ['Sarah', 'John', 'Ahmad', 'Maria'],
        ratings: [4.9, 4.5, 4.7, 4.6],
        ordersHandled: [45, 38, 42, 30]
      };
      
      if (window.staffChart) {
        window.staffChart.destroy();
      }
      
      window.staffChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Customer Rating', 'Speed', 'Orders Handled', 'Accuracy', 'Teamwork'],
          datasets: [
            {
              label: 'Sarah',
              data: [98, 85, 90, 95, 88],
              fill: true,
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgb(255, 99, 132)',
              pointBackgroundColor: 'rgb(255, 99, 132)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(255, 99, 132)'
            },
            {
              label: 'John',
              data: [90, 92, 82, 89, 95],
              fill: true,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgb(54, 162, 235)',
              pointBackgroundColor: 'rgb(54, 162, 235)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(54, 162, 235)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: {
                color: 'rgba(245, 245, 220, 0.2)'
              },
              grid: {
                color: 'rgba(245, 245, 220, 0.2)'
              },
              pointLabels: {
                color: 'rgba(245, 245, 220, 0.7)',
                font: {
                  size: 10
                }
              },
              ticks: {
                backdropColor: 'transparent',
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'rgba(245, 245, 220, 0.8)'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)'
            }
          }
        }
      });
    }
    
    // Draw Marketing Chart
    function drawMarketingChart(timeRange = 'week') {
      const ctx = document.getElementById('marketing-chart').getContext('2d');
      
      // Order sources data
      const data = {
        labels: ['AR Menu View', 'Regular Menu', 'Repeat Customers', 'Recommendations', 'Social Media'],
        values: [35, 25, 20, 15, 5]
      };
      
      if (window.marketingChart) {
        window.marketingChart.destroy();
      }
      
      window.marketingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              'rgba(212, 175, 55, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: 'rgba(245, 245, 220, 0.8)',
                padding: 15,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}%`;
                }
              }
            }
          }
        }
      });
    }
    
    // Update analytics insights
    function updateAnalyticsInsights(timeRange = 'week') {
      // In a real application, these would be calculated from data
      // For demo purposes, these are static
      
      const insights = {
        en: {
          sales: {
            day: 'Today\'s sales are up 8% compared to yesterday with peak time at lunch',
            week: 'Sales are up 12% compared to last week with peak hours between 12-2pm',
            month: 'This month shows 15% growth over last month with weekends being strongest',
            year: 'Annual growth is at 23% with Q2 showing best performance'
          },
          menu: {
            day: 'Today\'s top seller is Pepperoni Pizza at 28% of orders',
            week: 'Margherita Pizza is your top seller with 24% of sales this week',
            month: 'Fettuccine Alfredo has grown 18% in popularity this month',
            year: 'Pizza remains your top category representing 45% of annual revenue'
          },
          satisfaction: {
            day: 'Today\'s average rating is 4.7/5 stars from 25 reviews',
            week: '85% of customers rated their experience 4+ stars this week',
            month: 'Customer satisfaction has improved 7% this month over last month',
            year: 'Annual satisfaction rate is 4.6/5, a 9% improvement over last year'
          },
          table: {
            day: 'Today tables 9-12 have the highest turnover rate at 4.1 hours',
            week: 'Tables 5-8 have highest turnover rate at 3.2 hours avg this week',
            month: 'Monthly data shows weekend tables are 35% more efficient than weekdays',
            year: 'Annual data shows 6pm-8pm as your most efficient service time'
          },
          staff: {
            day: 'Today Ahmad is the top performer with 4.9/5 from customers',
            week: 'Sarah has the highest customer satisfaction score at 4.9/5 this week',
            month: 'John has shown the most improvement this month, up 12%',
            year: 'Sarah is your top annual performer with 4.8/5 average rating'
          },
          marketing: {
            day: 'Today AR menu users spent 22% more than regular menu users',
            week: 'AR menu visualization increases average order value by 18% this week',
            month: 'Social media referrals have increased 15% this month',
            year: 'AR menu visualization has driven a 25% increase in dessert orders annually'
          }
        },
        ar: {
          sales: {
            day: 'زادت مبيعات اليوم بنسبة 8٪ مقارنة بالأمس مع وقت الذروة في وقت الغداء',
            week: 'زادت المبيعات بنسبة 12٪ مقارنة بالأسبوع الماضي مع ساعات الذروة بين 12-2 مساءً',
            month: 'يُظهر هذا الشهر نموًا بنسبة 15٪ مقارنة بالشهر الماضي مع عطلات نهاية الأسبوع الأقوى',
            year: 'النمو السنوي هو 23٪ مع الربع الثاني يظهر أفضل أداء'
          },
          menu: {
            day: 'المنتج الأكثر مبيعًا اليوم هو بيتزا بيبروني بنسبة 28٪ من الطلبات',
            week: 'بيتزا مارغريتا هي الأكثر مبيعًا بنسبة 24٪ من المبيعات هذا الأسبوع',
            month: 'نمت شعبية فيتوتشيني ألفريدو بنسبة 18٪ هذا الشهر',
            year: 'تظل البيتزا الفئة الأولى التي تمثل 45٪ من الإيرادات السنوية'
          },
          satisfaction: {
            day: 'متوسط التقييم اليوم هو 4.7/5 نجوم من 25 مراجعة',
            week: '85٪ من العملاء قيموا تجربتهم بـ 4+ نجوم هذا الأسبوع',
            month: 'تحسن رضا العملاء بنسبة 7٪ هذا الشهر مقارنة بالشهر الماضي',
            year: 'معدل الرضا السنوي هو 4.6/5، بتحسن 9٪ عن العام الماضي'
          },
          table: {
            day: 'اليوم الطاولات 9-12 لديها أعلى معدل دوران عند 4.1 ساعات',
            week: 'الطاولات 5-8 لديها أعلى معدل دوران بمتوسط 3.2 ساعة هذا الأسبوع',
            month: 'تُظهر البيانات الشهرية أن طاولات عطلة نهاية الأسبوع أكثر كفاءة بنسبة 35٪ من أيام الأسبوع',
            year: 'تُظهر البيانات السنوية أن 6 مساءً - 8 مساءً هو وقت الخدمة الأكثر كفاءة'
          },
          staff: {
            day: 'اليوم أحمد هو الأفضل أداءً بتقييم 4.9/5 من العملاء',
            week: 'سارة لديها أعلى درجة رضا العملاء عند 4.9/5 هذا الأسبوع',
            month: 'أظهر جون أكبر تحسن هذا الشهر، بزيادة 12٪',
            year: 'سارة هي أفضل موظف سنوي بمتوسط تقييم 4.8/5'
          },
          marketing: {
            day: 'اليوم أنفق مستخدمو قائمة الواقع المعزز 22٪ أكثر من مستخدمي القائمة العادية',
            week: 'تصور قائمة الواقع المعزز يزيد متوسط قيمة الطلب بنسبة 18٪ هذا الأسبوع',
            month: 'زادت الإحالات من وسائل التواصل الاجتماعي بنسبة 15٪ هذا الشهر',
            year: 'أدى تصور قائمة الواقع المعزز إلى زيادة بنسبة 25٪ في طلبات الحلويات سنويًا'
          }
        }
      };
      
      // Get the current language
      const lang = currentLanguage || 'en';
      
      // Update insights based on time range and language
      document.getElementById('sales-insight').innerText = insights[lang].sales[timeRange];
      document.getElementById('menu-insight').innerText = insights[lang].menu[timeRange];
      document.getElementById('satisfaction-insight').innerText = insights[lang].satisfaction[timeRange];
      document.getElementById('table-insight').innerText = insights[lang].table[timeRange];
      document.getElementById('staff-insight').innerText = insights[lang].staff[timeRange];
      document.getElementById('marketing-insight').innerText = insights[lang].marketing[timeRange];
    }
    
    // Helper function to get time labels based on time range
    function getTimeLabels(timeRange) {
      switch(timeRange) {
        case 'day':
          return ['9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', '9PM'];
        case 'week':
          return ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        case 'month':
          return ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
        case 'year':
          return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        default:
          return ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      }
    }
    
    // Helper function to generate random data for demo
    function generateRandomData(length, min, max) {
      return Array.from({length: length}, () => Math.floor(Math.random() * (max - min + 1) + min));
    }
    
    // Function to add a demo order to client list (for offline mode)
    function addDemoOrderToClientList(order) {
      if (!clientOrdersList) return;
      
      // Make sure we don't duplicate demo orders
      if (document.getElementById(`order-item-${order.id}`)) {
        return;
      }
      
      const orderItem = document.createElement('div');
      orderItem.className = 'client-order-item';
      orderItem.id = `order-item-${order.id}`;
      
      // Format date
      const orderDate = order.timestamp.toDate ? order.timestamp.toDate() : order.timestamp;
      const formattedDate = new Intl.DateTimeFormat(currentLanguage === 'ar' ? 'ar-SA' : 'en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).format(orderDate);
      
      const statusClass = {
        'pending': 'status-pending',
        'preparing': 'status-preparing',
        'ready': 'status-ready',
        'completed': 'status-completed',
        'cancelled': 'status-cancelled'
      }[order.status] || 'status-pending';
      
      const statusText = {
        'pending': currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending',
        'preparing': currentLanguage === 'ar' ? 'قيد التحضير' : 'Preparing',
        'ready': currentLanguage === 'ar' ? 'جاهز' : 'Ready',
        'completed': currentLanguage === 'ar' ? 'مكتمل' : 'Completed',
        'cancelled': currentLanguage === 'ar' ? 'ملغى' : 'Cancelled'
      }[order.status] || (currentLanguage === 'ar' ? 'قيد الانتظار' : 'Pending');
      
      // Create order summary text
      let orderSummary = '';
      if (order.items && order.items.length > 0) {
        orderSummary = order.items.map(item => item.name).join(', ');
      }
      
      // Add a "Rate this order" button for completed orders
      let rateButton = '';
      if (order.status === 'completed' && !order.rating) {
        rateButton = `
          <button class="rate-btn" data-order-id="${order.id}">
            ${currentLanguage === 'ar' ? 'قيم هذا الطلب' : 'Rate this order'}
          </button>
        `;
      }
      
      // Show the rating if available
      let ratingDisplay = '';
      if (order.rating) {
        ratingDisplay = `
          <div class="order-rating">
            ${currentLanguage === 'ar' ? 'تقييمك:' : 'Your rating:'} 
            ${Array(5).fill(0).map((_, i) => 
              i < order.rating ? 
                '<span class="rating-star-small active">★</span>' : 
                '<span class="rating-star-small">★</span>'
            ).join('')}
          </div>
        `;
      }
      
      orderItem.innerHTML = `
        <div class="order-header">
          <div class="order-time">${formattedDate}</div>
          <div class="order-status ${statusClass}">${statusText}</div>
        </div>
        <div class="order-details">
          <div class="order-table">${currentLanguage === 'ar' ? 'الطاولة:' : 'Table:'} ${order.tableNumber}</div>
          <div class="order-summary">${orderSummary}</div>
          ${rateButton}
          ${ratingDisplay}
        </div>
      `;
      
      clientOrdersList.appendChild(orderItem);
      
      // Add event listener to rate button
      const rateBtnEl = orderItem.querySelector('.rate-btn');
      if (rateBtnEl) {
        rateBtnEl.addEventListener('click', () => {
          // Show rating modal
          currentOrderForRating = order.id;
          ratingModal.classList.add('active');
          
          // Reset rating
          currentRating = 0;
          ratingStars.forEach(s => s.classList.remove('active'));
          ratingFeedback.value = '';
        });
      }
    }
  </script>
  
  <!-- Rating Dialog Modal -->
  <div class="rating-modal" id="rating-modal">
    <div class="rating-content">
      <h3 class="rating-title" id="rating-title">RATE YOUR EXPERIENCE</h3>
      
      <div class="rating-stars">
        <span class="rating-star" data-rating="1">★</span>
        <span class="rating-star" data-rating="2">★</span>
        <span class="rating-star" data-rating="3">★</span>
        <span class="rating-star" data-rating="4">★</span>
        <span class="rating-star" data-rating="5">★</span>
      </div>
      
      <div class="feedback-container" id="feedback-container" style="display: none;">
        <label for="feedback-text" id="feedback-label">FEEDBACK (OPTIONAL)</label>
        <textarea id="feedback-text" rows="3" placeholder="Please let us know how we can improve"></textarea>
      </div>
      
      <input type="hidden" id="rating-order-id">
      <input type="hidden" id="rating-staff-name">
      
      <div class="modal-buttons">
        <button id="submit-rating-btn" onclick="submitRating()">SUBMIT</button>
        <button id="cancel-rating-btn" onclick="closeRatingDialog()">CANCEL</button>
      </div>
    </div>
  </div>
  
  <!-- Item Customization Modal (Talabat-style) -->
  <div class="customize-modal" id="customize-modal">
    <div class="customize-content">
      <div class="customize-header">
        <h2 class="customize-title" id="customize-item-name">Customize Your Item</h2>
        <button class="close-customize-btn" onclick="closeCustomizeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="food-customize-image">
        <img id="customize-item-image" src="" alt="Food item">
      </div>
      
      <div class="customize-price-container">
        <span id="customize-base-price" class="base-price"></span>
        <span id="customize-total-price" class="total-price"></span>
      </div>
      
      <div class="customize-sections">
        <!-- Extras Section -->
        <div class="customize-section">
          <div class="section-header">
            <h3 id="extras-section-title">ADD EXTRAS</h3>
            <span class="section-subtitle" id="extras-subtitle">Select additional toppings or sides</span>
          </div>
          
          <div class="extras-grid" id="extras-options">
            <!-- Extras will be dynamically populated -->
          </div>
        </div>
        
        <!-- Special Instructions Section -->
        <div class="customize-section">
          <div class="section-header">
            <h3 id="instructions-section-title">SPECIAL INSTRUCTIONS</h3>
            <span class="section-subtitle" id="instructions-subtitle">Any special requests for your order?</span>
          </div>
          
          <textarea id="special-instructions" class="special-instructions-input" 
            placeholder="Ex: Extra crispy, No onions, Allergy information, etc."></textarea>
        </div>
      </div>
      
      <!-- Quantity Selector -->
      <div class="quantity-selector">
        <span id="quantity-label">QUANTITY</span>
        <div class="quantity-controls">
          <button id="decrease-quantity" class="quantity-btn" onclick="changeQuantity(-1)">
            <i class="fas fa-minus"></i>
          </button>
          <span id="quantity-value">1</span>
          <button id="increase-quantity" class="quantity-btn" onclick="changeQuantity(1)">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
      
      <div class="customize-actions">
        <button id="add-to-cart-btn" class="add-to-cart-customize-btn" onclick="addCustomizedItemToCart(); closeCustomizeModal(); return false;">
          <i class="fas fa-shopping-cart"></i>
          <span id="add-to-cart-text">ADD TO CART</span>
        </button>
      </div>
    </div>
  </div>
</body>
</html>
