<!DOCTYPE html>
<html>
<head>
  <title>The Oak Cafe - Premium AR Dining</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --gold: #D4AF37;
      --dark-green: #1A3A2F;
      --light-cream: #F5F5DC;
      --red: #B22222;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    .overlay {
      background-color: rgba(26, 58, 47, 0.95);
      min-height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 10px 0;
      position: relative;
    }
    
    .logo {
      height: 60px;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      max-width: 100%;
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--gold);
      margin: 8px 0 4px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      line-height: 1.2;
    }
    
    .tagline {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.8rem;
      color: var(--light-cream);
      margin-bottom: 15px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .food-container {
      width: 100%;
      margin: 0 auto;
      background: rgba(245, 245, 220, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border: 1px solid var(--gold);
      flex-grow: 1;
      position: relative;
      z-index: 1;
    }
    
    model-viewer {
      width: 100%;
      height: 220px;
      margin: 12px 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* IMPROVED: Navigation controls - more visible and fixed positioning */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
      position: relative;
      z-index: 2;
      padding: 5px;
    }
    
    /* NEW: Sticky navigation controls that are always visible */
    .nav-controls {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 800;
      padding: 0 15px;
    }
    
    .nav-controls button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--dark-green);
      color: var(--gold);
      border: 2px solid var(--gold);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0.9;
    }
    
    .nav-controls button:active {
      transform: scale(0.95);
    }
    
    button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: none;
      padding: 10px 16px;  /* IMPROVED: Slightly wider padding */
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 5px;  /* IMPROVED: Added margin between buttons */
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .ar-button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%) !important;
      color: var(--dark-green) !important;
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 15px;
      font-weight: 600;
      animation: pulse 2s infinite;
      font-size: 0.85rem;
      width: calc(100% - 24px);
      max-width: 220px;
      border-radius: 25px !important;
    }
    
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.03); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    .footer {
      margin-top: 20px;
      padding: 15px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 12px 12px 0 0;
      border-top: 2px solid var(--gold);
      position: relative;
      z-index: 1;
    }
    
    .footer::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 2px;
      background: var(--gold);
      border-radius: 2px;
    }
    
    .footer-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin: 0 auto;
    }
    
    .branding-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .powered-by {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .ar-bites-logo {
      height: 35px;
      transition: var(--transition);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .social-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .social-link {
      color: var(--gold);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    
    .instagram-icon {
      width: 20px;
      height: 20px;
    }
    
    .copyright {
      font-size: 0.75rem;
      margin-top: 15px;
      color: rgba(255,255,255,0.7);
    }
    
    /* Login Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .modal-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
    }
    
    .modal-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--light-cream);
      text-align: left;
      font-size: 0.85rem;
    }
    
    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--gold);
      background: rgba(245, 245, 220, 0.1);
      color: white;
      font-size: 1rem;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Staff Dashboard - IMPROVED for better clarity and mobile experience */
    .staff-dashboard {
      display: none;
      padding: 12px;
    }
    
    /* IMPROVED: Better staff dashboard layout */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .stat-card {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--gold);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--light-cream);
    }
    
    /* IMPROVED: Better styling for tables management */
    .tables-management {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .table-card {
      position: relative;
      padding: 15px 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .table-card.available {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.5);
    }
    
    .table-card.occupied {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.5);
    }
    
    .table-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .table-number {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--gold);
    }
    
    .table-status {
      font-size: 0.7rem;
      margin-top: 5px;
    }
    
    .orders-list {
      margin-top: 15px;
    }
    
    .order-card {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      border-left: 3px solid var(--gold);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }
    
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }
    
    .status-preparing {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
    }
    
    .status-ready {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .status-completed {
      background: rgba(158, 158, 158, 0.2);
      color: #9E9E9E;
    }
    
    .status-cancelled {
      background: rgba(244, 67, 54, 0.2);
      color: #F44336;
    }
    
    .order-items {
      margin-bottom: 8px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }
    
    .order-actions {
      display: flex;
      gap: 8px; /* IMPROVED: Better spacing */
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      flex: 1;
      padding: 8px; /* IMPROVED: Better padding */
      border-radius: 4px;
      border: none;
      cursor: pointer;
      min-width: 70px;
      font-size: 0.75rem;
      margin: 0; /* Override general button margin */
    }
    
    /* User Type Selection */
    .user-type {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .user-btn {
      background: rgba(245, 245, 220, 0.1);
      color: white;
      border: 1px solid var(--gold);
      padding: 10px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      font-size: 0.85rem;
      margin: 0; /* Override general button margin */
    }
    
    .user-btn.active {
      background: var(--gold);
      color: var(--dark-green);
    }
    
    /* Cart System - IMPROVED with better spacing and recommendation layout */
    .add-to-cart {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(46, 125, 50, 0.3);
      font-size: 0.9rem;
      margin: 5px 0; /* Override general button margin */
    }
    
    .cart-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: 400px;
      background: rgba(26, 58, 47, 0.98);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      border: 1px solid var(--gold);
      z-index: 900;
      transform: translateX(120%);
      transition: var(--transition);
      max-height: 80vh; /* IMPROVED: Taller cart panel */
      display: flex;
      flex-direction: column;
    }
    
    .cart-panel.active {
      transform: translateX(0);
    }
    
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .cart-header h3 {
      margin: 0;
      color: var(--gold);
      font-size: 1rem;
    }
    
    .cart-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      max-height: 30vh;
      padding-right: 5px;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .item-name {
      flex: 2;
      text-align: left;
      font-size: 0.85rem;
    }
    
    .item-price {
      flex: 1;
      text-align: right;
      color: var(--gold);
      font-size: 0.85rem;
    }
    
    .remove-item {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      margin-left: 6px;
      font-size: 1rem;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0; /* Override general button margin */
    }
    
    /* NEW: Recommendations section in cart */
    .recommendations {
      margin-top: 15px;
      margin-bottom: 15px;
      border-top: 1px dashed rgba(212, 175, 55, 0.5);
      padding-top: 15px;
    }
    
    .recommendations h4 {
      color: var(--gold);
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-align: left;
    }
    
    .recommendation-items {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .recommendation-item {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 8px;
      padding: 10px;
      min-width: 120px;
      flex: 0 0 auto;
      text-align: left;
      border: 1px solid rgba(212, 175, 55, 0.3);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .recommendation-item:hover {
      background: rgba(245, 245, 220, 0.2);
      transform: translateY(-2px);
    }
    
    .recommendation-name {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .recommendation-price {
      font-size: 0.75rem;
      color: var(--gold);
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      width: 100%;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      font-size: 0.9rem;
      margin: 5px 0; /* Override general button margin */
    }
    
    .cart-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px; /* IMPROVED: Better spacing between buttons */
    }
    
    .checkout-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    .checkout-loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(26, 58, 47, 0.2);
      border-top-color: var(--dark-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cart-toggle {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: var(--gold);
      color: var(--dark-green);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 800;
      transition: var(--transition);
    }
    
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--red);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    /* Order Status Notification - IMPROVED to make it more visible */
    .order-status-notification {
      position: fixed;
      bottom: 12px;
      left: 12px;
      background: white;
      color: var(--dark-green);
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(-120%);
      transition: var(--transition);
      border-left: 3px solid var(--gold);
      width: calc(100% - 24px);
      max-width: 350px;
    }
    
    .order-status-notification.active {
      transform: translateX(0);
    }
    
    .status-icon {
      width: 22px;
      height: 22px;
    }
    
    .status-content {
      flex: 1;
      text-align: left;
    }
    
    .status-title {
      font-weight: bold;
      margin-bottom: 2px;
      color: var(--dark-green);
      font-size: 0.9rem;
    }
    
    .status-message {
      font-size: 0.8rem;
      color: #555;
    }
    
    .close-status {
      background: none;
      border: none;
      color: #999;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 6px;
    }

    /* Client Order Status - IMPROVED with cancel button */
    .client-orders {
      display: none;
      margin-top: 15px;
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
    }

    .client-orders.active {
      display: block;
    }

    .client-orders h3 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .client-order {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      position: relative;
    }

    .client-order:last-child {
      border-bottom: none;
    }

    .client-order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .client-order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }

    .client-order-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
    }

    .client-order-items {
      margin-bottom: 6px;
    }

    .client-order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      font-size: 0.8rem;
    }

    /* NEW: Cancel order button */
    .cancel-order {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--red);
      color: white;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      opacity: 0.8;
      transition: var(--transition);
    }

    .cancel-order:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .view-orders-btn {
      margin-top: 15px;
      width: 100%;
      background: rgba(212, 175, 55, 0.2);
      border: 1px solid var(--gold);
      color: var(--gold);
    }

    /* Table Number Modal - NEW IMPROVED */
    .table-number-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      padding: 15px;
    }

    .table-number-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
      text-align: center;
    }

    .table-number-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .table-number-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .table-number-btn {
      background: rgba(245, 245, 220, 0.1);
      color: var(--gold);
      border: 1px solid var(--gold);
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      font-weight: bold;
    }

    .table-number-btn:hover {
      background: var(--gold);
      color: var(--dark-green);
    }

    /* NEW: Table number indicator for customers */
    .change-table-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      background: rgba(212, 175, 55, 0.3);
      color: var(--gold);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      z-index: 800;
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
    }

    .current-table-number {
      font-weight: bold;
      margin-left: 5px;
    }

    /* Making tables more readable on mobile */
    @media (max-width: 480px) {
      .nav-buttons button {
        padding: 8px 12px;
        font-size: 0.8rem;
      }
      
      .food-container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .order-actions {
        flex-direction: column;
      }
      
      .action-btn {
        width: 100%;
        margin-bottom: 5px;
      }
      
      .tables-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      
      .table-card {
        padding: 10px 5px;
      }
      
      .table-number {
        font-size: 1rem;
      }
      
      .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="header">
      <h1>The Oak Cafe</h1>
      <p class="tagline">Premium AR Dining Experience</p>
      
      <!-- NEW: Table number display and change button for customers -->
      <div id="changeTableBtn" class="change-table-btn" style="display: none;">
        Table: <span id="currentTableNumber" class="current-table-number">1</span>
      </div>

      <div class="user-type">
        <button id="customerBtn" class="user-btn active">Customer</button>
        <button id="staffBtn" class="user-btn">Staff</button>
      </div>
    </div>

    <!-- Customer View -->
    <div id="customerView">
      <div class="food-container">
        <model-viewer id="foodModel" src="" alt="3D food model" ar ar-modes="webxr scene-viewer quick-look" 
          camera-controls auto-rotate shadow-intensity="1" shadow-softness="1" exposure="1.2"
          poster="https://cdn.glitch.com/d71c330f-b9a5-4cdd-82a3-b2f9afa9ab03%2Fgun_poster.png?v=1591287804224">
          <button slot="ar-button" class="ar-button">
            View in Your Space
          </button>
        </model-viewer>

        <div class="nav-buttons">
          <button id="previousBtn">Previous Item</button>
          <button id="addToCartBtn">Add to Cart</button>
          <button id="nextBtn">Next Item</button>
        </div>

        <!-- NEW: Better positioned navigation controls that are always visible -->
        <div class="nav-controls">
          <button id="prevControlBtn">&lsaquo;</button>
          <button id="nextControlBtn">&rsaquo;</button>
        </div>

        <!-- Client Orders Section -->
        <div id="clientOrders" class="client-orders">
          <h3>Your Orders</h3>
          <div id="clientOrdersList">
            <!-- Orders will be populated here -->
          </div>
        </div>
      </div>

      <!-- Cart Toggle Button -->
      <div id="cartToggle" class="cart-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <span id="cartCount" class="cart-count" style="display: none;">0</span>
      </div>

      <!-- Cart Panel - IMPROVED with recommendations -->
      <div id="cartPanel" class="cart-panel">
        <div class="cart-header">
          <h3>Your Cart</h3>
          <button id="closeCart" class="close-status">×</button>
        </div>
        <div id="cartItems" class="cart-items">
          <!-- Cart items will be populated here -->
          <div class="cart-empty" style="text-align: center; padding: 20px;">
            Your cart is empty
          </div>
        </div>

        <!-- NEW: Recommendations Section -->
        <div id="recommendations" class="recommendations" style="display: none;">
          <h4>You might also like:</h4>
          <div id="recommendationItems" class="recommendation-items">
            <!-- Recommendations will be populated here -->
          </div>
        </div>

        <!-- IMPROVED: Better spacing between buttons -->
        <div class="cart-buttons">
          <div id="cartTotal" style="text-align: right; margin-bottom: 10px; color: var(--gold); font-weight: bold;">Total: $0.00</div>
          <button id="checkoutBtn" class="checkout-btn" disabled>
            <span class="checkout-text">Complete Order</span>
          </button>
          <button id="clearCartBtn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
            Clear Cart
          </button>
        </div>
      </div>

      <!-- Order Status Notification -->
      <div id="orderStatusNotification" class="order-status-notification">
        <div class="status-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-content">
          <div class="status-title">Order Placed Successfully!</div>
          <div class="status-message">Your order #12345 is being prepared.</div>
        </div>
        <button class="close-status">×</button>
      </div>
    </div>

    <!-- Staff View - IMPROVED for better mobile experience and clarity -->
    <div id="staffView" class="staff-dashboard">
      <h2 style="color: var(--gold); margin-bottom: 15px;">Staff Dashboard</h2>
      
      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <div id="pendingOrdersCount" class="stat-value">0</div>
          <div class="stat-label">Pending Orders</div>
        </div>
        <div class="stat-card">
          <div id="occupiedTablesCount" class="stat-value">0</div>
          <div class="stat-label">Occupied Tables</div>
        </div>
        <div class="stat-card">
          <div id="todayOrdersCount" class="stat-value">0</div>
          <div class="stat-label">Today's Orders</div>
        </div>
      </div>
      
      <!-- Tables Management - NEW improved interface -->
      <div class="tables-management">
        <h3 style="color: var(--gold); margin-bottom: 10px;">Tables Management</h3>
        <div id="tablesGrid" class="tables-grid">
          <!-- Tables will be populated here -->
        </div>
      </div>
      
      <!-- Orders Section -->
      <h3 style="color: var(--gold); margin-top: 20px; margin-bottom: 10px;">Orders</h3>
      <div class="orders-filter" style="margin-bottom: 15px; display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;">
        <button id="filterAllOrders" class="action-btn" style="background: var(--gold); color: var(--dark-green);">All</button>
        <button id="filterPendingOrders" class="action-btn" style="background: rgba(255, 193, 7, 0.2); color: #FFC107;">Pending</button>
        <button id="filterPreparingOrders" class="action-btn" style="background: rgba(33, 150, 243, 0.2); color: #2196F3;">Preparing</button>
        <button id="filterReadyOrders" class="action-btn" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">Ready</button>
      </div>
      <div id="ordersList" class="orders-list">
        <!-- Orders will be populated here -->
      </div>
    </div>

    <div class="footer">
      <div class="footer-grid">
        <div class="branding-section">
          <div class="powered-by">
            <img src="https://source.unsplash.com/random/100x35/?logo,restaurant" alt="Logo" class="ar-bites-logo">
          </div>
          <div class="social-links">
            <a href="#" class="social-link">
              <svg class="instagram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
              @theoakcafe
            </a>
            <a href="#" class="social-link">
              Contact Us
            </a>
          </div>
        </div>
      </div>
      <div class="copyright">
        © 2023 The Oak Cafe. All rights reserved.
      </div>
    </div>
  </div>

  <!-- Staff Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">Staff Login</h3>
      <div class="input-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="Enter your username">
      </div>
      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter your password">
      </div>
      <div class="modal-buttons">
        <button id="loginBtn" style="background: var(--gold); color: var(--dark-green);">Login</button>
        <button id="cancelLoginBtn" style="background: rgba(255,255,255,0.1); color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- NEW: Table Number Selection Modal shown only once at first load -->
  <div id="tableNumberModal" class="table-number-modal">
    <div class="table-number-content">
      <h3 class="table-number-title">Select Your Table Number</h3>
      <p style="margin-bottom: 15px; color: var(--light-cream);">Please select your table number to continue</p>
      <div class="table-number-grid">
        <!-- Table numbers will be populated here -->
      </div>
    </div>
  </div>

  <script>
    // Initialize Firebase with your new configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAUCymhsmIx4IOkHphEFpLEhfLnPk0iPhU",
      authDomain: "the-oak-cafe-menu.firebaseapp.com",
      projectId: "the-oak-cafe-menu",
      storageBucket: "the-oak-cafe-menu.firebasestorage.app",
      messagingSenderId: "69318608602",
      appId: "1:69318608602:web:e13a53b0e7d674522647e3",
      measurementId: "G-8BNCQ270K7"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // App state variables
    let currentIndex = 0;
    let menuItems = [];
    let cartItems = [];
    let currentTableNumber = null;
    let isStaffLoggedIn = false;
    let orders = [];
    let tables = [];
    let orderCancellationTimers = {};

    // DOM Element references
    const customerView = document.getElementById('customerView');
    const staffView = document.getElementById('staffView');
    const customerBtn = document.getElementById('customerBtn');
    const staffBtn = document.getElementById('staffBtn');
    const foodModel = document.getElementById('foodModel');
    const previousBtn = document.getElementById('previousBtn');
    const nextBtn = document.getElementById('nextBtn');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const cartToggle = document.getElementById('cartToggle');
    const cartPanel = document.getElementById('cartPanel');
    const cartItems_el = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const closeCart = document.getElementById('closeCart');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const orderStatusNotification = document.getElementById('orderStatusNotification');
    const clientOrders = document.getElementById('clientOrders');
    const clientOrdersList = document.getElementById('clientOrdersList');
    const loginModal = document.getElementById('loginModal');
    const tableNumberModal = document.getElementById('tableNumberModal');
    const prevControlBtn = document.getElementById('prevControlBtn');
    const nextControlBtn = document.getElementById('nextControlBtn');
    const changeTableBtn = document.getElementById('changeTableBtn');
    const currentTableNumber_el = document.getElementById('currentTableNumber');
    const recommendations = document.getElementById('recommendations');
    const recommendationItems = document.getElementById('recommendationItems');
    
    // Staff dashboard elements
    const pendingOrdersCount = document.getElementById('pendingOrdersCount');
    const occupiedTablesCount = document.getElementById('occupiedTablesCount');
    const todayOrdersCount = document.getElementById('todayOrdersCount');
    const tablesGrid = document.getElementById('tablesGrid');
    const ordersList = document.getElementById('ordersList');
    const filterAllOrders = document.getElementById('filterAllOrders');
    const filterPendingOrders = document.getElementById('filterPendingOrders');
    const filterPreparingOrders = document.getElementById('filterPreparingOrders');
    const filterReadyOrders = document.getElementById('filterReadyOrders');

    // Cart total element
    const cartTotal = document.getElementById('cartTotal');

    // Helper Functions

    function formatPrice(price) {
      return (price / 100).toFixed(2);
    }

    function formatTime(timestamp) {
      if (!timestamp) return 'Just now';
      
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function getStatusColor(status) {
      switch (status) {
        case 'pending':
          return 'status-pending';
        case 'preparing':
          return 'status-preparing';
        case 'ready':
          return 'status-ready';
        case 'completed':
          return 'status-completed';
        case 'cancelled':
          return 'status-cancelled';
        default:
          return '';
      }
    }

    // IMPROVED: Load menu items with error handling
    async function loadMenuItems() {
      try {
        // Check if collection exists first
        const menuCollection = await db.collection('menuItems').get();
        
        if (menuCollection.empty) {
          // Add sample menu items if collection is empty
          await seedMenuItems();
          await loadMenuItems(); // Retry loading
          return;
        }
        
        menuItems = menuCollection.docs.map(doc => {
          return {
            id: doc.id,
            ...doc.data()
          };
        });
        
        // Sort menu items by category
        menuItems.sort((a, b) => a.category.localeCompare(b.category));
        
        if (menuItems.length > 0) {
          displayMenuItem(0);
        }
      } catch (error) {
        console.error("Error loading menu items:", error);
        // Fallback to sample data
        menuItems = getSampleMenuItems();
        displayMenuItem(0);
      }
    }

    // Seed sample menu items
    async function seedMenuItems() {
      const sampleMenuItems = [
        {
          name: "Classic Margherita Pizza",
          description: "Fresh mozzarella, tomato sauce, basil, and extra virgin olive oil",
          price: 1495,
          category: "Pizza",
          modelUrl: "https://modelviewer.dev/shared-assets/models/pizza.glb",
          imageUrl: "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        },
        {
          name: "Pepperoni Pizza",
          description: "Tomato sauce, mozzarella, and pepperoni",
          price: 1695,
          category: "Pizza",
          modelUrl: "https://modelviewer.dev/shared-assets/models/pizza.glb",
          imageUrl: "https://images.unsplash.com/photo-1628840042765-356cda07504e?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        },
        {
          name: "Fettuccine Alfredo",
          description: "Fettuccine pasta in a creamy Parmesan sauce",
          price: 1895,
          category: "Pasta",
          modelUrl: "https://modelviewer.dev/shared-assets/models/pasta.glb",
          imageUrl: "https://images.unsplash.com/photo-1645112411341-6c4fd023882c?auto=format&fit=crop&w=500&q=80",
          isPopular: false,
          isAvailable: true
        },
        {
          name: "Tiramisu",
          description: "Classic Italian dessert with coffee-soaked ladyfingers and mascarpone cream",
          price: 895,
          category: "Dessert",
          modelUrl: "https://modelviewer.dev/shared-assets/models/Tiramisu.glb",
          imageUrl: "https://images.unsplash.com/photo-1571877899936-e7d5757114b9?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        },
        {
          name: "Caprese Salad",
          description: "Fresh mozzarella, tomatoes, and basil with balsamic glaze",
          price: 1295,
          category: "Appetizer",
          modelUrl: "https://modelviewer.dev/shared-assets/models/salad.glb",
          imageUrl: "https://images.unsplash.com/photo-1592417817098-8fd3d9eb14a5?auto=format&fit=crop&w=500&q=80",
          isPopular: false,
          isAvailable: true
        },
        {
          name: "Chocolate Lava Cake",
          description: "Warm chocolate cake with a molten center, served with vanilla ice cream",
          price: 995,
          category: "Dessert",
          modelUrl: "https://modelviewer.dev/shared-assets/models/cake.glb",
          imageUrl: "https://images.unsplash.com/photo-1563805042-7684c019e1cb?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        },
        {
          name: "Garlic Bread",
          description: "Toasted bread with garlic butter and herbs",
          price: 595,
          category: "Appetizer",
          modelUrl: "https://modelviewer.dev/shared-assets/models/bread.glb",
          imageUrl: "https://images.unsplash.com/photo-1573140401453-cbada022b4c9?auto=format&fit=crop&w=500&q=80",
          isPopular: false,
          isAvailable: true
        },
        {
          name: "Red Wine (Glass)",
          description: "House selection of Italian red wine",
          price: 995,
          category: "Drink",
          modelUrl: "https://modelviewer.dev/shared-assets/models/wine.glb",
          imageUrl: "https://images.unsplash.com/photo-1553361371-9fe91b8da0cd?auto=format&fit=crop&w=500&q=80",
          isPopular: false,
          isAvailable: true
        }
      ];

      try {
        const batch = db.batch();
        
        sampleMenuItems.forEach(item => {
          const docRef = db.collection('menuItems').doc();
          batch.set(docRef, item);
        });
        
        await batch.commit();
        console.log("Sample menu items added successfully");
      } catch (error) {
        console.error("Error adding sample menu items:", error);
      }
    }

    // Sample menu items for fallback
    function getSampleMenuItems() {
      return [
        {
          id: "sample1",
          name: "Classic Margherita Pizza",
          description: "Fresh mozzarella, tomato sauce, basil, and extra virgin olive oil",
          price: 1495,
          category: "Pizza",
          modelUrl: "https://modelviewer.dev/shared-assets/models/pizza.glb",
          imageUrl: "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        },
        {
          id: "sample2",
          name: "Pepperoni Pizza",
          description: "Tomato sauce, mozzarella, and pepperoni",
          price: 1695,
          category: "Pizza",
          modelUrl: "https://modelviewer.dev/shared-assets/models/pizza.glb",
          imageUrl: "https://images.unsplash.com/photo-1628840042765-356cda07504e?auto=format&fit=crop&w=500&q=80",
          isPopular: true,
          isAvailable: true
        }
      ];
    }

    // Display the current menu item
    function displayMenuItem(index) {
      if (menuItems.length === 0) return;
      
      currentIndex = index;
      const item = menuItems[currentIndex];
      
      // Set the 3D model or fallback to basic one if not available
      if (item.modelUrl) {
        foodModel.src = item.modelUrl;
        foodModel.alt = item.name;
      } else {
        foodModel.src = "https://modelviewer.dev/shared-assets/models/pizza.glb";
        foodModel.alt = item.name;
      }
      
      // Set item information
      document.querySelector('.food-container').dataset.itemId = item.id;
      
      // Update the header to show category, name, and price
      const header = document.querySelector('h1');
      header.innerHTML = `${item.name} <span style="font-size: 0.8em;">$${formatPrice(item.price)}</span>`;
      
      const tagline = document.querySelector('.tagline');
      tagline.textContent = item.description;
      
      // Update add to cart button to show name
      addToCartBtn.textContent = `Add ${item.name} to Cart`;
    }
    
    // Navigation Functions
    function showPreviousItem() {
      if (currentIndex > 0) {
        displayMenuItem(currentIndex - 1);
      } else {
        displayMenuItem(menuItems.length - 1);
      }
    }
    
    function showNextItem() {
      if (currentIndex < menuItems.length - 1) {
        displayMenuItem(currentIndex + 1);
      } else {
        displayMenuItem(0);
      }
    }
    
    // IMPROVED: Cart Functions with recommendations
    function addToCart(itemId = null) {
      if (!currentTableNumber) {
        showTableNumberModal();
        return;
      }
      
      // If itemId is not provided, use the currently displayed item
      if (!itemId) {
        const currentItem = menuItems[currentIndex];
        itemId = currentItem.id;
      }
      
      const item = menuItems.find(item => item.id === itemId);
      if (!item) return;
      
      // Check if the item is already in the cart
      const existingItem = cartItems.find(cartItem => cartItem.id === item.id);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cartItems.push({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: 1
        });
      }
      
      updateCartUI();
      showRecommendations();
      
      // Show the notification
      const notification = document.createElement('div');
      notification.className = 'order-status-notification active';
      notification.style.transition = 'all 0.3s ease';
      notification.innerHTML = `
        <div class="status-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-content">
          <div class="status-title">Item Added to Cart</div>
          <div class="status-message">${item.name} added to your cart</div>
        </div>
        <button class="close-status">×</button>
      `;
      
      document.body.appendChild(notification);
      
      // Remove the notification after 3 seconds
      setTimeout(() => {
        notification.style.transform = 'translateX(-120%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
      
      // Add event listener to close button
      notification.querySelector('.close-status').addEventListener('click', () => {
        notification.style.transform = 'translateX(-120%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      });

      // Show cart when first item is added
      if (cartItems.length === 1) {
        showCart();
      }
    }
    
    // NEW: Show relevant recommendations based on cart items
    function showRecommendations() {
      if (cartItems.length === 0) {
        recommendations.style.display = 'none';
        return;
      }
      
      // Get categories from current cart
      const cartCategories = new Set();
      cartItems.forEach(item => {
        const menuItem = menuItems.find(menuItem => menuItem.id === item.id);
        if (menuItem) {
          cartCategories.add(menuItem.category);
        }
      });
      
      // Get item IDs already in cart to exclude
      const cartItemIds = cartItems.map(item => item.id);
      
      // Find recommendations (items not in cart)
      const recommendedItems = menuItems.filter(item => 
        !cartItemIds.includes(item.id) && 
        (item.isPopular || cartCategories.has(item.category))
      ).slice(0, 5); // Limit to 5 recommendations
      
      if (recommendedItems.length === 0) {
        recommendations.style.display = 'none';
        return;
      }
      
      // Display recommendations
      recommendations.style.display = 'block';
      recommendationItems.innerHTML = '';
      
      recommendedItems.forEach(item => {
        const recItemEl = document.createElement('div');
        recItemEl.className = 'recommendation-item';
        recItemEl.dataset.id = item.id;
        recItemEl.innerHTML = `
          <div class="recommendation-name">${item.name}</div>
          <div class="recommendation-price">$${formatPrice(item.price)}</div>
        `;
        
        recItemEl.addEventListener('click', () => {
          addToCart(item.id);
        });
        
        recommendationItems.appendChild(recItemEl);
      });
    }
    
    function updateCartUI() {
      // Update cart count
      const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      
      if (totalItems > 0) {
        cartCount.textContent = totalItems;
        cartCount.style.display = 'flex';
        checkoutBtn.disabled = false;
      } else {
        cartCount.style.display = 'none';
        checkoutBtn.disabled = true;
      }
      
      // Update cart items
      cartItems_el.innerHTML = '';
      
      if (cartItems.length === 0) {
        cartItems_el.innerHTML = `
          <div class="cart-empty" style="text-align: center; padding: 20px;">
            Your cart is empty
          </div>
        `;
        return;
      }
      
      cartItems.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <div class="item-name">${item.quantity} x ${item.name}</div>
          <div class="item-price">$${formatPrice(item.price * item.quantity)}</div>
          <button class="remove-item" data-id="${item.id}">×</button>
        `;
        
        cartItems_el.appendChild(cartItem);
        
        // Add event listener to remove button
        cartItem.querySelector('.remove-item').addEventListener('click', () => {
          removeFromCart(item.id);
        });
      });
      
      // Update cart total
      const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      cartTotal.textContent = `Total: $${formatPrice(total)}`;
    }
    
    function removeFromCart(itemId) {
      cartItems = cartItems.filter(item => item.id !== itemId);
      updateCartUI();
      showRecommendations();
    }
    
    function clearCart() {
      cartItems = [];
      updateCartUI();
      showRecommendations();
    }
    
    function showCart() {
      cartPanel.classList.add('active');
      showRecommendations();
    }
    
    function hideCart() {
      cartPanel.classList.remove('active');
    }
    
    // IMPROVED: Checkout function that automatically shows order status
    async function checkout() {
      if (cartItems.length === 0 || !currentTableNumber) return;
      
      checkoutBtn.classList.add('checkout-loading');
      checkoutBtn.disabled = true;
      
      const order = {
        tableNumber: currentTableNumber,
        items: cartItems,
        status: 'pending',
        totalAmount: cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        const docRef = await db.collection('orders').add(order);
        console.log("Order created with ID: ", docRef.id);
        
        // Clear cart
        cartItems = [];
        updateCartUI();
        hideCart();
        
        // Update table status to occupied
        await db.collection('tables').doc(currentTableNumber.toString()).set({
          tableNumber: currentTableNumber,
          status: 'occupied',
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Show order confirmation notification
        showOrderConfirmation(docRef.id);
        
        // NEW: Automatically show the client orders panel
        showClientOrders();
        
        // Start cancellation timer
        startOrderCancellationTimer(docRef.id);
        
        // Log analytics event
        analytics.logEvent('purchase', {
          transaction_id: docRef.id,
          value: order.totalAmount / 100,
          currency: 'USD'
        });
      } catch (error) {
        console.error("Error creating order: ", error);
        
        // Show error notification
        const notification = document.createElement('div');
        notification.className = 'order-status-notification active';
        notification.style.background = '#ffebee';
        notification.innerHTML = `
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#F44336" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <div class="status-content">
            <div class="status-title" style="color: #d32f2f;">Order Failed</div>
            <div class="status-message" style="color: #d32f2f;">Please try again later.</div>
          </div>
          <button class="close-status">×</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.transform = 'translateX(-120%)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 5000);
        
        notification.querySelector('.close-status').addEventListener('click', () => {
          notification.style.transform = 'translateX(-120%)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        });
      } finally {
        checkoutBtn.classList.remove('checkout-loading');
        checkoutBtn.disabled = false;
      }
    }
    
    // NEW: Start the cancellation timer for an order (3 minutes)
    function startOrderCancellationTimer(orderId) {
      const timerId = setTimeout(async () => {
        try {
          // Remove cancel button from UI when timer expires
          const cancelBtns = document.querySelectorAll(`.cancel-order[data-id="${orderId}"]`);
          cancelBtns.forEach(btn => btn.remove());
          
          delete orderCancellationTimers[orderId];
        } catch (error) {
          console.error("Error handling order cancellation timer:", error);
        }
      }, 180000); // 3 minutes
      
      orderCancellationTimers[orderId] = timerId;
    }
    
    // NEW: Function to cancel an order
    async function cancelOrder(orderId) {
      try {
        await db.collection('orders').doc(orderId).update({
          status: 'cancelled',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Clear the cancellation timer
        if (orderCancellationTimers[orderId]) {
          clearTimeout(orderCancellationTimers[orderId]);
          delete orderCancellationTimers[orderId];
        }
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'order-status-notification active';
        notification.style.background = '#ffebee';
        notification.innerHTML = `
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#F44336" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          </div>
          <div class="status-content">
            <div class="status-title" style="color: #d32f2f;">Order Cancelled</div>
            <div class="status-message" style="color: #555;">Your order has been cancelled.</div>
          </div>
          <button class="close-status">×</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.transform = 'translateX(-120%)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 5000);
        
        notification.querySelector('.close-status').addEventListener('click', () => {
          notification.style.transform = 'translateX(-120%)';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        });
        
        // Refresh orders display
        loadOrdersForCustomer();
      } catch (error) {
        console.error("Error cancelling order:", error);
      }
    }
    
    function showOrderConfirmation(orderId) {
      // Show order confirmation notification
      const notification = document.createElement('div');
      notification.className = 'order-status-notification active';
      notification.innerHTML = `
        <div class="status-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <div class="status-content">
          <div class="status-title">Order Placed Successfully!</div>
          <div class="status-message">Your order #${orderId.slice(0, 6)} is being prepared.</div>
        </div>
        <button class="close-status">×</button>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(-120%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 5000);
      
      notification.querySelector('.close-status').addEventListener('click', () => {
        notification.style.transform = 'translateX(-120%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      });
    }
    
    // NEW: Improved table number selection functionality
    function showTableNumberModal() {
      tableNumberModal.style.display = 'flex';
      
      // Populate table number grid
      const tableNumberGrid = document.querySelector('.table-number-grid');
      tableNumberGrid.innerHTML = '';
      
      for (let i = 1; i <= 16; i++) {
        const tableBtn = document.createElement('button');
        tableBtn.className = 'table-number-btn';
        tableBtn.textContent = i;
        tableBtn.addEventListener('click', () => {
          selectTableNumber(i);
        });
        
        tableNumberGrid.appendChild(tableBtn);
      }
    }
    
    // NEW: Select table number and save to localStorage
    function selectTableNumber(number) {
      currentTableNumber = number;
      currentTableNumber_el.textContent = number;
      changeTableBtn.style.display = 'flex';
      tableNumberModal.style.display = 'none';
      
      // Save to localStorage to remember between visits
      localStorage.setItem('oakCafeTableNumber', number);
      
      // Check for existing table in Firestore or create it
      db.collection('tables').doc(number.toString()).get()
        .then(doc => {
          if (!doc.exists) {
            // Create table document
            db.collection('tables').doc(number.toString()).set({
              tableNumber: number,
              status: 'available',
              lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .catch(error => {
          console.error("Error checking table:", error);
        });
    }
    
    // Show Orders for Customer
    function showClientOrders() {
      if (!currentTableNumber) return;
      
      clientOrders.classList.add('active');
      loadOrdersForCustomer();
    }
    
    // Load Customer Orders
    async function loadOrdersForCustomer() {
      if (!currentTableNumber) return;
      
      try {
        const snapshot = await db.collection('orders')
          .where('tableNumber', '==', currentTableNumber)
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();
        
        clientOrdersList.innerHTML = '';
        
        if (snapshot.empty) {
          clientOrdersList.innerHTML = '<p style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">No orders yet</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const order = {
            id: doc.id,
            ...doc.data()
          };
          
          const orderEl = document.createElement('div');
          orderEl.className = 'client-order';
          
          // Calculate if order is within 3-minute cancellation window
          const createdAt = order.createdAt?.toDate?.() || new Date();
          const now = new Date();
          const diffInMs = now - createdAt;
          const diffInMinutes = diffInMs / 60000;
          const canCancel = order.status === 'pending' && diffInMinutes < 3;
          
          let orderHTML = `
            <div class="client-order-header">
              <div class="client-order-id">Order #${order.id.slice(0, 6)}</div>
              <div class="client-order-status ${getStatusColor(order.status)}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</div>
            </div>
            <div class="client-order-items">
          `;
          
          // Add cancel button if within time window
          if (canCancel) {
            orderHTML += `<div class="cancel-order" data-id="${order.id}">×</div>`;
          }
          
          // Add order items
          order.items.forEach(item => {
            orderHTML += `
              <div class="client-order-item">
                <span>${item.quantity} × ${item.name}</span>
                <span>$${formatPrice(item.price * item.quantity)}</span>
              </div>
            `;
          });
          
          // Add order total
          orderHTML += `
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-weight: bold; font-size: 0.85rem;">
              <span>Total</span>
              <span>$${formatPrice(order.totalAmount)}</span>
            </div>
          `;
          
          orderEl.innerHTML = orderHTML;
          clientOrdersList.appendChild(orderEl);
          
          // Add event listener to cancel button
          const cancelBtn = orderEl.querySelector('.cancel-order');
          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
              cancelOrder(order.id);
            });
          }
        });
      } catch (error) {
        console.error("Error loading customer orders:", error);
        clientOrdersList.innerHTML = '<p style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">Error loading orders</p>';
      }
    }
    
    // Staff Functions
    
    function showLoginModal() {
      loginModal.style.display = 'flex';
      document.getElementById('username').focus();
    }
    
    function hideLoginModal() {
      loginModal.style.display = 'none';
    }
    
    function staffLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // For demo, simple validation
      if (username === 'staff' && password === 'password') {
        isStaffLoggedIn = true;
        hideLoginModal();
        switchToStaffView();
        
        // Start real-time listeners
        setupOrdersListener();
        setupTablesListener();
      } else {
        alert('Invalid credentials. Try using "staff" for both username and password.');
      }
    }
    
    // IMPROVED: Switch to Staff View with better UI
    function switchToStaffView() {
      customerView.style.display = 'none';
      staffView.style.display = 'block';
      customerBtn.classList.remove('active');
      staffBtn.classList.add('active');
      
      // Load initial data
      loadStaffDashboardData();
    }
    
    // Switch to Customer View
    function switchToCustomerView() {
      staffView.style.display = 'none';
      customerView.style.display = 'block';
      staffBtn.classList.remove('active');
      customerBtn.classList.add('active');
    }
    
    // IMPROVED: Load Staff Dashboard Data
    async function loadStaffDashboardData() {
      try {
        // Load orders
        const ordersSnapshot = await db.collection('orders')
          .orderBy('createdAt', 'desc')
          .get();
        
        orders = ordersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load tables
        const tablesSnapshot = await db.collection('tables').get();
        
        tables = tablesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // If no tables, create sample tables
        if (tables.length === 0) {
          await createSampleTables();
          await loadStaffDashboardData();
          return;
        }
        
        // Update UI
        updateStaffDashboardUI();
      } catch (error) {
        console.error("Error loading staff dashboard data:", error);
      }
    }
    
    // Create sample tables
    async function createSampleTables() {
      try {
        const batch = db.batch();
        
        for (let i = 1; i <= 16; i++) {
          const tableRef = db.collection('tables').doc(i.toString());
          batch.set(tableRef, {
            tableNumber: i,
            status: 'available',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        await batch.commit();
        console.log("Sample tables created");
      } catch (error) {
        console.error("Error creating sample tables:", error);
      }
    }
    
    // IMPROVED: Update Staff Dashboard UI
    function updateStaffDashboardUI() {
      // Update stats
      const pendingCount = orders.filter(order => order.status === 'pending').length;
      const occupiedCount = tables.filter(table => table.status === 'occupied').length;
      
      // Count today's orders
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayCount = orders.filter(order => {
        const orderDate = order.createdAt?.toDate?.() || new Date();
        return orderDate >= today;
      }).length;
      
      pendingOrdersCount.textContent = pendingCount;
      occupiedTablesCount.textContent = occupiedCount;
      todayOrdersCount.textContent = todayCount;
      
      // Update tables grid
      updateTablesGrid();
      
      // Update orders list
      updateOrdersList();
    }
    
    // IMPROVED: Update Tables Grid
    function updateTablesGrid() {
      tablesGrid.innerHTML = '';
      
      // Sort tables by number
      tables.sort((a, b) => a.tableNumber - b.tableNumber);
      
      tables.forEach(table => {
        const tableCard = document.createElement('div');
        tableCard.className = `table-card ${table.status}`;
        tableCard.dataset.id = table.id;
        tableCard.innerHTML = `
          <div class="table-number">${table.tableNumber}</div>
          <div class="table-status">${table.status.charAt(0).toUpperCase() + table.status.slice(1)}</div>
        `;
        
        // Add click event to toggle table status
        tableCard.addEventListener('click', () => {
          toggleTableStatus(table.id, table.status);
        });
        
        tablesGrid.appendChild(tableCard);
      });
    }
    
    // Toggle table status
    async function toggleTableStatus(tableId, currentStatus) {
      const newStatus = currentStatus === 'available' ? 'occupied' : 'available';
      
      try {
        await db.collection('tables').doc(tableId).update({
          status: newStatus,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`Table ${tableId} status updated to ${newStatus}`);
      } catch (error) {
        console.error("Error updating table status:", error);
      }
    }
    
    // Update Orders List with filtering
    function updateOrdersList(filterStatus = null) {
      ordersList.innerHTML = '';
      
      // Filter orders if status is provided
      let filteredOrders = orders;
      if (filterStatus) {
        filteredOrders = orders.filter(order => order.status === filterStatus);
      }
      
      // Sort orders by creation date (newest first)
      filteredOrders.sort((a, b) => {
        const dateA = a.createdAt?.toDate?.() || new Date();
        const dateB = b.createdAt?.toDate?.() || new Date();
        return dateB - dateA;
      });
      
      if (filteredOrders.length === 0) {
        ordersList.innerHTML = '<p style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">No orders to display</p>';
        return;
      }
      
      filteredOrders.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        orderCard.dataset.id = order.id;
        
        let orderHTML = `
          <div class="order-header">
            <div class="order-id">Order #${order.id.slice(0, 6)}</div>
            <div class="order-status ${getStatusColor(order.status)}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</div>
          </div>
          <div style="margin-bottom: 8px; font-size: 0.8rem;">
            <span style="color: var(--gold);">Table ${order.tableNumber}</span> • 
            <span>${formatTime(order.createdAt)}</span>
          </div>
          <div class="order-items">
        `;
        
        // Add order items
        order.items.forEach(item => {
          orderHTML += `
            <div class="order-item">
              <span>${item.quantity} × ${item.name}</span>
              <span>$${formatPrice(item.price * item.quantity)}</span>
            </div>
          `;
        });
        
        // Add order total
        orderHTML += `
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 8px; margin-bottom: 10px; font-weight: bold; font-size: 0.85rem;">
            <span>Total</span>
            <span>$${formatPrice(order.totalAmount)}</span>
          </div>
        `;
        
        // Add action buttons based on current status
        orderHTML += '<div class="order-actions">';
        
        if (order.status === 'pending') {
          orderHTML += `
            <button class="action-btn" style="background: #2196F3; color: white;" data-action="preparing" data-id="${order.id}">Start Preparing</button>
            <button class="action-btn" style="background: #F44336; color: white;" data-action="cancelled" data-id="${order.id}">Cancel</button>
          `;
        } else if (order.status === 'preparing') {
          orderHTML += `
            <button class="action-btn" style="background: #4CAF50; color: white;" data-action="ready" data-id="${order.id}">Mark Ready</button>
          `;
        } else if (order.status === 'ready') {
          orderHTML += `
            <button class="action-btn" style="background: #9E9E9E; color: white;" data-action="completed" data-id="${order.id}">Mark Completed</button>
          `;
        }
        
        orderHTML += '</div>';
        orderCard.innerHTML = orderHTML;
        ordersList.appendChild(orderCard);
        
        // Add event listeners to action buttons
        const actionButtons = orderCard.querySelectorAll('.action-btn');
        actionButtons.forEach(button => {
          button.addEventListener('click', () => {
            const action = button.getAttribute('data-action');
            const orderId = button.getAttribute('data-id');
            updateOrderStatus(orderId, action);
          });
        });
      });
    }
    
    // Update Order Status
    async function updateOrderStatus(orderId, newStatus) {
      try {
        await db.collection('orders').doc(orderId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log(`Order ${orderId} status updated to ${newStatus}`);
      } catch (error) {
        console.error("Error updating order status:", error);
      }
    }
    
    // Set up real-time listeners
    function setupOrdersListener() {
      db.collection('orders')
        .orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const order = {
              id: change.doc.id,
              ...change.doc.data()
            };
            
            if (change.type === 'added') {
              // Add to orders array if not already exists
              if (!orders.some(o => o.id === order.id)) {
                orders.push(order);
              }
            } else if (change.type === 'modified') {
              // Update existing order
              const index = orders.findIndex(o => o.id === order.id);
              if (index !== -1) {
                orders[index] = order;
              }
            } else if (change.type === 'removed') {
              // Remove from orders array
              const index = orders.findIndex(o => o.id === order.id);
              if (index !== -1) {
                orders.splice(index, 1);
              }
            }
          });
          
          // Update UI
          updateStaffDashboardUI();
          
          // If customer view showing, update customer orders
          if (customerView.style.display !== 'none' && currentTableNumber) {
            loadOrdersForCustomer();
          }
        });
    }
    
    function setupTablesListener() {
      db.collection('tables').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          const table = {
            id: change.doc.id,
            ...change.doc.data()
          };
          
          if (change.type === 'added') {
            // Add to tables array if not already exists
            if (!tables.some(t => t.id === table.id)) {
              tables.push(table);
            }
          } else if (change.type === 'modified') {
            // Update existing table
            const index = tables.findIndex(t => t.id === table.id);
            if (index !== -1) {
              tables[index] = table;
            }
          } else if (change.type === 'removed') {
            // Remove from tables array
            const index = tables.findIndex(t => t.id === table.id);
            if (index !== -1) {
              tables.splice(index, 1);
            }
          }
        });
        
        // Update UI
        updateStaffDashboardUI();
      });
    }
    
    // Initialization
    
    // Load menu items
    loadMenuItems();
    
    // Check if table number is already stored
    const storedTableNumber = localStorage.getItem('oakCafeTableNumber');
    if (storedTableNumber) {
      currentTableNumber = parseInt(storedTableNumber);
      currentTableNumber_el.textContent = storedTableNumber;
      changeTableBtn.style.display = 'flex';
    } else {
      // Show table selection modal
      showTableNumberModal();
    }
    
    // Event Listeners
    
    // Navigation buttons
    previousBtn.addEventListener('click', showPreviousItem);
    nextBtn.addEventListener('click', showNextItem);
    prevControlBtn.addEventListener('click', showPreviousItem);
    nextControlBtn.addEventListener('click', showNextItem);
    
    // Cart buttons
    addToCartBtn.addEventListener('click', () => addToCart());
    cartToggle.addEventListener('click', showCart);
    closeCart.addEventListener('click', hideCart);
    checkoutBtn.addEventListener('click', checkout);
    clearCartBtn.addEventListener('click', clearCart);
    
    // User type buttons
    customerBtn.addEventListener('click', switchToCustomerView);
    staffBtn.addEventListener('click', () => {
      if (isStaffLoggedIn) {
        switchToStaffView();
      } else {
        showLoginModal();
      }
    });
    
    // Login modal buttons
    document.getElementById('loginBtn').addEventListener('click', staffLogin);
    document.getElementById('cancelLoginBtn').addEventListener('click', hideLoginModal);
    
    // Table selection
    changeTableBtn.addEventListener('click', showTableNumberModal);
    
    // Staff order filters
    filterAllOrders.addEventListener('click', () => updateOrdersList());
    filterPendingOrders.addEventListener('click', () => updateOrdersList('pending'));
    filterPreparingOrders.addEventListener('click', () => updateOrdersList('preparing'));
    filterReadyOrders.addEventListener('click', () => updateOrdersList('ready'));
    
    // Keyboard Navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        showPreviousItem();
      } else if (e.key === 'ArrowRight') {
        showNextItem();
      }
    });
  </script>
</body>
</html>
