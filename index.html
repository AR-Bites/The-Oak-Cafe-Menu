<!DOCTYPE html>
<html>
<head>
  <title>The Oak Cafe - Premium AR Dining</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --gold: #D4AF37;
      --dark-green: #1A3A2F;
      --light-cream: #F5F5DC;
      --red: #B22222;
      --bright-red: #FF3B30;
      --green: #32CD32;
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    .overlay {
      background-color: rgba(26, 58, 47, 0.95);
      min-height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 10px 0;
      position: relative;
      text-align: center;
    }
    
    .header h1, 
    .header .tagline {
      text-align: center !important;
      width: 100%;
    }
    
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      padding: 5px;
    }
    
    .logo {
      height: 80px;
      filter: drop-shadow(0 2px 6px rgba(212, 175, 55, 0.3));
      max-width: 100%;
      animation: subtle-pulse 3s infinite alternate;
      transition: transform 0.3s ease;
    }
    
    @keyframes subtle-pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.03); }
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--gold);
      margin: 8px 0 4px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      line-height: 1.2;
    }
    
    .tagline {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.8rem;
      color: var(--light-cream);
      margin-bottom: 15px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    /* Category Selector */
    /* Category Container and Navigation - Enhanced for clarity */
    .category-container {
      display: flex;
      flex-direction: column;
      margin: 0 auto 20px;
      max-width: 650px;
      overflow: visible;
      background: rgba(26, 58, 47, 0.1);
      border-radius: 15px;
      padding: 15px 10px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .category-heading {
      text-align: center;
      margin-bottom: 10px;
      color: var(--gold);
      font-size: 16px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .main-categories {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .main-categories::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 1px;
      background: linear-gradient(to right, transparent, var(--gold), transparent);
    }
    
    .main-category-btn {
      padding: 12px 22px;
      background: rgba(26, 58, 47, 0.95);
      color: #fff;
      border: 2px solid var(--gold);
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      min-width: 110px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .main-category-btn::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 0;
      background-color: var(--gold);
      transition: width 0.3s ease;
    }
    
    .main-category-btn:hover {
      background: rgba(45, 89, 75, 0.95);
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    
    .main-category-btn:hover::before {
      width: 100%;
    }
    
    .main-category-btn.active {
      background: var(--gold);
      color: #1a3a2f;
      font-weight: 700;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .sub-categories {
      position: relative;
      padding-top: 5px;
    }
    
    .subcategory-label {
      text-align: center;
      font-size: 14px;
      color: var(--light-cream);
      margin-bottom: 8px;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .subcategory-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 10px 10px;
      max-width: 650px;
      position: relative;
    }
    
    .subcategory-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      width: 100%;
    }
    
    /* Subcategory button styles with improved visibility */
    .category-btn {
      padding: 10px 18px;
      background: rgba(26, 58, 47, 0.85);
      color: #fff;
      border: 1px solid var(--gold);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
      min-width: 100px;
      text-align: center;
      white-space: nowrap;
    }
    
    .category-btn::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 2px;
      width: 0;
      background-color: var(--gold);
      transition: width 0.3s ease;
    }
    
    .category-btn:hover {
      background: rgba(45, 89, 75, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .category-btn:hover::before {
      width: 100%;
    }
    
    .category-btn.active {
      background: var(--gold);
      color: #1a3a2f;
      font-weight: 600;
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }
    
    /* RTL Support for category navigation */
    .rtl .category-container,
    .rtl .main-categories,
    .rtl .subcategory-group {
      direction: rtl;
    }
    
    .food-container {
      width: 100%;
      margin: 0 auto;
      background: rgba(245, 245, 220, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border: 1px solid var(--gold);
      flex-grow: 1;
      position: relative;
      z-index: 1;
    }
    
    /* 3D Model Viewer Enhancements */
    .model-container {
      position: relative;
      width: 100%;
      height: 250px;
      margin: 12px 0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    model-viewer {
      width: 100%;
      height: 220px;
      margin: 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background-color: rgba(26, 58, 47, 0.1);
      --poster-color: transparent;
      transition: opacity 0.3s ease;
    }
    
    .model-loading-indicator {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(26, 58, 47, 0.4);
      backdrop-filter: blur(2px);
      z-index: 5;
      border-radius: 10px;
      transition: opacity 0.3s ease;
    }
    
    .model-spinner {
      width: 35px;
      height: 35px;
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid var(--gold);
      border-right: 3px solid var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .model-hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .nav-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-areas: "prev add next";
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 25px auto;
      position: relative;
      z-index: 50;
      padding: 15px;
      background: rgba(26, 58, 47, 0.9);
      backdrop-filter: blur(8px);
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(212, 175, 55, 0.5);
      width: 95%;
      max-width: 500px;
    }
    
    /* Enhanced navigation arrow buttons */
    .nav-arrow-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: rgba(245, 245, 220, 0.1);
      color: var(--gold);
      border: 2px solid var(--gold);
      border-radius: 50px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 120px;
      min-height: 50px;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #prev-btn {
      grid-area: prev;
    }
    
    .add-to-cart {
      grid-area: add;
    }
    
    #next-btn {
      grid-area: next;
    }
    
    .nav-arrow-btn:hover {
      background: rgba(212, 175, 55, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    
    .nav-arrow-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .nav-arrow-container {
      display: flex;
      width: 100%;
      justify-content: space-between;
      gap: 15px;
    }
    
    .nav-arrow-btn i {
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    
    #prev-btn:hover i {
      transform: translateX(-3px);
    }
    
    #next-btn:hover i {
      transform: translateX(3px);
    }
    
    button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: none;
      padding: 10px 12px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .ar-button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%) !important;
      color: var(--dark-green) !important;
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 20px;
      font-weight: 700;
      animation: pulse 2s infinite;
      font-size: 1.05rem;
      width: calc(100% - 24px);
      max-width: 220px;
      border-radius: 25px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
      z-index: 10;
      border: 2px solid rgba(255, 255, 255, 0.3) !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .ar-button::before {
      content: 'ðŸ‘“';
      font-size: 1.3rem;
      display: inline-block;
      margin-right: 5px;
      animation: subtle-wiggle 3s infinite;
    }
    
    @keyframes subtle-wiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(5deg); }
      75% { transform: rotate(-5deg); }
    }
    
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.03); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    .footer {
      margin-top: 20px;
      padding: 15px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 12px 12px 0 0;
      border-top: 2px solid var(--gold);
      position: relative;
      z-index: 1;
    }
    
    .footer::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 2px;
      background: var(--gold);
      border-radius: 2px;
    }
    
    .footer-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin: 0 auto;
    }
    
    .branding-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .powered-by {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .ar-bites-logo {
      height: 35px;
      transition: var(--transition);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .social-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .social-link {
      color: var(--gold);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    
    .instagram-icon {
      width: 20px;
      height: 20px;
    }
    
    .copyright {
      font-size: 0.75rem;
      margin-top: 15px;
      color: rgba(255,255,255,0.7);
    }
    
    /* Login Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .modal-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
    }
    
    .modal-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--light-cream);
      text-align: left;
      font-size: 0.85rem;
    }
    
    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: rgba(245, 245, 220, 0.1);
      color: white;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25);
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Staff Dashboard */
    .staff-dashboard {
      display: none;
      padding: 12px;
    }
    
    /* Staff header and role display */
    .staff-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      background-color: rgba(26, 58, 47, 0.7);
      padding: 12px 15px;
      border-radius: 10px;
      border-left: 4px solid var(--gold);
    }
    
    .staff-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .logout-btn {
      background: #d32f2f;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .logout-btn:hover {
      background: #b71c1c;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .logout-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    #staff-name-display {
      font-weight: bold;
      font-size: 0.9rem;
      color: var(--light-cream);
    }
    
    #staff-role-badge {
      background-color: var(--gold);
      color: var(--dark-green);
      font-size: 0.7rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 12px;
      margin-top: 5px;
      text-transform: uppercase;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Role-specific badge styles */
    .role-server {
      background-color: #4CAF50 !important;
      color: white !important;
    }
    
    .role-chef {
      background-color: #FF5722 !important;
      color: white !important;
    }
    
    .role-manager {
      background-color: #2196F3 !important;
      color: white !important;
    }
    
    .admin-name {
      font-size: 0.65rem;
      opacity: 0.8;
      font-weight: normal;
      display: block;
      margin-top: 3px;
      color: var(--gold);
    }
    
    .orders-list {
      margin-top: 15px;
    }
    
    /* Assigned staff info styling */
    .assigned-staff-info {
      margin: 5px 0;
      padding: 5px 8px;
      background-color: rgba(33, 33, 33, 0.6);
      border-radius: 4px;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .staff-role-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.7rem;
      color: white;
      margin-left: 5px;
      text-transform: uppercase;
    }
    
    .order-card {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      border-left: 3px solid var(--gold);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }
    
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .status-preparing {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
      border: 1px solid rgba(33, 150, 243, 0.3);
    }
    
    .status-ready {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .status-completed {
      background: rgba(158, 158, 158, 0.2);
      color: #9E9E9E;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(158, 158, 158, 0.2);
      border: 1px solid rgba(158, 158, 158, 0.3);
    }
    
    .status-cancelled {
      background: rgba(244, 67, 54, 0.1);
      color: #F44336;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    /* Style for cards when updating */
    .order-card.updating {
      position: relative;
      opacity: 0.8;
      transform: scale(0.99);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .order-card.updating::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.5) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 38 38"><defs><linearGradient x1="8.042%" y1="0%" x2="65.682%" y2="23.865%" id="a"><stop stop-color="%23476eff" stop-opacity="0" offset="0%"/><stop stop-color="%23476eff" stop-opacity=".631" offset="63.146%"/><stop stop-color="%23476eff" offset="100%"/></linearGradient></defs><g fill="none" fill-rule="evenodd"><g transform="translate(1 1)"><path d="M36 18c0-9.94-8.06-18-18-18" stroke="url(%23a)" stroke-width="2" transform="rotate(319.489 18 18)"><animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/></path></g></g></svg>') center no-repeat;
      z-index: 2;
      border-radius: 10px;
    }
    
    .order-items {
      margin-bottom: 8px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }
    
    .order-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      min-width: 80px;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s ease;
      background: linear-gradient(to bottom, #f7f7f7, #e8e8e8);
      color: #333;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:hover {
      background: linear-gradient(to bottom, #ffffff, #f0f0f0);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .action-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      background: #e8e8e8;
    }
    
    .action-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .action-btn:hover::after {
      opacity: 1;
    }
    
    /* User Type Selection */
    .user-type {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .user-btn {
      background: rgba(245, 245, 220, 0.1);
      color: white;
      border: 1px solid var(--gold);
      padding: 10px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      font-size: 0.85rem;
    }
    
    .user-btn.active {
      background: var(--gold);
      color: var(--dark-green);
    }
    
    /* Cart System */
    .add-to-cart {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(46, 125, 50, 0.3);
      font-size: 0.9rem;
    }
    
    .cart-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: 400px;
      background: rgba(26, 58, 47, 0.98);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      border: 1px solid var(--gold);
      z-index: 900;
      transform: translateX(120%);
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.1);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .cart-panel.active {
      transform: translateX(0);
      box-shadow: 0 8px 25px rgba(0,0,0,0.45);
    }
    
    @media (max-width: 480px) {
      .cart-panel {
        bottom: 0;
        right: 0;
        width: 100%;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        max-height: 85vh;
        padding-top: 25px;
      }
      
      .cart-panel.active {
        transform: translateY(0);
      }
      
      .cart-panel::before {
        content: '';
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
    }
    
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .cart-header h3 {
      margin: 0;
      color: var(--gold);
      font-size: 1rem;
    }
    
    .cart-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      max-height: 30vh;
      padding-right: 5px;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .item-name {
      flex: 2;
      text-align: left;
      font-size: 0.85rem;
    }
    
    .item-price {
      flex: 1;
      text-align: right;
      color: var(--gold);
      font-size: 0.85rem;
    }
    
    .remove-item {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      margin-left: 6px;
      font-size: 1rem;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      width: 100%;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      font-size: 0.9rem;
    }
    
    .checkout-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    /* Loading button styles */
    .checkout-loading {
      position: relative;
      pointer-events: none; /* Prevent any interactions during loading */
    }
    
    /* Hide the text content */
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    /* Clean loading spinner without overriding conflicts */
    .checkout-loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(26, 58, 47, 0.2);
      border-top-color: var(--dark-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      background: none;
      z-index: 1;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cart-toggle {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: var(--gold);
      color: var(--dark-green);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 800;
      transition: var(--transition);
    }
    
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--red);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    /* Order Status Notification - Enhanced for better visibility and experience */
    .order-status-notification {
      position: fixed;
      top: 20px; /* Centered at the top */
      left: 50%;
      transform: translateX(-50%) translateY(-120%);
      background: white;
      color: var(--dark-green);
      padding: 18px 22px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 3px 8px rgba(0,0,0,0.3);
      z-index: 9999; /* Ensure highest visibility */
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border-left: 6px solid var(--gold);
      width: calc(100% - 40px);
      max-width: 420px;
      opacity: 0;
      text-align: left;
      animation: notification-pulse 3s infinite alternate;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    @keyframes notification-pulse {
      0% { box-shadow: 0 10px 35px rgba(0,0,0,0.4); }
      50% { box-shadow: 0 10px 35px rgba(212, 175, 55, 0.35); }
      100% { box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    }
    
    .order-status-notification.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .order-status-notification.success {
      border-left-color: var(--green);
      background: linear-gradient(to right, rgba(76, 175, 80, 0.1), white);
    }
    
    .order-status-notification.error {
      border-left-color: var(--bright-red);
      background: linear-gradient(to right, rgba(244, 67, 54, 0.1), white);
    }
    
    .order-status-notification.info {
      border-left-color: #2196F3;
      background: linear-gradient(to right, rgba(33, 150, 243, 0.1), white);
    }
    
    .status-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .order-status-notification.success .status-icon {
      color: #4CAF50;
    }
    
    .order-status-notification.error .status-icon {
      color: #F44336;
    }
    
    .order-status-notification.info .status-icon {
      color: #2196F3;
    }
    
    .status-content {
      flex: 1;
      text-align: left;
    }
    
    .status-title {
      font-weight: bold;
      margin-bottom: 4px;
      color: var(--dark-green);
      font-size: 1rem;
    }
    
    .status-message {
      font-size: 0.85rem;
      color: #333;
      line-height: 1.3;
    }
    
    .close-status {
      background: none;
      border: none;
      color: #666;
      font-size: 1.1rem;
      cursor: pointer;
      margin-left: 8px;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .close-status:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #333;
    }

    /* Client Order Status */
    .client-orders {
      display: none;
      margin-top: 15px;
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 12px;
    }

    .client-orders.active {
      display: block;
    }

    .client-orders h3 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1rem;
    }

    .client-order {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .client-order:last-child {
      border-bottom: none;
    }

    .client-order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .client-order-id {
      color: var(--gold);
      font-weight: bold;
      font-size: 0.85rem;
    }

    .client-order-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .client-order-status::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: currentColor;
      box-shadow: 0 0 3px currentColor;
    }

    .client-order-items {
      margin-bottom: 6px;
    }

    .client-order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      font-size: 0.8rem;
    }

    .view-orders-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px;
      font-size: 0.8rem;
    }

    /* Table Number Modal */
    .table-number-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 15px;
      overflow-y: auto;
    }
    
    .table-number-content {
      background: rgba(26, 58, 47, 0.98);
      padding: 30px;
      border-radius: 16px;
      border: 2px solid var(--gold);
      width: 100%;
      max-width: 340px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      animation: modalFadeIn 0.5s ease;
      max-height: 85vh;
      overflow-y: auto;
      margin: auto;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .table-number-title {
      color: var(--gold);
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: bold;
      text-align: center;
    }
    
    .table-number-subtitle {
      color: var(--light-cream);
      margin-bottom: 20px;
      font-size: 0.95rem;
      text-align: center;
    }

    .table-number-help {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--gold);
      text-align: center;
    }
    
    .table-number-help i {
      color: var(--gold);
      font-size: 16px;
    }
    
    .table-number-input {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid rgba(212, 175, 55, 0.5);
      background: rgba(245, 245, 220, 0.1);
      color: white;
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .table-availability-indicator {
      height: 24px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .table-availability-indicator.available {
      color: var(--green);
    }
    
    .table-availability-indicator.occupied {
      color: var(--bright-red);
    }
    
    .table-availability-indicator i {
      font-size: 16px;
    }
    
    .table-number-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25);
    }
    
    .input-error {
      animation: shake 0.6s ease;
      border-color: var(--bright-red) !important;
      box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.25) !important;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    
    /* Notification Icon Animations */
    @keyframes pulse-success {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(76, 175, 80, 0.7); }
    }
    
    @keyframes pulse-error {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(244, 67, 54, 0.7); }
    }
    
    @keyframes pulse-info {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.1); text-shadow: 0 0 8px rgba(33, 150, 243, 0.7); }
    }
    
    .user-option-buttons {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      margin-bottom: 20px;
    }
    
    .guest-option, .staff-option {
      flex: 1;
      padding: 20px 14px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .guest-option {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      font-weight: 600;
      border: 2px solid transparent;
    }
    
    .guest-option::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0) 70%);
      transform: translateX(-100%);
      transition: all 0.6s ease;
    }
    
    .guest-option:hover::after {
      transform: translateX(100%);
    }
    
    .staff-option {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light-cream);
      border: 2px solid rgba(212, 175, 55, 0.3);
    }
    
    .staff-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.1) 50%, rgba(212, 175, 55, 0) 100%);
      transition: all 0.6s ease;
    }
    
    .staff-option:hover::before {
      left: 100%;
    }
    
    .staff-option-active {
      transform: scale(0.95);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .option-icon {
      display: block;
      margin: 0 auto 12px;
      font-size: 28px;
      animation: subtle-float 2s infinite alternate;
    }
    
    .option-description {
      font-size: 12px;
      margin-top: 8px;
      opacity: 0.85;
      line-height: 1.3;
      max-width: 120px;
      transition: all 0.3s ease;
    }
    
    .guest-option:hover .option-description,
    .staff-option:hover .option-description {
      opacity: 1;
    }
    
    @keyframes subtle-float {
      0% { transform: translateY(0); }
      100% { transform: translateY(-3px); }
    }
    
    .guest-option:hover, .staff-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    }
    
    .guest-option:active, .staff-option:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Table Grid */
    .tables-section {
      margin-top: 15px;
      padding: 15px;
      background: rgba(245, 245, 220, 0.05);
      border-radius: 12px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .table-item {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 10px;
      padding: 10px 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .table-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .table-item.occupied {
      background: rgba(178, 34, 34, 0.8);
      border: 2px solid var(--bright-red);
      box-shadow: 0 0 15px rgba(255, 59, 48, 0.5);
      transform: translateY(-2px);
      position: relative;
      overflow: hidden;
    }
    
    .table-item.occupied::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 59, 48, 0) 0%, rgba(255, 59, 48, 0.3) 50%, rgba(255, 59, 48, 0) 100%);
      animation: shine 2s infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%); }
      60%, 100% { transform: translateX(100%); }
    }
    
    .table-status-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-top: 5px;
      position: relative;
    }
    
    .status-free {
      background: var(--green);
      box-shadow: 0 0 8px rgba(39, 174, 96, 0.4);
    }
    
    .status-occupied {
      background: var(--bright-red);
      box-shadow: 0 0 8px rgba(255, 59, 48, 0.6);
      animation: pulse-occupied 1.5s infinite;
    }
    
    @keyframes pulse-occupied {
      0% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 59, 48, 0.6); }
      50% { transform: scale(1.15); box-shadow: 0 0 12px rgba(255, 59, 48, 0.8); }
      100% { transform: scale(1); box-shadow: 0 0 8px rgba(255, 59, 48, 0.6); }
    }
    
    .table-number {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .table-details {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .table-details-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 360px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .table-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
      padding-bottom: 10px;
    }

    /* Loading Animation */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 58, 47, 0.98);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      transition: opacity 0.5s ease;
    }
    
    .loading-logo {
      width: 120px;
      height: auto;
      margin-bottom: 25px;
      animation: pulse-logo 2s infinite;
    }
    
    @keyframes pulse-logo {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .loading-spinner {
      width: 45px;
      height: 45px;
      border: 3px solid rgba(212, 175, 55, 0.2);
      border-top: 3px solid var(--gold);
      border-right: 3px solid var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: var(--gold);
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      letter-spacing: 0.5px;
    }
    
    .loading-progress {
      width: 180px;
      height: 3px;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 3px;
      margin-top: 15px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    
    .loading-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold) 0%, #E8C547 100%);
      width: 0%;
      transition: width 0.3s ease-out;
      box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
    }
    
    /* Rating Modal */
    .rating-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .rating-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gold);
      width: 100%;
      max-width: 320px;
    }
    
    .rating-title {
      color: var(--gold);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    .rating-star {
      font-size: 1.5rem;
      color: #ccc;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .rating-star:hover, .rating-star.active {
      color: var(--gold);
    }
    
    /* Rating system animation */
    @keyframes pulse-attention {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .rating-stars.pulse-attention {
      animation: pulse-attention 0.5s ease-in-out 2;
    }
    
    /* Admin Dashboard */
    .admin-dashboard {
      display: none;
      padding: 15px;
    }
    
    /* Admin Tabs - Enhanced Modern Design */
    .admin-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid rgba(212, 175, 55, 0.4);
      margin-bottom: 25px;
      padding-bottom: 2px;
      overflow-x: auto;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
    }
    
    .admin-tab {
      background: rgba(26, 58, 47, 0.5);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      padding: 14px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      position: relative;
      white-space: nowrap;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .admin-tab:hover {
      background: rgba(26, 58, 47, 0.8);
      transform: translateY(-3px);
      box-shadow: 0 -3px 8px rgba(0,0,0,0.1);
    }
    
    .admin-tab.active {
      background: linear-gradient(to bottom, rgba(212, 175, 55, 0.3), rgba(26, 58, 47, 0.9));
      color: var(--gold);
      border: 1px solid rgba(212, 175, 55, 0.6);
      border-bottom: none;
      position: relative;
      z-index: 1;
      transform: translateY(-3px);
    }
    
    .admin-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: var(--dark-green);
    }
    
    .admin-tab-content {
      display: none;
      animation: fadeEffect 0.5s ease;
    }
    
    .admin-tab-content.active {
      display: block;
    }
    
    @keyframes fadeEffect {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .admin-panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    
    .admin-panel {
      background: rgba(245, 245, 220, 0.05);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .admin-panel-title {
      color: var(--gold);
      font-size: 1rem;
      margin-bottom: 10px;
      text-align: left;
      font-weight: 600;
    }
    
    /* Advanced Analytics Styles */
    .analytics-dashboard {
      width: 100%;
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .analytics-header h3 {
      color: var(--gold);
      margin: 0;
      font-size: 1.3rem;
    }
    
    .time-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .time-filter label {
      color: var(--light-cream);
    }
    
    .time-filter select {
      background: rgba(26, 58, 47, 0.7);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.4);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    .analytics-card {
      background: rgba(26, 58, 47, 0.7);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(212, 175, 55, 0.2);
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      border-color: rgba(212, 175, 55, 0.4);
    }
    
    .analytics-card.wide {
      grid-column: span 3;
    }
    
    .analytics-card-header {
      background: rgba(245, 245, 220, 0.1);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .analytics-card-header h4 {
      margin: 0;
      color: var(--gold);
      font-size: 1rem;
    }
    
    .analytics-actions {
      display: flex;
      gap: 8px;
    }
    
    .analytics-card-body {
      padding: 15px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .analytics-insight {
      background: rgba(245, 245, 220, 0.05);
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .analytics-insight i {
      color: var(--gold);
    }
    
    .analytics-insight span {
      font-size: 0.85rem;
      color: var(--light-cream);
      line-height: 1.4;
    }
    
    /* Staff Management Styles */
    .staff-management-panel {
      display: flex;
      flex-direction: column;
    }
    
    .staff-accounts-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .staff-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .staff-account-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .staff-account-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .staff-account-info {
      flex: 1;
    }
    
    .staff-account-name {
      font-weight: bold;
      font-size: 0.95rem;
      color: var(--gold);
      margin-bottom: 4px;
    }
    
    .staff-account-username {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    .staff-account-role {
      font-size: 0.8rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 5px;
      display: inline-block;
    }
    
    .staff-account-actions {
      display: flex;
      gap: 8px;
    }
    
    .staff-action-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .edit-staff-btn:hover {
      color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }
    
    .delete-staff-btn:hover {
      color: var(--bright-red);
      background: rgba(255, 59, 48, 0.1);
    }
    
    .add-staff-form, .new-assignment-form {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .add-staff-form h4, .new-assignment-form h4 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1rem;
    }
    
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    
    .staff-table-assignments {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .table-assignment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .table-assignment-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .table-assignment-staff {
      font-weight: bold;
      color: var(--gold);
    }
    
    .table-assignment-range {
      font-size: 0.9rem;
    }
    
    .delete-assignment-btn {
      background: transparent;
      border: none;
      color: var(--bright-red);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .delete-assignment-btn:hover {
      background: rgba(255, 59, 48, 0.1);
    }
    
    /* Analytics Action Buttons */
    .action-btn {
      background: rgba(26, 58, 47, 0.7);
      color: var(--light-cream);
      border: 1px solid rgba(212, 175, 55, 0.4);
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background: rgba(26, 58, 47, 0.9);
      border-color: var(--gold);
      transform: translateY(-2px);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .stat-card {
      background: rgba(26, 58, 47, 0.7);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--gold);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--light-cream);
      text-align: center;
    }
    
    .admin-orders {
      margin-top: 10px;
    }
    
    /* Enhanced Button Styles */
    .confirm-btn, .cancel-btn, .checkout-btn, .apply-btn {
      padding: 14px 18px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .confirm-btn, .checkout-btn, .apply-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: 1px solid rgba(212, 175, 55, 0.6);
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      color: white;
      border: 1px solid rgba(244, 67, 54, 0.6);
    }
    
    .confirm-btn::after, .cancel-btn::after, .checkout-btn::after, .apply-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 70%);
      z-index: -1;
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }
    
    .confirm-btn:hover, .cancel-btn:hover, .checkout-btn:hover, .apply-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }
    
    .confirm-btn:hover::after, .cancel-btn:hover::after, .checkout-btn:hover::after, .apply-btn:hover::after {
      transform: translateX(100%);
    }
    
    .confirm-btn:active, .cancel-btn:active, .checkout-btn:active, .apply-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Button loading state */
    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    
    .button-loading::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: button-loading-spinner 0.8s linear infinite;
      left: calc(50% - 10px);
      top: calc(50% - 10px);
    }
    
    @keyframes button-loading-spinner {
      from {
        transform: rotate(0turn);
      }
      to {
        transform: rotate(1turn);
      }
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
    }
    
    .apply-btn {
      background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
      color: white;
    }
    
    /* Specific button styles overrides */
    .checkout-btn {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
    }
    
    .apply-btn {
      background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
      color: white;
    }
    
    /* Media Queries - Enhanced for Better Mobile Experience */
    @media (max-width: 480px) {
      .header {
        padding: 12px 0;
      }
      
      .logo {
        height: 65px;
      }
      
      h1 {
        font-size: 1.6rem;
        margin: 8px 0 4px;
      }
      
      .tagline {
        font-size: 0.8rem;
        margin-bottom: 10px;
      }
      
      /* Improved navigation for mobile with larger tap targets */
      .nav-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 15px;
        width: 100%;
        max-width: none;
      }
      
      .nav-buttons button {
        font-size: 1rem;
        padding: 15px;
        border-radius: 12px;
        min-width: 60px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      /* Better layout for mobile navigation */
      .add-to-cart {
        width: 100%;
        padding: 16px;
        font-size: 1.1rem;
        margin-bottom: 5px;
        border-radius: 15px;
        background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        order: -1;
        min-height: 56px;
      }
      
      /* Style for the navigation arrow container */
      .nav-arrow-container {
        display: flex;
        width: 100%;
        justify-content: space-between;
        gap: 10px;
      }
      
      /* Position prev/next buttons in the container */
      #prev-btn, #next-btn {
        flex: 1;
        margin-top: 5px;
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Add visual feedback for touch */
      #prev-btn:active, #next-btn:active {
        transform: scale(0.98);
        background: rgba(245, 245, 220, 0.2);
      }
      
      /* Make the navigation buttons more visible on mobile */
      .nav-arrow-btn {
        padding: 14px 18px;
        font-size: 0.95rem;
        min-width: 100px;
        border-width: 2px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      }
      
      /* Enhanced button feedback on mobile */
      .nav-buttons button:active {
        transform: scale(0.97);
      }
      
      .nav-buttons button.active {
        box-shadow: 0 0 0 2px var(--gold), 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-2px);
      }
      
      /* Make primary actions more prominent */
      .add-to-cart {
        order: -1;
        width: 100%;
        margin-bottom: 12px;
        padding: 14px;
        font-size: 1rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      /* Better spacing for content */
      .food-container {
        padding: 20px 15px;
        margin-top: 15px;
        border-radius: 15px;
      }
      
      /* Improved model viewer */
      model-viewer {
        height: 230px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
      }
      
      /* Make the AR button more visible and intuitive on mobile */
      .ar-button {
        font-size: 1rem !important;
        padding: 12px 18px !important;
        bottom: 20px !important;
        border-radius: 30px !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
      }
      
      /* Improve form elements on mobile */
      .input-group input, .input-group select, .input-group textarea {
        font-size: 16px; /* Prevents iOS zoom on focus */
        padding: 12px 15px;
        border-radius: 10px;
      }
      
      /* Enhanced cart experience on mobile */
      .cart-toggle {
        padding: 12px;
        right: 15px;
        bottom: 15px;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      }
      
      /* Better cart panel for mobile */
      .cart-panel {
        max-width: none;
        width: 100%;
        right: 0;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        padding-top: 25px;
        padding-bottom: 25px;
        box-shadow: 0 -5px 25px rgba(0,0,0,0.3);
      }
      
      /* Improved table options for mobile */
      .user-option-buttons {
        flex-direction: column;
        gap: 15px;
      }
      
      .guest-option, .staff-option {
        width: 100%;
        padding: 18px 15px;
        border-radius: 12px;
      }
      
      /* Enhance table number input for mobile */
      .table-number-input {
        padding: 15px;
        font-size: 18px;
        border-radius: 12px;
      }
      
      /* Improved modal buttons for better touch targets */
      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-buttons button {
        width: 100%;
        padding: 14px;
        font-size: 1rem;
        border-radius: 12px;
      }
      
      /* Improved notification styling for mobile */
      .order-status-notification {
        width: 90%;
        left: 5%;
        border-radius: 15px;
        padding: 15px;
      }
      
      /* Analytics Mobile Adjustments */
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-card.wide {
        grid-column: span 1;
      }
      
      .analytics-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .admin-tabs {
        flex-wrap: wrap;
      }
      
      .admin-tab {
        font-size: 0.8rem;
        padding: 10px 12px;
      }
      
      /* Enhanced footer for mobile */
      .footer {
        padding: 20px 15px;
      }
      
      .copyright {
        text-align: center;
        font-size: 0.8rem;
        padding: 10px 0;
      }
    }
    
    @media (min-width: 481px) and (max-width: 767px) {
      model-viewer {
        height: 250px;
      }
      
      .nav-buttons {
        gap: 10px;
      }
      
      /* Better spacing for medium-sized devices */
      .food-container {
        padding: 15px;
      }
      
      /* Analytics Tablet Adjustments */
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .analytics-card.wide {
        grid-column: span 2;
      }
      
      .admin-tabs {
        gap: 3px;
      }
      
      .admin-tab {
        padding: 10px 14px;
      }
    }
    
    @media (min-width: 768px) {
      .footer-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .admin-panels {
        grid-template-columns: 1fr 1fr;
      }
      
      model-viewer {
        height: 300px;
      }
      
      .food-container {
        max-width: 600px;
        margin: 0 auto;
      }
      
      .cart-panel {
        max-width: 380px;
      }
    }
    
    /* RTL Support for Arabic */
    .rtl {
      direction: rtl;
      text-align: right;
    }
    
    .rtl .input-group label {
      text-align: right;
    }
    
    .rtl .item-name {
      text-align: right;
    }
    
    .rtl h1#title, .rtl .tagline, .rtl .table-number-title, .rtl .table-number-subtitle {
      text-align: center !important;
    }
    
    /* Additional RTL fixes for table input modal */
    .rtl .table-number-help span,
    .rtl #guest-option-text,
    .rtl #staff-option-text,
    .rtl .option-description {
      text-align: center !important;
    }
    
    .rtl .table-number-input {
      text-align: center !important;
      direction: ltr; /* Numbers are always LTR */
    }
    
    .rtl .item-price {
      text-align: left;
    }
    
    .rtl .social-link {
      flex-direction: row-reverse;
    }
    
    /* RTL Support for navigation buttons */
    .rtl #prev-btn i {
      transform: rotate(180deg);
    }
    
    .rtl #next-btn i {
      transform: rotate(180deg);
    }
    
    .rtl #prev-btn:hover i {
      transform: rotate(180deg) translateX(3px);
    }
    
    .rtl #next-btn:hover i {
      transform: rotate(180deg) translateX(-3px);
    }
    
    .rtl .order-id {
      text-align: right;
    }
    
    .rtl .admin-panel-title {
      text-align: right;
    }
    
    .rtl .status-content {
      text-align: right;
    }
    
    /* RTL Support for Analytics */
    .rtl .analytics-header {
      flex-direction: row-reverse;
    }
    
    .rtl .analytics-card-header {
      flex-direction: row-reverse;
    }
    
    .rtl .analytics-insight {
      flex-direction: row-reverse;
    }
    
    .rtl .admin-tabs {
      direction: rtl;
    }
    
    .rtl .time-filter {
      direction: rtl;
    }
    
    /* RTL fixes for table number modal */
    .rtl .table-number-help {
      flex-direction: row-reverse;
      border-left: none;
      border-right: 3px solid var(--gold);
    }
    
    .rtl .modal-buttons {
      justify-content: center;
    }
    
    .rtl .user-option-buttons {
      flex-direction: row-reverse;
    }

    /* Language Toggle */
    .language-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(26, 58, 47, 0.8);
      border: 1px solid var(--gold);
      border-radius: 20px;
      padding: 5px 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      z-index: 10;
    }
    
    /* Connection Status Toast */
    .connection-toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 8px;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      max-width: 90%;
      border-left: 4px solid var(--gold);
    }
    
    .connection-toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .connection-toast.error {
      border-left-color: #ff5252;
    }
    
    .connection-toast.success {
      border-left-color: #4caf50;
    }
    
    .toast-icon {
      font-size: 20px;
      color: var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .connection-toast.error .toast-icon {
      color: #ff5252;
    }
    
    .connection-toast.success .toast-icon {
      color: #4caf50;
    }
    
    .toast-message {
      font-size: 14px;
      color: var(--light-cream);
      flex: 1;
    }
    
    /* Staff Ratings List */
    .staff-ratings-list {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 10px;
    }
    
    .rating-item {
      background: rgba(40, 40, 40, 0.5);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid var(--gold);
    }
    
    .rating-item.low-rating {
      border-left-color: var(--red);
    }
    
    .rating-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .rating-staff-name {
      font-weight: bold;
      color: var(--gold);
    }
    
    .rating-stars-display {
      color: var(--gold);
    }
    
    .rating-stars-display.low-rating {
      color: var(--red);
    }
    
    .rating-feedback {
      font-style: italic;
      color: var(--light-cream);
      font-size: 0.9em;
      margin-top: 5px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 5px;
    }
    
    .rating-meta {
      font-size: 0.8em;
      color: var(--light-cream);
      opacity: 0.7;
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    
    /* Table Action Buttons */
    .table-action-btn {
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    .free-table-btn {
      background-color: #4caf50;
      color: white;
    }
    
    .free-table-btn:hover {
      background-color: #2e7d32;
    }
    
    .occupy-table-btn {
      background-color: #d4af37;
      color: #2c1e0f;
    }
    
    .occupy-table-btn:hover {
      background-color: #b8941f;
    }
    
    /* Occupied Tables Count */
    .occupied-tables-count {
      margin-bottom: 15px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="header">
      <div class="logo-container">
        <img src="images-removebg-preview (1).png" alt="The Oak Cafe Logo" class="logo" />
      </div>
      <h1 id="title">The Oak Cafe</h1>
      <p class="tagline" id="tagline">Experience dining in augmented reality</p>
      <div class="language-toggle" onclick="toggleLanguage()">
        <span id="current-lang">EN</span>
      </div>
      <div class="user-type">
        <button class="user-btn active" id="guest-btn" onclick="switchUserType('guest')">GUEST</button>
        <button class="user-btn" id="staff-login-btn" onclick="showLoginModal()">LOGIN</button>
      </div>
    </div>
    
    <!-- Guest View -->
    <div class="guest-view" id="guest-view">
      <div class="category-container">
        <div class="category-heading">Main Categories</div>
        <div class="main-categories" id="main-categories">
          <button class="main-category-btn active" data-maincategory="all" id="all-main-category-btn" onclick="changeMainCategory('all')">
            <span>All</span>
          </button>
          <button class="main-category-btn" data-maincategory="food" id="food-main-category-btn" onclick="changeMainCategory('food')">
            <span>Food</span>
          </button>
          <button class="main-category-btn" data-maincategory="drinks" id="drinks-main-category-btn" onclick="changeMainCategory('drinks')">
            <span>Drinks</span>
          </button>
          <button class="main-category-btn" data-maincategory="desserts" id="desserts-main-category-btn" onclick="changeMainCategory('desserts')">
            <span>Desserts</span>
          </button>
        </div>
        
        <div class="sub-categories" id="sub-categories">
          <!-- Food subcategories -->
          <div class="subcategory-group" id="food-subcategories">
            <div class="subcategory-label">Food Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-food" data-parent="food" id="all-food-btn" onclick="changeCategory('all-food')">All Food</button>
              <button class="category-btn" data-category="pizza" data-parent="food" id="pizza-category-btn" onclick="changeCategory('pizza')">Pizza</button>
              <button class="category-btn" data-category="pasta" data-parent="food" id="pasta-category-btn" onclick="changeCategory('pasta')">Pasta</button>
              <button class="category-btn" data-category="salads" data-parent="food" id="salads-category-btn" onclick="changeCategory('salads')">Salads</button>
              <button class="category-btn" data-category="burgers" data-parent="food" id="burgers-category-btn" onclick="changeCategory('burgers')">Burgers</button>
            </div>
          </div>
          
          <!-- Drinks subcategories -->
          <div class="subcategory-group" id="drinks-subcategories" style="display: none;">
            <div class="subcategory-label">Beverage Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-drinks" data-parent="drinks" id="all-drinks-btn" onclick="changeCategory('all-drinks')">All Drinks</button>
              <button class="category-btn" data-category="hot-drinks" data-parent="drinks" id="hot-drinks-category-btn" onclick="changeCategory('hot-drinks')">Hot Drinks</button>
              <button class="category-btn" data-category="cold-drinks" data-parent="drinks" id="cold-drinks-category-btn" onclick="changeCategory('cold-drinks')">Cold Drinks</button>
              <button class="category-btn" data-category="smoothies" data-parent="drinks" id="smoothies-category-btn" onclick="changeCategory('smoothies')">Smoothies</button>
            </div>
          </div>
          
          <!-- Desserts subcategories -->
          <div class="subcategory-group" id="desserts-subcategories" style="display: none;">
            <div class="subcategory-label">Dessert Types</div>
            <div class="subcategory-buttons">
              <button class="category-btn active" data-category="all-desserts" data-parent="desserts" id="all-desserts-btn" onclick="changeCategory('all-desserts')">All Desserts</button>
              <button class="category-btn" data-category="cakes" data-parent="desserts" id="cakes-category-btn" onclick="changeCategory('cakes')">Cakes</button>
              <button class="category-btn" data-category="ice-cream" data-parent="desserts" id="ice-cream-category-btn" onclick="changeCategory('ice-cream')">Ice Cream</button>
            </div>
          </div>
        </div>
      </div>
      <div class="food-container">
        <h2 id="food-name">Margherita Pizza</h2>
        <div class="model-container">
          <model-viewer id="food-model-viewer" src="models/Margherita Pizza.glb" alt="3D Food Model" auto-rotate camera-controls ar ar-modes="webxr scene-viewer quick-look" ar-scale="auto" camera-orbit="-20deg 75deg 2m" shadow-intensity="1" ar-placement="floor" loading="eager" reveal="interaction" environment-image="neutral" exposure="1" shadow-softness="1">
            <button slot="ar-button" class="ar-button" id="ar-button">VIEW IN AR</button>
            <div class="model-loading-indicator" id="model-loading-indicator">
              <div class="loading-spinner model-spinner"></div>
            </div>
          </model-viewer>
        </div>
        <p id="food-description">Fresh mozzarella, tomatoes, and basil on a thin crust, baked to perfection.</p>
        <p id="food-price">Price: $14.99</p>
        
        <div class="nav-buttons">
          <button onclick="addToCart()" class="add-to-cart" id="add-cart-btn">+ ADD TO CART</button>
          <div class="nav-arrow-container">
            <button onclick="showPreviousItem()" id="prev-btn" class="nav-arrow-btn">
              <i class="fas fa-chevron-left"></i> PREV
            </button>
            <button onclick="showNextItem()" id="next-btn" class="nav-arrow-btn">
              NEXT <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <div class="extras-section">
          <div class="input-group">
            <label for="extras-select" id="extras-label">ADD EXTRAS</label>
            <select id="extras-select">
              <option value="">No extras</option>
              <option value="extra_cheese">Extra Cheese (+$2.00)</option>
              <option value="extra_toppings">Extra Toppings (+$3.00)</option>
              <option value="garlic_bread">Garlic Bread Side (+$4.00)</option>
            </select>
          </div>
          
          <div class="input-group">
            <label for="item-notes" id="notes-label">SPECIAL INSTRUCTIONS</label>
            <textarea id="item-notes" rows="2" placeholder="Any special requests..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="client-orders" id="client-orders">
        <h3 id="your-orders-title">YOUR ORDERS</h3>
        <div id="client-orders-list"></div>
      </div>
      
      <button class="view-orders-btn" id="view-orders-btn" onclick="toggleClientOrders()">VIEW MY ORDERS</button>
    </div>
    
    <!-- Staff Dashboard -->
    <div class="staff-dashboard" id="staff-dashboard">
      <div class="staff-header">
        <h2 id="staff-dashboard-title">STAFF DASHBOARD</h2>
        <button onclick="logoutStaff()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> <span id="staff-logout-btn-text">LOGOUT</span>
        </button>
        <div class="staff-info">
          <span id="staff-name-display">Staff Member</span>
          <span id="staff-role-badge">Role</span>
        </div>
      </div>
      
      <div class="estimated-time-section">
        <p id="staff-estimated-time-label">ESTIMATED WAIT TIME:</p>
        <p id="staff-estimated-time">15 minutes</p>
      </div>
      
      <div class="tables-section">
        <h3 id="occupied-tables-title">OCCUPIED TABLES</h3>
        <div class="tables-grid" id="tables-grid">
          <!-- Tables will appear here -->
        </div>
      </div>
      
      <div class="orders-list" id="orders-list">
        <!-- Orders will appear here -->
      </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="admin-dashboard">
      <div class="admin-header">
        <h2 id="admin-dashboard-title">ADMIN DASHBOARD</h2>
        <button onclick="logoutStaff()" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> <span id="admin-logout-btn-text">LOGOUT</span>
        </button>
      </div>
      
      <!-- Admin Navigation Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab active" id="dashboard-tab" onclick="switchAdminTab('dashboard')">DASHBOARD</button>
        <button class="admin-tab" id="analytics-tab" onclick="switchAdminTab('analytics')">ADVANCED ANALYTICS</button>
        <button class="admin-tab" id="management-tab" onclick="switchAdminTab('management')">MANAGEMENT</button>
      </div>
      
      <!-- Main Dashboard Tab Content -->
      <div class="admin-tab-content active" id="dashboard-content">
        <div class="admin-panels">
          <div class="admin-panel">
            <h3 id="statistics-title">STATISTICS</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="total-orders">0</div>
                <div class="stat-label" id="total-orders-title">TOTAL ORDERS</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="avg-rating">0.0</div>
                <div class="stat-label" id="avg-rating-title">AVG RATING</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="low-ratings">0</div>
                <div class="stat-label" id="low-ratings-title">LOW RATINGS</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="active-staff">0</div>
                <div class="stat-label" id="active-staff-title">ACTIVE STAFF</div>
              </div>
            </div>
          </div>
          
          <div class="admin-panel">
            <h3 id="orders-title">ORDERS</h3>
            <canvas id="orders-chart" height="200"></canvas>
          </div>
          
          <div class="admin-panel">
            <h3 id="ratings-title">RATINGS</h3>
            <canvas id="ratings-chart" height="200"></canvas>
            
            <!-- Staff Ratings List -->
            <div class="staff-ratings-list" id="staff-ratings-list">
              <!-- Staff ratings will be displayed here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Advanced Analytics Tab Content -->
      <div class="admin-tab-content" id="analytics-content">
        <div class="analytics-dashboard">
          <div class="analytics-header">
            <h3 id="analytics-title">ADVANCED ANALYTICS DASHBOARD</h3>
            <div class="time-filter">
              <label for="time-range">Time Range:</label>
              <select id="time-range" onchange="updateAnalytics()">
                <option value="day">Today</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
          </div>
          
          <div class="analytics-grid">
            <!-- Sales Performance -->
            <div class="analytics-card wide">
              <div class="analytics-card-header">
                <h4>Sales Performance</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('sales')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                  <button onclick="toggleChartView('sales')" class="action-btn">
                    <i class="fas fa-chart-line"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="sales-performance-chart" height="250"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="sales-insight">Sales are up 12% compared to last week with peak hours between 12-2pm.</span>
              </div>
            </div>
            
            <!-- Menu Item Performance -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Top Menu Items</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('menu')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="menu-performance-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="menu-insight">Margherita Pizza is your top seller with 24% of sales.</span>
              </div>
            </div>
            
            <!-- Customer Satisfaction -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Customer Satisfaction</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('satisfaction')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="satisfaction-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="satisfaction-insight">85% of customers rated their experience 4+ stars.</span>
              </div>
            </div>
            
            <!-- Table Turnover -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Table Utilization</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('tables')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="table-utilization-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="table-insight">Tables 5-8 have highest turnover rate at 3.2 hours avg.</span>
              </div>
            </div>
            
            <!-- Staff Performance -->
            <div class="analytics-card">
              <div class="analytics-card-header">
                <h4>Staff Performance</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('staff')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="staff-performance-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="staff-insight">Sarah has the highest customer satisfaction score at 4.9/5.</span>
              </div>
            </div>
            
            <!-- Marketing Effectiveness -->
            <div class="analytics-card wide">
              <div class="analytics-card-header">
                <h4>Order Sources</h4>
                <div class="analytics-actions">
                  <button onclick="exportAnalyticsData('marketing')" class="action-btn">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
              <div class="analytics-card-body">
                <canvas id="marketing-chart" height="200"></canvas>
              </div>
              <div class="analytics-insight">
                <i class="fas fa-lightbulb"></i>
                <span id="marketing-insight">AR menu visualization increases average order value by 18%.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Management Tab Content -->
      <div class="admin-tab-content" id="management-content">
        <div class="admin-panels">
          <div class="admin-panel staff-management-panel">
            <h3 id="staff-management-title" class="admin-panel-title">STAFF MANAGEMENT</h3>
            
            <div class="staff-accounts-container">
              <h4 id="staff-accounts-title">STAFF ACCOUNTS</h4>
              <div class="staff-list" id="staff-accounts-list">
                <!-- Staff accounts will appear here -->
              </div>
              
              <div class="add-staff-form">
                <h4 id="add-staff-title">ADD NEW STAFF</h4>
                <div class="input-group">
                  <label for="new-staff-username">USERNAME</label>
                  <input type="text" id="new-staff-username" placeholder="Enter username">
                </div>
                <div class="input-group">
                  <label for="new-staff-name">FULL NAME</label>
                  <input type="text" id="new-staff-name" placeholder="Enter staff name">
                </div>
                <div class="input-group">
                  <label for="new-staff-password">PASSWORD</label>
                  <input type="password" id="new-staff-password" placeholder="Enter password">
                </div>
                <div class="input-group">
                  <label for="new-staff-role">ROLE</label>
                  <select id="new-staff-role">
                    <option value="server">Server</option>
                    <option value="chef">Chef</option>
                    <option value="manager">Manager</option>
                    <option value="staff">General Staff</option>
                  </select>
                </div>
                <button onclick="addStaffAccount()" id="add-staff-btn" class="confirm-btn">ADD STAFF</button>
              </div>
            </div>
          </div>

          <div class="admin-panel">
            <h3 id="staff-assignment-title">TABLE ASSIGNMENTS</h3>
            <div class="staff-table-assignments" id="staff-table-assignments">
              <!-- Table assignments will appear here -->
            </div>
            
            <div class="new-assignment-form">
              <h4 id="new-assignment-title">NEW TABLE ASSIGNMENT</h4>
              <div class="input-grid">
                <div class="input-group">
                  <label for="staff-assignment" id="staff-assignment-label">SELECT STAFF</label>
                  <select id="staff-assignment">
                    <option value="">Select staff member</option>
                  </select>
                </div>
                <div class="input-group">
                  <label for="table-range-start">TABLE RANGE START</label>
                  <input type="number" id="table-range-start" min="1" value="1">
                </div>
                <div class="input-group">
                  <label for="table-range-end">TABLE RANGE END</label>
                  <input type="number" id="table-range-end" min="1" value="20">
                </div>
              </div>
              <button onclick="assignTableRange()" id="assign-staff-btn" class="confirm-btn">ASSIGN TABLES</button>
            </div>
          </div>
          
          <div class="admin-panel">
            <h3 id="discount-management-title">DISCOUNT MANAGEMENT</h3>
            <div class="input-group">
              <label for="discount-code-input">DISCOUNT CODE</label>
              <input type="text" id="discount-code-input" placeholder="Enter discount code">
            </div>
            <div class="input-group">
              <label for="discount-percent">DISCOUNT PERCENTAGE</label>
              <input type="number" id="discount-percent" min="5" max="50" value="10">
            </div>
            <button onclick="applyDiscount()" id="apply-discount-btn" class="confirm-btn">CREATE DISCOUNT</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-grid">
        <div class="branding-section">
          <div class="powered-by">
            <span id="powered-by-text">Powered by</span>
            <img src="ar-bites-logo.png" alt="AR Bites" class="ar-bites-logo" />
          </div>
        </div>
        <div class="social-links">
          <a href="https://www.instagram.com/ar.bitesjo?igsh=ajhmd3ZvbjJhamJh" target="_blank" rel="noopener noreferrer" class="social-link">
            <svg class="instagram-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
            </svg>
            <span id="instagram-text">Follow AR Bites on Instagram</span>
          </a>
        </div>
      </div>
      <div class="copyright" id="copyright-text">Â© 2023-2025 AR Bites. All rights reserved.</div>
    </div>
  </div>
  
  <!-- Cart System -->
  <div class="cart-toggle" id="cart-toggle" onclick="toggleCart()">
    <i class="fas fa-shopping-cart"></i>
    <div class="cart-count" id="cart-count">0</div>
  </div>
  
  <div class="cart-panel" id="cart-panel">
    <div class="cart-header">
      <h3 id="cart-title">YOUR CART</h3>
      <button onclick="toggleCart()" style="background: none; color: white; border: none;">&times;</button>
    </div>
    
    <div class="cart-items" id="cart-items">
      <!-- Cart items will appear here -->
    </div>
    
    <div class="total-section">
      <div id="total-breakdown"></div>
      <p id="estimated-time-label">Estimated Wait Time: <span id="estimated-time">15 minutes</span></p>
    </div>
    
    <div class="input-group" style="margin-top: 10px;">
      <label for="discount-code" id="discount-label">DISCOUNT CODE</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="discount-code" placeholder="Enter code...">
        <button id="apply-discount" onclick="applyDiscount()" class="apply-btn">APPLY</button>
      </div>
    </div>
    
    <button class="checkout-btn" id="checkout-btn" onclick="checkout()">
      <span class="checkout-text" id="checkout-text">CHECKOUT</span>
    </button>
  </div>
  
  <!-- Order Status Notification -->
  <div class="order-status-notification" id="status-notification">
    <div class="status-icon" id="status-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="status-content">
      <div class="status-title" id="status-title">Order Status</div>
      <div class="status-message" id="status-message">Your order has been received.</div>
    </div>
    <button class="close-status" onclick="closeNotification()">&times;</button>
  </div>
  
  <!-- Login Modal -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <h2 class="modal-title" id="login-title">ACCOUNT LOGIN</h2>
      <div class="input-group">
        <label for="username" id="username-label">USERNAME</label>
        <input type="text" id="username" placeholder="Enter username">
      </div>
      <div class="input-group">
        <label for="password" id="password-label">PASSWORD</label>
        <input type="password" id="password" placeholder="Enter password">
      </div>
      <div class="modal-buttons">
        <button onclick="loginUser()" class="confirm-btn" id="login-btn">LOGIN</button>
        <button onclick="closeModal()" class="cancel-btn" id="cancel-login-btn">CANCEL</button>
      </div>
    </div>
  </div>
  
  <!-- Table Number Modal -->
  <div class="table-number-modal" id="table-number-modal">
    <div class="table-number-content">
      <h2 class="table-number-title" id="table-number-title">YOUR TABLE NUMBER</h2>
      <p class="table-number-subtitle" id="table-number-subtitle">Please select your role or enter your table number to continue</p>
      
      <div class="user-option-buttons">
        <div class="guest-option" onclick="showGuestOption()">
          <i class="fas fa-utensils option-icon"></i>
          <span id="guest-option-text">I'm a Guest</span>
          <div class="option-description" id="guest-option-desc">Select this if you're dining in and need to place an order from your table</div>
        </div>
        <div class="staff-option" onclick="handleStaffBypass()">
          <i class="fas fa-user-tie option-icon"></i>
          <span id="staff-option-text">I'm Staff</span>
          <div class="option-description" id="staff-option-desc">Restaurant staff access - manage orders, tables, and kitchen operations</div>
        </div>
      </div>
      
      <div id="table-number-input-container" style="display: none;">
        <div class="table-number-help">
          <i class="fas fa-info-circle"></i>
          <span id="table-number-help-text">Your table number is displayed on the QR code at your table</span>
        </div>
        <input type="number" class="table-number-input" id="table-number-input" placeholder="Enter table number" min="1">
        <div class="table-availability-indicator" id="table-availability-indicator"></div>
        <div class="modal-buttons">
          <button onclick="confirmTableNumber()" class="confirm-btn" id="confirm-table-btn">
            <i class="fas fa-check-circle"></i> <span>CONFIRM</span>
          </button>
          <button onclick="closeTableModal(true)" class="cancel-btn" id="cancel-table-btn">
            <i class="fas fa-times-circle"></i> <span>CANCEL</span>
          </button>
        </div>
        <div class="staff-bypass-section" id="staff-bypass-section" style="display: none; margin-top: 15px; text-align: center;">
          <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
          <button onclick="bypassTableSelection()" class="staff-bypass-btn" style="
            padding: 10px 15px;
            background: linear-gradient(135deg, #4a6741 0%, #5a7d53 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          ">
            <i class="fas fa-user-shield"></i> <span>STAFF BYPASS - SKIP TABLE SELECTION</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="rating-modal" id="rating-modal">
    <div class="rating-content">
      <h2 class="rating-title" id="rating-title">RATE YOUR EXPERIENCE</h2>
      <div class="rating-stars">
        <i class="fas fa-star rating-star" data-rating="1"></i>
        <i class="fas fa-star rating-star" data-rating="2"></i>
        <i class="fas fa-star rating-star" data-rating="3"></i>
        <i class="fas fa-star rating-star" data-rating="4"></i>
        <i class="fas fa-star rating-star" data-rating="5"></i>
      </div>
      <div class="input-group">
        <label for="rating-feedback" id="rating-feedback-label">FEEDBACK (OPTIONAL)</label>
        <textarea id="rating-feedback" rows="3" placeholder="Tell us about your experience..."></textarea>
      </div>
      <div class="modal-buttons">
        <button onclick="submitRating()" class="confirm-btn" id="submit-rating-btn">SUBMIT</button>
        <button onclick="closeRatingModal()" class="cancel-btn" id="cancel-rating-btn">CANCEL</button>
      </div>
    </div>
  </div>
  
  <!-- Table Details Modal -->
  <div class="table-details" id="table-details">
    <div class="table-details-content">
      <div class="table-details-header">
        <h2 class="modal-title" id="table-details-title">TABLE 1</h2>
        <button onclick="closeTableDetails()" style="background: none; color: white; border: none;">&times;</button>
      </div>
      
      <!-- Staff assignment information -->
      <div id="table-staff-info">
        <!-- Assigned staff info will appear here -->
      </div>
      
      <div id="table-orders-list">
        <!-- Table orders will appear here -->
      </div>
      
      <!-- Table action buttons for staff (mark as free/occupied) -->
      <div id="table-action-buttons">
        <!-- Table management buttons will appear here for staff -->
      </div>
      
      <button id="close-details" onclick="closeTableDetails()" class="confirm-btn" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>
  
  <!-- Loading Animation -->
  <div class="loading-overlay" id="loading-overlay">
    <img src="ar-bites-logo.png" alt="AR Bites Logo" class="loading-logo" />
    <div class="loading-spinner"></div>
    <p class="loading-text" id="loading-text">Loading Augmented Reality Experience...</p>
    <div class="loading-progress">
      <div class="loading-bar" id="loading-bar"></div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    
    // Firebase configuration with better error handling
    const firebaseApiKey = "{{FIREBASE_API_KEY}}";
    const firebaseConfig = {
      apiKey: firebaseApiKey || "AIzaSyD5bF7rsIhlJ0-EBdRTHH67quCzjOFCRdQ", 
      authDomain: "the-oak-cafe.firebaseapp.com", 
      projectId: "the-oak-cafe",
      storageBucket: "the-oak-cafe.firebasestorage.app",
      messagingSenderId: "871343311823",
      appId: "1:871343311823:web:eb6724643e10cafde9e0ba",
      measurementId: "G-G83C83HXWR"
    };
    
    // Initialize Firebase with better error handling for demo and production modes
    let db;
    let isOfflineMode = false; // Use Firebase by default
    
    // Show a temporary toast notification
    function showConnectionToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `connection-toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">
          ${type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>'}
        </div>
        <div class="toast-message">${message}</div>
      `;
      document.body.appendChild(toast);
      
      // Animate in
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 5000);
    }
    
    try {
      firebase.initializeApp(firebaseConfig);
      
      try {
        firebase.analytics();
      } catch (analyticsError) {
        console.log("Analytics not available:", analyticsError);
      }
      
      db = firebase.firestore();
      
      // Define staff accounts early for initialization
      const accounts = [
        { username: 'admin', name: 'Restaurant Administrator', password: '123456', role: 'admin' },
        { username: 'ahmad', name: 'Ahmad Mohammed', password: '123456', role: 'manager' },
        { username: 'john', name: 'John Smith', password: '123456', role: 'chef' },
        { username: 'sarah', name: 'Sarah Johnson', password: '123456', role: 'server' },
        { username: 'staff', name: 'General Staff', password: '123456', role: 'staff' }
      ];
      
      // Initialize collections and data
      const initializeFirebase = async () => {
        try {
          console.log("Setting up Firebase collections and data...");
          
          // Load table assignments from Firebase to sync with local array
          const loadTableAssignments = async () => {
            try {
              const assignmentsRef = db.collection('tableAssignments');
              const snapshot = await assignmentsRef.get();
              
              // Clear existing assignments to be replaced with Firebase data
              tableAssignments = [];
              
              if (!snapshot.empty) {
                snapshot.forEach(doc => {
                  const data = doc.data();
                  tableAssignments.push({
                    id: doc.id,
                    staffUsername: data.staffUsername,
                    startTable: data.startTable,
                    endTable: data.endTable
                  });
                });
                console.log("Loaded table assignments from Firebase:", tableAssignments);
              } else {
                // If no assignments exist, create default ones
                console.log("No table assignments found, creating defaults");
                
                // Create default assignments if needed
                const defaultAssignments = [
                  { staffUsername: 'sarah', startTable: 1, endTable: 5 },
                  { staffUsername: 'john', startTable: 6, endTable: 10 },
                  { staffUsername: 'ahmad', startTable: 11, endTable: 16 }
                ];
                
                // Save to Firebase and update local array
                for (const assignment of defaultAssignments) {
                  const docRef = await assignmentsRef.add({
                    staffUsername: assignment.staffUsername,
                    startTable: assignment.startTable,
                    endTable: assignment.endTable,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  
                  tableAssignments.push({
                    id: docRef.id,
                    ...assignment
                  });
                }
                
                console.log("Created default table assignments");
              }
            } catch (err) {
              console.error("Error loading table assignments:", err);
              // Keep the default assignments in memory even if Firebase fails
            }
          };
          
          // Load and create staff accounts if needed
          const setupStaffAccounts = async () => {
            try {
              const staffRef = db.collection('staff');
              
              // Check for each staff account
              for (const acc of accounts) {
                const staffQuery = await staffRef.where('username', '==', acc.username).limit(1).get();
                
                if (staffQuery.empty) {
                  await staffRef.add({
                    username: acc.username,
                    name: acc.name || acc.username,
                    role: acc.role || 'staff',
                    password: acc.password, // Note: In a real app, never store plaintext passwords
                    active: true,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  console.log(`Staff account created for ${acc.username}`);
                } else {
                  console.log(`Staff account already exists for ${acc.username}`);
                }
              }
            } catch (err) {
              console.error("Error setting up staff accounts:", err);
            }
          };
          
          // Setup listeners for orders
          const setupOrdersCollection = async () => {
            try {
              // Ensure the orders collection exists
              const ordersRef = db.collection('orders');
              await ordersRef.limit(1).get();
              
              // Setup real-time listener for occupied tables based on orders
              ordersRef.onSnapshot(snapshot => {
                try {
                  if (!snapshot.empty) {
                    // Update occupiedTables based on orders
                    const tableMap = new Map();
                    
                    snapshot.forEach(doc => {
                      const orderData = doc.data();
                      const tableNum = orderData.tableNumber;
                      
                      if (tableNum) {
                        // Add to occupied tables
                        occupiedTables.add(tableNum);
                        
                        // Update table details
                        if (!tableDetails[tableNum]) {
                          tableDetails[tableNum] = { orders: [] };
                        }
                        
                        // Add order to table details if not already there
                        const orderExists = tableDetails[tableNum].orders.some(o => o.id === doc.id);
                        if (!orderExists) {
                          tableDetails[tableNum].orders.push({
                            id: doc.id,
                            status: orderData.status,
                            items: orderData.items || [],
                            timestamp: orderData.timestamp?.toDate() || new Date(),
                            total: orderData.total || 0,
                            assignedStaff: orderData.assignedStaff
                          });
                          
                          // Sort orders by timestamp (newest first)
                          tableDetails[tableNum].orders.sort((a, b) => 
                            b.timestamp.getTime() - a.timestamp.getTime()
                          );
                        }
                        
                        // Map tables to their assigned staff
                        if (orderData.assignedStaff) {
                          tableMap.set(tableNum, orderData.assignedStaff);
                        }
                      }
                    });
                    
                    console.log("Updated occupied tables from Firebase:", Array.from(occupiedTables));
                    
                    // Update tables display if we're in staff mode
                    if (userType === 'staff' || userType === 'admin') {
                      updateTablesDisplay();
                    }
                  }
                } catch (err) {
                  console.error("Error processing orders snapshot:", err);
                }
              }, err => {
                console.error("Error in orders snapshot listener:", err);
              });
              
            } catch (err) {
              console.error("Error setting up orders collection:", err);
            }
          };
          
          // Execute all initialization tasks
          await Promise.all([
            loadTableAssignments(),
            setupStaffAccounts(),
            setupOrdersCollection()
          ]);
          
          console.log("Firebase initialization completed");
        } catch (err) {
          console.error("Error in Firebase initialization:", err);
        }
      };
      
      // Initialize Firebase collections and data
      initializeFirebase();
      
      // Monitor online/offline status
      firebase.firestore().enableNetwork()
        .then(() => {
          console.log("Firebase connection successful");
          isOfflineMode = false;
        })
        .catch(err => {
          console.error("Network connection error:", err);
          // Only set offline mode on actual network errors
          console.error("Firebase connection error:", err.code);
        });
    } catch (firebaseError) {
      console.log("Firebase initialization error:", firebaseError);
      isOfflineMode = true;
      
      // Removed notifications during loading as requested
      console.log("Firebase initialization failed, using demo mode");
      
      // Create a mock database for demo purposes when Firebase is unavailable
      db = {
        collection: (collectionName) => {
          return {
            doc: (id) => {
              return {
                get: () => Promise.resolve({
                  exists: true,
                  data: () => {
                    // Return mock data based on collection and document ID
                    if (collectionName === 'orders') {
                      return {
                        tableNumber: parseInt(id) || 1,
                        items: [{name: 'Margherita Pizza', price: 14.99}],
                        status: 'pending',
                        timestamp: new Date(),
                        userId: 'guest'
                      };
                    }
                    return {};
                  }
                }),
                set: (data) => Promise.resolve(data),
                update: (data) => Promise.resolve(data)
              };
            },
            where: () => ({
              get: () => Promise.resolve({
                empty: false,
                docs: [{
                  id: '1',
                  data: () => ({
                    tableNumber: 1,
                    status: 'pending'
                  })
                }]
              })
            }),
            add: (data) => Promise.resolve({ id: 'mockId' }),
            onSnapshot: (callback) => {
              // Call immediately with mock data
              callback({
                docs: [
                  {
                    id: '1',
                    data: () => ({
                      tableNumber: 1,
                      status: 'pending',
                      items: [{name: 'Margherita Pizza', price: 14.99}],
                      timestamp: new Date(),
                      userId: 'guest'
                    })
                  }
                ]
              });
              // Return unsubscribe function
              return () => {};
            },
            get: () => Promise.resolve({
              size: 5,
              empty: false,
              docs: Array(5).fill(0).map((_, i) => ({
                id: String(i+1),
                data: () => ({
                  tableNumber: i+1,
                  status: ['pending', 'preparing', 'ready', 'completed', 'cancelled'][i % 5],
                  rating: Math.floor(Math.random() * 5) + 1,
                  timestamp: new Date(),
                  userId: 'guest'
                })
              }))
            })
          };
        }
      };
      
      // Removed notifications during loading as requested
      console.log("Demo mode active with sample data");
      
      // Pre-populate some demo data for tables
      window.setTimeout(() => {
        // Add mock occupied tables
        for (let tableNum of [2, 5, 8]) {
          occupiedTables.add(tableNum);
          
          // Create mock details for staff view
          tableDetails[tableNum] = {
            orders: [
              {
                id: `order-${tableNum}-1`,
                status: ['pending', 'preparing', 'ready'][Math.floor(Math.random() * 3)],
                items: [
                  { name: 'Margherita Pizza', price: 14.99, totalPrice: 14.99 },
                  { name: 'Alfredo Pasta', price: 13.99, totalPrice: 13.99 }
                ],
                timestamp: new Date(Date.now() - Math.random() * 3600000),
                total: 28.98
              }
            ]
          };
        }
        
        // Basic implementation of updateTablesDisplay for demo mode
        function updateTablesDisplay() {
          console.log("Updating tables display in demo mode");
          const tablesContainer = document.getElementById('occupied-tables-container');
          if (!tablesContainer) return;
          
          // Clear existing content
          tablesContainer.innerHTML = '';
          
          // Display occupied tables
          for (const tableNum of occupiedTables) {
            const tableCard = document.createElement('div');
            tableCard.className = 'table-card';
            tableCard.dataset.tableNumber = tableNum;
            
            const statusClass = 'status-occupied'; // Default to occupied
            
            tableCard.innerHTML = `
              <div class="table-card-header">
                <h3>TABLE ${tableNum}</h3>
                <span class="table-status ${statusClass}">
                  ${currentLanguage === 'ar' ? 'Ù…Ø´ØºÙˆÙ„Ø©' : 'OCCUPIED'}
                </span>
              </div>
              <div class="table-card-content">
                <div class="table-info">
                  <p>${currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Orders'}: 
                    <span>1</span>
                  </p>
                  <p>${currentLanguage === 'ar' ? 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«' : 'Last Updated'}: 
                    <span>5 ${currentLanguage === 'ar' ? 'Ø¯Ù‚Ø§Ø¦Ù‚' : 'mins'} ${currentLanguage === 'ar' ? 'Ù…Ø¶Øª' : 'ago'}</span>
                  </p>
                </div>
                <button class="view-table-details-btn" onclick="viewTableDetails(${tableNum})">
                  ${currentLanguage === 'ar' ? 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'VIEW DETAILS'}
                </button>
              </div>
            `;
            
            tablesContainer.appendChild(tableCard);
          }
        }
        
        // Update tables display for staff view
        updateTablesDisplay();
        
        // Add some mock orders for guest mode
        if (clientOrdersList) {
          // Add this without the offline mode check
      if (clientOrdersList.childElementCount === 0) {
            addDemoOrderToClientList({
              id: 'demo-order-1',
              status: 'preparing',
              items: [{ name: 'Margherita Pizza', price: 14.99, totalPrice: 14.99 }],
              timestamp: new Date(Date.now() - 900000), // 15 minutes ago
              tableNumber: 3
            });
          }
        }
      }, 500);
    }
    
    // Global Variables
    let currentFoodIndex = 0;
    let currentCategory = "all";
    let currentMainCategory = "all";
    let filteredFoodItems = [];
    let cart = [];
    let estimatedTime = 15; // in minutes
    let currentLanguage = 'en';
    let userType = "guest"; // guest, staff, admin
    let currentStaff = null;
    let clientId = localStorage.getItem('clientId') || 
                  'CL-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    let occupiedTables = new Set(); // Track occupied tables
    let tableNumber = null; // Current table number
    let tableNumberExpiry = null; // When the table number expires
    let tableDetails = {}; // Store table details for staff view
    let currentRating = 0;
    let currentOrderForRating = null;
    
    // Food catalog
    const foodItems = [
      // FOOD - Pizza items
      {
        name: "Margherita Pizza",
        nameAr: "Ø¨ÙŠØªØ²Ø§ Ù…Ø§Ø±Ø¬Ø±ÙŠØªØ§",
        modelSrc: "models/Margherita Pizza.glb",
        description: "Fresh mozzarella, tomatoes, and basil on a thin crust, baked to perfection.",
        descriptionAr: "Ø¬Ø¨Ù†Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§ Ø·Ø§Ø²Ø¬Ø©ØŒ Ø·Ù…Ø§Ø·Ù…ØŒ ÙˆØ±ÙŠØ­Ø§Ù† Ø¹Ù„Ù‰ Ø¹Ø¬ÙŠÙ†Ø© Ø±Ù‚ÙŠÙ‚Ø©ØŒ Ù…Ø®Ø¨ÙˆØ²Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ.",
        price: 14.99,
        category: "pizza",
        mainCategory: "food"
      },
      {
        name: "Pepperoni Pizza",
        nameAr: "Ø¨ÙŠØªØ²Ø§ Ø¨Ø¨Ø±ÙˆÙ†ÙŠ",
        modelSrc: "models/Pepperoni Pizza.glb",
        description: "Classic pepperoni with cheese and our signature tomato sauce.",
        descriptionAr: "Ø¨Ø¨Ø±ÙˆÙ†ÙŠ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ Ù…Ø¹ Ø§Ù„Ø¬Ø¨Ù† ÙˆØµÙ„ØµØ© Ø§Ù„Ø·Ù…Ø§Ø·Ù… Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù„Ø¯ÙŠÙ†Ø§.",
        price: 15.99,
        category: "pizza",
        mainCategory: "food"
      },
      {
        name: "Vegetarian Pizza",
        nameAr: "Ø¨ÙŠØªØ²Ø§ Ù†Ø¨Ø§ØªÙŠØ©",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Fresh bell peppers, mushrooms, onions, and olives on our signature crust.",
        descriptionAr: "ÙÙ„ÙÙ„ Ø­Ù„Ùˆ Ø·Ø§Ø²Ø¬ØŒ ÙØ·Ø±ØŒ Ø¨ØµÙ„ØŒ ÙˆØ²ÙŠØªÙˆÙ† Ø¹Ù„Ù‰ Ø¹Ø¬ÙŠÙ†ØªÙ†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²Ø©.",
        price: 16.99,
        category: "pizza",
        mainCategory: "food"
      },
      
      // FOOD - Pasta items
      {
        name: "Alfredo Pasta",
        nameAr: "Ø¨Ø§Ø³ØªØ§ Ø£Ù„ÙØ±ÙŠØ¯Ùˆ",
        modelSrc: "models/Alfredo Pasta.glb",
        description: "Creamy Alfredo sauce with fettuccine pasta, garnished with parsley.",
        descriptionAr: "ØµÙ„ØµØ© Ø£Ù„ÙØ±ÙŠØ¯Ùˆ ÙƒØ±ÙŠÙ…ÙŠØ© Ù…Ø¹ Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© ÙÙŠØªÙˆØªØ´ÙŠÙ†ÙŠØŒ Ù…Ø²ÙŠÙ†Ø© Ø¨Ø§Ù„Ø¨Ù‚Ø¯ÙˆÙ†Ø³.",
        price: 13.99,
        category: "pasta",
        mainCategory: "food"
      },
      {
        name: "Spaghetti Bolognese",
        nameAr: "Ø³Ø¨Ø§ØºÙŠØªÙŠ Ø¨ÙˆÙ„ÙˆÙ†ÙŠØ²",
        modelSrc: "models/Spaghetti Bolognese.glb",
        description: "Spaghetti with a rich, slow-cooked meat sauce and parmesan cheese.",
        descriptionAr: "Ø³Ø¨Ø§ØºÙŠØªÙŠ Ù…Ø¹ ØµÙ„ØµØ© Ù„Ø­Ù… ØºÙ†ÙŠØ© Ù…Ø·Ø¨ÙˆØ®Ø© Ø¨Ø¨Ø·Ø¡ ÙˆØ¬Ø¨Ù†Ø© Ø¨Ø§Ø±Ù…ÙŠØ²Ø§Ù†.",
        price: 14.99,
        category: "pasta",
        mainCategory: "food"
      },
      {
        name: "Pesto Pasta",
        nameAr: "Ø¨Ø§Ø³ØªØ§ Ø¨ÙŠØ³ØªÙˆ",
        modelSrc: "models/Alfredo Pasta.glb", // Using existing model as placeholder
        description: "Linguine pasta with basil pesto, pine nuts, and freshly grated parmesan.",
        descriptionAr: "Ù…Ø¹ÙƒØ±ÙˆÙ†Ø© Ù„ÙŠÙ†Ø¬ÙˆÙŠÙ†ÙŠ Ù…Ø¹ ØµÙ„ØµØ© Ø§Ù„Ø¨ÙŠØ³ØªÙˆ Ø¨Ø§Ù„Ø±ÙŠØ­Ø§Ù† ÙˆØ§Ù„ØµÙ†ÙˆØ¨Ø± ÙˆØ¬Ø¨Ù†Ø© Ø¨Ø§Ø±Ù…ÙŠØ²Ø§Ù† Ù…Ø¨Ø´ÙˆØ±Ø© Ø·Ø§Ø²Ø¬Ø©.",
        price: 14.49,
        category: "pasta",
        mainCategory: "food"
      },
      
      // FOOD - Salad items
      {
        name: "Caesar Salad",
        nameAr: "Ø³Ù„Ø·Ø© Ø³ÙŠØ²Ø±",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Crisp romaine lettuce with Caesar dressing, croutons, and parmesan cheese.",
        descriptionAr: "Ø®Ø³ Ø±ÙˆÙ…Ø§Ù†ÙŠ Ù…Ù‚Ø±Ù…Ø´ Ù…Ø¹ ØµÙ„ØµØ© Ø³ÙŠØ²Ø±ØŒ Ù‚Ø·Ø¹ Ø®Ø¨Ø² Ù…Ø­Ù…ØµØ©ØŒ ÙˆØ¬Ø¨Ù†Ø© Ø¨Ø§Ø±Ù…ÙŠØ²Ø§Ù†.",
        price: 9.99,
        category: "salads",
        mainCategory: "food"
      },
      {
        name: "Greek Salad",
        nameAr: "Ø³Ù„Ø·Ø© ÙŠÙˆÙ†Ø§Ù†ÙŠØ©",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Fresh cucumbers, tomatoes, olives, feta cheese, and red onions with olive oil dressing.",
        descriptionAr: "Ø®ÙŠØ§Ø± Ø·Ø§Ø²Ø¬ØŒ Ø·Ù…Ø§Ø·Ù…ØŒ Ø²ÙŠØªÙˆÙ†ØŒ Ø¬Ø¨Ù†Ø© ÙÙŠØªØ§ØŒ ÙˆØ¨ØµÙ„ Ø£Ø­Ù…Ø± Ù…Ø¹ ØµÙ„ØµØ© Ø²ÙŠØª Ø§Ù„Ø²ÙŠØªÙˆÙ†.",
        price: 10.99,
        category: "salads",
        mainCategory: "food"
      },
      
      // FOOD - Burger items
      {
        name: "Classic Cheeseburger",
        nameAr: "ØªØ´ÙŠØ²Ø¨Ø±Ø¬Ø± ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Juicy beef patty with cheddar cheese, lettuce, tomato, and our special sauce.",
        descriptionAr: "Ù‚Ø·Ø¹Ø© Ù„Ø­Ù… Ø¨Ù‚Ø±ÙŠ Ø¹ØµÙŠØ±ÙŠØ© Ù…Ø¹ Ø¬Ø¨Ù†Ø© Ø´ÙŠØ¯Ø±ØŒ Ø®Ø³ØŒ Ø·Ù…Ø§Ø·Ù…ØŒ ÙˆØµÙ„ØµØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ©.",
        price: 12.99,
        category: "burgers",
        mainCategory: "food"
      },
      {
        name: "Veggie Burger",
        nameAr: "Ø¨Ø±Ø¬Ø± Ù†Ø¨Ø§ØªÙŠ",
        modelSrc: "models/Alfredo Pasta.glb", // Using existing model as placeholder
        description: "Plant-based patty with avocado, grilled onions, and chipotle mayo.",
        descriptionAr: "Ù‚Ø·Ø¹Ø© Ø¨Ø±Ø¬Ø± Ù†Ø¨Ø§ØªÙŠØ© Ù…Ø¹ Ø£ÙÙˆÙƒØ§Ø¯ÙˆØŒ Ø¨ØµÙ„ Ù…Ø´ÙˆÙŠØŒ ÙˆÙ…Ø§ÙŠÙˆÙ†ÙŠØ² ØªØ´ÙŠØ¨ÙˆØªÙ„ÙŠ.",
        price: 13.99,
        category: "burgers",
        mainCategory: "food"
      },
      
      // DRINKS - Hot Drinks
      {
        name: "Hot Chocolate",
        modelSrc: "models/Spaghetti Bolognese.glb", // Using existing model as placeholder
        description: "Rich and creamy hot chocolate topped with marshmallows and whipped cream.",
        price: 3.99,
        category: "hot-drinks",
        mainCategory: "drinks"
      },
      {
        name: "Cappuccino",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Espresso with steamed milk and a silky microfoam.",
        price: 4.49,
        category: "hot-drinks",
        mainCategory: "drinks"
      },
      
      // DRINKS - Cold Drinks
      {
        name: "Iced Mocha",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Chilled espresso with chocolate, milk, and ice, topped with whipped cream.",
        price: 4.99,
        category: "cold-drinks",
        mainCategory: "drinks"
      },
      {
        name: "Lemonade",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Freshly squeezed lemons with sparkling water and a touch of sweetness.",
        price: 3.49,
        category: "cold-drinks",
        mainCategory: "drinks"
      },
      
      // DRINKS - Smoothies
      {
        name: "Berry Blast Smoothie",
        modelSrc: "models/Alfredo Pasta.glb", // Using existing model as placeholder
        description: "Mixed berries, yogurt, and honey blended with ice for a refreshing treat.",
        price: 5.99,
        category: "smoothies",
        mainCategory: "drinks"
      },
      {
        name: "Tropical Paradise Smoothie",
        modelSrc: "models/Spaghetti Bolognese.glb", // Using existing model as placeholder
        description: "Mango, pineapple, and banana blended with coconut milk and ice.",
        price: 6.49,
        category: "smoothies",
        mainCategory: "drinks"
      },
      
      // DESSERTS - Cakes
      {
        name: "Chocolate Cake",
        modelSrc: "models/Margherita Pizza.glb", // Using existing model as placeholder
        description: "Decadent chocolate cake with a rich chocolate ganache and berries.",
        price: 6.99,
        category: "cakes",
        mainCategory: "desserts"
      },
      {
        name: "Red Velvet Cake",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Moist red velvet cake with cream cheese frosting and white chocolate shavings.",
        price: 7.49,
        category: "cakes",
        mainCategory: "desserts"
      },
      
      // DESSERTS - Ice Cream
      {
        name: "Vanilla Bean Ice Cream",
        modelSrc: "models/Alfredo Pasta.glb", // Using existing model as placeholder
        description: "Creamy vanilla bean ice cream served with a wafer cookie.",
        price: 4.99,
        category: "ice-cream",
        mainCategory: "desserts"
      },
      {
        name: "Tiramisu",
        modelSrc: "models/Pepperoni Pizza.glb", // Using existing model as placeholder
        description: "Classic Italian dessert with layers of coffee-soaked ladyfingers and mascarpone cream.",
        price: 7.99,
        category: "cakes",
        mainCategory: "desserts"
      }
    ];
    
    // DOM Elements
    const overlay = document.querySelector('.overlay');
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingBar = document.getElementById("loading-bar");
    const loadingText = document.getElementById("loading-text");
    const foodName = document.getElementById("food-name");
    const foodDescription = document.getElementById("food-description");
    const foodPrice = document.getElementById("food-price");
    const modelViewer = document.getElementById("food-model-viewer");
    const cartToggle = document.getElementById("cart-toggle");
    const cartPanel = document.getElementById("cart-panel");
    const cartItems = document.getElementById("cart-items");
    const cartCount = document.getElementById("cart-count");
    const cartTitle = document.getElementById("cart-title");
    const loginModal = document.getElementById("login-modal");
    const loginTitle = document.getElementById("login-title");
    const usernameLabel = document.getElementById("username-label");
    const passwordLabel = document.getElementById("password-label");
    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("login-btn");
    const cancelLoginBtn = document.getElementById("cancel-login-btn");
    const guestView = document.getElementById("guest-view");
    const staffDashboard = document.getElementById("staff-dashboard");
    const adminDashboard = document.getElementById("admin-dashboard");
    const guestBtn = document.getElementById("guest-btn");
    const staffBtn = document.getElementById("staff-btn");
    const adminBtn = document.getElementById("admin-btn");
    const staffDashboardTitle = document.getElementById("staff-dashboard-title");
    const checkoutText = document.getElementById("checkout-text");
    const checkoutBtn = document.getElementById("checkout-btn");
    const discountLabel = document.getElementById("discount-label");
    const applyDiscountBtn = document.getElementById("apply-discount");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const addCartBtn = document.getElementById("add-cart-btn");
    const arButton = document.getElementById("ar-button");
    const extrasLabel = document.getElementById("extras-label");
    const notesLabel = document.getElementById("notes-label");
    const statusNotification = document.getElementById("status-notification");
    const statusTitle = document.getElementById("status-title");
    const statusMessage = document.getElementById("status-message");
    const title = document.getElementById("title");
    const tagline = document.getElementById("tagline");
    const poweredByText = document.getElementById("powered-by-text");
    const currentLang = document.getElementById("current-lang");
    const instagramText = document.getElementById("instagram-text");
    const copyrightText = document.getElementById("copyright-text");
    const estimatedTimeLabel = document.getElementById("estimated-time-label");
    const yourOrdersTitle = document.getElementById("your-orders-title");
    const viewOrdersBtn = document.getElementById("view-orders-btn");
    const clientOrdersList = document.getElementById("client-orders-list");
    const clientOrders = document.getElementById("client-orders");
    const tableNumberModal = document.getElementById("table-number-modal");
    const tableNumberInput = document.getElementById("table-number-input");
    const tableNumberInputContainer = document.getElementById("table-number-input-container");
    const tableNumberTitle = document.getElementById("table-number-title");
    const tableNumberSubtitle = document.getElementById("table-number-subtitle");
    const guestOptionText = document.getElementById("guest-option-text");
    const staffOptionText = document.getElementById("staff-option-text");
    const itemNotes = document.getElementById("item-notes");
    const extrasSelect = document.getElementById("extras-select");
    const discountCodeInput = document.getElementById("discount-code");
    const totalBreakdown = document.getElementById("total-breakdown");
    const estimatedTimeEl = document.getElementById("estimated-time");
    const staffEstimatedTimeEl = document.getElementById("staff-estimated-time");
    const tablesGrid = document.getElementById("tables-grid");
    const tableDetailsModal = document.getElementById("table-details");
    const tableDetailsTitle = document.getElementById("table-details-title");
    const tableOrdersList = document.getElementById("table-orders-list");
    const closeDetailsBtn = document.getElementById("close-details");
    const ratingModal = document.getElementById("rating-modal");
    const ratingStars = document.querySelectorAll(".rating-star");
    const ratingFeedback = document.getElementById("rating-feedback");
    const ratingFeedbackLabel = document.getElementById("rating-feedback-label");
    const submitRatingBtn = document.getElementById("submit-rating-btn");
    const staffAssignment = document.getElementById("staff-assignment");
    const totalOrdersEl = document.getElementById("total-orders");
    const staffEstimatedTimeLabel = document.getElementById("staff-estimated-time-label");
    const occupiedTablesTitle = document.getElementById("occupied-tables-title");
    const adminDashboardTitle = document.getElementById("admin-dashboard-title");
    const totalOrdersTitle = document.getElementById("total-orders-title");
    const avgRatingTitle = document.getElementById("avg-rating-title");
    const lowRatingsTitle = document.getElementById("low-ratings-title");
    const activeStaffTitle = document.getElementById("active-staff-title");
    const statisticsTitle = document.getElementById("statistics-title");
    const ordersTitle = document.getElementById("orders-title");
    const ratingsTitle = document.getElementById("ratings-title");
    const staffAssignmentTitle = document.getElementById("staff-assignment-title");
    const staffAssignmentLabel = document.getElementById("staff-assignment-label");
    const assignStaffBtn = document.getElementById("assign-staff-btn");
    const confirmTableBtn = document.getElementById("confirm-table-btn");
    const cancelTableBtn = document.getElementById("cancel-table-btn");
    const ratingTitle = document.getElementById("rating-title");
    const cancelRatingBtn = document.getElementById("cancel-rating-btn");
    
    // Constants
    const USER_TYPE_KEY = "userType";
    const STAFF_TOKEN = "staffToken";
    const ADMIN_TOKEN = "adminToken";
    const TABLE_NUMBER_KEY = "tableNumber";
    const TABLE_EXPIRY_KEY = "tableExpiry";
    const LANGUAGE_KEY = "language";
    const CLIENT_ID_KEY = "clientId";
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', async function() {
      // Load language preference
      currentLanguage = localStorage.getItem(LANGUAGE_KEY) || 'en';
      updateLanguage();
      
      // Retrieve authentication status
      userType = localStorage.getItem(USER_TYPE_KEY) || "guest";
      currentStaff = localStorage.getItem(STAFF_TOKEN);
      checkAuthState();
      
      // Set up enter key for password field
      const passwordField = document.getElementById('password');
      if (passwordField) {
        passwordField.addEventListener('keyup', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            loginUser();
          }
        });
      }
      
      // FORCE CLEAR any existing table number for testing
      localStorage.removeItem(TABLE_NUMBER_KEY);
      localStorage.removeItem(TABLE_EXPIRY_KEY);
      tableNumber = null;
      tableNumberExpiry = null;
      
      // Check for expired table number - should always be null now for testing
      const savedTableNumber = localStorage.getItem(TABLE_NUMBER_KEY);
      const expiry = localStorage.getItem(TABLE_EXPIRY_KEY);
      
      console.log("Table number in storage:", savedTableNumber);
      
      if (savedTableNumber && expiry && new Date(expiry) > new Date()) {
        tableNumber = parseInt(savedTableNumber, 10);
        tableNumberExpiry = new Date(expiry);
      }
      
      // Set client ID for tracking orders
      localStorage.setItem(CLIENT_ID_KEY, clientId);
      
      // Check if the user is already logged in as staff or admin
      const staffLoggedIn = localStorage.getItem(STAFF_TOKEN);
      const adminLoggedIn = localStorage.getItem(ADMIN_TOKEN);
      
      if (staffLoggedIn || adminLoggedIn) {
        console.log("Staff/Admin already logged in, bypassing table modal");
        // Set user type based on existing token
        userType = adminLoggedIn ? 'admin' : 'staff';
        localStorage.setItem(USER_TYPE_KEY, userType);
        checkAuthState();
      } else {
        // Force showing the table number modal on initialization for guests
        console.log("Initialization: Forcing table modal display");
        // Delay slightly to ensure it's fully visible
        setTimeout(() => {
          showTableModal();
        }, 500);
      }
      
      // Set initial category to "All" by default
      currentCategory = 'all';
      currentMainCategory = 'all';
      
      // Set "All" main category button as active
      const allMainCategoryBtn = document.getElementById('all-main-category-btn');
      if (allMainCategoryBtn) {
        document.querySelectorAll('.main-category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        allMainCategoryBtn.classList.add('active');
      }
      
      // Hide subcategories when "All" is selected
      const subCategoriesContainer = document.getElementById('sub-categories');
      if (subCategoriesContainer) {
        subCategoriesContainer.style.display = 'none';
      }
      
      // Filter food items and display the first one
      filterFoodItems();
      updateFoodDisplay();
      
      // Start preloading all 3D models
      setTimeout(() => {
        preloadModels();
      }, 2000);
      
      // Start the loading animation
      simulateLoading();
      
      // Listen for rating stars
      ratingStars.forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.getAttribute('data-rating'));
          currentRating = rating;
          
          // Update stars visually
          ratingStars.forEach(s => {
            if (parseInt(s.getAttribute('data-rating')) <= rating) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        });
      });
      
      // Fetch occupied tables initially
      await fetchOrders();
      
      // Set up real-time listeners for orders
      setupOrderListeners();
      
      // Update table number modal placeholder
      tableNumberInput.placeholder = currentLanguage === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Enter table number';
      
      // Set up charts for admin dashboard
      setupCharts();
    });
    
    // Simulate loading progress - faster and with failsafe
    function simulateLoading() {
      // Make sure overlay is visible first
      loadingOverlay.style.display = 'flex';
      loadingOverlay.style.opacity = '1';
      
      // Initialize progress and track loaded assets
      let progress = 0;
      let modelLoaded = false;
      
      // Start with initial loading text
      loadingText.textContent = currentLanguage === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...' : 'Initializing application...';
      
      // Update loading text based on progress
      function updateLoadingText(progress) {
        if (progress <= 30) {
          loadingText.textContent = currentLanguage === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...' : 'Initializing application...';
        } else if (progress <= 60) {
          loadingText.textContent = currentLanguage === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯...' : 'Loading 3D Models...';
        } else if (progress <= 85) {
          loadingText.textContent = currentLanguage === 'ar' ? 'ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...' : 'Preparing Interface...';
        } else {
          loadingText.textContent = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø² ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§...' : 'Almost Ready...';
        }
      }
      
      // Add event listener to detect when 3D model is loaded
      if (modelViewer) {
        modelViewer.addEventListener('load', () => {
          modelLoaded = true;
          console.log("Model loaded successfully");
        });
        
        // Also handle error case
        modelViewer.addEventListener('error', () => {
          console.log("Model failed to load, continuing anyway");
          modelLoaded = true; // Treat as loaded so we can continue
        });
      }
      
      // Controlled progress increments with varying speeds
      const interval = setInterval(() => {
        // Dynamic progress increment - faster at start, slower as we approach 100%
        let increment;
        
        if (progress < 30) {
          increment = 5 + Math.random() * 3; // Fast initial loading
        } else if (progress < 70) {
          increment = 3 + Math.random() * 2; // Medium speed for middle portion
        } else {
          // Final portion moves slower and waits for model
          if (modelLoaded) {
            increment = 4 + Math.random() * 2; // Final push once model loaded
          } else {
            increment = 0.5 + Math.random() * 0.5; // Very slow if waiting for model
          }
        }
        
        progress += increment;
        
        // Cap at 99% until everything is truly ready
        if (progress >= 99) {
          if (modelLoaded) {
            progress = 100;
            clearInterval(interval);
            
            // Complete the loading
            loadingBar.style.width = '100%';
            
            // Hide loading overlay with a nice transition
            setTimeout(() => {
              loadingOverlay.style.opacity = '0';
              setTimeout(() => {
                loadingOverlay.style.display = 'none';
                
                // Make sure all components are visible
                document.querySelector('.overlay').style.visibility = 'visible';
                if (modelViewer) modelViewer.style.visibility = 'visible';
                
                // Show table number modal immediately after loading
                // But skip it for logged in staff/admin
                console.log("Checking tableNumber value:", tableNumber);
                console.log("User type on completion:", userType);
                
                // Check if we have a staff/admin token and skip the modal if we do
                if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
                  console.log("Staff/Admin already logged in, not showing table modal");
                } else {
                  // Force showing the table modal for guests
                  console.log("Showing table modal for guests");
                  showTableModal();
                }
              }, 300);
            }, 200);
          } else {
            progress = 99; // Stay at 99% until model loads
          }
        }
        
        // Update progress bar and text
        loadingBar.style.width = `${progress}%`;
        updateLoadingText(progress);
        
      }, 150); // Update at 150ms intervals for smooth animation
      
      // Ultimate failsafe: Ensure loading screen closes even if there are errors
      setTimeout(() => {
        if (loadingOverlay.style.display !== 'none') {
          console.log("Loading timeout reached, forcing completion");
          clearInterval(interval);
          loadingBar.style.width = '100%';
          loadingText.textContent = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø²!' : 'Ready!';
          
          setTimeout(() => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
              
              // Ensure visibility of components
              document.querySelector('.overlay').style.visibility = 'visible';
              if (modelViewer) modelViewer.style.visibility = 'visible';
              
              // Check if we need to display the table modal in failsafe
              console.log("Failsafe: Checking if we need to show table modal");
              
              // Skip for logged in staff/admin
              if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
                console.log("Failsafe: Staff/Admin already logged in, not showing table modal");
              } else {
                // Force showing the table modal for guests
                console.log("Failsafe: Showing table modal for guests");
                showTableModal();
              }
            }, 300);
          }, 200);
        }
      }, 5000); // Max 5 seconds before forcing completion
    }
    
    // Language support
    function toggleLanguage() {
      currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
      localStorage.setItem(LANGUAGE_KEY, currentLanguage);
      updateLanguage();
    }
    
    // Logout staff or admin user
    function logoutStaff() {
      // Clear auth tokens
      localStorage.removeItem(STAFF_TOKEN);
      localStorage.removeItem(ADMIN_TOKEN);
      localStorage.removeItem("staffName");
      localStorage.removeItem("staffRole");
      
      // Set user type back to guest
      userType = "guest";
      localStorage.setItem(USER_TYPE_KEY, "guest");
      
      // Check auth state to update UI
      checkAuthState();
      
      // Show success notification
      showNotification(
        currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­' : 'Successfully Logged Out',
        currentLanguage === 'ar' 
          ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­'
          : 'You have been successfully logged out',
        'success'
      );
    }
    
    function updateLanguage() {
      const translations = {
        en: {
          title: "The Oak Cafe",
          tagline: "Experience dining in augmented reality",
          yourCart: "YOUR CART",
          checkout: "CHECKOUT",
          cancel: "CANCEL",
          confirm: "CONFIRM",
          yourTableNumber: "YOUR TABLE NUMBER",
          tableNumberSubtitle: "Please select your role or enter your table number to continue",
          tableNumberHelp: "Your table number is displayed on the QR code at your table",
          guestOptionDesc: "Select this if you're dining in and need to place an order from your table",
          staffOptionDesc: "Restaurant staff access - manage orders, tables, and kitchen operations",
          guestOption: "I'm a Guest",
          staffOption: "I'm Staff",
          login: "LOGIN",
          accountLogin: "ACCOUNT LOGIN",
        staffLogin: "STAFF LOGIN",
          username: "USERNAME",
          password: "PASSWORD",
          addToCart: "+ ADD TO CART",
          prev: "â† PREV",
          next: "NEXT â†’",
          viewInAr: "VIEW IN AR",
          addExtras: "ADD EXTRAS",
          specialInstructions: "SPECIAL INSTRUCTIONS",
          discountCode: "DISCOUNT CODE",
          apply: "APPLY",
          estimatedWaitTime: "Estimated Wait Time:",
          yourOrders: "YOUR ORDERS",
          viewMyOrders: "VIEW MY ORDERS",
          staffDashboard: "STAFF DASHBOARD",
          occupiedTables: "OCCUPIED TABLES",
          adminDashboard: "ADMIN DASHBOARD",
          statistics: "STATISTICS",
          orders: "ORDERS",
          ratings: "RATINGS",
          totalOrders: "TOTAL ORDERS",
          avgRating: "AVG RATING",
          lowRatings: "LOW RATINGS",
          activeStaff: "ACTIVE STAFF",
          staffManagement: "STAFF MANAGEMENT",
          staffAccounts: "STAFF ACCOUNTS", 
          addNewStaff: "ADD NEW STAFF",
          staffAssignment: "TABLE ASSIGNMENTS",
          assignStaff: "ASSIGN TABLES",
          editStaff: "EDIT STAFF",
          deleteStaff: "DELETE STAFF",
          confirmDelete: "CONFIRM DELETE",
          cancel: "CANCEL",
          username: "USERNAME",
          password: "PASSWORD",
          fullName: "FULL NAME",
          role: "ROLE",
          tableRange: "TABLE RANGE",
          tableRangeStart: "START TABLE",
          tableRangeEnd: "END TABLE",
          noAssignments: "NO ASSIGNMENTS",
          logout: "LOGOUT",
          rateYourExperience: "RATE YOUR EXPERIENCE",
          feedback: "FEEDBACK (OPTIONAL)",
          submit: "SUBMIT",
          poweredBy: "Experience at",
          followInstagram: "Follow us on Instagram",
          copyright: "Â© 2023 The Oak Cafe. All rights reserved.",
          loadingText: "Loading Augmented Reality Experience...",
          // Category buttons
          allItems: "All Items",
          hotFood: "Hot Food",
          coldFood: "Cold Food",
          drinks: "Drinks",
          desserts: "Desserts"
        },
        ar: {
          title: "Ø°Ø§ Ø£ÙˆÙƒ ÙƒØ§ÙÙŠÙ‡",
          tagline: "Ø§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¬Ø±Ø¨Ø© ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù… Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²",
          yourCart: "Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚",
          checkout: "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨",
          cancel: "Ø¥Ù„ØºØ§Ø¡",
          confirm: "ØªØ£ÙƒÙŠØ¯",
          yourTableNumber: "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©",
          tableNumberSubtitle: "ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¯ÙˆØ±Ùƒ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
          tableNumberHelp: "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…ÙØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø±Ù…Ø² QR Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø·Ø§ÙˆÙ„ØªÙƒ",
          guestOptionDesc: "Ø­Ø¯Ø¯ Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù… ÙˆØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ù† Ø·Ø§ÙˆÙ„ØªÙƒ",
          staffOptionDesc: "ÙˆØµÙˆÙ„ Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø·Ø¹Ù… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø·Ø¨Ø®",
          guestOption: "Ø£Ù†Ø§ Ø¶ÙŠÙ",
          staffOption: "Ø£Ù†Ø§ Ù…ÙˆØ¸Ù",
          login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
          accountLogin: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨",
          staffLogin: "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
          username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
          password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
          addToCart: "+ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©",
          prev: "â† Ø§Ù„Ø³Ø§Ø¨Ù‚",
          next: "Ø§Ù„ØªØ§Ù„ÙŠ â†’",
          viewInAr: "Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²",
          addExtras: "Ø¥Ø¶Ø§ÙØ§Øª",
          specialInstructions: "ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ©",
          discountCode: "Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ…",
          apply: "ØªØ·Ø¨ÙŠÙ‚",
          estimatedWaitTime: "ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ:",
          yourOrders: "Ø·Ù„Ø¨Ø§ØªÙƒ",
          viewMyOrders: "Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙŠ",
          staffDashboard: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
          occupiedTables: "Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©",
          adminDashboard: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±",
          statistics: "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
          orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
          ratings: "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª",
          totalOrders: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
          avgRating: "Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",
          lowRatings: "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø©",
          activeStaff: "Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†",
          staffManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
          staffAccounts: "Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†", 
          addNewStaff: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯",
          staffAssignment: "ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª",
          assignStaff: "ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª",
          editStaff: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù",
          deleteStaff: "Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù",
          confirmDelete: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
          cancel: "Ø¥Ù„ØºØ§Ø¡",
          username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
          password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
          fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
          role: "Ø§Ù„Ù…Ù†ØµØ¨",
          tableRange: "Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª",
          tableRangeStart: "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚",
          tableRangeEnd: "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Ø·Ø§Ù‚",
          noAssignments: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹ÙŠÙŠÙ†Ø§Øª",
          logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
          rateYourExperience: "Ù‚ÙŠÙ… ØªØ¬Ø±Ø¨ØªÙƒ",
          feedback: "ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
          submit: "Ø¥Ø±Ø³Ø§Ù„",
          poweredBy: "Ø§Ø³ØªÙ…ØªØ¹ ÙÙŠ",
          followInstagram: "ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…",
          copyright: "Â© 2023 Ø°Ø§ Ø£ÙˆÙƒ ÙƒØ§ÙÙŠÙ‡. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.",
          loadingText: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²...",
          // Category buttons
          allItems: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±",
          hotFood: "Ø·Ø¹Ø§Ù… Ø³Ø§Ø®Ù†",
          coldFood: "Ø·Ø¹Ø§Ù… Ø¨Ø§Ø±Ø¯",
          drinks: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª",
          desserts: "Ø­Ù„ÙˆÙŠØ§Øª",
          // Advanced Analytics translations
          advancedAnalytics: "ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©",
          analyticsTitle: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©",
          managementTab: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
          dashboardTab: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
          timeRange: "Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ:",
          todayOption: "Ø§Ù„ÙŠÙˆÙ…",
          weekOption: "Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
          monthOption: "Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±",
          yearOption: "Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…",
          salesPerformance: "Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
          topMenuItems: "Ø£ÙØ¶Ù„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",
          customerSatisfaction: "Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
          tableUtilization: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©",
          staffPerformance: "Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
          orderSources: "Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
          exportData: "ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
          discountManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª",
          discountCode: "Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ…",
          discountPercentage: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…",
          createDiscount: "Ø¥Ù†Ø´Ø§Ø¡ Ø®ØµÙ…",
          // Category buttons
          allItems: "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±",
          pizza: "Ø¨ÙŠØªØ²Ø§",
          pasta: "Ù…Ø¹ÙƒØ±ÙˆÙ†Ø©",
          salads: "Ø³Ù„Ø·Ø§Øª",
          drinks: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª",
          desserts: "Ø­Ù„ÙˆÙŠØ§Øª"
        }
      };
      
      const t = translations[currentLanguage];
      
      // Update UI text
      title.textContent = t.title;
      tagline.textContent = t.tagline;
      cartTitle.textContent = t.yourCart;
      checkoutText.textContent = t.checkout;
      prevBtn.textContent = t.prev;
      nextBtn.textContent = t.next;
      addCartBtn.textContent = t.addToCart;
      arButton.textContent = t.viewInAr;
      extrasLabel.textContent = t.addExtras;
      notesLabel.textContent = t.specialInstructions;
      discountLabel.textContent = t.discountCode;
      applyDiscountBtn.textContent = t.apply;
      estimatedTimeLabel.textContent = t.estimatedWaitTime;
      yourOrdersTitle.textContent = t.yourOrders;
      viewOrdersBtn.textContent = t.viewMyOrders;
      tableNumberTitle.textContent = t.yourTableNumber;
      tableNumberSubtitle.textContent = t.tableNumberSubtitle;
      guestOptionText.textContent = t.guestOption;
      staffOptionText.textContent = t.staffOption;
      loginTitle.textContent = t.accountLogin;
      usernameLabel.textContent = t.username;
      passwordLabel.textContent = t.password;
      loginBtn.textContent = t.login;
      cancelLoginBtn.textContent = t.cancel;
      confirmTableBtn.textContent = t.confirm;
      cancelTableBtn.textContent = t.cancel;
      staffDashboardTitle.textContent = t.staffDashboard;
      loadingText.textContent = t.loadingText;
      poweredByText.textContent = t.poweredBy;
      instagramText.textContent = t.followInstagram;
      copyrightText.textContent = t.copyright;
      
      // Update table number help text
      const tableNumberHelpText = document.getElementById('table-number-help-text');
      if (tableNumberHelpText) {
        tableNumberHelpText.textContent = t.tableNumberHelp;
      }
      
      // Update role option descriptions
      const guestOptionDesc = document.getElementById('guest-option-desc');
      const staffOptionDesc = document.getElementById('staff-option-desc');
      if (guestOptionDesc) {
        guestOptionDesc.textContent = t.guestOptionDesc;
      }
      if (staffOptionDesc) {
        staffOptionDesc.textContent = t.staffOptionDesc;
      }
      
      currentLang.textContent = currentLanguage.toUpperCase();
      ratingTitle.textContent = t.rateYourExperience;
      ratingFeedbackLabel.textContent = t.feedback;
      submitRatingBtn.textContent = t.submit;
      cancelRatingBtn.textContent = t.cancel;
      staffEstimatedTimeLabel.textContent = t.estimatedWaitTime;
      
      if (occupiedTablesTitle) {
        occupiedTablesTitle.textContent = t.occupiedTables;
      }
      
      // Update admin view
      // Update logout buttons
      const staffLogoutBtnText = document.getElementById('staff-logout-btn-text');
      const adminLogoutBtnText = document.getElementById('admin-logout-btn-text');
      
      if (staffLogoutBtnText) {
        staffLogoutBtnText.textContent = t.logout;
      }
      
      if (adminLogoutBtnText) {
        adminLogoutBtnText.textContent = t.logout;
      }
      
      if (adminDashboard) {
        // Make sure all text is in English in English mode
        if (currentLanguage === 'en') {
          document.querySelectorAll('#admin-dashboard h3, #admin-dashboard h4, #admin-dashboard button, #admin-dashboard label').forEach(el => {
            el.style.fontFamily = '"Poppins", sans-serif';
          });
        }
        
        adminDashboardTitle.textContent = t.adminDashboard;
        statisticsTitle.textContent = t.statistics;
        ordersTitle.textContent = t.orders;
        ratingsTitle.textContent = t.ratings;
        totalOrdersTitle.textContent = t.totalOrders;
        avgRatingTitle.textContent = t.avgRating;
        lowRatingsTitle.textContent = t.lowRatings;
        activeStaffTitle.textContent = t.activeStaff;
        
        // Update staff management section titles
        const staffManagementTitle = document.getElementById('staff-management-title');
        const staffAccountsTitle = document.getElementById('staff-accounts-title');
        const addStaffTitle = document.getElementById('add-staff-title');
        const staffAssignmentTitle = document.getElementById('staff-assignment-title');
        const newAssignmentTitle = document.getElementById('new-assignment-title');
        const addStaffBtn = document.getElementById('add-staff-btn');
        const staffAssignmentLabel = document.getElementById('staff-assignment-label');
        const assignStaffBtn = document.getElementById('assign-staff-btn');
        
        if (staffManagementTitle) staffManagementTitle.textContent = t.staffManagement;
        if (staffAccountsTitle) staffAccountsTitle.textContent = t.staffAccounts;
        if (addStaffTitle) addStaffTitle.textContent = t.addNewStaff;
        if (staffAssignmentTitle) staffAssignmentTitle.textContent = t.staffAssignment;
        if (newAssignmentTitle) newAssignmentTitle.textContent = t.addNewStaff;
        if (addStaffBtn) addStaffBtn.textContent = t.addNewStaff;
        if (staffAssignmentLabel) staffAssignmentLabel.textContent = t.assignStaff;
        if (assignStaffBtn) assignStaffBtn.textContent = t.assignStaff;
        
        // Update Advanced Analytics tab
        const analyticsTab = document.getElementById('analytics-tab');
        if (analyticsTab) {
          analyticsTab.textContent = t.advancedAnalytics;
        }
        
        // Update Management tab
        const managementTab = document.getElementById('management-tab');
        if (managementTab) {
          managementTab.textContent = t.managementTab;
        }
        
        // Update Dashboard tab
        const dashboardTab = document.getElementById('dashboard-tab');
        if (dashboardTab) {
          dashboardTab.textContent = t.dashboardTab;
        }
        
        // Update analytics dashboard title
        const analyticsTitle = document.getElementById('analytics-title');
        if (analyticsTitle) {
          analyticsTitle.textContent = t.analyticsTitle;
        }
        
        // Update time range label
        const timeRangeLabel = document.querySelector('.time-filter label');
        if (timeRangeLabel) {
          timeRangeLabel.textContent = t.timeRange;
        }
        
        // Update time range options
        const timeRangeSelect = document.getElementById('time-range');
        if (timeRangeSelect) {
          const dayOption = timeRangeSelect.querySelector('option[value="day"]');
          const weekOption = timeRangeSelect.querySelector('option[value="week"]');
          const monthOption = timeRangeSelect.querySelector('option[value="month"]');
          const yearOption = timeRangeSelect.querySelector('option[value="year"]');
          
          if (dayOption) dayOption.textContent = t.todayOption;
          if (weekOption) weekOption.textContent = t.weekOption;
          if (monthOption) monthOption.textContent = t.monthOption;
          if (yearOption) yearOption.textContent = t.yearOption;
        }
        
        // Update analytics card headers
        document.querySelectorAll('.analytics-card-header h4').forEach(header => {
          if (header.textContent === 'Sales Performance') header.textContent = t.salesPerformance;
          if (header.textContent === 'Top Menu Items') header.textContent = t.topMenuItems;
          if (header.textContent === 'Customer Satisfaction') header.textContent = t.customerSatisfaction;
          if (header.textContent === 'Table Utilization') header.textContent = t.tableUtilization;
          if (header.textContent === 'Staff Performance') header.textContent = t.staffPerformance;
          if (header.textContent === 'Order Sources') header.textContent = t.orderSources;
        });
        
        // Update discount management section
        const discountManagementTitle = document.getElementById('discount-management-title');
        if (discountManagementTitle) {
          discountManagementTitle.textContent = t.discountManagement;
        }
        
        // Update discount code input label
        const discountCodeInputLabel = document.querySelector('label[for="discount-code-input"]');
        if (discountCodeInputLabel) {
          discountCodeInputLabel.textContent = t.discountCode;
        }
        
        // Update discount percentage label
        const discountPercentLabel = document.querySelector('label[for="discount-percent"]');
        if (discountPercentLabel) {
          discountPercentLabel.textContent = t.discountPercentage;
        }
        
        // Update create discount button
        const applyDiscountBtn = document.getElementById('apply-discount-btn');
        if (applyDiscountBtn) {
          applyDiscountBtn.textContent = t.createDiscount;
        }
      }
      
      // Apply RTL for Arabic
      document.body.classList.toggle('rtl', currentLanguage === 'ar');
      
      // Update main category buttons
      const allMainCategoryBtn = document.getElementById('all-main-category-btn');
      const foodMainCategoryBtn = document.getElementById('food-main-category-btn');
      const drinksMainCategoryBtn = document.getElementById('drinks-main-category-btn');
      const dessertsMainCategoryBtn = document.getElementById('desserts-main-category-btn');
      
      if (allMainCategoryBtn) {
        const allBtn = allMainCategoryBtn.querySelector('span');
        if (allBtn) allBtn.textContent = currentLanguage === 'ar' ? 'Ø§Ù„ÙƒÙ„' : 'All';
      }
      if (foodMainCategoryBtn) {
        const foodBtn = foodMainCategoryBtn.querySelector('span');
        if (foodBtn) foodBtn.textContent = currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ø¹Ø§Ù…' : 'Food';
      }
      if (drinksMainCategoryBtn) {
        const drinksBtn = drinksMainCategoryBtn.querySelector('span');
        if (drinksBtn) drinksBtn.textContent = currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª' : 'Drinks';
      }
      if (dessertsMainCategoryBtn) {
        const dessertsBtn = dessertsMainCategoryBtn.querySelector('span');
        if (dessertsBtn) dessertsBtn.textContent = currentLanguage === 'ar' ? 'Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª' : 'Desserts';
      }
      
      // Update subcategory labels
      const foodSubcategoryLabel = document.querySelector('#food-subcategories .subcategory-label');
      const drinksSubcategoryLabel = document.querySelector('#drinks-subcategories .subcategory-label');
      const dessertsSubcategoryLabel = document.querySelector('#desserts-subcategories .subcategory-label');
      
      if (foodSubcategoryLabel) foodSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø·Ø¹Ø§Ù…' : 'Food Types';
      if (drinksSubcategoryLabel) drinksSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª' : 'Beverage Types';
      if (dessertsSubcategoryLabel) dessertsSubcategoryLabel.textContent = currentLanguage === 'ar' ? 'Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª' : 'Dessert Types';

      // Update food subcategory buttons
      const allFoodBtn = document.getElementById('all-food-btn');
      const pizzaCategoryBtn = document.getElementById('pizza-category-btn');
      const pastaCategoryBtn = document.getElementById('pasta-category-btn');
      const saladsCategoryBtn = document.getElementById('salads-category-btn');
      const burgersCategoryBtn = document.getElementById('burgers-category-btn');
      
      if (allFoodBtn) allFoodBtn.textContent = currentLanguage === 'ar' ? 'ÙƒÙ„ Ø§Ù„Ø·Ø¹Ø§Ù…' : 'All Food';
      if (pizzaCategoryBtn) pizzaCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø¨ÙŠØªØ²Ø§' : 'Pizza';
      if (pastaCategoryBtn) pastaCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø¨Ø§Ø³ØªØ§' : 'Pasta';
      if (saladsCategoryBtn) saladsCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø³Ù„Ø·Ø§Øª' : 'Salads';
      if (burgersCategoryBtn) burgersCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø¨Ø±Ø¬Ø±' : 'Burgers';
      
      // Update drinks subcategory buttons
      const allDrinksBtn = document.getElementById('all-drinks-btn');
      const hotDrinksCategoryBtn = document.getElementById('hot-drinks-category-btn');
      const coldDrinksCategoryBtn = document.getElementById('cold-drinks-category-btn');
      const smoothiesCategoryBtn = document.getElementById('smoothies-category-btn');
      
      if (allDrinksBtn) allDrinksBtn.textContent = currentLanguage === 'ar' ? 'ÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª' : 'All Drinks';
      if (hotDrinksCategoryBtn) hotDrinksCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©' : 'Hot Drinks';
      if (coldDrinksCategoryBtn) coldDrinksCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©' : 'Cold Drinks';
      if (smoothiesCategoryBtn) smoothiesCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø¹ØµØ§Ø¦Ø±' : 'Smoothies';
      
      // Update desserts subcategory buttons
      const allDessertsBtn = document.getElementById('all-desserts-btn');
      const cakesCategoryBtn = document.getElementById('cakes-category-btn');
      const iceCreamCategoryBtn = document.getElementById('ice-cream-category-btn');
      
      if (allDessertsBtn) allDessertsBtn.textContent = currentLanguage === 'ar' ? 'ÙƒÙ„ Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª' : 'All Desserts';
      if (cakesCategoryBtn) cakesCategoryBtn.textContent = currentLanguage === 'ar' ? 'ÙƒÙŠÙƒ' : 'Cakes';
      if (iceCreamCategoryBtn) iceCreamCategoryBtn.textContent = currentLanguage === 'ar' ? 'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…' : 'Ice Cream';
      
      // Also update the current food item in case it has translations
      updateFoodDisplay();
      
      // Update table input placeholder
      tableNumberInput.placeholder = currentLanguage === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Enter table number';
      
      // Update special instructions placeholder
      itemNotes.placeholder = currentLanguage === 'ar' ? 'Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ©...' : 'Any special requests...';
    }
    
    // Food catalog display
    // Model cache for preloaded models
    const modelCache = {};
    
    // Preload all 3D models
    function preloadModels() {
      // Removed notification popups during loading as they were confusing users
      
      foodItems.forEach(item => {
        const modelSrc = item.modelSrc;
        if (!modelCache[modelSrc]) {
          // Create a new hidden model-viewer for preloading
          const tempModelViewer = document.createElement('model-viewer');
          tempModelViewer.style.position = 'absolute';
          tempModelViewer.style.opacity = '0';
          tempModelViewer.style.pointerEvents = 'none';
          tempModelViewer.style.width = '1px';
          tempModelViewer.style.height = '1px';
          tempModelViewer.src = modelSrc;
          tempModelViewer.loading = 'eager';
          tempModelViewer.reveal = 'interaction';
          tempModelViewer.preload = true;
          
          document.body.appendChild(tempModelViewer);
          
          // Store in cache
          modelCache[modelSrc] = {
            loaded: false,
            element: tempModelViewer
          };
          
          // Listen for the load event
          tempModelViewer.addEventListener('load', () => {
            modelCache[modelSrc].loaded = true;
            console.log(`Model ${modelSrc} preloaded successfully`);
          });
        }
      });
    }
    
    // Main category selection
    function changeMainCategory(mainCategory) {
      // Update active button in main categories
      document.querySelectorAll('.main-category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.main-category-btn[data-maincategory="${mainCategory}"]`).classList.add('active');
      
      // Hide all subcategory groups first
      document.querySelectorAll('.subcategory-group').forEach(group => {
        group.style.display = 'none';
      });
      
      // Hide the sub-categories container completely when "All" is selected
      const subCategoriesContainer = document.getElementById('sub-categories');
      if (mainCategory === 'all') {
        // If "All" is selected, hide the subcategories section
        subCategoriesContainer.style.display = 'none';
        currentCategory = 'all';
        currentMainCategory = 'all';
        filterFoodItems();
        updateFoodDisplay();
      } else {
        // Show the subcategories container
        subCategoriesContainer.style.display = 'block';
        
        // Show corresponding subcategory group
        const subcategoryGroup = document.getElementById(`${mainCategory}-subcategories`);
        if (subcategoryGroup) {
          subcategoryGroup.style.display = 'flex';
          
          // Set default subcategory as "All [MainCategory]"
          currentMainCategory = mainCategory;
          currentCategory = `all-${mainCategory}`;
          
          // Update active button in subcategory
          document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          document.querySelector(`.category-btn[data-category="all-${mainCategory}"]`).classList.add('active');
          
          // Filter items and update display
          filterFoodItems();
          updateFoodDisplay();
        }
      }
    }
    
    // Subcategory selection
    function changeCategory(category) {
      // Update active button in subcategories
      const parentGroup = document.querySelector(`.category-btn[data-category="${category}"]`).closest('.subcategory-group');
      
      if (parentGroup) {
        parentGroup.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      } else {
        // Fallback for when category structure is simple
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
      
      document.querySelector(`.category-btn[data-category="${category}"]`).classList.add('active');
      
      // Set current category and reset index
      currentCategory = category;
      currentFoodIndex = 0;
      
      // Filter and update display
      filterFoodItems();
      updateFoodDisplay();
    }
    
    // Filter food items based on categories
    function filterFoodItems() {
      if (currentCategory === 'all') {
        // Show all items
        filteredFoodItems = [...foodItems];
      } else if (currentCategory.startsWith('all-')) {
        // Show all items from a main category (e.g., "all-food")
        const mainCat = currentCategory.replace('all-', '');
        
        if (mainCat === 'food') {
          // For food category, include pizza, pasta, salads, burgers
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'pizza' || 
            item.category === 'pasta' || 
            item.category === 'salads' || 
            item.category === 'burgers');
        } else if (mainCat === 'drinks') {
          // For drinks category, include hot-drinks, cold-drinks, smoothies
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'hot-drinks' || 
            item.category === 'cold-drinks' || 
            item.category === 'smoothies' ||
            item.category === 'drinks');
        } else if (mainCat === 'desserts') {
          // For dessert category, include cakes, ice-cream
          filteredFoodItems = foodItems.filter(item => 
            item.category === 'cakes' || 
            item.category === 'ice-cream' ||
            item.category === 'desserts');
        } else {
          // Fallback to simple filtering by the main category
          filteredFoodItems = foodItems.filter(item => item.category === mainCat);
        }
      } else {
        // Filter by specific subcategory
        filteredFoodItems = foodItems.filter(item => item.category === currentCategory);
      }
      
      // Reset index if it's out of bounds for the filtered items
      if (currentFoodIndex >= filteredFoodItems.length) {
        currentFoodIndex = 0;
      }
      
      return filteredFoodItems;
    }
    
    function updateFoodDisplay() {
      // Make sure we have filtered items
      if (filteredFoodItems.length === 0) {
        filterFoodItems();
      }
      
      const item = filteredFoodItems[currentFoodIndex];
      const modelLoadingIndicator = document.getElementById('model-loading-indicator');
      
      // Show loading indicator
      modelLoadingIndicator.style.display = 'flex';
      
      // Update text content first (for perceived speed)
      // Use Arabic name and description if available and language is Arabic
      foodName.textContent = (currentLanguage === 'ar' && item.nameAr) ? item.nameAr : item.name;
      foodDescription.textContent = (currentLanguage === 'ar' && item.descriptionAr) ? item.descriptionAr : item.description;
      
      // Format price according to language
      if (currentLanguage === 'ar') {
        foodPrice.textContent = `Ø§Ù„Ø³Ø¹Ø±: ${item.price.toFixed(2)} $`;
      } else {
        foodPrice.textContent = `Price: $${item.price.toFixed(2)}`;
      }
      
      // Use cached model if available, otherwise load directly
      if (modelCache[item.modelSrc] && modelCache[item.modelSrc].loaded) {
        console.log(`Using cached model for ${item.name}`);
        modelViewer.src = item.modelSrc;
        
        // Hide loading indicator after a short delay for smoother transition
        setTimeout(() => {
          modelLoadingIndicator.style.display = 'none';
        }, 300);
      } else {
        console.log(`Loading model for ${item.name}`);
        modelViewer.src = item.modelSrc;
        
        // Add event listener to hide loading indicator when model is loaded
        const onLoad = () => {
          modelLoadingIndicator.style.display = 'none';
          modelViewer.removeEventListener('load', onLoad);
          
          // Add to cache if not already there
          if (!modelCache[item.modelSrc]) {
            modelCache[item.modelSrc] = {
              loaded: true,
              element: modelViewer
            };
          } else {
            modelCache[item.modelSrc].loaded = true;
          }
        };
        
        modelViewer.addEventListener('load', onLoad);
      }
      
      // Clear existing extras
      extrasSelect.innerHTML = '';
      
      // Add default "No extras" option
      const noExtrasOption = document.createElement('option');
      noExtrasOption.value = '';
      noExtrasOption.textContent = currentLanguage === 'ar' ? 'Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ§Øª' : 'No extras';
      extrasSelect.appendChild(noExtrasOption);
      
      // Add dynamic extras based on food category
      if (item.category === 'pizza') {
        const extras = [
          { value: 'extra_cheese', text: currentLanguage === 'ar' ? 'Ø¬Ø¨Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ© (+$2.00)' : 'Extra Cheese (+$2.00)' },
          { value: 'extra_toppings', text: currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© (+$3.00)' : 'Extra Toppings (+$3.00)' },
          { value: 'garlic_bread', text: currentLanguage === 'ar' ? 'Ø®Ø¨Ø² Ø¨Ø§Ù„Ø«ÙˆÙ… (+$4.00)' : 'Garlic Bread Side (+$4.00)' }
        ];
        
        extras.forEach(extra => {
          const option = document.createElement('option');
          option.value = extra.value;
          option.textContent = extra.text;
          extrasSelect.appendChild(option);
        });
      } else if (item.category === 'pasta') {
        const extras = [
          { value: 'extra_sauce', text: currentLanguage === 'ar' ? 'ØµÙ„ØµØ© Ø¥Ø¶Ø§ÙÙŠØ© (+$1.50)' : 'Extra Sauce (+$1.50)' },
          { value: 'garlic_bread', text: currentLanguage === 'ar' ? 'Ø®Ø¨Ø² Ø¨Ø§Ù„Ø«ÙˆÙ… (+$4.00)' : 'Garlic Bread Side (+$4.00)' },
          { value: 'parmesan', text: currentLanguage === 'ar' ? 'Ø¬Ø¨Ù†Ø© Ø¨Ø§Ø±Ù…ÙŠØ²Ø§Ù† Ø¥Ø¶Ø§ÙÙŠØ© (+$2.00)' : 'Extra Parmesan (+$2.00)' }
        ];
        
        extras.forEach(extra => {
          const option = document.createElement('option');
          option.value = extra.value;
          option.textContent = extra.text;
          extrasSelect.appendChild(option);
        });
      }
      
      // Clear any previous notes
      itemNotes.value = '';
    }
    
    function showPreviousItem() {
      currentFoodIndex = (currentFoodIndex - 1 + filteredFoodItems.length) % filteredFoodItems.length;
      updateFoodDisplay();
    }
    
    function showNextItem() {
      currentFoodIndex = (currentFoodIndex + 1) % filteredFoodItems.length;
      updateFoodDisplay();
    }
    
    // Cart System
    function addToCart() {
      // If no table number set, show modal with a clear message
      if (userType === "guest" && !tableNumber) {
        // Show notification to explain the user needs to enter a table number
        showNotification(
          currentLanguage === 'ar' 
            ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚' 
            : 'Please enter your table number to add items to cart', 
          'warning'
        );
        
        setTimeout(() => {
          // Show table modal with a flag to show extended message
          showTableModal(true);
        }, 500);
        return;
      }
      
      const item = filteredFoodItems[currentFoodIndex];
      
      // Get selected extras
      const extraOption = extrasSelect.value;
      let extrasCost = 0;
      let extrasLabel = '';
      
      if (extraOption === 'extra_cheese' || extraOption === 'parmesan') {
        extrasCost = 2.00;
        extrasLabel = currentLanguage === 'ar' ? 'Ø¬Ø¨Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ©' : 'Extra Cheese';
      } else if (extraOption === 'extra_toppings') {
        extrasCost = 3.00;
        extrasLabel = currentLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©' : 'Extra Toppings';
      } else if (extraOption === 'garlic_bread') {
        extrasCost = 4.00;
        extrasLabel = currentLanguage === 'ar' ? 'Ø®Ø¨Ø² Ø¨Ø§Ù„Ø«ÙˆÙ…' : 'Garlic Bread Side';
      } else if (extraOption === 'extra_sauce') {
        extrasCost = 1.50;
        extrasLabel = currentLanguage === 'ar' ? 'ØµÙ„ØµØ© Ø¥Ø¶Ø§ÙÙŠØ©' : 'Extra Sauce';
      }
      
      // Get notes
      const notes = itemNotes.value.trim();
      
      const cartItem = {
        name: item.name,
        price: item.price,
        extras: extraOption ? extrasLabel : null,
        extrasCost: extrasCost,
        notes: notes,
        totalPrice: item.price + extrasCost
      };
      
      cart.push(cartItem);
      updateCartDisplay();
      
      // Verify the checkout button is enabled
      checkoutBtn.disabled = false;
      
      // Show confirmation notification
      showNotification(
        currentLanguage === 'ar' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'Added to Cart',
        currentLanguage === 'ar' ? `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${item.name} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚` : `${item.name} has been added to your cart`,
        'success'
      );
    }
    
    function updateCartDisplay() {
      // Update cart count
      cartCount.textContent = cart.length;
      
      // Clear cart items
      cartItems.innerHTML = '';
      
      // Calculate total
      let subtotal = 0;
      
      // Generate cart item elements
      cart.forEach((item, index) => {
        subtotal += item.totalPrice;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        
        const itemName = document.createElement('div');
        itemName.className = 'item-name';
        
        let nameText = item.name;
        if (item.extras) {
          nameText += ` (${item.extras})`;
        }
        if (item.notes) {
          nameText += `<br><small>${item.notes}</small>`;
        }
        
        itemName.innerHTML = nameText;
        
        const itemPrice = document.createElement('div');
        itemPrice.className = 'item-price';
        itemPrice.textContent = `$${item.totalPrice.toFixed(2)}`;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-item';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeCartItem(index);
        
        cartItem.appendChild(itemName);
        cartItem.appendChild(itemPrice);
        cartItem.appendChild(removeBtn);
        
        cartItems.appendChild(cartItem);
      });
      
      // Calculate tax (assuming 8%)
      const tax = subtotal * 0.08;
      
      // Calculate total
      const total = subtotal + tax;
      
      // Update total breakdown
      totalBreakdown.innerHTML = `
        <p style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>${currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ' : 'Subtotal'}</span>
          <span>$${subtotal.toFixed(2)}</span>
        </p>
        <p style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>${currentLanguage === 'ar' ? 'Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (8%)' : 'Tax (8%)'}</span>
          <span>$${tax.toFixed(2)}</span>
        </p>
        <p style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
          <span>${currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}</span>
          <span>$${total.toFixed(2)}</span>
        </p>
      `;
      
      // Disable checkout if cart is empty
      checkoutBtn.disabled = cart.length === 0;
    }
    
    function removeCartItem(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }
    
    function toggleCart() {
      cartPanel.classList.toggle('active');
    }
    
    // Authentication
    function showLoginModal() {
      // Clear previous values
      username.value = '';
      password.value = '';
      
      // Show the modal with a fade-in effect
      loginModal.style.opacity = '0';
      loginModal.style.display = 'flex';
      
      // Apply fade-in animation
      setTimeout(() => {
        loginModal.style.opacity = '1';
      }, 50);
      
      // Set focus to username field after a short delay
      setTimeout(() => {
        username.focus();
      }, 300);
    }
    
    function closeModal() {
      // Fade out effect
      loginModal.style.opacity = '0';
      
      // Hide after animation completes
      setTimeout(() => {
        loginModal.style.display = 'none';
        loginModal.style.opacity = '1'; // Reset for next time
      }, 300);
    }
    
    // Initialize staff and admin accounts
    const accounts = [
      { username: 'admin', name: 'Restaurant Administrator', password: '123456', role: 'admin' },
      { username: 'ahmad', name: 'Ahmad Mohammed', password: '123456', role: 'manager' },
      { username: 'john', name: 'John Smith', password: '123456', role: 'chef' },
      { username: 'sarah', name: 'Sarah Johnson', password: '123456', role: 'server' },
      { username: 'staff', name: 'General Staff', password: '123456', role: 'staff' }
    ];
    
    // Initialize table assignments
    const tableAssignments = [
      { staffUsername: 'sarah', startTable: 1, endTable: 20 },
      { staffUsername: 'john', startTable: 21, endTable: 40 },
      { staffUsername: 'staff', startTable: 41, endTable: 60 }
    ];
    
    // Helper function to get staff assigned to a specific table
    function getStaffForTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      const assignment = tableAssignments.find(a => 
        tableNumber >= a.startTable && tableNumber <= a.endTable
      );
      
      if (!assignment) return null;
      
      // Get staff details from accounts
      const staffMember = accounts.find(acc => acc.username === assignment.staffUsername);
      if (!staffMember) return null;
      
      return {
        name: staffMember.name || staffMember.username,
        role: staffMember.role || 'staff',
        username: staffMember.username
      };
    }
    
    // Function to create orders with proper Firebase integration
    async function createOrderInFirebase(orderData) {
      if (!orderData || !orderData.tableNumber) {
        console.error("Invalid order data for Firebase");
        return null;
      }
      
      try {
        // Minimal logging to improve performance
        console.log("Creating order for table:", orderData.tableNumber);
        
        // Check database connection first
        if (!db || typeof db.collection !== 'function') {
          console.error("Firebase database not initialized");
          throw new Error("Database not connected");
        }
        
        // Ensure table number is an integer
        const tableNumber = parseInt(orderData.tableNumber);
        if (isNaN(tableNumber)) {
          console.error("Invalid table number in order data:", orderData.tableNumber);
          throw new Error("Invalid table number");
        }
        orderData.tableNumber = tableNumber;
        
        // Get assigned staff for this table
        const assignedStaff = getStaffForTable(tableNumber);
        if (assignedStaff) {
          console.log(`Table ${tableNumber} is assigned to staff member: ${assignedStaff.name} (${assignedStaff.role})`);
          
          // Add staff information to order
          orderData.assignedStaff = {
            name: assignedStaff.name,
            username: assignedStaff.username,
            role: assignedStaff.role
          };
        } else {
          console.log(`No staff assigned to table ${tableNumber}`);
        }
        
        // Add timestamps
        if (firebase && firebase.firestore) {
          orderData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          orderData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
          // Fallback for offline mode
          orderData.createdAt = new Date();
          orderData.updatedAt = new Date();
        }
        
        let orderId;
        
        // Check if we're in offline/demo mode
        if (isOfflineMode || !db || typeof db.collection !== 'function') {
          console.log("In offline mode, creating order locally");
          // Generate a random ID for the order in offline mode
          orderId = 'offline-' + Math.floor(Math.random() * 1000000);
        } else {
          // Add to Firebase with improved error handling
          try {
            // First, try to check if the table is still available
            const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
            const tableStatus = await tableStatusRef.get();
            
            // If the table is already marked as occupied in Firebase, we may want to warn the user
            if (tableStatus.exists && tableStatus.data().status === 'occupied') {
              console.warn(`Table ${tableNumber} is already marked as occupied in Firebase. Continuing anyway.`);
            }
            
            // Prepare a batched write to update both the order and table status atomically
            const batch = db.batch();
            
            // Create new order document
            const orderRef = db.collection('orders').doc();
            batch.set(orderRef, orderData);
            
            // Update table status to occupied
            batch.set(tableStatusRef, {
              status: 'occupied',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              orderId: orderRef.id,
              updatedBy: {
                username: orderData.assignedStaff?.username || 'system',
                role: orderData.assignedStaff?.role || 'system'
              }
            });
            
            // Commit the batch
            await batch.commit();
            
            orderId = orderRef.id;
            console.log("Order created successfully with ID:", orderId);
            
          } catch (dbError) {
            console.error("Firebase error creating order:", dbError);
            
            // Try a simpler approach - just add the order without the batch
            try {
              console.log("Trying fallback approach - adding order without batch");
              const docRef = await db.collection('orders').add(orderData);
              orderId = docRef.id;
              console.log("Order created via fallback with ID:", orderId);
            } catch (fallbackError) {
              console.error("Even fallback order creation failed:", fallbackError);
              // Ultimate fallback - create order ID locally
              orderId = 'fallback-' + Math.floor(Math.random() * 1000000);
              console.log("Using local fallback order ID:", orderId);
            }
          }
        }
        
        // Update local tables data regardless of Firebase status
        occupiedTables.add(tableNumber);
        
        // Prepare order for table details
        const orderForTable = {
          id: orderId,
          status: orderData.status,
          items: orderData.items,
          timestamp: new Date(),
          total: orderData.total,
          assignedStaff: orderData.assignedStaff
        };
        
        // Update table details
        if (!tableDetails[tableNumber]) {
          tableDetails[tableNumber] = { orders: [] };
        }
        
        // Add to beginning of orders array
        tableDetails[tableNumber].orders.unshift(orderForTable);
        
        // Update staff view if needed
        if (userType === 'staff' || userType === 'admin') {
          updateTablesDisplay();
        }
        
        return orderId;
      } catch (error) {
        console.error("Error creating order in Firebase:", error);
        // Last resort fallback - generate a local ID
        const fallbackId = 'error-' + Math.floor(Math.random() * 1000000);
        console.log("Using fallback order ID:", fallbackId);
        return fallbackId;
      }
    }
    
    function loginUser() {
      const user = username.value;
      const pass = password.value;
      
      console.log("Login attempt:", user);
      
      // Find user in accounts array
      const account = accounts.find(acc => acc.username === user && acc.password === pass);
      
      if (!account) {
        showNotification(
          currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Login Error',
          currentLanguage === 'ar' 
            ? "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" 
            : "Invalid username or password",
          'error'
        );
        return;
      }
      
      // Handle different account types (admin vs staff)
      if (account.role === 'admin') {
        userType = "admin";
        localStorage.setItem(USER_TYPE_KEY, "admin");
        localStorage.setItem(ADMIN_TOKEN, "true");
        localStorage.setItem("adminName", account.name);
        closeModal();
        checkAuthState();
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Successfully Logged In',
          currentLanguage === 'ar' 
            ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„" 
            : "Logged in as Administrator",
          'success'
        );
      } else {
        userType = "staff";
        localStorage.setItem(USER_TYPE_KEY, "staff");
        localStorage.setItem(STAFF_TOKEN, "true");
        localStorage.setItem("staffName", account.name);
        localStorage.setItem("staffRole", account.role);
        localStorage.setItem("username", account.username);  // Store username for table assignment lookups
        closeModal();
        checkAuthState();
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Successfully Logged In',
          currentLanguage === 'ar' 
            ? `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€ ${account.name}`
            : `Logged in as ${account.name} (${account.role})`,
          'success'
        );
      }
    }
    
    function checkAuthState() {
      console.log("Checking auth state. Current userType:", userType);
      console.log("Staff token:", localStorage.getItem(STAFF_TOKEN));
      console.log("Admin token:", localStorage.getItem(ADMIN_TOKEN));
      
      // Reset UI
      guestBtn.classList.remove('active');
      const staffLoginBtn = document.getElementById('staff-login-btn');
      if (staffLoginBtn) staffLoginBtn.classList.remove('active');
      
      // Hide all views
      guestView.style.display = 'none';
      staffDashboard.style.display = 'none';
      adminDashboard.style.display = 'none';
      
      // Update login button text based on auth state
      if (staffLoginBtn) {
        if (localStorage.getItem(STAFF_TOKEN) || localStorage.getItem(ADMIN_TOKEN)) {
          // If logged in, show the user type
          staffLoginBtn.textContent = localStorage.getItem(ADMIN_TOKEN) ? 'ADMIN' : 'STAFF';
        } else {
          // If not logged in, show "LOGIN"
          staffLoginBtn.textContent = currentLanguage === 'ar' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'LOGIN';
        }
      }
      
      // Show appropriate view
      if (userType === "guest") {
        guestBtn.classList.add('active');
        guestView.style.display = 'block';
      } else if (userType === "staff") {
        if (staffLoginBtn) staffLoginBtn.classList.add('active');
        staffDashboard.style.display = 'block';
        
        // Display staff name and role from localStorage
        const staffNameDisplay = document.getElementById('staff-name-display');
        const staffRoleBadge = document.getElementById('staff-role-badge');
        
        if (staffNameDisplay && staffRoleBadge) {
          const staffName = localStorage.getItem('staffName') || 'Staff Member';
          const staffRole = localStorage.getItem('staffRole') || 'staff';
          
          staffNameDisplay.textContent = staffName;
          staffRoleBadge.textContent = staffRole;
          
          // Add color coding based on role
          staffRoleBadge.className = '';
          staffRoleBadge.classList.add('role-' + staffRole.toLowerCase());
        }
        
        renderOrders();
        renderTablesOverview();
      } else if (userType === "admin") {
        if (staffLoginBtn) staffLoginBtn.classList.add('active');
        adminDashboard.style.display = 'block';
        
        // Display admin name if available
        const adminName = localStorage.getItem('adminName') || 'Administrator';
        
        // Update admin dashboard title to include name
        const adminDashboardTitle = document.getElementById('admin-dashboard-title');
        if (adminDashboardTitle) {
          adminDashboardTitle.innerHTML = `ADMIN DASHBOARD <span class="admin-name">${adminName}</span>`;
        }
        
        renderAdminDashboard();
      }
    }
    
    function switchUserType(type) {
      // If user already authenticated as staff or admin, switch to that view
      if (type === "staff" && localStorage.getItem(STAFF_TOKEN)) {
        userType = "staff";
        localStorage.setItem(USER_TYPE_KEY, "staff");
        checkAuthState();
        return;
      }
      
      if (type === "admin" && localStorage.getItem(ADMIN_TOKEN)) {
        userType = "admin";
        localStorage.setItem(USER_TYPE_KEY, "admin");
        checkAuthState();
        return;
      }
      
      // For guest view
      if (type === "guest") {
        userType = "guest";
        localStorage.setItem(USER_TYPE_KEY, "guest");
        checkAuthState();
        return;
      }
      
      // If clicked on login button, show the unified login modal
      showLoginModal();
    }
    
    // Load table number if valid
    function showTableModal(fromCartAction = false) {
      tableNumberModal.style.display = 'flex';
      
      // Enhanced message if coming from cart action
      if (fromCartAction) {
        const tableNumberTitle = document.getElementById('table-number-title');
        if (tableNumberTitle) {
          tableNumberTitle.innerHTML = currentLanguage === 'ar' 
            ? '<strong>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</strong>' 
            : '<strong>Enter Table Number to Complete Order</strong>';
        }
        
        // Show input field immediately when called from cart
        document.querySelector('.user-option-buttons').style.display = 'none';
        tableNumberInputContainer.style.display = 'block';
        
        // Add a back button to cancel table input and return to order
        const tableActionButtons = document.querySelector('.table-action-buttons');
        
        // Update button text to make it clearer
        if (tableActionButtons) {
          const confirmButton = document.getElementById('confirm-table-btn');
          const cancelButton = document.getElementById('cancel-table-btn');
          
          if (confirmButton) {
            confirmButton.textContent = currentLanguage === 'ar' ? 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨' : 'CONFIRM & PLACE ORDER';
          }
          
          if (cancelButton) {
            cancelButton.textContent = currentLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡ ÙˆØ¹ÙˆØ¯Ø©' : 'CANCEL & GO BACK';
            cancelButton.style.display = 'inline-block';
          }
        }
        
        // Focus the input field
        setTimeout(() => {
          tableNumberInput.focus();
        }, 100);
      } else {
        // Reset the input container (hidden initially)
        tableNumberInputContainer.style.display = 'none';
      }
      
      // Check if staff login is active
      const staffBypassSection = document.getElementById('staff-bypass-section');
      const staffToken = localStorage.getItem(STAFF_TOKEN);
      const adminToken = localStorage.getItem(ADMIN_TOKEN);
      
      if (staffToken || adminToken) {
        // Show staff bypass option
        staffBypassSection.style.display = 'block';
      } else {
        // Hide staff bypass for regular users
        staffBypassSection.style.display = 'none';
      }
    }
    
    // This function is redefined below
    
    function bypassTableSelection() {
      // Set user type to staff/admin if not already
      if (userType !== 'staff' && userType !== 'admin') {
        userType = localStorage.getItem(STAFF_TOKEN) ? 'staff' : 'admin';
        localStorage.setItem(USER_TYPE_KEY, userType);
      }
      
      // Close the table modal
      closeTableModal();
      
      // Show success notification
      showNotification(
        currentLanguage === 'ar' ? 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Selection Bypassed',
        currentLanguage === 'ar' 
          ? 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….' 
          : 'Table selection bypassed successfully. You can now access the dashboard.',
        'success'
      );
      
      // Update UI to reflect staff/admin mode
      checkAuthState();
    }
    
    function showGuestOption() {
      // Show the table number input when guest option is selected and hide the option buttons
      document.querySelector('.user-option-buttons').style.display = 'none';
      tableNumberInputContainer.style.display = 'block';
      
      // Animate the appearance with a slight delay
      setTimeout(() => {
        tableNumberInput.focus();
        
        // Clear the availability indicator
        const availabilityIndicator = document.getElementById('table-availability-indicator');
        availabilityIndicator.innerHTML = '';
        availabilityIndicator.className = 'table-availability-indicator';
        
        // Scroll to the input if needed
        tableNumberInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
      
      // Add real-time table availability check
      tableNumberInput.addEventListener('input', checkTableAvailabilityRealtime);
    }
    
    // Real-time table availability check as the user types
    async function checkTableAvailabilityRealtime() {
      const tableNumberInt = parseInt(tableNumberInput.value, 10);
      const availabilityIndicator = document.getElementById('table-availability-indicator');
      
      // Clear the indicator if input is empty or invalid
      if (isNaN(tableNumberInt) || tableNumberInt <= 0) {
        availabilityIndicator.innerHTML = '';
        availabilityIndicator.className = 'table-availability-indicator';
        return;
      }
      
      // Show checking message
      availabilityIndicator.className = 'table-availability-indicator';
      availabilityIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
      
      // Check if table is available
      const isAvailable = await checkTableAvailability(tableNumberInt);
      
      if (isAvailable) {
        availabilityIndicator.className = 'table-availability-indicator available';
        availabilityIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Table available';
      } else {
        availabilityIndicator.className = 'table-availability-indicator occupied';
        availabilityIndicator.innerHTML = '<i class="fas fa-times-circle"></i> Table currently occupied';
      }
    }
    
    function handleStaffBypass() {
      // Add visual feedback for the click
      const staffOption = document.querySelector('.staff-option');
      staffOption.classList.add('staff-option-active');
      
      setTimeout(() => {
        staffOption.classList.remove('staff-option-active');
      }, 300);
      
      // Switch to staff view without entering table number
      if (localStorage.getItem(STAFF_TOKEN) === "true" || localStorage.getItem(ADMIN_TOKEN) === "true") {
        // If already authenticated as staff or admin
        const role = localStorage.getItem(ADMIN_TOKEN) === "true" ? "admin" : "staff";
        userType = role;
        localStorage.setItem(USER_TYPE_KEY, role);
        
        // Close modal with a slight delay to show the button animation
        setTimeout(() => {
          closeTableModal();
          checkAuthState();
          
          // Show feedback to user
          showNotification(
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ¬Ø§ÙˆØ²' : 'Staff Access',
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø§Ø¬Ø² Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table selection bypassed with staff credentials',
            'success'
          );
        }, 200);
      } else {
        // Need to authenticate first - show transition animation
        const tableContent = document.querySelector('.table-number-content');
        tableContent.style.opacity = '0';
        tableContent.style.transform = 'scale(0.95)';
        
        setTimeout(() => {
          closeTableModal();
          tableContent.style.opacity = '1';
          tableContent.style.transform = 'scale(1)';
          
          // Show login modal with focused username field
          showLoginModal();
          if (username) {
            setTimeout(() => username.focus(), 300);
          }
          
          // Show smaller notification that login is required
          showConnectionToast(
            currentLanguage === 'ar' 
              ? 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…ÙˆØ¸Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©' 
              : 'Please login with staff credentials to continue',
            'info'
          );
          
          // Set up a one-time post-login handler
          const originalLoginUser = loginUser;
          loginUser = function() {
            // Call the original function
            originalLoginUser();
            
            // Check if login was successful
            if (userType === "staff" || userType === "admin") {
              // Show success message for staff bypass
              showNotification(
                currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Login Successful',
                currentLanguage === 'ar' 
                  ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­' 
                  : 'You have successfully logged in with staff credentials',
                'success'
              );
            }
            
            // Restore the original function
            loginUser = originalLoginUser;
          };
        }, 200);
      }
    }
    
    function confirmTableNumber() {
      const tableNumberInt = parseInt(tableNumberInput.value, 10);
      const confirmBtn = document.getElementById('confirm-table-btn');
      
      // If staff option is selected, allow bypassing table number selection
      const isStaffOptionSelected = document.querySelector('.staff-option.staff-option-active');
      
      if ((isNaN(tableNumberInt) || tableNumberInt <= 0) && !isStaffOptionSelected) {
        showNotification(
          currentLanguage === 'ar' ? "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©" : "Invalid Table",
          currentLanguage === 'ar' ? "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø·Ø§ÙˆÙ„Ø© ØµØ­ÙŠØ­" : "Please enter a valid table number",
          'error'
        );
        
        // Shake the input to indicate error
        tableNumberInput.classList.add('input-error');
        setTimeout(() => {
          tableNumberInput.classList.remove('input-error');
        }, 600);
        
        return;
      }
      
      // Add loading effect to button
      const originalBtnContent = confirmBtn.innerHTML;
      confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>VERIFYING</span>';
      confirmBtn.disabled = true;
      
      // Check if the table is already occupied
      checkTableAvailability(tableNumberInt).then(isAvailable => {
        if (!isAvailable) {
          // Show error notification instead of alert
          showNotification(
            currentLanguage === 'ar' ? "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©" : "Table Unavailable",
            currentLanguage === 'ar' 
              ? `Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumberInt} Ù…Ø´ØºÙˆÙ„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰.`
              : `Table ${tableNumberInt} is occupied. Please choose another table.`,
            'error'
          );
          
          // Reset button
          confirmBtn.innerHTML = originalBtnContent;
          confirmBtn.disabled = false;
          
          // Focus the input for another try
          tableNumberInput.focus();
          return;
        }
        
        // Success animation
        confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> <span>CONFIRMED</span>';
        confirmBtn.style.background = 'linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%)';
        
        // Save table number with 1 hour expiry
        tableNumber = tableNumberInt;
        tableNumberExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour
        
        localStorage.setItem(TABLE_NUMBER_KEY, tableNumber.toString());
        localStorage.setItem(TABLE_EXPIRY_KEY, tableNumberExpiry.toString());
        
        // Check which staff member is assigned to this table
        const assignedStaff = getStaffForTable(tableNumberInt);
        
        // Store assigned staff information
        if (assignedStaff) {
          localStorage.setItem('assignedStaffName', assignedStaff.name);
          localStorage.setItem('assignedStaffUsername', assignedStaff.username);
          localStorage.setItem('assignedStaffRole', assignedStaff.role);
          console.log(`Table ${tableNumberInt} is assigned to ${assignedStaff.name} (${assignedStaff.role})`);
        } else {
          localStorage.removeItem('assignedStaffName');
          localStorage.removeItem('assignedStaffUsername');
          localStorage.removeItem('assignedStaffRole');
          console.log(`No staff assigned to table ${tableNumberInt}`);
        }
        
        // Close modal after a short delay to show success state
        setTimeout(() => {
          closeTableModal();
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? "ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø©" : "Table Assigned",
            currentLanguage === 'ar' 
              ? `ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumberInt} Ø¨Ù†Ø¬Ø§Ø­`
              : `You've been successfully assigned to Table ${tableNumberInt}`,
            'success'
          );
          
          // Reset button state for next use
          setTimeout(() => {
            confirmBtn.innerHTML = originalBtnContent;
            confirmBtn.style.background = '';
            confirmBtn.disabled = false;
          }, 500);
        }, 1000);
      });
    }
    
    // Check if a table is available
    async function checkTableAvailability(tableNum) {
      try {
        // Parse table number to ensure it's a number
        const tableNumInt = parseInt(tableNum);
        if (isNaN(tableNumInt)) {
          console.error("Invalid table number:", tableNum);
          return false;
        }
        
        // Check if table is already occupied in memory
        if (occupiedTables.has(tableNumInt)) {
          console.log(`Table ${tableNumInt} is already marked as occupied locally`);
          return false;
        }
        
        // Check if we are in offline/demo mode
        if (isOfflineMode || !db || typeof db.collection !== 'function') {
          console.log(`In offline mode, assuming table ${tableNumInt} is available`);
          return true;
        }
        
        // Double check with database
        console.log(`Checking Firebase for table ${tableNumInt} availability`);
        try {
          const querySnapshot = await db.collection("orders")
            .where("tableNumber", "==", tableNumInt)
            .where("status", "in", ["pending", "preparing", "ready"])
            .get();
          
          const isAvailable = querySnapshot.empty;
          console.log(`Table ${tableNumInt} is ${isAvailable ? 'available' : 'occupied'} according to Firebase`);
          return isAvailable;
        } catch (dbError) {
          console.error("Error querying Firebase for table availability:", dbError);
          // If we can't check the database, assume it's available to avoid blocking users
          return true;
        }
      } catch (error) {
        console.error("Error checking table availability:", error);
        return true; // Assume available if there's an error to avoid blocking users
      }
    }
    
    // Release a table (used when order is completed or cancelled)
    function releaseTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      console.log(`Attempting to release table ${tableNumber}`);
      
      if (isNaN(tableNumber)) {
        console.error('Invalid table number for release');
        return false;
      }
      
      // For non-staff/admin users, we need to verify they're authorized to release tables
      if (userType !== 'staff' && userType !== 'admin') {
        // Only allow guest to release a table if it's their table
        if (userType === 'guest' && tableNumber !== parseInt(tableNumber)) {
          console.error('Guests can only release their own table');
          return false;
        }
      } else {
        // For staff, check if they're authorized to manage this table
        // Check if this staff member is assigned to this table
        const currentStaffUsername = localStorage.getItem('username');
        const staffRole = localStorage.getItem('staffRole');
        
        let canManageTable = userType === 'admin'; // Admins can manage any table
        
        // Managers can manage any table too
        if (staffRole === 'manager') {
          canManageTable = true;
        }
        
        if (userType === 'staff' && currentStaffUsername && !canManageTable) {
          const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
          
          // Check if this table is in any of the assigned ranges
          canManageTable = staffAssignments.some(assignment => {
            return tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
          });
        }
        
        if (!canManageTable) {
          showNotification(
            currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' : 'Not Authorized',
            currentLanguage === 'ar' 
              ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ù…Ø®ØµØµØ© Ù„Ùƒ' 
              : 'You cannot manage this table as it is not assigned to you',
            'error'
          );
          return false;
        }
      }
      
      if (occupiedTables.has(tableNumber)) {
        // Show loading state in UI first to prevent lag appearance
        showNotification(
          currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'Updating',
          currentLanguage === 'ar' 
            ? 'Ø¬Ø§Ø±Ù ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø©...' 
            : 'Freeing table...',
          'info',
          2000 // Auto-close after 2s
        );
        
        // Remove from local tracking immediately for responsive UI
        occupiedTables.delete(tableNumber);
        
        // Remove table details if they exist
        if (tableDetails[tableNumber]) {
          delete tableDetails[tableNumber];
        }
        
        // Update UI immediately for responsive experience
        if (userType === 'staff' || userType === 'admin') {
          updateTablesDisplay();
          renderTablesOverview();
        }
        
        // If we have Firebase connection, perform the backend updates in background
        if (db && typeof db.collection === 'function') {
          // Use a batch operation for all Firebase updates to improve consistency
          const batch = db.batch();
          
          // First get all orders for this table, regardless of status
          return db.collection('orders')
            .where('tableNumber', '==', tableNumber)
            .get()
            .then((orderDocs) => {
              if (!orderDocs.empty) {
                console.log(`Found ${orderDocs.docs.length} orders for table ${tableNumber}`);
                
                // Categorize orders by status
                let pendingOrdersFound = false;
                
                orderDocs.forEach(doc => {
                  const orderData = doc.data();
                  console.log(`Processing order ${doc.id} with status: ${orderData.status}`);
                  
                  if (['pending', 'preparing', 'ready'].includes(orderData.status)) {
                    // For active orders, delete them completely instead of just marking as cancelled
                    // This helps prevent database clutter and improves performance
                    batch.delete(doc.ref);
                    pendingOrdersFound = true;
                    console.log(`Marked order ${doc.id} for deletion (active order)`);
                  } else if (orderData.status === 'completed') {
                    // Delete completed orders
                    batch.delete(doc.ref);
                    console.log(`Marked order ${doc.id} for deletion (completed order)`);
                  }
                });
                
                // Update table status
                const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
                batch.set(tableStatusRef, {
                  status: 'free',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedBy: {
                    username: localStorage.getItem('username') || 'system',
                    role: localStorage.getItem('staffRole') || 'system'
                  }
                });
                
                // Commit all changes in one batch
                return batch.commit().then(() => {
                  console.log('All Firebase updates completed for table release');
                  
                  // Only show a success notification if we actually canceled any pending orders
                  if (pendingOrdersFound) {
                    showNotification(
                      currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Orders Removed',
                      currentLanguage === 'ar' 
                        ? 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©' 
                        : 'All active orders were deleted',
                      'success'
                    );
                  }
                  return true;
                });
              } else {
                // Just update the table status if no orders found
                const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
                batch.set(tableStatusRef, {
                  status: 'free',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedBy: {
                    username: localStorage.getItem('username') || 'system',
                    role: localStorage.getItem('staffRole') || 'system'
                  }
                });
                
                return batch.commit().then(() => {
                  console.log('Table status updated in Firebase');
                  return true;
                });
              }
            })
            .catch((error) => {
              console.error('Error during table release:', error);
              
              // Show error but don't block UI
              showNotification(
                currentLanguage === 'ar' ? 'ØªØ­Ø°ÙŠØ±' : 'Warning',
                currentLanguage === 'ar' 
                  ? 'ØªÙ… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ„ÙƒÙ† Ù‚Ø¯ Ù„Ø§ ØªØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…'
                  : 'Table freed locally but changes may not sync with server',
                'warning'
              );
            });
        }
        
        return true;
      } else {
        console.log(`Table ${tableNumber} not found in occupied tables`);
        return false;
      }
    }
    
    function occupyTable(tableNum) {
      const tableNumber = parseInt(tableNum);
      
      if (!tableNumber || isNaN(tableNumber)) {
        console.error('Invalid table number');
        return false;
      }
      
      // Check if user is a staff member
      if (userType !== 'staff' && userType !== 'admin') {
        console.error('Only staff can mark tables as occupied');
        return false;
      }
      
      // Check if this staff member is assigned to this table
      const currentStaffUsername = localStorage.getItem('username');
      const staffRole = localStorage.getItem('staffRole');
      
      let canManageTable = userType === 'admin'; // Admins can manage any table
      
      // Managers can manage any table too
      if (staffRole === 'manager') {
        canManageTable = true;
      }
      
      if (userType === 'staff' && currentStaffUsername && !canManageTable) {
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        
        // Check if this table is in any of the assigned ranges
        canManageTable = staffAssignments.some(assignment => {
          return tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
        });
      }
      
      if (!canManageTable) {
        showNotification(
          currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' : 'Not Authorized',
          currentLanguage === 'ar' 
            ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ù…Ø®ØµØµØ© Ù„Ùƒ' 
            : 'You cannot manage this table as it is not assigned to you',
          'error'
        );
        return false;
      }
      
      // Show a notification to indicate the action is in progress
      showNotification(
        currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'Updating',
        currentLanguage === 'ar' 
          ? `Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber}...` 
          : `Updating table ${tableNumber} status...`,
        'info',
        1500 // Auto-close after 1.5 seconds
      );
      
      // Immediately update the UI for better responsiveness
      occupiedTables.add(tableNumber);
      
      // Initialize table details if they don't exist
      if (!tableDetails[tableNumber]) {
        tableDetails[tableNumber] = { orders: [] };
      }
      
      // Update UI immediately
      updateTablesDisplay();
      renderTablesOverview();
      
      // If the app is in Firebase mode, update the table status in Firebase
      if (db && typeof db.collection === 'function') {
        // Check first if the table is already marked as occupied in Firebase
        db.collection('tableStatus').doc(tableNumber.toString()).get()
          .then(doc => {
            // Create a batch for atomic updates
            const batch = db.batch();
            
            // Update the table status
            const tableStatusRef = db.collection('tableStatus').doc(tableNumber.toString());
            batch.set(tableStatusRef, {
              status: 'occupied',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: {
                username: currentStaffUsername || 'system',
                role: localStorage.getItem('staffRole') || 'system'
              }
            });
            
            // If the table was already occupied, we might want to check for existing orders
            if (doc.exists && doc.data().status === 'occupied') {
              // We'll just update the status without modifying any orders
              console.log(`Table ${tableNumber} was already marked as occupied in Firebase`);
            }
            
            // Commit all changes
            return batch.commit();
          })
          .then(() => {
            // Show success notification
            showNotification(
              currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Status Updated',
              currentLanguage === 'ar' 
                ? `ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber} ÙƒÙ…Ø´ØºÙˆÙ„Ø©` 
                : `Table ${tableNumber} is now marked as Occupied`,
              'success'
            );
          })
          .catch(error => {
            console.error('Error updating table status in Firebase:', error);
            
            // Show warning that the local state was updated but the server might be out of sync
            showNotification(
              currentLanguage === 'ar' ? 'ØªØ­Ø°ÙŠØ±' : 'Warning',
              currentLanguage === 'ar' 
                ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ„ÙƒÙ† Ù‚Ø¯ Ù„Ø§ ØªØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…'
                : 'Table marked as occupied locally but changes may not sync with server',
              'warning'
            );
          });
      } else {
        // If no Firebase, just show a success notification
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Status Updated',
          currentLanguage === 'ar' 
            ? `ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber} ÙƒÙ…Ø´ØºÙˆÙ„Ø©` 
            : `Table ${tableNumber} is now marked as Occupied`,
          'success'
        );
      }
      
      return true;
    }
    
    function closeTableModal(fromCancel = false) {
      // Fade out effect for smoother transition
      tableNumberModal.style.opacity = '0';
      
      // Reset UI elements after a short delay
      setTimeout(() => {
        tableNumberModal.style.display = 'none';
        tableNumberModal.style.opacity = '1'; // Reset opacity for next time
        
        // Reset input field and buttons
        tableNumberInput.value = '';
        
        // If this was called from cancel button in checkout flow, show feedback
        if (fromCancel) {
          showNotification(
            currentLanguage === 'ar' ? 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡' : 'Cancelled',
            currentLanguage === 'ar' ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table number entry cancelled',
            'info'
          );
        }
        
        // Reset button states
        const confirmButton = document.getElementById('confirm-table-btn');
        if (confirmButton) {
          confirmButton.textContent = currentLanguage === 'ar' ? 'ØªØ£ÙƒÙŠØ¯' : 'CONFIRM';
          confirmButton.disabled = false;
          confirmButton.style.background = '';
        }
      }, 300);
    }
    
    // Checkout
    async function checkout() {
      if (cart.length === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'Ø³Ù„Ø© ÙØ§Ø±ØºØ©' : 'Empty Cart',
          currentLanguage === 'ar' 
            ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ø¥Ù„Ù‰ Ø³Ù„ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹'
            : 'Please add items to your cart first',
          'info'
        );
        return;
      }
      
      // Verify table number exists
      if (!tableNumber) {
        showNotification(
          currentLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ø·Ù„ÙˆØ¨' : 'Table Number Required',
          currentLanguage === 'ar' 
            ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹'
            : 'Please enter your table number first',
          'warning'
        );
        
        // Show table number input modal
        setTimeout(() => {
          showTableModal(true);
        }, 500);
        return;
      }
      
      // Check if table is still available
      try {
        const isAvailable = await checkTableAvailability(tableNumber);
        if (!isAvailable) {
          // Table is occupied, show error and ask for new table
          showNotification(
            currentLanguage === 'ar' ? "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©" : "Table Unavailable",
            currentLanguage === 'ar' 
              ? `Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber} Ù…Ø´ØºÙˆÙ„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰.`
              : `Table ${tableNumber} is occupied. Please choose another table.`,
            'error'
          );
          
          // Show table modal after a slight delay
          setTimeout(() => {
            showTableModal(true);
          }, 500);
          return;
        }
      } catch (error) {
        console.error("Error checking table availability:", error);
        // Continue with order process - we'll let createOrderInFirebase handle table validation again
      }
      
      // Set checkout button to loading state with visual feedback
      checkoutBtn.classList.add('checkout-loading');
      checkoutBtn.disabled = true;
      
      try {
        // Calculate total
        let subtotal = 0;
        cart.forEach(item => {
          subtotal += item.totalPrice;
        });
        
        const tax = subtotal * 0.08;
        const total = subtotal + tax;
        
        // Prepare the order data
        const order = {
          clientId: clientId,
          items: JSON.parse(JSON.stringify(cart)), // Create deep copy to prevent mutation issues
          subtotal: subtotal,
          tax: tax,
          total: total,
          status: 'pending',
          tableNumber: tableNumber,
          estimatedTime: estimatedTime,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Show processing notification to improve perceived responsiveness
        showNotification(
          currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' : 'Processing',
          currentLanguage === 'ar' 
            ? 'Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ...' 
            : 'Processing your order...',
          'info',
          3000
        );
        
        // Create the order in Firebase
        const orderId = await createOrderInFirebase(order);
        
        if (!orderId) {
          // If order creation failed
          throw new Error("Failed to create order in Firebase");
        }
        
        // Mark table as occupied locally for immediate feedback
        occupiedTables.add(tableNumber);
        
        // Update estimated time for next order (kitchen load simulation)
        estimatedTime = Math.min(estimatedTime + 5, 60); // Increase by 5 mins, max 60
        updateEstimatedTime();
        
        // Show success notification
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­' : 'Order Placed',
          currentLanguage === 'ar' 
            ? `ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!` 
            : `Your order has been successfully placed!`,
          'success'
        );
        
        // Clear cart
        cart = [];
        updateCartDisplay();
        
        // Close cart panel
        toggleCart();
        
        // Auto show the client orders panel with a slight delay for better UX
        setTimeout(() => {
          clientOrders.classList.add('active');
          renderClientOrders();
        }, 800);
        
      } catch (error) {
        console.error('Error placing order:', error);
        // Show detailed error notification
        showNotification(
          currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨' : 'Order Error',
          currentLanguage === 'ar' 
            ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'
            : error.message || 'There was an error placing your order. Please try again.',
          'error'
        );
      } finally {
        // Reset checkout button state
        checkoutBtn.classList.remove('checkout-loading');
        checkoutBtn.disabled = false;
      }
    }
    
    function updateEstimatedTime() {
      estimatedTimeEl.textContent = `${estimatedTime} ${currentLanguage === 'ar' ? 'Ø¯Ù‚Ø§Ø¦Ù‚' : 'minutes'}`;
      staffEstimatedTimeEl.textContent = `${estimatedTime} ${currentLanguage === 'ar' ? 'Ø¯Ù‚Ø§Ø¦Ù‚' : 'minutes'}`;
    }
    
    // Order Management
    function setupOrderListeners() {
      // Listen for orders in real-time
      db.collection('orders')
        .onSnapshot((snapshot) => {
          // Track which tables are occupied
          const newOccupiedTables = new Set();
          const newTableDetails = {};
          
          snapshot.forEach(doc => {
            const orderData = doc.data();
            
            // We only care about current client's orders for the client view
            if (orderData.clientId === clientId) {
              // Render client orders if needed
              if (clientOrders.classList.contains('active')) {
                renderClientOrders();
              }
              
              // Show notifications for status changes
              if (orderData.status === 'preparing') {
                showNotification(
                  currentLanguage === 'ar' ? 'Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Order Preparing',
                  currentLanguage === 'ar' 
                    ? `Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… ${orderData.id} Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¢Ù†` 
                    : `Your order #${orderData.id} is now being prepared`,
                  'info'
                );
              } else if (orderData.status === 'ready') {
                showNotification(
                  currentLanguage === 'ar' ? 'Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø²' : 'Order Ready',
                  currentLanguage === 'ar' 
                    ? `Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… ${orderData.id} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…` 
                    : `Your order #${orderData.id} is ready for pickup`,
                  'success'
                );
              } else if (orderData.status === 'completed' && !orderData.rated) {
                // Show rating modal for completed orders that haven't been rated
                currentOrderForRating = orderData.id;
                showRatingModal();
              }
            }
            
            // Track occupied tables for pending/preparing/ready orders
            if (orderData.tableNumber && typeof orderData.tableNumber === 'number' && 
                ['pending', 'preparing', 'ready'].includes(orderData.status)) {
              newOccupiedTables.add(orderData.tableNumber);
              
              // Build table details for staff view
              if (!newTableDetails[orderData.tableNumber]) {
                newTableDetails[orderData.tableNumber] = [];
              }
              
              newTableDetails[orderData.tableNumber].push({
                id: orderData.id,
                status: orderData.status,
                items: orderData.items,
                total: orderData.total,
                createdAt: orderData.createdAt
              });
            }
          });
          
          // Update occupied tables
          occupiedTables = newOccupiedTables;
          tableDetails = newTableDetails;
          
          if (userType === "staff") {
            renderOrders();
            renderTablesOverview();
          } else if (userType === "admin") {
            renderAdminDashboard();
          }
        }, (error) => {
          console.error("Error setting up order listener:", error);
        });
    }
    
    async function fetchOrders() {
      try {
        // Fetch all pending/preparing/ready orders to track occupied tables
        const ordersSnapshot = await db.collection('orders')
          .where('status', 'in', ['pending', 'preparing', 'ready'])
          .get();
        
        const occupiedTablesSet = new Set();
        const tableDetailsObj = {};
        
        ordersSnapshot.forEach(doc => {
          const orderData = doc.data();
          
          if (orderData.tableNumber && typeof orderData.tableNumber === 'number') {
            occupiedTablesSet.add(orderData.tableNumber);
            
            // Build table details for staff view
            if (!tableDetailsObj[orderData.tableNumber]) {
              tableDetailsObj[orderData.tableNumber] = [];
            }
            
            tableDetailsObj[orderData.tableNumber].push({
              id: orderData.id,
              status: orderData.status,
              items: orderData.items,
              total: orderData.total,
              createdAt: orderData.createdAt
            });
          }
        });
        
        occupiedTables = occupiedTablesSet;
        tableDetails = tableDetailsObj;
        
      } catch (error) {
        console.error("Error fetching orders:", error);
      }
    }
    
    function renderOrders(retryAttempt = 0) {
      console.log(`Rendering orders (retry attempt: ${retryAttempt})`);
      const ordersList = document.getElementById('orders-list');
      
      // Show loading indicator
      ordersList.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: var(--light-cream);"></i>
          <p style="margin-top: 10px; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...' : 'Loading orders...'}</p>
        </div>
      `;
      
      // Verify Firebase connection before proceeding
      if (!db || typeof db.collection !== 'function') {
        console.error("Firebase database not initialized");
        ordersList.innerHTML = `
          <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©' : 'Error: Database not connected'}</p>
          <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' : 'Retry'}
          </button>
        `;
        return;
      }
      
      // Maximum retry attempts
      const MAX_RETRIES = 3;
      
      try {
        // Define a function to fetch orders with fallback for missing index errors
        const fetchOrders = async () => {
          try {
            // Get the current staff username
            const staffUsername = localStorage.getItem('username');
            console.log("Current staff username for tables:", staffUsername);
            
            // For manager role - show all orders
            if (localStorage.getItem('staffRole') === 'manager' || userType === 'admin') {
              // Manager sees all orders
              return await db.collection('orders')
                .where('status', 'in', ['pending', 'preparing', 'ready'])
                .get();
            } 
            
            // For other staff - get their assigned tables
            const assignedTables = [];
            tableAssignments.forEach(assignment => {
              if (assignment.staffUsername === staffUsername) {
                // Add all tables in their range
                for (let i = assignment.startTable; i <= assignment.endTable; i++) {
                  assignedTables.push(i);
                }
              }
            });
            
            console.log("Staff assigned tables:", assignedTables);
            
            // Get orders that are active, then we'll filter for staff's tables
            // This works without a composite index
            const allActiveOrders = await db.collection('orders')
              .where('status', 'in', ['pending', 'preparing', 'ready'])
              .get();
              
            // We need to manually filter for the staff's assigned tables
            if (assignedTables.length > 0) {
              // Create a filtered snapshot like object
              const filteredDocs = [];
              
              allActiveOrders.forEach(doc => {
                const data = doc.data();
                if (assignedTables.includes(data.tableNumber)) {
                  filteredDocs.push(doc);
                }
              });
              
              return {
                empty: filteredDocs.length === 0,
                docs: filteredDocs,
                forEach: callback => filteredDocs.forEach(callback)
              };
            }
            
            return allActiveOrders;
          } catch (error) {
            // Check if it's a missing index error
            if (error.code === 'failed-precondition') {
              console.log("Missing composite index for orders. Using fallback method.");
              
              // Fallback approach: get all orders and filter in memory
              const allOrders = await db.collection('orders').get();
              
              // Filter the documents manually
              const filteredDocs = [];
              
              allOrders.forEach(doc => {
                const data = doc.data();
                if (data.status === 'pending' || data.status === 'preparing' || data.status === 'ready') {
                  filteredDocs.push(doc);
                }
              });
              
              // Sort by creation date if available
              filteredDocs.sort((a, b) => {
                const aData = a.data();
                const bData = b.data();
                
                if (aData.createdAt && bData.createdAt) {
                  return bData.createdAt.seconds - aData.createdAt.seconds;
                }
                return 0;
              });
              
              // Create a snapshot-like object
              return {
                empty: filteredDocs.length === 0,
                docs: filteredDocs,
                forEach: callback => filteredDocs.forEach(callback)
              };
            }
            
            // For other errors, just re-throw
            throw error;
          }
        };
        
        // Use our fetchOrders function
        fetchOrders().then((querySnapshot) => {
            if (querySnapshot.empty) {
              ordersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©' : 'No active orders'}</p>`;
              return;
            }
          
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            // Make sure order has an ID from the document
            order.id = doc.id;
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.dataset.orderId = doc.id; // Add data attribute for order ID
            
            // Format timestamp
            let timestampStr = '';
            if (order.createdAt) {
              const timestamp = order.createdAt.toDate();
              timestampStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Generate status class and text
            let statusClass = '';
            let statusText = '';
            
            switch (order.status) {
              case 'pending':
                statusClass = 'status-pending';
                statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Pending';
                break;
              case 'preparing':
                statusClass = 'status-preparing';
                statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Preparing';
                break;
              case 'ready':
                statusClass = 'status-ready';
                statusText = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø²' : 'Ready';
                break;
            }
            
            // Create HTML for order items
            let itemsHtml = '';
            order.items.forEach(item => {
              itemsHtml += `
                <div class="order-item">
                  <span>${item.name} ${item.extras ? `(${item.extras})` : ''}</span>
                  <span>$${item.totalPrice.toFixed(2)}</span>
                </div>
              `;
            });
            
            // Check for assigned staff - first check if order has assignedStaff object
            // Then check for direct properties, then check table assignments
            let assignedStaffName = null;
            let assignedStaffRole = null;
            
            // Check different ways staff might be assigned to the order
            if (order.assignedStaff) {
              // Get from new assignedStaff object
              assignedStaffName = order.assignedStaff.name;
              assignedStaffRole = order.assignedStaff.role;
            } else if (order.assignedStaffName) {
              // Get from older direct properties
              assignedStaffName = order.assignedStaffName;
              assignedStaffRole = order.assignedStaffRole;
            } else if (order.tableNumber) {
              // As a fallback, check table assignments
              const tableStaff = getStaffForTable(order.tableNumber);
              if (tableStaff) {
                assignedStaffName = tableStaff.name;
                assignedStaffRole = tableStaff.role;
              }
            }
            
            // Create assigned staff info HTML if available
            const assignedStaffHtml = assignedStaffName ? `
              <div class="assigned-staff-info">
                <span style="color: #ffc107;">
                  <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' : 'Assigned Staff'}:
                </span>
                <span>${assignedStaffName} 
                  ${assignedStaffRole ? `<span class="staff-role-badge role-${assignedStaffRole}">${assignedStaffRole}</span>` : ''}
                </span>
              </div>
            ` : '';
            
            // Create HTML for the order card
            orderCard.innerHTML = `
              <div class="order-header">
                <div class="order-id">${currentLanguage === 'ar' ? 'Ø·Ù„Ø¨' : 'Order'} #${order.id.slice(-4).toUpperCase()} - ${currentLanguage === 'ar' ? 'Ø·Ø§ÙˆÙ„Ø©' : 'Table'} ${order.tableNumber}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
              </div>
              <div class="order-time">${timestampStr}</div>
              ${assignedStaffHtml}
              <div class="order-items">
                ${itemsHtml}
              </div>
              <div class="order-total" style="text-align: right; font-weight: bold; margin-top: 5px;">
                ${currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}: $${order.total.toFixed(2)}
              </div>
              <div class="order-actions">
                ${order.status === 'pending' ? `
                  <button class="action-btn" style="background: #2196F3; color: white;" onclick="updateOrderStatus('${order.id}', 'preparing')">
                    ${currentLanguage === 'ar' ? 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Start Preparing'}
                  </button>
                ` : ''}
                ${order.status === 'preparing' ? `
                  <button class="action-btn" style="background: #4CAF50; color: white;" onclick="updateOrderStatus('${order.id}', 'ready')">
                    ${currentLanguage === 'ar' ? 'ØªØ­Ø¯ÙŠØ¯ ÙƒØ¬Ø§Ù‡Ø²' : 'Mark Ready'}
                  </button>
                ` : ''}
                ${order.status === 'ready' ? `
                  <button class="action-btn" style="background: #9E9E9E; color: white;" onclick="updateOrderStatus('${order.id}', 'completed')">
                    ${currentLanguage === 'ar' ? 'Ø¥ÙƒÙ…Ø§Ù„' : 'Complete'}
                  </button>
                ` : ''}
                <button class="action-btn" style="background: #FF5722; color: white;" onclick="cancelOrder('${order.id}')">
                  ${currentLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'}
                </button>
              </div>
            `;
            
            ordersList.appendChild(orderCard);
          });
        })
        .catch((error) => {
          console.error("Error fetching orders:", error);
          
          // If this is not the final retry attempt, try again
          if (retryAttempt < MAX_RETRIES) {
            console.log(`Retrying order fetch (attempt ${retryAttempt + 1} of ${MAX_RETRIES})...`);
            setTimeout(() => {
              renderOrders(retryAttempt + 1);
            }, 1000); // Wait 1 second before retrying
            return;
          }
          
          // Show error with retry button
          ordersList.innerHTML = `
            <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Error loading orders'}</p>
            <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' : 'Retry'}
            </button>
          `;
        });
      } catch (error) {
        console.error("Fatal error in renderOrders:", error);
        
        // Show error with retry button
        ordersList.innerHTML = `
          <p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Error loading orders'}</p>
          <button onclick="renderOrders(0)" class="retry-btn" style="display: block; margin: 10px auto; padding: 5px 15px; background: var(--gold); color: black; border: none; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> ${currentLanguage === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' : 'Retry'}
          </button>
        `;
      }
    }
    
    function renderTablesOverview() {
      // Clear the existing grid
      tablesGrid.innerHTML = '';
      
      // Get current staff username if we're in staff view
      const currentStaffUsername = userType === 'staff' ? localStorage.getItem('username') : null;
      console.log("Current staff username for tables:", currentStaffUsername);
      
      // Filter for tables assigned to current staff member if we're in staff view
      let tablesToShow = [];
      
      if (userType === 'staff' && currentStaffUsername) {
        // Get table assignments for this staff member
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        
        // Create an array of all table numbers assigned to this staff member
        const assignedTables = [];
        staffAssignments.forEach(assignment => {
          for (let t = assignment.startTable; t <= assignment.endTable; t++) {
            assignedTables.push(t);
          }
        });
        
        // Filter occupied tables to only show those assigned to this staff
        tablesToShow = Array.from(occupiedTables).filter(tableNum => 
          assignedTables.includes(parseInt(tableNum))
        ).sort((a, b) => a - b);
      } else {
        // For admin view, show all occupied tables
        tablesToShow = Array.from(occupiedTables).sort((a, b) => a - b);
      }
      
      if (tablesToShow.length === 0) {
        tablesGrid.innerHTML = `<p style="grid-column: 1 / -1; color: var(--light-cream);">${
          currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ø´ØºÙˆÙ„Ø©' : 
          (userType === 'staff' ? 'No occupied tables assigned to you' : 'No occupied tables')
        }</p>`;
        return;
      }
      
      // Show the tables
      tablesToShow.forEach(tableNum => {
        const tableData = tableDetails[tableNum];
        const tableEl = document.createElement('div');
        tableEl.className = `table-item ${tableData ? 'occupied' : ''}`;
        tableEl.onclick = () => showTableDetails(tableNum);
        
        let statusText = currentLanguage === 'ar' ? 'Ù…ØªØ§Ø­Ø©' : 'Available';
        let statusClass = '';
        
        if (tableData) {
          statusText = currentLanguage === 'ar' ? 'Ù…Ø´ØºÙˆÙ„Ø©' : 'Occupied';
          statusClass = 'status-occupied';
        }
        
        tableEl.innerHTML = `
          <div class="table-number">${tableNum}</div>
          <div class="table-status-indicator ${statusClass}"></div>
        `;
        
        tablesGrid.appendChild(tableEl);
      });
    }
    
    function showTableDetails(tableNum) {
      tableDetailsTitle.textContent = `${currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'TABLE'} ${tableNum}`;
      
      // Check if this table has an assigned staff member
      const assignedStaff = getStaffForTable(tableNum);
      let staffInfoHtml = '';
      
      if (assignedStaff) {
        staffInfoHtml = `
          <div style="margin-bottom: 10px; text-align: center; padding: 8px; background: rgba(33, 33, 33, 0.5); border-radius: 8px;">
            <div style="font-size: 0.85rem; color: #ffc107;">
              <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' : 'Assigned Staff'}:
            </div>
            <div style="font-weight: bold;">
              ${assignedStaff.name} 
              <span class="staff-role-badge role-${assignedStaff.role}">${assignedStaff.role}</span>
            </div>
          </div>
        `;
      }
      
      // Add staff info to the modal
      const tableStaffInfo = document.getElementById('table-staff-info');
      if (tableStaffInfo) {
        tableStaffInfo.innerHTML = staffInfoHtml;
      }
      
      // Add table status management controls for staff
      const isStaffOrAdmin = userType === 'staff' || userType === 'admin';
      const tableActionButtons = document.getElementById('table-action-buttons');
      
      if (tableActionButtons && isStaffOrAdmin) {
        // Check if the current staff member is assigned to this table
        const currentStaffUsername = localStorage.getItem('username');
        let canManageTable = userType === 'admin'; // Admins can manage any table
        
        if (userType === 'staff' && currentStaffUsername) {
          const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
          
          // Check if this table is in any of the assigned ranges
          canManageTable = staffAssignments.some(assignment => 
            parseInt(tableNum) >= assignment.startTable && parseInt(tableNum) <= assignment.endTable
          );
        }
        
        // Only show management controls if staff is assigned to this table
        if (canManageTable) {
          const isOccupied = occupiedTables.has(parseInt(tableNum));
          tableActionButtons.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <button 
                onclick="markTableStatus(${tableNum}, '${isOccupied ? 'free' : 'occupied'}')" 
                class="table-action-btn ${isOccupied ? 'free-table-btn' : 'occupy-table-btn'}">
                <i class="fas fa-${isOccupied ? 'check-circle' : 'utensils'}"></i>
                ${isOccupied 
                  ? (currentLanguage === 'ar' ? 'ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'MARK AS FREE') 
                  : (currentLanguage === 'ar' ? 'ØªØ¹ÙŠÙŠÙ† ÙƒÙ…Ø´ØºÙˆÙ„Ø©' : 'MARK AS OCCUPIED')}
              </button>
            </div>
          `;
        } else {
          tableActionButtons.innerHTML = '';
        }
      } else if (tableActionButtons) {
        tableActionButtons.innerHTML = '';
      }
      
      const orders = tableDetails[tableNum] || { orders: [] };
      
      if (!orders.orders || orders.orders.length === 0) {
        tableOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª' : 'No orders'}</p>`;
      } else {
        tableOrdersList.innerHTML = '';
        
        orders.orders.forEach(order => {
          const orderEl = document.createElement('div');
          orderEl.className = 'order-card';
          
          // Generate status class and text
          let statusClass = '';
          let statusText = '';
          
          switch (order.status) {
            case 'pending':
              statusClass = 'status-pending';
              statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Pending';
              break;
            case 'preparing':
              statusClass = 'status-preparing';
              statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Preparing';
              break;
            case 'ready':
              statusClass = 'status-ready';
              statusText = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø²' : 'Ready';
              break;
          }
          
          // Create HTML for order items
          let itemsHtml = '';
          order.items.forEach(item => {
            itemsHtml += `
              <div class="order-item">
                <span>${item.name} ${item.extras ? `(${item.extras})` : ''}</span>
                <span>$${item.totalPrice.toFixed(2)}</span>
              </div>
            `;
          });
          
          orderEl.innerHTML = `
            <div class="order-header">
              <div class="order-id">${currentLanguage === 'ar' ? 'Ø·Ù„Ø¨' : 'Order'} #${order.id.slice(-4).toUpperCase()}</div>
              <div class="order-status ${statusClass}">${statusText}</div>
            </div>
            <div class="order-items">
              ${itemsHtml}
            </div>
            <div class="order-total" style="text-align: right; font-weight: bold; margin-top: 5px;">
              ${currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}: $${order.total.toFixed(2)}
            </div>
          `;
          
          tableOrdersList.appendChild(orderEl);
        });
      }
      
      tableDetailsModal.style.display = 'flex';
    }
    
    function closeTableDetails() {
      tableDetailsModal.style.display = 'none';
    }
    
    // Special function just for cancelling orders to make it more direct and reliable
    async function cancelOrder(orderId) {
      console.log(`Explicitly cancelling order ${orderId}`);
      
      // Get UI elements
      const targetCardElement = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if (targetCardElement) {
        targetCardElement.classList.add('updating');
      }
      
      // Show immediate notification
      showNotification(
        currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù„ØºØ§Ø¡' : 'Cancelling',
        currentLanguage === 'ar' 
          ? `Ø¬Ø§Ø±Ù Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨...` 
          : `Cancelling order...`,
        'info',
        1500
      );
      
      try {
        // Verify Firebase connection
        if (!db || typeof db.collection !== 'function') {
          throw new Error("Firebase database not connected");
        }
        
        // Get the order document
        const orderRef = db.collection('orders').doc(orderId);
        const orderDoc = await orderRef.get();
        
        if (!orderDoc.exists) {
          throw new Error(`Order ${orderId} not found in database`);
        }
        
        const orderData = orderDoc.data();
        const tableNum = orderData.tableNumber;
        
        // No need for auth check for now - just cancel it
        
        // Delete the order directly
        await orderRef.delete();
        console.log(`Order ${orderId} has been deleted from the database`);
        
        // Remove from UI
        if (targetCardElement && targetCardElement.parentNode) {
          // Apply fade out animation
          targetCardElement.style.opacity = '0';
          targetCardElement.style.transform = 'scale(0.95)';
          
          // After animation, remove from DOM
          setTimeout(() => {
            if (targetCardElement.parentNode) {
              targetCardElement.parentNode.removeChild(targetCardElement);
            }
          }, 300);
        }
        
        // Check if we need to release the table
        releaseTable(tableNum);
        
        // Show success message
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨' : 'Order Cancelled',
          currentLanguage === 'ar' 
            ? `ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ #${orderId.slice(-4).toUpperCase()} Ø¨Ù†Ø¬Ø§Ø­` 
            : `Order #${orderId.slice(-4).toUpperCase()} has been cancelled successfully`,
          'success'
        );
        
        // Refresh orders
        setTimeout(() => {
          if (userType === 'staff' || userType === 'admin') {
            renderOrders();
          } else {
            renderClientOrders();
          }
        }, 800);
        
      } catch (error) {
        console.error("Error cancelling order:", error);
        
        // Show error message
        showNotification(
          currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨' : 'Cancellation Failed',
          currentLanguage === 'ar' 
            ? `Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨: ${error.message}` 
            : `Error cancelling order: ${error.message}`,
          'error'
        );
        
        // Reset card UI
        if (targetCardElement) {
          targetCardElement.classList.remove('updating');
        }
      }
    }
    
    async function updateOrderStatus(orderId, newStatus) {
      console.log(`Updating order ${orderId} to status: ${newStatus}`);
      
      // Immediately show "updating" notification to give feedback
      const targetCardElement = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if (targetCardElement) {
        targetCardElement.classList.add('updating');
      }
      
      // Get temporary status label for immediate feedback
      let tempStatusText = currentLanguage === 'ar' ? 
        getStatusTranslation(newStatus) : newStatus;
      
      // Show immediate notification of status change
      if (newStatus === 'cancelled') {
        showNotification(
          currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù„ØºØ§Ø¡' : 'Cancelling',
          currentLanguage === 'ar' 
            ? `Ø¬Ø§Ø±Ù Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨...` 
            : `Cancelling order...`,
          'info',
          1500 // Auto-hide after 1.5 seconds
        );
      } else {
        showNotification(
          currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'Updating',
          currentLanguage === 'ar' 
            ? `Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${tempStatusText}...` 
            : `Updating order to ${tempStatusText}...`,
          'info',
          1500 // Auto-hide after 1.5 seconds
        );
      }
      
      try {
        // Verify Firebase connection
        if (!db || typeof db.collection !== 'function') {
          throw new Error("Firebase database not connected");
        }
        
        // Find the order to get table number and staff info
        const orderRef = db.collection('orders').doc(orderId);
        const orderDoc = await orderRef.get();
        
        if (!orderDoc.exists) {
          throw new Error(`Order ${orderId} not found in database`);
        }
        
        const orderData = orderDoc.data();
          
          if (!orderData) {
            console.error("Order not found");
            return;
          }
          
          // Get current staff role and username
          const staffRole = localStorage.getItem('staffRole');
          const staffUsername = localStorage.getItem('username');
          const isAdmin = userType === 'admin';
          
          // Get staff info for the table
          const tableStaff = getStaffForTable(orderData.tableNumber);
          
          // Only allow order updates if:
          // 1. Current user is an admin
          // 2. Current user is the assigned staff for this table
          // 3. Current user has manager role
          const isAssignedStaff = tableStaff && staffUsername === tableStaff.username;
          const isManager = staffRole === 'manager';
          
          if (!isAdmin && !isAssignedStaff && !isManager) {
            showNotification(
              currentLanguage === 'ar' ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©' : 'Not Authorized',
              currentLanguage === 'ar' 
                ? 'ÙÙ‚Ø· Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨' 
                : 'Only the assigned staff or manager can change this order status',
              'error'
            );
            return;
          }
          
          // Update local display immediately for better UX
          if (targetCardElement) {
            const statusElement = targetCardElement.querySelector('.order-status');
            if (statusElement) {
              // Update the class
              statusElement.className = `order-status status-${newStatus}`;
              // Update the text
              statusElement.textContent = tempStatusText;
            }
            
            // Hide actions that don't make sense anymore
            if (newStatus === 'cancelled' || newStatus === 'completed') {
              const actionsElement = targetCardElement.querySelector('.order-actions');
              if (actionsElement) {
                actionsElement.innerHTML = `<div class="order-status-info">${
                  currentLanguage === 'ar' ? 
                    (newStatus === 'cancelled' ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨' : 'ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨') :
                    (newStatus === 'cancelled' ? 'Order cancelled' : 'Order completed')
                }</div>`;
              }
            }
            
            // Remove the updating style
            targetCardElement.classList.remove('updating');
          }
          
          // Check if the order already has the new assignedStaff structure
          const updateData = {
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            staffId: currentStaff
          };
          
          // Add assigned staff info to the update
          if (tableStaff) {
            if (orderData.assignedStaff) {
              // Use the new structure if it exists
              updateData.assignedStaff = {
                name: tableStaff.name,
                username: tableStaff.username,
                role: tableStaff.role
              };
            } else {
              // Fallback to old structure for compatibility
              updateData.assignedStaffName = tableStaff.name;
              updateData.assignedStaffUsername = tableStaff.username;
              updateData.assignedStaffRole = tableStaff.role;
            }
          }
          
          // If order is completed, add completion time to calculate deletion time
          if (newStatus === 'completed') {
            updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
            // For completed orders, we need to show rating for users
            if (orderData.tableNumber === tableNumber) {
              // If this is the user's table, show rating dialog after status update
              setTimeout(() => {
                showRatingDialog(orderId);
              }, 1000);
            }
          }
          
          // For cancelled orders, actually delete them rather than just updating status
          if (newStatus === 'cancelled') {
            // Delete the order completely
            await db.collection('orders').doc(orderId).delete();
            
            console.log(`Order ${orderId} has been deleted from the database`);
            
            // Remove from local UI if needed
            if (targetCardElement && targetCardElement.parentNode) {
              // Apply fade out animation
              targetCardElement.style.opacity = '0';
              targetCardElement.style.transform = 'scale(0.95)';
              
              // After animation, remove from DOM
              setTimeout(() => {
                if (targetCardElement.parentNode) {
                  targetCardElement.parentNode.removeChild(targetCardElement);
                }
              }, 300);
            }
            
            // Release the table
            releaseTable(orderData.tableNumber);
          } else {
            // For other statuses, just update the order
            await db.collection('orders').doc(orderId).update(updateData);
            
            // If order is completed, release the table
            if (newStatus === 'completed') {
              // No need to wait for this, let it happen in background
              releaseTable(orderData.tableNumber);
            }
          }
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨' : 'Order Updated',
            currentLanguage === 'ar' 
              ? `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${orderId.slice(-4).toUpperCase()} Ø¥Ù„Ù‰ ${getStatusTranslation(newStatus)}` 
              : `Order #${orderId.slice(-4).toUpperCase()} updated to ${newStatus}`,
            'success'
          );
        } catch (error) {
          console.error("Error updating order:", error);
          showNotification(
            currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨' : 'Order Update Failed',
            currentLanguage === 'ar' ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨" : "There was an error while updating the order: " + error.message,
            'error'
          );
          
          // Reset the card if there was an error
          if (targetCardElement) {
            targetCardElement.classList.remove('updating');
          }
        } finally {
          // Refresh the orders display after update regardless of success/failure
          setTimeout(() => {
            if (userType === 'staff' || userType === 'admin') {
              renderOrders();
            } else {
              renderClientOrders();
            }
          }, 800);
        }
    }
    
    function getStatusTranslation(status) {
      if (currentLanguage === 'ar') {
        switch (status) {
          case 'pending': return 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
          case 'preparing': return 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±';
          case 'ready': return 'Ø¬Ø§Ù‡Ø²';
          case 'completed': return 'Ù…ÙƒØªÙ…Ù„';
          case 'cancelled': return 'Ù…Ù„ØºÙŠ';
          default: return status;
        }
      }
      return status;
    }
    
    // Function to mark a table as free or occupied
    function markTableStatus(tableNum, status) {
      const tableNumber = parseInt(tableNum);
      
      if (isNaN(tableNumber)) {
        console.error('Invalid table number');
        return;
      }
      
      console.log(`Attempting to mark table ${tableNumber} as ${status}`);
      
      // Check if the current staff is assigned to this table
      const currentStaffUsername = localStorage.getItem('username');
      console.log('Current staff username:', currentStaffUsername);
      
      let canManageTable = userType === 'admin'; // Admins can manage any table
      
      if (userType === 'staff' && currentStaffUsername) {
        console.log('Table assignments:', tableAssignments);
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        console.log('Staff assignments for current user:', staffAssignments);
        
        // Check if this table is in any of the assigned ranges
        canManageTable = staffAssignments.some(assignment => {
          const inRange = tableNumber >= assignment.startTable && tableNumber <= assignment.endTable;
          console.log(`Checking if table ${tableNumber} is in range ${assignment.startTable}-${assignment.endTable}: ${inRange}`);
          return inRange;
        });
      }
      
      console.log(`Can manage table: ${canManageTable}`);
      
      if (!canManageTable) {
        showNotification(
          currentLanguage === 'ar' ? 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' : 'Not Authorized',
          currentLanguage === 'ar' 
            ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ù…Ø®ØµØµØ© Ù„Ùƒ' 
            : 'You cannot manage this table as it is not assigned to you',
          'error'
        );
        return;
      }
      
      // Update table status based on the requested action
      if (status === 'free') {
        console.log(`Releasing table ${tableNumber}`);
        if (releaseTable(tableNumber)) {
          showNotification(
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Status Updated',
            currentLanguage === 'ar' 
              ? `ØªÙ… ØªØ­Ø±ÙŠØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber}` 
              : `Table ${tableNumber} is now marked as Free`,
            'success'
          );
        } else {
          console.log(`Failed to release table ${tableNumber}`);
        }
      } else if (status === 'occupied') {
        console.log(`Occupying table ${tableNumber}`);
        if (occupyTable(tableNumber)) {
          showNotification(
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø©' : 'Table Status Updated',
            currentLanguage === 'ar' 
              ? `ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ${tableNumber} ÙƒÙ…Ø´ØºÙˆÙ„Ø©` 
              : `Table ${tableNumber} is now marked as Occupied`,
            'success'
          );
        } else {
          console.log(`Failed to occupy table ${tableNumber}`);
        }
      }
      
      // Close the table details modal
      closeTableDetails();
      
      // Update displays
      updateTablesDisplay();
      renderTablesOverview();
    }
    
    // Rating system functions
    // currentRating is already declared above, so we're not redeclaring it
    
    function showRatingDialog(orderId) {
      // Get order details to fetch staff name
      db.collection('orders').doc(orderId).get()
        .then(doc => {
          if (!doc.exists) {
            console.error("Order not found for rating");
            return;
          }
          
          const orderData = doc.data();
          let staffName = '';
          
          // Check different ways staff might be assigned
          if (orderData.assignedStaff) {
            staffName = orderData.assignedStaff.name;
          } else if (orderData.assignedStaffName) {
            staffName = orderData.assignedStaffName;
          }
          
          // Reset any previous rating
          currentRating = 0;
          
          // Reset rating stars
          const ratingStars = document.querySelectorAll(".rating-star");
          ratingStars.forEach(star => star.classList.remove('active'));
          
          // Hide feedback container initially
          document.getElementById('feedback-container').style.display = 'none';
          
          // Store order ID and staff name in hidden fields
          document.getElementById('rating-order-id').value = orderId;
          document.getElementById('rating-staff-name').value = staffName;
          
          // Update text labels based on language
          document.getElementById('rating-title').textContent = 
            currentLanguage === 'ar' ? 'Ù‚ÙŠÙ… ØªØ¬Ø±Ø¨ØªÙƒ' : 'RATE YOUR EXPERIENCE';
          
          document.getElementById('feedback-label').textContent = 
            currentLanguage === 'ar' ? 'ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'FEEDBACK (OPTIONAL)';
          
          document.getElementById('submit-rating-btn').textContent = 
            currentLanguage === 'ar' ? 'Ø¥Ø±Ø³Ø§Ù„' : 'SUBMIT';
          
          document.getElementById('cancel-rating-btn').textContent = 
            currentLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'CANCEL';
          
          // Setup rating star event handlers
          ratingStars.forEach(star => {
            star.addEventListener('click', () => {
              const rating = parseInt(star.getAttribute('data-rating'));
              currentRating = rating;
              
              // Update stars visually
              ratingStars.forEach(s => {
                if (parseInt(s.getAttribute('data-rating')) <= rating) {
                  s.classList.add('active');
                } else {
                  s.classList.remove('active');
                }
              });
              
              // If rating is 3 or less, show feedback container
              const feedbackContainer = document.getElementById('feedback-container');
              if (rating <= 3) {
                feedbackContainer.style.display = 'block';
                // Clear previous feedback
                document.getElementById('feedback-text').value = '';
              } else {
                feedbackContainer.style.display = 'none';
              }
            });
          });
          
          // Show the rating modal
          const ratingModal = document.getElementById('rating-modal');
          ratingModal.style.display = 'flex';
        })
        .catch(error => {
          console.error("Error getting order for rating:", error);
        });
    }
    
    function closeRatingDialog() {
      document.getElementById('rating-modal').style.display = 'none';
    }
    
    function submitRating() {
      if (currentRating === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ‚ÙŠÙŠÙ… Ù…Ø·Ù„ÙˆØ¨' : 'Rating Required',
          currentLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙ‚ÙŠÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Please select a rating before submitting',
          'warning'
        );
        return;
      }
      
      const orderId = document.getElementById('rating-order-id').value;
      const staffName = document.getElementById('rating-staff-name').value;
      const feedback = document.getElementById('feedback-text').value;
      
      // Create rating object
      const ratingData = {
        orderId: orderId,
        rating: currentRating,
        staffName: staffName,
        feedback: feedback || '', // Send empty string if no feedback
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        tableNumber: tableNumber,
        fromLanguage: currentLanguage
      };
      
      // Save to ratings collection in Firebase
      db.collection('ratings').add(ratingData)
        .then(() => {
          // Update order with rating info
          return db.collection('orders').doc(orderId).update({
            rated: true,
            rating: currentRating
          });
        })
        .then(() => {
          // Close the rating dialog
          closeRatingDialog();
          
          // Show success notification
          showNotification(
            currentLanguage === 'ar' ? 'Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ùƒ' : 'Thank You for Your Rating',
            currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­' : 'Your feedback has been recorded successfully',
            'success'
          );
        })
        .catch(error => {
          console.error("Error saving rating:", error);
          
          showNotification(
            currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' : 'Rating Error',
            currentLanguage === 'ar' ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ' : 'There was an error saving your rating',
            'error'
          );
        });
    }
    
    // Function to clean up old completed orders (delete after 6 hours)
    async function cleanupCompletedOrders() {
      if (!db || typeof db.collection !== 'function') {
        console.warn("Database not available, skipping order cleanup");
        return;
      }

      console.log("Running cleanup of completed orders and fixing stuck orders");
      
      try {
        // Calculate cutoff times
        const sixHoursAgo = new Date();
        sixHoursAgo.setHours(sixHoursAgo.getHours() - 6);
        
        const twoHoursAgo = new Date();
        twoHoursAgo.setHours(twoHoursAgo.getHours() - 2);
        
        // Create a batched write for efficiency
        const batch = db.batch();
        let documentCount = 0;
        const BATCH_LIMIT = 495; // Firestore limit is 500
        let hasDeletions = false;
        
        // CLEANUP TASK 1: Delete completed orders older than 6 hours
        try {
          const completedOrdersQuery = await db.collection('orders')
            .where('status', '==', 'completed')
            .get();
          
          completedOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if completedAt exists and is older than six hours
            if (data.completedAt && data.completedAt.toDate && data.completedAt.toDate() < sixHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.delete(doc.ref);
                documentCount++;
                hasDeletions = true;
              }
            }
          });
          
          console.log(`Found ${documentCount} old completed orders to delete`);
        } catch (error) {
          console.error("Error querying completed orders:", error);
          // Continue with other tasks
        }
        
        // CLEANUP TASK 2: Mark stale "pending" orders as cancelled after 2 hours
        try {
          const stuckPendingOrdersQuery = await db.collection('orders')
            .where('status', '==', 'pending')
            .get();
          
          let stuckPendingCount = 0;
          stuckPendingOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if the pending order is older than 2 hours
            if (data.createdAt && data.createdAt.toDate && data.createdAt.toDate() < twoHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.update(doc.ref, {
                  status: 'cancelled',
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  systemCancelled: true,
                  cancellationReason: 'Automatically cancelled after 2 hours in pending state'
                });
                documentCount++;
                stuckPendingCount++;
              }
            }
          });
          
          console.log(`Found ${stuckPendingCount} stuck pending orders to auto-cancel`);
        } catch (error) {
          console.error("Error processing stuck pending orders:", error);
        }
        
        // CLEANUP TASK 3: Clean up cancelled orders older than 12 hours
        try {
          const twelvehHoursAgo = new Date();
          twelvehHoursAgo.setHours(twelvehHoursAgo.getHours() - 12);
          
          const cancelledOrdersQuery = await db.collection('orders')
            .where('status', '==', 'cancelled')
            .get();
          
          let cancelledCount = 0;
          cancelledOrdersQuery.forEach(doc => {
            const data = doc.data();
            // Check if the cancelled order is older than 12 hours
            if (data.updatedAt && data.updatedAt.toDate && data.updatedAt.toDate() < twelvehHoursAgo) {
              if (documentCount < BATCH_LIMIT) {
                batch.delete(doc.ref);
                documentCount++;
                cancelledCount++;
                hasDeletions = true;
              }
            }
          });
          
          console.log(`Found ${cancelledCount} old cancelled orders to delete`);
        } catch (error) {
          console.error("Error cleaning up cancelled orders:", error);
        }
        
        // Commit changes if any documents were processed
        if (documentCount > 0) {
          await batch.commit();
          console.log(`Database cleanup successful: Processed ${documentCount} documents`);
          
          // If we deleted orders, check if any tables can be released
          if (hasDeletions) {
            checkAndReleaseEmptyTables();
          }
        } else {
          console.log("No documents needed cleanup");
        }
        
      } catch (error) {
        console.error("Error during orders cleanup process:", error);
      }
    }
    
    // Check for tables that can be released (no active orders)
    async function checkAndReleaseEmptyTables() {
      try {
        // First get all occupied tables
        const tableStatusQuery = await db.collection('tableStatus')
          .where('status', '==', 'occupied')
          .get();
        
        // For each occupied table, check if it still has active orders
        tableStatusQuery.forEach(async (tableDoc) => {
          const tableNumber = tableDoc.id;
          
          try {
            // Check for any active orders for this table
            const activeOrdersQuery = await db.collection('orders')
              .where('tableNumber', '==', parseInt(tableNumber))
              .where('status', 'in', ['pending', 'preparing', 'ready'])
              .get();
            
            // If no active orders, release the table
            if (activeOrdersQuery.empty) {
              await db.collection('tableStatus').doc(tableNumber).update({
                status: 'free',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: { username: 'system', role: 'system' }
              });
              
              console.log(`Released table ${tableNumber} as it has no active orders`);
            }
          } catch (error) {
            console.error(`Error checking orders for table ${tableNumber}:`, error);
          }
        });
      } catch (error) {
        console.error("Error in checkAndReleaseEmptyTables:", error);
      }
    }
    
    // Run cleanup process every hour
    setInterval(cleanupCompletedOrders, 60 * 60 * 1000);
    
    // Client Orders
    function renderClientOrders() {
      // Initial loading state - but only if there's no content already
      if (!clientOrdersList.querySelector('.client-order')) {
        clientOrdersList.innerHTML = `
          <div style="text-align: center; padding: 10px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 1rem; color: var(--light-cream);"></i>
            <p style="margin-top: 10px; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...' : 'Loading orders...'}</p>
          </div>
        `;
      }
      
      // If we don't have a table number yet, don't show any orders
      if (!tableNumber) {
        clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹' : 'Please select a table number first'}</p>`;
        return;
      }
      
      // Verify Firebase connection
      if (!db || typeof db.collection !== 'function') {
        console.error("Firebase database not initialized");
        clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø©' : 'Error: Database not connected'}</p>`;
        return;
      }
      
      console.log(`Fetching orders for client ${clientId} at table ${tableNumber}`);
      
      // Track existing order elements to update them instead of recreating
      const existingOrderElements = {};
      document.querySelectorAll('.client-order').forEach(el => {
        const orderId = el.dataset.orderId;
        if (orderId) {
          existingOrderElements[orderId] = el;
        }
      });
      
      // Use a simpler query to get all orders for this client and table
      db.collection('orders')
        .where('tableNumber', '==', tableNumber)
        .where('clientId', '==', clientId)
        .get()
        .then((querySnapshot) => {
          if (querySnapshot.empty) {
            clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©' : 'No active orders'}</p>`;
            return;
          }
          
          // Clear all existing messages first if we have orders
          const loadingMessage = clientOrdersList.querySelector('p');
          if (loadingMessage) {
            loadingMessage.remove();
          }
          
          // Keep track of order IDs we find and process to avoid duplicates
          const foundOrderIds = new Set();
          
          // First update existing order elements or create new ones as needed
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            order.id = doc.id; // Make sure the id is set
            foundOrderIds.add(doc.id);
            
            // Check if we already have this order in the UI
            let orderEl = existingOrderElements[doc.id];
            let isNewOrder = false;
            
            if (!orderEl) {
              // If not, create a new element
              isNewOrder = true;
              orderEl = document.createElement('div');
              orderEl.className = 'client-order order-card'; // Add order-card class for unified styling
              orderEl.dataset.orderId = doc.id; // Set dataset for easier selection
            }
            
            // Generate status class and text
            let statusClass = '';
            let statusText = '';
            
            switch (order.status) {
              case 'pending':
                statusClass = 'status-pending';
                statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Pending';
                break;
              case 'preparing':
                statusClass = 'status-preparing';
                statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Preparing';
                break;
              case 'ready':
                statusClass = 'status-ready';
                statusText = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø²' : 'Ready';
                break;
              case 'completed':
                statusClass = 'status-completed';
                statusText = currentLanguage === 'ar' ? 'Ù…ÙƒØªÙ…Ù„' : 'Completed';
                break;
              case 'cancelled':
                statusClass = 'status-cancelled';
                statusText = currentLanguage === 'ar' ? 'Ù…Ù„ØºÙŠ' : 'Cancelled';
                break;
            }
            
            // Format timestamp
            let timestampStr = '';
            if (order.createdAt) {
              const timestamp = order.createdAt.toDate();
              timestampStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Create HTML for order items
            let itemsHtml = '';
            order.items.forEach(item => {
              itemsHtml += `
                <div class="client-order-item">
                  <span>${item.name}</span>
                  <span>$${item.totalPrice.toFixed(2)}</span>
                </div>
              `;
            });
            
            // Check for assigned staff - handle both new and old format
            let assignedStaffName = null;
            let assignedStaffRole = null;
            
            // Check different ways staff might be assigned to the order
            if (order.assignedStaff) {
              // Get from new assignedStaff object
              assignedStaffName = order.assignedStaff.name;
              assignedStaffRole = order.assignedStaff.role;
            } else if (order.assignedStaffName) {
              // Get from older direct properties
              assignedStaffName = order.assignedStaffName;
              assignedStaffRole = order.assignedStaffRole;
            }
            
            // Create staff info HTML if available
            const assignedStaffHtml = assignedStaffName ? `
              <div style="margin: 8px 0; padding: 5px; background: rgba(50, 50, 50, 0.3); border-radius: 4px; font-size: 0.8rem;">
                <span style="color: #ffc107;">
                  <i class="fas fa-user-tag"></i> ${currentLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' : 'Your Server'}:
                </span>
                <span>${assignedStaffName}</span>
              </div>
            ` : '';
            
            // Create simplified display of order number (just use last 4 chars and format nicely)
            const orderNumber = order.id.slice(-4).toUpperCase();
            
            // Create HTML for the order - simpler and more user-friendly display
            orderEl.innerHTML = `
              <div class="client-order-header">
                <div class="client-order-id">${currentLanguage === 'ar' ? 'Ø·Ù„Ø¨' : 'Order'} #${orderNumber}</div>
                <div class="client-order-status ${statusClass}">${statusText}</div>
              </div>
              <div style="font-size: 0.8rem; margin-bottom: 8px; color: var(--light-cream);">${timestampStr}</div>
              ${assignedStaffHtml}
              <div class="client-order-items">
                ${itemsHtml}
              </div>
              <div style="text-align: right; font-weight: bold; font-size: 0.85rem;">
                ${currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total'}: $${order.total.toFixed(2)}
              </div>
              ${order.status === 'pending' ? `
                <button onclick="cancelOrder('${order.id}')" style="background: var(--red); margin-top: 8px; width: 100%;">
                  ${currentLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨' : 'CANCEL ORDER'}
                </button>
              ` : ''}
            `;
            
            // If it's a new order, add it to the DOM
            if (isNewOrder) {
              clientOrdersList.appendChild(orderEl);
            }
          });
          
          // Now remove any elements that are not in the current data
          Object.keys(existingOrderElements).forEach(id => {
            if (!foundOrderIds.has(id)) {
              // This order is no longer in the database, remove the element
              const elementToRemove = existingOrderElements[id];
              if (elementToRemove && elementToRemove.parentNode) {
                // Animate the removal
                elementToRemove.style.opacity = '0';
                elementToRemove.style.transform = 'scale(0.95)';
                
                // Remove after animation completes
                setTimeout(() => {
                  if (elementToRemove.parentNode) {
                    elementToRemove.parentNode.removeChild(elementToRemove);
                  }
                }, 300);
              }
            }
          });
          
          // If after processing there are no orders, show "no orders" message
          setTimeout(() => {
            if (clientOrdersList.children.length === 0) {
              clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--light-cream);">${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©' : 'No active orders'}</p>`;
            }
          }, 350); // Wait a bit longer than the animation to make sure all removals have completed
        })
        .catch((error) => {
          console.error("Error fetching client orders:", error);
          clientOrdersList.innerHTML = `<p style="text-align: center; color: var(--red);">${currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Error loading orders'}</p>`;
        });
    }
    
    function toggleClientOrders() {
      clientOrders.classList.toggle('active');
      if (clientOrders.classList.contains('active')) {
        renderClientOrders();
      }
    }
    
    // This client-side cancelOrder function now uses the main cancelOrder function
    // defined earlier in the code
    
    // Enhanced Notifications with better visibility and handling
    function showNotification(title, message, type = 'info') {
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      
      // Clear any existing notification timeout
      if (window.notificationTimeout) {
        clearTimeout(window.notificationTimeout);
        window.notificationTimeout = null;
      }
      
      // Reset previous classes
      statusNotification.classList.remove('success', 'error', 'info');
      
      // Add appropriate class based on type
      statusNotification.classList.add(type);
      
      // Enhanced icons with animated effects
      const statusIcon = document.getElementById('status-icon');
      if (type === 'success') {
        statusIcon.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50; animation: pulse-success 2s infinite;"></i>';
      } else if (type === 'error') {
        statusIcon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #F44336; animation: pulse-error 2s infinite;"></i>';
      } else {
        statusIcon.innerHTML = '<i class="fas fa-info-circle" style="color: #2196F3; animation: pulse-info 2s infinite;"></i>';
      }
      
      // Ensure the notification is visible
      statusNotification.style.display = 'flex';
      
      // Improved animation handling - always reset first
      if (statusNotification.classList.contains('active')) {
        statusNotification.classList.remove('active');
        
        // Use a small delay for better visual transition
        setTimeout(() => {
          statusNotification.classList.add('active');
          setupAutoHide();
        }, 150);
      } else {
        // Show notification with slight delay for better attention grab
        setTimeout(() => {
          statusNotification.classList.add('active');
          setupAutoHide();
        }, 50);
      }
      
      // Function to handle auto-hide with extended timeout
      function setupAutoHide() {
        // Auto hide after 8 seconds for better visibility (increased from 5 seconds)
        setTimeout(() => {
          closeNotification();
        }, 8000);
      }
    }
    
    function closeNotification() {
      statusNotification.classList.remove('active');
    }
    
    // Rating System
    function showRatingModal() {
      // Reset stars
      ratingStars.forEach(star => star.classList.remove('active'));
      currentRating = 0;
      
      // Clear feedback
      ratingFeedback.value = '';
      
      // Show modal
      ratingModal.style.display = 'flex';
    }
    
    function closeRatingModal() {
      ratingModal.style.display = 'none';
    }
    
    async function submitRating() {
      if (currentRating === 0) {
        showNotification(
          currentLanguage === 'ar' ? 'ØªÙ‚ÙŠÙŠÙ… Ù…Ø·Ù„ÙˆØ¨' : 'Rating Required',
          currentLanguage === 'ar' ? "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ØªÙ‚ÙŠÙŠÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Please select a rating before submitting",
          'error'
        );
        // Add focus animation to the rating stars
        const starsContainer = document.querySelector('.rating-stars');
        starsContainer.classList.add('pulse-attention');
        setTimeout(() => starsContainer.classList.remove('pulse-attention'), 1000);
        return;
      }
      
      try {
        // Update order with rating
        await db.collection('orders').doc(currentOrderForRating).update({
          rating: currentRating,
          feedback: ratingFeedback.value.trim(),
          rated: true,
          ratedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Show notification
        showNotification(
          currentLanguage === 'ar' ? 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!' : 'Thank You!',
          currentLanguage === 'ar' 
            ? 'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ. Ù†Ù‚Ø¯Ø± Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ!' 
            : 'Thanks for your rating. We appreciate your feedback!',
          'success'
        );
        
        closeRatingModal();
      } catch (error) {
        console.error("Error submitting rating:", error);
        showNotification(
          currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' : 'Rating Error',
          currentLanguage === 'ar' ? "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…" : "There was an error while submitting your rating",
          'error'
        );
      }
    }
    
    // Admin Dashboard
    function renderAdminDashboard() {
      // Load staff accounts and table assignments
      loadStaffAccounts();
      loadTableAssignments();
      
      // Fetch stats and render charts
      db.collection('orders').get().then(snapshot => {
        const totalOrders = snapshot.size;
        let totalRating = 0;
        let ratedOrders = 0;
        let lowRatings = 0;
        
        // Prepare data for charts
        const orderStatusData = {
          pending: 0,
          preparing: 0,
          ready: 0,
          completed: 0,
          cancelled: 0
        };
        
        const ratingDistribution = [0, 0, 0, 0, 0]; // 1-5 stars
        
        snapshot.forEach(doc => {
          const order = doc.data();
          
          // Count by status
          if (orderStatusData.hasOwnProperty(order.status)) {
            orderStatusData[order.status]++;
          }
          
          // Track ratings
          if (order.rating) {
            totalRating += order.rating;
            ratedOrders++;
            
            // Count low ratings (1-2 stars)
            if (order.rating <= 2) {
              lowRatings++;
            }
            
            // Update rating distribution
            if (order.rating >= 1 && order.rating <= 5) {
              ratingDistribution[order.rating - 1]++;
            }
          }
        });
        
        // Calculate average rating
        const avgRating = ratedOrders > 0 ? (totalRating / ratedOrders).toFixed(1) : '0.0';
        
        // Update stats display
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('avg-rating').textContent = avgRating;
        document.getElementById('low-ratings').textContent = lowRatings;
        
        // Count active staff
        db.collection('staff')
          .where('active', '==', true)
          .get()
          .then(staffSnapshot => {
            document.getElementById('active-staff').textContent = staffSnapshot.size;
          });
        
        // Update charts
        updateOrdersChart(orderStatusData);
        updateRatingsChart(ratingDistribution);
      });
    }
    
    function setupCharts() {
      // Orders chart
      const ordersCtx = document.getElementById('orders-chart').getContext('2d');
      window.ordersChart = new Chart(ordersCtx, {
        type: 'bar',
        data: {
          labels: ['Pending', 'Preparing', 'Ready', 'Completed', 'Cancelled'],
          datasets: [{
            label: 'Orders by Status',
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(255, 193, 7, 0.6)',
              'rgba(33, 150, 243, 0.6)',
              'rgba(76, 175, 80, 0.6)',
              'rgba(158, 158, 158, 0.6)',
              'rgba(244, 67, 54, 0.6)'
            ],
            borderColor: [
              'rgba(255, 193, 7, 1)',
              'rgba(33, 150, 243, 1)',
              'rgba(76, 175, 80, 1)',
              'rgba(158, 158, 158, 1)',
              'rgba(244, 67, 54, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
      
      // Ratings chart
      const ratingsCtx = document.getElementById('ratings-chart').getContext('2d');
      window.ratingsChart = new Chart(ratingsCtx, {
        type: 'doughnut',
        data: {
          labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
          datasets: [{
            label: 'Rating Distribution',
            data: [0, 0, 0, 0, 0],
            backgroundColor: [
              'rgba(244, 67, 54, 0.6)',
              'rgba(255, 152, 0, 0.6)',
              'rgba(255, 235, 59, 0.6)',
              'rgba(156, 204, 101, 0.6)',
              'rgba(76, 175, 80, 0.6)'
            ],
            borderColor: [
              'rgba(244, 67, 54, 1)',
              'rgba(255, 152, 0, 1)',
              'rgba(255, 235, 59, 1)',
              'rgba(156, 204, 101, 1)',
              'rgba(76, 175, 80, 1)'
            ],
            borderWidth: 1
          }]
        }
      });
    }
    
    function updateOrdersChart(data) {
      if (window.ordersChart) {
        window.ordersChart.data.datasets[0].data = [
          data.pending,
          data.preparing,
          data.ready,
          data.completed,
          data.cancelled
        ];
        window.ordersChart.update();
      }
    }
    
    function updateRatingsChart(data) {
      if (window.ratingsChart) {
        window.ratingsChart.data.datasets[0].data = data;
        window.ratingsChart.update();
      }
    }
    
    // Load and display staff ratings feedback in the admin dashboard
    function loadStaffRatings() {
      const staffRatingsList = document.getElementById('staff-ratings-list');
      if (!staffRatingsList) return;
      
      // Clear existing content
      staffRatingsList.innerHTML = '';
      
      // Fetch ratings from Firebase, order by timestamp (newest first)
      db.collection('ratings')
        .orderBy('timestamp', 'desc')
        .limit(20) // Limit to most recent 20 ratings
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            staffRatingsList.innerHTML = '<div class="no-ratings">No customer ratings available yet.</div>';
            return;
          }
          
          snapshot.forEach(doc => {
            const rating = doc.data();
            const isLowRating = rating.rating <= 3;
            
            // Format timestamp
            let timeStr = '';
            if (rating.timestamp) {
              const timestamp = rating.timestamp.toDate();
              timeStr = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Generate star icons based on rating
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
              const starClass = i <= rating.rating ? 'fas fa-star' : 'far fa-star';
              starsHtml += `<i class="${starClass}"></i>`;
            }
            
            // Create the rating item HTML
            const ratingEl = document.createElement('div');
            ratingEl.className = `rating-item ${isLowRating ? 'low-rating' : ''}`;
            
            ratingEl.innerHTML = `
              <div class="rating-header">
                <span class="rating-staff-name">${rating.staffName || 'N/A'}</span>
                <span class="rating-stars-display ${isLowRating ? 'low-rating' : ''}">${starsHtml}</span>
              </div>
              ${rating.feedback ? `<div class="rating-feedback">"${rating.feedback}"</div>` : ''}
              <div class="rating-meta">
                <span>Table #${rating.tableNumber || 'N/A'}</span>
                <span>${timeStr}</span>
              </div>
            `;
            
            staffRatingsList.appendChild(ratingEl);
          });
        })
        .catch(error => {
          console.error("Error loading staff ratings:", error);
          staffRatingsList.innerHTML = '<div class="no-ratings">Error loading ratings. Please try again.</div>';
        });
    }
    
    // Add call to loadStaffRatings in renderAdminDashboard function
    function renderAdminDashboard() {
      // Load staff accounts and table assignments
      loadStaffAccounts();
      loadTableAssignments();
      loadStaffRatings(); // Load staff ratings
      
      // Fetch stats and render charts
      db.collection('orders').get().then(snapshot => {
        const totalOrders = snapshot.size;
        let totalRating = 0;
        let ratedOrders = 0;
        let lowRatings = 0;
        
        // Prepare data for charts
        const orderStatusData = {
          pending: 0,
          preparing: 0,
          ready: 0,
          completed: 0,
          cancelled: 0
        };
        
        const ratingDistribution = [0, 0, 0, 0, 0]; // 1-5 stars
        
        snapshot.forEach(doc => {
          const order = doc.data();
          
          // Count by status
          if (orderStatusData.hasOwnProperty(order.status)) {
            orderStatusData[order.status]++;
          }
          
          // Track ratings
          if (order.rating) {
            totalRating += order.rating;
            ratedOrders++;
            
            // Count low ratings (1-2 stars)
            if (order.rating <= 2) {
              lowRatings++;
            }
            
            // Update rating distribution
            if (order.rating >= 1 && order.rating <= 5) {
              ratingDistribution[order.rating - 1]++;
            }
          }
        });
        
        // Calculate average rating
        const avgRating = ratedOrders > 0 ? (totalRating / ratedOrders).toFixed(1) : '0.0';
        
        // Update stats display
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('avg-rating').textContent = avgRating;
        document.getElementById('low-ratings').textContent = lowRatings;
        
        // Count active staff
        db.collection('staff')
          .where('active', '==', true)
          .get()
          .then(staffSnapshot => {
            document.getElementById('active-staff').textContent = staffSnapshot.size;
          });
        
        // Update charts
        updateOrdersChart(orderStatusData);
        updateRatingsChart(ratingDistribution);
      });
    }
    
    // Load staff accounts into the UI
    function loadStaffAccounts() {
      const staffListElement = document.getElementById('staff-accounts-list');
      const staffDropdown = document.getElementById('staff-assignment');
      
      if (staffListElement) {
        staffListElement.innerHTML = '';
        
        accounts.forEach(staff => {
          if (staff.role !== 'admin') { // Don't show admin in the list
            const staffItem = document.createElement('div');
            staffItem.className = 'staff-account-item';
            staffItem.innerHTML = `
              <div class="staff-account-info">
                <div class="staff-account-name">${staff.name}</div>
                <div class="staff-account-username">@${staff.username}</div>
                <div class="staff-account-role">${staff.role.toUpperCase()}</div>
              </div>
              <div class="staff-account-actions">
                <button class="staff-action-btn edit-staff-btn" onclick="editStaffAccount('${staff.username}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="staff-action-btn delete-staff-btn" onclick="deleteStaffAccount('${staff.username}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            `;
            staffListElement.appendChild(staffItem);
          }
        });
      }
      
      if (staffDropdown) {
        // Clear all options except the first one
        while (staffDropdown.options.length > 1) {
          staffDropdown.remove(1);
        }
        
        // Add staff options to dropdown
        accounts.forEach(staff => {
          if (staff.role !== 'admin') { // Don't include admin in assignments
            const option = document.createElement('option');
            option.value = staff.username;
            option.textContent = `${staff.name} (${staff.role})`;
            staffDropdown.appendChild(option);
          }
        });
      }
    }
    
    // Function to load table assignments into the UI
    function loadTableAssignments() {
      const tableAssignmentsElement = document.getElementById('staff-table-assignments');
      
      if (tableAssignmentsElement) {
        tableAssignmentsElement.innerHTML = '';
        
        if (tableAssignments.length === 0) {
          tableAssignmentsElement.innerHTML = '<div class="no-assignments">No table assignments found</div>';
          return;
        }
        
        tableAssignments.forEach((assignment, index) => {
          const staffInfo = accounts.find(staff => staff.username === assignment.staffUsername);
          if (!staffInfo) return;
          
          const assignmentItem = document.createElement('div');
          assignmentItem.className = 'table-assignment-item';
          assignmentItem.innerHTML = `
            <div>
              <span class="table-assignment-staff">${staffInfo.name}</span>
              <span class="table-assignment-range">Tables ${assignment.startTable}-${assignment.endTable}</span>
            </div>
            <button class="delete-assignment-btn" onclick="deleteTableAssignment(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          tableAssignmentsElement.appendChild(assignmentItem);
        });
      }
    }
    
    // Function to add a new staff account
    function addStaffAccount() {
      const username = document.getElementById('new-staff-username').value.trim();
      const name = document.getElementById('new-staff-name').value.trim();
      const password = document.getElementById('new-staff-password').value.trim();
      const role = document.getElementById('new-staff-role').value;
      
      if (!username || !name || !password) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Check if username already exists
      if (accounts.some(staff => staff.username === username)) {
        showNotification('Username already exists', 'error');
        return;
      }
      
      // Add new staff account
      accounts.push({ username, name, password, role });
      
      // Update UI
      loadStaffAccounts();
      
      // Clear form
      document.getElementById('new-staff-username').value = '';
      document.getElementById('new-staff-name').value = '';
      document.getElementById('new-staff-password').value = '';
      
      showNotification('Staff account added successfully', 'success');
    }
    
    // Function to edit a staff account
    function editStaffAccount(username) {
      const staff = accounts.find(staff => staff.username === username);
      if (!staff) return;
      
      // Currently just show a notification - could be replaced with proper modal edit functionality
      showNotification('Edit staff feature coming soon', 'info');
    }
    
    // Function to delete a staff account
    function deleteStaffAccount(username) {
      const confirmDelete = confirm(`Are you sure you want to delete the staff account for ${username}?`);
      if (!confirmDelete) return;
      
      // Remove from accounts array
      const index = accounts.findIndex(staff => staff.username === username);
      if (index !== -1) {
        accounts.splice(index, 1);
      }
      
      // Remove any table assignments for this staff
      for (let i = tableAssignments.length - 1; i >= 0; i--) {
        if (tableAssignments[i].staffUsername === username) {
          tableAssignments.splice(i, 1);
        }
      }
      
      // Update UI
      loadStaffAccounts();
      loadTableAssignments();
      
      showNotification('Staff account deleted successfully', 'success');
    }
    
    // Function to assign a table range to a staff member
    function assignTableRange() {
      const staffUsername = document.getElementById('staff-assignment').value;
      const startTable = parseInt(document.getElementById('table-range-start').value);
      const endTable = parseInt(document.getElementById('table-range-end').value);
      
      if (!staffUsername) {
        showNotification('Please select a staff member', 'error');
        return;
      }
      
      if (isNaN(startTable) || isNaN(endTable) || startTable < 1 || endTable < startTable) {
        showNotification('Please enter a valid table range', 'error');
        return;
      }
      
      // Check for overlapping table ranges
      const hasOverlap = tableAssignments.some(assignment => {
        return (
          (startTable >= assignment.startTable && startTable <= assignment.endTable) ||
          (endTable >= assignment.startTable && endTable <= assignment.endTable) ||
          (startTable <= assignment.startTable && endTable >= assignment.endTable)
        );
      });
      
      if (hasOverlap) {
        showNotification('Table range overlaps with an existing assignment', 'error');
        return;
      }
      
      // Add new assignment
      tableAssignments.push({ staffUsername, startTable, endTable });
      
      // Update UI
      loadTableAssignments();
      
      showNotification('Table range assigned successfully', 'success');
    }
    
    // Function to delete a table assignment
    function deleteTableAssignment(index) {
      const assignment = tableAssignments[index];
      if (!assignment) return;
      
      const staffInfo = accounts.find(staff => staff.username === assignment.staffUsername);
      const confirmDelete = confirm(`Are you sure you want to remove table assignment (Tables ${assignment.startTable}-${assignment.endTable}) from ${staffInfo ? staffInfo.name : assignment.staffUsername}?`);
      
      if (!confirmDelete) return;
      
      tableAssignments.splice(index, 1);
      loadTableAssignments();
      
      showNotification('Table assignment removed successfully', 'success');
    }
    
    // Function to check which staff member is assigned to a table
    // This function is a duplicate and has been merged with the earlier implementation
    
    // Function to update tables display in staff view
    function updateTablesDisplay() {
      console.log("Updating tables display");
      const tablesContainer = document.getElementById('occupied-tables-container');
      if (!tablesContainer) return;
      
      // Clear existing content
      tablesContainer.innerHTML = '';
      
      // Create an element to show total number of occupied tables
      const occupiedTablesCount = document.createElement('div');
      occupiedTablesCount.className = 'occupied-tables-count';
      occupiedTablesCount.innerHTML = `
        <span style="font-weight: bold; margin-bottom: 10px; display: block; text-align: center; color: var(--light-cream); background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px;">
          <i class="fas fa-utensils"></i> ${currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©' : 'Occupied Tables'}: 
          <span style="color: var(--gold);">${occupiedTables.size}</span>
        </span>
      `;
      tablesContainer.appendChild(occupiedTablesCount);
      
      // Get current staff username if we're in staff view
      const currentStaffUsername = userType === 'staff' ? localStorage.getItem('username') : null;
      
      // Filter for tables assigned to current staff member if we're in staff view
      let tablesToShow = [];
      
      if (userType === 'staff' && currentStaffUsername) {
        // Get table assignments for this staff member
        const staffAssignments = tableAssignments.filter(a => a.staffUsername === currentStaffUsername);
        
        // Create an array of all table numbers assigned to this staff member
        const assignedTables = [];
        staffAssignments.forEach(assignment => {
          for (let t = assignment.startTable; t <= assignment.endTable; t++) {
            assignedTables.push(t);
          }
        });
        
        // Filter occupied tables to only show those assigned to this staff
        tablesToShow = Array.from(occupiedTables).filter(tableNum => 
          assignedTables.includes(parseInt(tableNum))
        ).sort((a, b) => a - b);
        
        // Show message if no tables assigned
        if (tablesToShow.length === 0) {
          const noTablesMsg = document.createElement('div');
          noTablesMsg.className = 'no-tables-message';
          noTablesMsg.innerHTML = `
            <p style="text-align: center; color: var(--light-cream); padding: 20px;">
              ${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ø´ØºÙˆÙ„Ø© Ù…Ø®ØµØµØ© Ù„Ùƒ' : 'No occupied tables assigned to you'}
            </p>
          `;
          tablesContainer.appendChild(noTablesMsg);
          return;
        }
      } else {
        // For admin view, show all occupied tables
        tablesToShow = Array.from(occupiedTables).sort((a, b) => a - b);
        
        // Show message if no tables occupied
        if (tablesToShow.length === 0) {
          const noTablesMsg = document.createElement('div');
          noTablesMsg.className = 'no-tables-message';
          noTablesMsg.innerHTML = `
            <p style="text-align: center; color: var(--light-cream); padding: 20px;">
              ${currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ø´ØºÙˆÙ„Ø©' : 'No occupied tables'}
            </p>
          `;
          tablesContainer.appendChild(noTablesMsg);
          return;
        }
      }
      
      // Display tables
      tablesToShow.forEach(tableNum => {
        const tableCard = document.createElement('div');
        tableCard.className = 'table-card';
        tableCard.dataset.tableNumber = tableNum;
        
        // Get table details
        const details = tableDetails[tableNum] || { orders: [] };
        const hasOrders = details.orders && details.orders.length > 0;
        
        // Get staff assigned to this table
        const assignedStaff = getStaffForTable(tableNum);
        const staffInfo = assignedStaff ? 
          `<p class="assigned-staff">
            <span class="staff-label">${currentLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ¸Ù:' : 'Staff:'}</span>
            <span class="staff-name ${assignedStaff.role}">${assignedStaff.name}</span>
          </p>` : '';
        
        // Get status based on orders
        let statusText = currentLanguage === 'ar' ? 'Ù…Ø´ØºÙˆÙ„Ø©' : 'OCCUPIED';
        let statusClass = 'status-occupied';
        
        if (hasOrders) {
          const latestOrder = details.orders[0];
          if (latestOrder.status === 'ready') {
            statusText = currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…' : 'READY TO SERVE';
            statusClass = 'status-ready';
          } else if (latestOrder.status === 'preparing') {
            statusText = currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'PREPARING';
            statusClass = 'status-preparing';
          }
        }
        
        tableCard.innerHTML = `
          <div class="table-card-header">
            <h3>TABLE ${tableNum}</h3>
            <span class="table-status ${statusClass}">
              ${statusText}
            </span>
          </div>
          <div class="table-card-content">
            <div class="table-info">
              <p>${currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Orders'}: 
                <span>${hasOrders ? details.orders.length : 0}</span>
              </p>
              ${staffInfo}
              <p>${currentLanguage === 'ar' ? 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«' : 'Last Updated'}: 
                <span>${hasOrders ? '5 ' + (currentLanguage === 'ar' ? 'Ø¯Ù‚Ø§Ø¦Ù‚' : 'mins') + ' ' + (currentLanguage === 'ar' ? 'Ù…Ø¶Øª' : 'ago') : '-'}</span>
              </p>
            </div>
            <button class="view-table-details-btn" onclick="viewTableDetails(${tableNum})">
              ${currentLanguage === 'ar' ? 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'VIEW DETAILS'}
            </button>
          </div>
        `;
        
        tablesContainer.appendChild(tableCard);
      });
    }
    
    // Apply discount
    function applyDiscount() {
      const code = discountCodeInput.value.trim();
      
      if (!code) {
        showNotification(
          currentLanguage === 'ar' ? 'Ø±Ù…Ø² Ù…Ø·Ù„ÙˆØ¨' : 'Code Required',
          currentLanguage === 'ar' ? "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ… Ù‚Ø¨Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" : "Please enter a discount code before applying",
          'error'
        );
        
        // Add focus animation on the input
        discountCodeInput.classList.add('input-error');
        setTimeout(() => discountCodeInput.classList.remove('input-error'), 600);
        discountCodeInput.focus();
        return;
      }
      
      // In a real application, this would validate the code and apply discount
      // For demo, we'll just show a notification
      showNotification(
        currentLanguage === 'ar' ? 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…' : 'Discount Applied',
        currentLanguage === 'ar' 
          ? `ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø±Ù…Ø² Ø§Ù„Ø®ØµÙ… ${code} Ø¨Ù†Ø¬Ø§Ø­` 
          : `Discount code ${code} has been applied successfully`,
        'success'
      );
    }
    
    // Admin Tabs Navigation
    function switchAdminTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`${tabName}-content`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // If analytics tab is selected, initialize the analytics charts
      if (tabName === 'analytics') {
        initializeAnalytics();
      }
    }
    
    // Initialize Advanced Analytics Dashboard
    function initializeAnalytics() {
      // Draw all charts
      drawSalesChart();
      drawMenuPerformanceChart();
      drawSatisfactionChart();
      drawTableUtilizationChart();
      drawStaffPerformanceChart();
      drawMarketingChart();
      
      // Get insights from data
      updateAnalyticsInsights();
    }
    
    // Update analytics based on selected time range
    function updateAnalytics() {
      const timeRange = document.getElementById('time-range').value;
      console.log(`Updating analytics for time range: ${timeRange}`);
      
      // Redraw all charts with the new time range
      drawSalesChart(timeRange);
      drawMenuPerformanceChart(timeRange);
      drawSatisfactionChart(timeRange);
      drawTableUtilizationChart(timeRange);
      drawStaffPerformanceChart(timeRange);
      drawMarketingChart(timeRange);
      
      // Update insights based on new data
      updateAnalyticsInsights(timeRange);
      
      // Show notification that data has been updated
      showNotification(
        'Analytics Updated',
        `Data has been refreshed for ${timeRange === 'day' ? 'today' : 
          timeRange === 'week' ? 'this week' : 
          timeRange === 'month' ? 'this month' : 'this year'}`,
        'info'
      );
    }
    
    // Export analytics data to CSV
    function exportAnalyticsData(dataType) {
      console.log(`Exporting ${dataType} data`);
      
      // Show notification that export is in progress
      showNotification(
        'Export Started',
        `Preparing ${dataType} data for export. Download will begin shortly.`,
        'info'
      );
      
      // Simulate download delay
      setTimeout(() => {
        // In a real application, this would generate and download a CSV file
        // For demo purposes, we'll just show a notification
        showNotification(
          'Export Complete',
          `${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data has been exported successfully.`,
          'success'
        );
      }, 1500);
    }
    
    // Toggle between different chart views (line/bar/pie)
    function toggleChartView(chartType) {
      console.log(`Toggling chart view for ${chartType}`);
      
      // Simulate chart type change
      showNotification(
        'Chart View Changed',
        `Chart visualization has been updated.`,
        'info'
      );
      
      // In a real implementation, this would change the chart type
      // For demo, we'll just redraw the current chart
      if (chartType === 'sales') {
        drawSalesChart();
      }
    }
    
    // Draw Sales Performance Chart
    function drawSalesChart(timeRange = 'week') {
      const ctx = document.getElementById('sales-performance-chart').getContext('2d');
      
      // Get data based on time range
      const labels = getTimeLabels(timeRange);
      const data = generateRandomData(labels.length, 500, 1500);
      
      if (window.salesChart) {
        window.salesChart.destroy();
      }
      
      window.salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sales ($)',
            data: data,
            fill: true,
            backgroundColor: 'rgba(212, 175, 55, 0.2)',
            borderColor: 'rgba(212, 175, 55, 1)',
            tension: 0.4,
            pointBackgroundColor: 'rgba(212, 175, 55, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: 'rgba(245, 245, 220, 0.8)'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              borderColor: 'rgba(212, 175, 55, 0.5)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            },
            x: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Menu Performance Chart
    function drawMenuPerformanceChart(timeRange = 'week') {
      const ctx = document.getElementById('menu-performance-chart').getContext('2d');
      
      // Menu items data
      const data = {
        labels: ['Margherita Pizza', 'Pepperoni Pizza', 'Fettuccine Alfredo', 'Caesar Salad', 'Tiramisu'],
        values: [24, 19, 15, 12, 8]
      };
      
      if (window.menuChart) {
        window.menuChart.destroy();
      }
      
      window.menuChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              'rgba(212, 175, 55, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: 'rgba(245, 245, 220, 0.8)',
                padding: 10,
                font: {
                  size: 10
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}%`;
                }
              }
            }
          }
        }
      });
    }
    
    // Draw Customer Satisfaction Chart
    function drawSatisfactionChart(timeRange = 'week') {
      const ctx = document.getElementById('satisfaction-chart').getContext('2d');
      
      // Rating distribution
      const data = {
        labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
        values: [65, 20, 10, 3, 2]
      };
      
      if (window.satisfactionChart) {
        window.satisfactionChart.destroy();
      }
      
      window.satisfactionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Ratings',
            data: data.values,
            backgroundColor: [
              'rgba(46, 125, 50, 0.8)',
              'rgba(56, 142, 60, 0.8)',
              'rgba(251, 192, 45, 0.8)',
              'rgba(245, 124, 0, 0.8)',
              'rgba(211, 47, 47, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.parsed.x}% of ratings`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            },
            y: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Table Utilization Chart
    function drawTableUtilizationChart(timeRange = 'week') {
      const ctx = document.getElementById('table-utilization-chart').getContext('2d');
      
      // Table utilization data
      const data = {
        labels: ['Table 1-4', 'Table 5-8', 'Table 9-12', 'Table 13-16'],
        values: [70, 90, 60, 40]
      };
      
      if (window.tableChart) {
        window.tableChart.destroy();
      }
      
      window.tableChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Utilization %',
            data: data.values,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)',
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(245, 245, 220, 0.1)'
              },
              ticks: {
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          }
        }
      });
    }
    
    // Draw Staff Performance Chart
    function drawStaffPerformanceChart(timeRange = 'week') {
      const ctx = document.getElementById('staff-performance-chart').getContext('2d');
      
      // Staff performance data
      const data = {
        labels: ['Sarah', 'John', 'Ahmad', 'Maria'],
        ratings: [4.9, 4.5, 4.7, 4.6],
        ordersHandled: [45, 38, 42, 30]
      };
      
      if (window.staffChart) {
        window.staffChart.destroy();
      }
      
      window.staffChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Customer Rating', 'Speed', 'Orders Handled', 'Accuracy', 'Teamwork'],
          datasets: [
            {
              label: 'Sarah',
              data: [98, 85, 90, 95, 88],
              fill: true,
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgb(255, 99, 132)',
              pointBackgroundColor: 'rgb(255, 99, 132)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(255, 99, 132)'
            },
            {
              label: 'John',
              data: [90, 92, 82, 89, 95],
              fill: true,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgb(54, 162, 235)',
              pointBackgroundColor: 'rgb(54, 162, 235)',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: 'rgb(54, 162, 235)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: {
                color: 'rgba(245, 245, 220, 0.2)'
              },
              grid: {
                color: 'rgba(245, 245, 220, 0.2)'
              },
              pointLabels: {
                color: 'rgba(245, 245, 220, 0.7)',
                font: {
                  size: 10
                }
              },
              ticks: {
                backdropColor: 'transparent',
                color: 'rgba(245, 245, 220, 0.6)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'rgba(245, 245, 220, 0.8)'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)'
            }
          }
        }
      });
    }
    
    // Draw Marketing Chart
    function drawMarketingChart(timeRange = 'week') {
      const ctx = document.getElementById('marketing-chart').getContext('2d');
      
      // Order sources data
      const data = {
        labels: ['AR Menu View', 'Regular Menu', 'Repeat Customers', 'Recommendations', 'Social Media'],
        values: [35, 25, 20, 15, 5]
      };
      
      if (window.marketingChart) {
        window.marketingChart.destroy();
      }
      
      window.marketingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: [
              'rgba(212, 175, 55, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)'
            ],
            borderColor: 'rgba(245, 245, 220, 0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: 'rgba(245, 245, 220, 0.8)',
                padding: 15,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 58, 47, 0.9)',
              titleColor: 'rgba(212, 175, 55, 1)',
              bodyColor: 'rgba(245, 245, 220, 0.8)',
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed}%`;
                }
              }
            }
          }
        }
      });
    }
    
    // Update analytics insights
    function updateAnalyticsInsights(timeRange = 'week') {
      // In a real application, these would be calculated from data
      // For demo purposes, these are static
      
      const insights = {
        en: {
          sales: {
            day: 'Today\'s sales are up 8% compared to yesterday with peak time at lunch',
            week: 'Sales are up 12% compared to last week with peak hours between 12-2pm',
            month: 'This month shows 15% growth over last month with weekends being strongest',
            year: 'Annual growth is at 23% with Q2 showing best performance'
          },
          menu: {
            day: 'Today\'s top seller is Pepperoni Pizza at 28% of orders',
            week: 'Margherita Pizza is your top seller with 24% of sales this week',
            month: 'Fettuccine Alfredo has grown 18% in popularity this month',
            year: 'Pizza remains your top category representing 45% of annual revenue'
          },
          satisfaction: {
            day: 'Today\'s average rating is 4.7/5 stars from 25 reviews',
            week: '85% of customers rated their experience 4+ stars this week',
            month: 'Customer satisfaction has improved 7% this month over last month',
            year: 'Annual satisfaction rate is 4.6/5, a 9% improvement over last year'
          },
          table: {
            day: 'Today tables 9-12 have the highest turnover rate at 4.1 hours',
            week: 'Tables 5-8 have highest turnover rate at 3.2 hours avg this week',
            month: 'Monthly data shows weekend tables are 35% more efficient than weekdays',
            year: 'Annual data shows 6pm-8pm as your most efficient service time'
          },
          staff: {
            day: 'Today Ahmad is the top performer with 4.9/5 from customers',
            week: 'Sarah has the highest customer satisfaction score at 4.9/5 this week',
            month: 'John has shown the most improvement this month, up 12%',
            year: 'Sarah is your top annual performer with 4.8/5 average rating'
          },
          marketing: {
            day: 'Today AR menu users spent 22% more than regular menu users',
            week: 'AR menu visualization increases average order value by 18% this week',
            month: 'Social media referrals have increased 15% this month',
            year: 'AR menu visualization has driven a 25% increase in dessert orders annually'
          }
        },
        ar: {
          sales: {
            day: 'Ø²Ø§Ø¯Øª Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø³Ø¨Ø© 8Ùª Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ù…Ø³ Ù…Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø°Ø±ÙˆØ© ÙÙŠ ÙˆÙ‚Øª Ø§Ù„ØºØ¯Ø§Ø¡',
            week: 'Ø²Ø§Ø¯Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ù†Ø³Ø¨Ø© 12Ùª Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ Ù…Ø¹ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© Ø¨ÙŠÙ† 12-2 Ù…Ø³Ø§Ø¡Ù‹',
            month: 'ÙŠÙØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù†Ù…ÙˆÙ‹Ø§ Ø¨Ù†Ø³Ø¨Ø© 15Ùª Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ Ù…Ø¹ Ø¹Ø·Ù„Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£Ù‚ÙˆÙ‰',
            year: 'Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù‡Ùˆ 23Ùª Ù…Ø¹ Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠØ¸Ù‡Ø± Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡'
          },
          menu: {
            day: 'Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø¨ÙŠØªØ²Ø§ Ø¨ÙŠØ¨Ø±ÙˆÙ†ÙŠ Ø¨Ù†Ø³Ø¨Ø© 28Ùª Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
            week: 'Ø¨ÙŠØªØ²Ø§ Ù…Ø§Ø±ØºØ±ÙŠØªØ§ Ù‡ÙŠ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§ Ø¨Ù†Ø³Ø¨Ø© 24Ùª Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            month: 'Ù†Ù…Øª Ø´Ø¹Ø¨ÙŠØ© ÙÙŠØªÙˆØªØ´ÙŠÙ†ÙŠ Ø£Ù„ÙØ±ÙŠØ¯Ùˆ Ø¨Ù†Ø³Ø¨Ø© 18Ùª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
            year: 'ØªØ¸Ù„ Ø§Ù„Ø¨ÙŠØªØ²Ø§ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„ØªÙŠ ØªÙ…Ø«Ù„ 45Ùª Ù…Ù† Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ©'
          },
          satisfaction: {
            day: 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ 4.7/5 Ù†Ø¬ÙˆÙ… Ù…Ù† 25 Ù…Ø±Ø§Ø¬Ø¹Ø©',
            week: '85Ùª Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù‚ÙŠÙ…ÙˆØ§ ØªØ¬Ø±Ø¨ØªÙ‡Ù… Ø¨Ù€ 4+ Ù†Ø¬ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            month: 'ØªØ­Ø³Ù† Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ù†Ø³Ø¨Ø© 7Ùª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ',
            year: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¶Ø§ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù‡Ùˆ 4.6/5ØŒ Ø¨ØªØ­Ø³Ù† 9Ùª Ø¹Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠ'
          },
          table: {
            day: 'Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª 9-12 Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ 4.1 Ø³Ø§Ø¹Ø§Øª',
            week: 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª 5-8 Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø¯ÙˆØ±Ø§Ù† Ø¨Ù…ØªÙˆØ³Ø· 3.2 Ø³Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            month: 'ØªÙØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø£Ù† Ø·Ø§ÙˆÙ„Ø§Øª Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø© Ø¨Ù†Ø³Ø¨Ø© 35Ùª Ù…Ù† Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            year: 'ØªÙØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø£Ù† 6 Ù…Ø³Ø§Ø¡Ù‹ - 8 Ù…Ø³Ø§Ø¡Ù‹ Ù‡Ùˆ ÙˆÙ‚Øª Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø©'
          },
          staff: {
            day: 'Ø§Ù„ÙŠÙˆÙ… Ø£Ø­Ù…Ø¯ Ù‡Ùˆ Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡Ù‹ Ø¨ØªÙ‚ÙŠÙŠÙ… 4.9/5 Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',
            week: 'Ø³Ø§Ø±Ø© Ù„Ø¯ÙŠÙ‡Ø§ Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø±Ø¶Ø§ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ 4.9/5 Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            month: 'Ø£Ø¸Ù‡Ø± Ø¬ÙˆÙ† Ø£ÙƒØ¨Ø± ØªØ­Ø³Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŒ Ø¨Ø²ÙŠØ§Ø¯Ø© 12Ùª',
            year: 'Ø³Ø§Ø±Ø© Ù‡ÙŠ Ø£ÙØ¶Ù„ Ù…ÙˆØ¸Ù Ø³Ù†ÙˆÙŠ Ø¨Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… 4.8/5'
          },
          marketing: {
            day: 'Ø§Ù„ÙŠÙˆÙ… Ø£Ù†ÙÙ‚ Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² 22Ùª Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©',
            week: 'ØªØµÙˆØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² ÙŠØ²ÙŠØ¯ Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø³Ø¨Ø© 18Ùª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            month: 'Ø²Ø§Ø¯Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ù…Ù† ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø¨Ù†Ø³Ø¨Ø© 15Ùª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
            year: 'Ø£Ø¯Ù‰ ØªØµÙˆØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø² Ø¥Ù„Ù‰ Ø²ÙŠØ§Ø¯Ø© Ø¨Ù†Ø³Ø¨Ø© 25Ùª ÙÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª Ø³Ù†ÙˆÙŠÙ‹Ø§'
          }
        }
      };
      
      // Get the current language
      const lang = currentLanguage || 'en';
      
      // Update insights based on time range and language
      document.getElementById('sales-insight').innerText = insights[lang].sales[timeRange];
      document.getElementById('menu-insight').innerText = insights[lang].menu[timeRange];
      document.getElementById('satisfaction-insight').innerText = insights[lang].satisfaction[timeRange];
      document.getElementById('table-insight').innerText = insights[lang].table[timeRange];
      document.getElementById('staff-insight').innerText = insights[lang].staff[timeRange];
      document.getElementById('marketing-insight').innerText = insights[lang].marketing[timeRange];
    }
    
    // Helper function to get time labels based on time range
    function getTimeLabels(timeRange) {
      switch(timeRange) {
        case 'day':
          return ['9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', '9PM'];
        case 'week':
          return ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        case 'month':
          return ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
        case 'year':
          return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        default:
          return ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      }
    }
    
    // Helper function to generate random data for demo
    function generateRandomData(length, min, max) {
      return Array.from({length: length}, () => Math.floor(Math.random() * (max - min + 1) + min));
    }
    
    // Function to add a demo order to client list (for offline mode)
    function addDemoOrderToClientList(order) {
      if (!clientOrdersList) return;
      
      // Make sure we don't duplicate demo orders
      if (document.getElementById(`order-item-${order.id}`)) {
        return;
      }
      
      const orderItem = document.createElement('div');
      orderItem.className = 'client-order-item';
      orderItem.id = `order-item-${order.id}`;
      
      // Format date
      const orderDate = order.timestamp.toDate ? order.timestamp.toDate() : order.timestamp;
      const formattedDate = new Intl.DateTimeFormat(currentLanguage === 'ar' ? 'ar-SA' : 'en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).format(orderDate);
      
      const statusClass = {
        'pending': 'status-pending',
        'preparing': 'status-preparing',
        'ready': 'status-ready',
        'completed': 'status-completed',
        'cancelled': 'status-cancelled'
      }[order.status] || 'status-pending';
      
      const statusText = {
        'pending': currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Pending',
        'preparing': currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±' : 'Preparing',
        'ready': currentLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø²' : 'Ready',
        'completed': currentLanguage === 'ar' ? 'Ù…ÙƒØªÙ…Ù„' : 'Completed',
        'cancelled': currentLanguage === 'ar' ? 'Ù…Ù„ØºÙ‰' : 'Cancelled'
      }[order.status] || (currentLanguage === 'ar' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Pending');
      
      // Create order summary text
      let orderSummary = '';
      if (order.items && order.items.length > 0) {
        orderSummary = order.items.map(item => item.name).join(', ');
      }
      
      // Add a "Rate this order" button for completed orders
      let rateButton = '';
      if (order.status === 'completed' && !order.rating) {
        rateButton = `
          <button class="rate-btn" data-order-id="${order.id}">
            ${currentLanguage === 'ar' ? 'Ù‚ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨' : 'Rate this order'}
          </button>
        `;
      }
      
      // Show the rating if available
      let ratingDisplay = '';
      if (order.rating) {
        ratingDisplay = `
          <div class="order-rating">
            ${currentLanguage === 'ar' ? 'ØªÙ‚ÙŠÙŠÙ…Ùƒ:' : 'Your rating:'} 
            ${Array(5).fill(0).map((_, i) => 
              i < order.rating ? 
                '<span class="rating-star-small active">â˜…</span>' : 
                '<span class="rating-star-small">â˜…</span>'
            ).join('')}
          </div>
        `;
      }
      
      orderItem.innerHTML = `
        <div class="order-header">
          <div class="order-time">${formattedDate}</div>
          <div class="order-status ${statusClass}">${statusText}</div>
        </div>
        <div class="order-details">
          <div class="order-table">${currentLanguage === 'ar' ? 'Ø§Ù„Ø·Ø§ÙˆÙ„Ø©:' : 'Table:'} ${order.tableNumber}</div>
          <div class="order-summary">${orderSummary}</div>
          ${rateButton}
          ${ratingDisplay}
        </div>
      `;
      
      clientOrdersList.appendChild(orderItem);
      
      // Add event listener to rate button
      const rateBtnEl = orderItem.querySelector('.rate-btn');
      if (rateBtnEl) {
        rateBtnEl.addEventListener('click', () => {
          // Show rating modal
          currentOrderForRating = order.id;
          ratingModal.classList.add('active');
          
          // Reset rating
          currentRating = 0;
          ratingStars.forEach(s => s.classList.remove('active'));
          ratingFeedback.value = '';
        });
      }
    }
  </script>
  
  <!-- Rating Dialog Modal -->
  <div class="rating-modal" id="rating-modal">
    <div class="rating-content">
      <h3 class="rating-title" id="rating-title">RATE YOUR EXPERIENCE</h3>
      
      <div class="rating-stars">
        <span class="rating-star" data-rating="1">â˜…</span>
        <span class="rating-star" data-rating="2">â˜…</span>
        <span class="rating-star" data-rating="3">â˜…</span>
        <span class="rating-star" data-rating="4">â˜…</span>
        <span class="rating-star" data-rating="5">â˜…</span>
      </div>
      
      <div class="feedback-container" id="feedback-container" style="display: none;">
        <label for="feedback-text" id="feedback-label">FEEDBACK (OPTIONAL)</label>
        <textarea id="feedback-text" rows="3" placeholder="Please let us know how we can improve"></textarea>
      </div>
      
      <input type="hidden" id="rating-order-id">
      <input type="hidden" id="rating-staff-name">
      
      <div class="modal-buttons">
        <button id="submit-rating-btn" onclick="submitRating()">SUBMIT</button>
        <button id="cancel-rating-btn" onclick="closeRatingDialog()">CANCEL</button>
      </div>
    </div>
  </div>
</body>
</html>
