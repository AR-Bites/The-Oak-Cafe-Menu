<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Oak Cafe Menu</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap');
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9f5f0;
      color: #333;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Playfair Display', serif;
    }
    
    .menu-section {
      transition: all 0.3s ease;
    }
    
    .menu-item {
      transition: transform 0.2s;
    }
    
    .menu-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .table-number {
      transition: all 0.3s ease;
    }
    
    .table-number:hover {
      background-color: #4e342e;
    }
    
    .cart-item {
      animation: fadeIn 0.5s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #d4a373;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .order-btn {
      transition: all 0.3s ease;
    }
    
    .order-btn:hover {
      transform: scale(1.05);
    }
    
    .order-status {
      transition: all 0.3s ease;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="bg-[#5c4033] text-white py-4 sticky top-0 z-10 shadow-md">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold">The Oak Cafe</h1>
      <div class="flex items-center space-x-4">
        <button id="tableBtn" class="text-sm bg-[#8b5a2b] hover:bg-[#6b4423] py-2 px-3 rounded-full">
          Table: <span id="tableNumber">Select</span>
        </button>
        <div class="relative">
          <button id="cartBtn" class="flex items-center bg-[#d4a373] hover:bg-[#c49262] py-2 px-4 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="hidden md:inline">Cart</span>
            <span id="cartBadge" class="badge hidden">0</span>
          </button>
        </div>
        <button id="orderStatusBtn" class="hidden text-sm bg-[#8b5a2b] hover:bg-[#6b4423] py-2 px-3 rounded-full">
          View Order
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Category Navigation -->
    <div class="flex overflow-x-auto space-x-4 pb-4 mb-8 sticky top-16 bg-[#f9f5f0] z-10 pt-4">
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-[#5c4033] text-white rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="all">All</button>
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-white hover:bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="Starters">Starters</button>
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-white hover:bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="Pizza">Pizza</button>
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-white hover:bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="Pasta">Pasta</button>
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-white hover:bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="Dessert">Desserts</button>
      <button class="category-btn flex-shrink-0 px-4 py-2 bg-white hover:bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]" data-category="Drinks">Drinks</button>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="flex flex-col items-center justify-center py-20">
      <div class="w-12 h-12 border-4 border-[#d4a373] border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-lg text-gray-600">Loading menu items...</p>
    </div>

    <!-- Menu Items Grid -->
    <div id="menuContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
      <!-- Menu items will be populated here -->
    </div>
  </main>

  <!-- Table Selection Modal -->
  <div id="tableModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-[#5c4033]">Select Your Table</h2>
      <p class="text-gray-600 mb-6">Please select your table number to proceed with your order.</p>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="1">1</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="2">2</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="3">3</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="4">4</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="5">5</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="6">6</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="7">7</button>
        <button class="table-number bg-[#5c4033] hover:bg-[#4e342e] text-white font-bold py-6 rounded-lg" data-table="8">8</button>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50 hidden">
    <div class="bg-white rounded-t-lg md:rounded-lg p-6 w-full max-w-md md:max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-[#5c4033]">Your Cart</h2>
        <button id="closeCartBtn" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="cartItems" class="mb-6 divide-y divide-gray-200">
        <!-- Cart items will be populated here -->
        <p id="emptyCart" class="py-8 text-center text-gray-500">Your cart is empty</p>
      </div>
      <div id="cartTotal" class="font-bold text-xl mb-6 text-right">Total: $0.00</div>
      <div class="flex flex-col space-y-3">
        <button id="placeOrderBtn" class="bg-[#5c4033] hover:bg-[#4e342e] text-white py-3 rounded-lg font-medium order-btn disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Place Order
        </button>
        <button id="clearCartBtn" class="border border-red-500 text-red-500 hover:bg-red-50 py-2 rounded-lg">
          Clear Cart
        </button>
      </div>
    </div>
  </div>

  <!-- Order Status Modal -->
  <div id="orderStatusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end md:items-center justify-center z-50 hidden">
    <div class="bg-white rounded-t-lg md:rounded-lg p-6 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-[#5c4033]">Order Status</h2>
        <button id="closeOrderStatusBtn" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="mb-6">
        <div id="orderNumber" class="text-lg font-medium mb-2">Order #12345</div>
        <div id="orderStatus" class="mb-4">
          <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium order-status">
            Preparing
          </span>
        </div>
        <div class="divide-y divide-gray-200">
          <div class="py-4">
            <div class="font-medium">Estimated wait time:</div>
            <div id="estimatedTime" class="text-gray-600">15-20 minutes</div>
          </div>
          <div class="py-4">
            <div class="font-medium mb-2">Order Items:</div>
            <ul id="orderItems" class="space-y-2 text-gray-600">
              <!-- Order items will be populated here -->
            </ul>
          </div>
        </div>
      </div>
      <div id="cancelOrderContainer" class="mb-4">
        <button id="cancelOrderBtn" class="w-full border border-red-500 text-red-500 hover:bg-red-50 py-2 rounded-lg">
          Cancel Order
        </button>
      </div>
      <div class="text-center text-gray-500 text-sm">
        Thank you for dining with us!
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
    Item added to cart!
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAUCymhsmIx4IOkHphEFpLEhfLnPk0iPhU",
      authDomain: "the-oak-cafe-menu.firebaseapp.com",
      projectId: "the-oak-cafe-menu",
      storageBucket: "the-oak-cafe-menu.firebasestorage.app",
      messagingSenderId: "69318608602",
      appId: "1:69318608602:web:e13a53b0e7d674522647e3",
      measurementId: "G-8BNCQ270K7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // App State
    let menuItems = [];
    let cartItems = [];
    let currentOrder = null;
    let selectedTable = null;
    let cancelTimerId = null;

    // DOM Elements
    const menuContainer = document.getElementById('menuContainer');
    const loading = document.getElementById('loading');
    const tableModal = document.getElementById('tableModal');
    const cartModal = document.getElementById('cartModal');
    const orderStatusModal = document.getElementById('orderStatusModal');
    const tableNumber = document.getElementById('tableNumber');
    const tableBtn = document.getElementById('tableBtn');
    const cartBtn = document.getElementById('cartBtn');
    const cartBadge = document.getElementById('cartBadge');
    const closeCartBtn = document.getElementById('closeCartBtn');
    const cartItems_el = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const emptyCart = document.getElementById('emptyCart');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const orderStatusBtn = document.getElementById('orderStatusBtn');
    const closeOrderStatusBtn = document.getElementById('closeOrderStatusBtn');
    const orderNumber_el = document.getElementById('orderNumber');
    const orderStatus_el = document.getElementById('orderStatus');
    const estimatedTime = document.getElementById('estimatedTime');
    const orderItems_el = document.getElementById('orderItems');
    const cancelOrderBtn = document.getElementById('cancelOrderBtn');
    const cancelOrderContainer = document.getElementById('cancelOrderContainer');
    const categoryButtons = document.querySelectorAll('.category-btn');
    const notification = document.getElementById('notification');

    // Initialize the app
    document.addEventListener('DOMContentLoaded', initialize);

    function initialize() {
      // Show table selection modal on load
      showTableModal();
      
      // Fetch menu items
      fetchMenuItems();
      
      // Set up event listeners
      setupEventListeners();
    }

    function fetchMenuItems() {
      db.collection('menuItems').get()
        .then(snapshot => {
          if (snapshot.empty) {
            addSampleMenuItems().then(() => fetchMenuItems());
            return;
          }

          menuItems = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          renderMenuItems('all');
          loading.classList.add('hidden');
          menuContainer.classList.remove('hidden');
        })
        .catch(error => {
          console.error("Error fetching menu items:", error);
          // Fallback to local data if Firebase not accessible
          useSampleMenuItems();
        });
    }

    function useSampleMenuItems() {
      menuItems = [
        {
          id: '1',
          name: 'Margherita Pizza',
          description: 'Classic pizza with tomato sauce, mozzarella, and basil',
          price: 1299,
          category: 'Pizza',
          imageUrl: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002',
          isPopular: true,
          isAvailable: true
        },
        {
          id: '2',
          name: 'Pepperoni Pizza',
          description: 'Pizza topped with pepperoni slices and cheese',
          price: 1499,
          category: 'Pizza',
          imageUrl: 'https://images.unsplash.com/photo-1628840042765-356cda07504e',
          isPopular: true,
          isAvailable: true
        },
        {
          id: '3',
          name: 'Caprese Salad',
          description: 'Fresh tomatoes, mozzarella, and basil with balsamic glaze',
          price: 899,
          category: 'Starters',
          imageUrl: 'https://images.unsplash.com/photo-1592417817098-8fd3d9eb14a5',
          isPopular: false,
          isAvailable: true
        },
        {
          id: '4',
          name: 'Bruschetta',
          description: 'Toasted bread topped with tomatoes, garlic, and basil',
          price: 799,
          category: 'Starters',
          imageUrl: 'https://images.unsplash.com/photo-1572695157366-5e585ab2b69f',
          isPopular: true,
          isAvailable: true
        },
        {
          id: '5',
          name: 'Spaghetti Carbonara',
          description: 'Pasta with eggs, cheese, pancetta, and black pepper',
          price: 1599,
          category: 'Pasta',
          imageUrl: 'https://images.unsplash.com/photo-1600803907087-f56d462fd26b',
          isPopular: true,
          isAvailable: true
        },
        {
          id: '6',
          name: 'Fettuccine Alfredo',
          description: 'Pasta in creamy parmesan sauce',
          price: 1499,
          category: 'Pasta',
          imageUrl: 'https://images.unsplash.com/photo-1645112411341-6c4fd023882c',
          isPopular: false,
          isAvailable: true
        },
        {
          id: '7',
          name: 'Tiramisu',
          description: 'Classic Italian dessert with coffee and mascarpone',
          price: 899,
          category: 'Dessert',
          imageUrl: 'https://images.unsplash.com/photo-1551024601-44f9a98f7272',
          isPopular: true,
          isAvailable: true
        },
        {
          id: '8',
          name: 'Cheesecake',
          description: 'New York style cheesecake with berry compote',
          price: 899,
          category: 'Dessert',
          imageUrl: 'https://images.unsplash.com/photo-1533134242443-d4fd215305ad',
          isPopular: false,
          isAvailable: true
        },
        {
          id: '9',
          name: 'Soft Drink',
          description: 'Choice of cola, lemon, or orange',
          price: 299,
          category: 'Drinks',
          isPopular: false,
          isAvailable: true
        },
        {
          id: '10',
          name: 'Italian Mineral Water',
          description: 'Still or sparkling',
          price: 249,
          category: 'Drinks',
          isPopular: false,
          isAvailable: true
        }
      ];
      
      renderMenuItems('all');
      loading.classList.add('hidden');
      menuContainer.classList.remove('hidden');
    }

    async function addSampleMenuItems() {
      const batch = db.batch();
      
      const sampleMenuItems = [
        {
          name: 'Margherita Pizza',
          description: 'Classic pizza with tomato sauce, mozzarella, and basil',
          price: 1299,
          category: 'Pizza',
          imageUrl: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002',
          isPopular: true,
          isAvailable: true
        },
        {
          name: 'Pepperoni Pizza',
          description: 'Pizza topped with pepperoni slices and cheese',
          price: 1499,
          category: 'Pizza',
          imageUrl: 'https://images.unsplash.com/photo-1628840042765-356cda07504e',
          isPopular: true,
          isAvailable: true
        },
        {
          name: 'Caprese Salad',
          description: 'Fresh tomatoes, mozzarella, and basil with balsamic glaze',
          price: 899,
          category: 'Starters',
          imageUrl: 'https://images.unsplash.com/photo-1592417817098-8fd3d9eb14a5',
          isPopular: false,
          isAvailable: true
        },
        {
          name: 'Bruschetta',
          description: 'Toasted bread topped with tomatoes, garlic, and basil',
          price: 799,
          category: 'Starters',
          imageUrl: 'https://images.unsplash.com/photo-1572695157366-5e585ab2b69f',
          isPopular: true,
          isAvailable: true
        },
        {
          name: 'Spaghetti Carbonara',
          description: 'Pasta with eggs, cheese, pancetta, and black pepper',
          price: 1599,
          category: 'Pasta',
          imageUrl: 'https://images.unsplash.com/photo-1600803907087-f56d462fd26b',
          isPopular: true,
          isAvailable: true
        },
        {
          name: 'Fettuccine Alfredo',
          description: 'Pasta in creamy parmesan sauce',
          price: 1499,
          category: 'Pasta',
          imageUrl: 'https://images.unsplash.com/photo-1645112411341-6c4fd023882c',
          isPopular: false,
          isAvailable: true
        },
        {
          name: 'Tiramisu',
          description: 'Classic Italian dessert with coffee and mascarpone',
          price: 899,
          category: 'Dessert',
          imageUrl: 'https://images.unsplash.com/photo-1551024601-44f9a98f7272',
          isPopular: true,
          isAvailable: true
        },
        {
          name: 'Cheesecake',
          description: 'New York style cheesecake with berry compote',
          price: 899,
          category: 'Dessert',
          imageUrl: 'https://images.unsplash.com/photo-1533134242443-d4fd215305ad',
          isPopular: false,
          isAvailable: true
        },
        {
          name: 'Soft Drink',
          description: 'Choice of cola, lemon, or orange',
          price: 299,
          category: 'Drinks',
          isPopular: false,
          isAvailable: true
        },
        {
          name: 'Italian Mineral Water',
          description: 'Still or sparkling',
          price: 249,
          category: 'Drinks',
          isPopular: false,
          isAvailable: true
        }
      ];
      
      sampleMenuItems.forEach(item => {
        const docRef = db.collection('menuItems').doc();
        batch.set(docRef, item);
      });
      
      await batch.commit();
      console.log("Sample menu items added to Firebase");
    }

    function setupEventListeners() {
      // Table selection
      document.querySelectorAll('.table-number').forEach(btn => {
        btn.addEventListener('click', () => {
          selectTable(btn.getAttribute('data-table'));
        });
      });
      
      // Table button
      tableBtn.addEventListener('click', showTableModal);
      
      // Category buttons
      categoryButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active button styles
          categoryButtons.forEach(b => {
            b.classList.remove('bg-[#5c4033]', 'text-white');
            b.classList.add('bg-white', 'hover:bg-gray-100');
          });
          
          btn.classList.remove('bg-white', 'hover:bg-gray-100');
          btn.classList.add('bg-[#5c4033]', 'text-white');
          
          // Filter menu items
          renderMenuItems(btn.getAttribute('data-category'));
        });
      });
      
      // Cart buttons
      cartBtn.addEventListener('click', showCartModal);
      closeCartBtn.addEventListener('click', hideCartModal);
      clearCartBtn.addEventListener('click', clearCart);
      placeOrderBtn.addEventListener('click', placeOrder);
      
      // Order status buttons
      orderStatusBtn.addEventListener('click', showOrderStatusModal);
      closeOrderStatusBtn.addEventListener('click', hideOrderStatusModal);
      cancelOrderBtn.addEventListener('click', cancelOrder);
      
      // Close modals when clicking outside
      window.addEventListener('click', e => {
        if (e.target === tableModal) tableModal.classList.add('hidden');
        if (e.target === cartModal) hideCartModal();
        if (e.target === orderStatusModal) hideOrderStatusModal();
      });
    }

    function renderMenuItems(category) {
      let filteredItems = menuItems;
      
      // Filter by category
      if (category !== 'all') {
        filteredItems = menuItems.filter(item => item.category === category);
      }
      
      // Clear the container
      menuContainer.innerHTML = '';
      
      if (filteredItems.length === 0) {
        menuContainer.innerHTML = `
          <div class="col-span-full text-center py-12">
            <p class="text-gray-500 text-lg">No menu items found in this category.</p>
          </div>
        `;
        return;
      }
      
      // Render each item
      filteredItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'menu-item bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl';
        
        // Format price properly
        const price = (item.price / 100).toFixed(2);
        
        card.innerHTML = `
          <div class="relative h-48 bg-gray-200">
            ${item.imageUrl ? `
              <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover">
            ` : `
              <div class="w-full h-full flex items-center justify-center bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
            `}
            ${item.isPopular ? `
              <div class="absolute top-2 right-2 bg-[#d4a373] text-white text-xs px-2 py-1 rounded-full">
                Popular
              </div>
            ` : ''}
          </div>
          <div class="p-4">
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-xl font-bold text-[#5c4033]">${item.name}</h3>
              <span class="font-bold text-[#5c4033]">$${price}</span>
            </div>
            <p class="text-gray-600 mb-4 text-sm">${item.description}</p>
            <button class="add-to-cart w-full bg-[#5c4033] hover:bg-[#4e342e] text-white py-2 rounded-lg transition-colors" data-id="${item.id}">
              Add to Cart
            </button>
          </div>
        `;
        
        menuContainer.appendChild(card);
        
        // Add event listener to the "Add to Cart" button
        card.querySelector('.add-to-cart').addEventListener('click', () => {
          addToCart(item);
        });
      });
    }

    function addToCart(item) {
      // Check if the item is already in the cart
      const existingItem = cartItems.find(cartItem => cartItem.id === item.id);
      
      if (existingItem) {
        // Increment quantity
        existingItem.quantity += 1;
      } else {
        // Add new item
        cartItems.push({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: 1
        });
      }
      
      // Update UI
      updateCartUI();
      showNotification('Item added to cart!');
      
      // Analytics event
      try {
        analytics.logEvent('add_to_cart', {
          items: [{
            id: item.id,
            name: item.name,
            price: item.price / 100
          }]
        });
      } catch (error) {
        console.error("Analytics error:", error);
      }
    }

    function updateCartUI() {
      // Update cart badge
      const totalQuantity = cartItems.reduce((total, item) => total + item.quantity, 0);
      
      if (totalQuantity > 0) {
        cartBadge.textContent = totalQuantity;
        cartBadge.classList.remove('hidden');
        placeOrderBtn.disabled = false;
      } else {
        cartBadge.classList.add('hidden');
        placeOrderBtn.disabled = true;
      }
      
      // Update cart items
      if (cartItems.length === 0) {
        emptyCart.classList.remove('hidden');
        cartItems_el.querySelectorAll('.cart-item').forEach(el => el.remove());
      } else {
        emptyCart.classList.add('hidden');
        
        // Clear current items
        cartItems_el.querySelectorAll('.cart-item').forEach(el => el.remove());
        
        // Add items
        cartItems.forEach(item => {
          const itemPrice = (item.price / 100).toFixed(2);
          const itemTotal = ((item.price * item.quantity) / 100).toFixed(2);
          
          const cartItem = document.createElement('div');
          cartItem.className = 'cart-item py-4';
          cartItem.innerHTML = `
            <div class="flex justify-between mb-2">
              <div>
                <span class="font-medium">${item.name}</span>
                <div class="text-gray-500 text-sm">$${itemPrice} each</div>
              </div>
              <div class="text-[#5c4033] font-medium">$${itemTotal}</div>
            </div>
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-2">
                <button class="cart-quantity-btn bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center" data-action="decrease" data-id="${item.id}">-</button>
                <span>${item.quantity}</span>
                <button class="cart-quantity-btn bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center" data-action="increase" data-id="${item.id}">+</button>
              </div>
              <button class="remove-item text-red-500 hover:text-red-700 text-sm" data-id="${item.id}">Remove</button>
            </div>
          `;
          
          cartItems_el.appendChild(cartItem);
          
          // Add event listeners for quantity buttons
          cartItem.querySelectorAll('.cart-quantity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const action = btn.getAttribute('data-action');
              const itemId = btn.getAttribute('data-id');
              updateCartItemQuantity(itemId, action);
            });
          });
          
          // Add event listener for remove button
          cartItem.querySelector('.remove-item').addEventListener('click', () => {
            const itemId = cartItem.querySelector('.remove-item').getAttribute('data-id');
            removeCartItem(itemId);
          });
        });
      }
      
      // Update total
      const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      cartTotal.textContent = `Total: $${(total / 100).toFixed(2)}`;
    }

    function updateCartItemQuantity(itemId, action) {
      const item = cartItems.find(item => item.id === itemId);
      
      if (!item) return;
      
      if (action === 'increase') {
        item.quantity += 1;
      } else if (action === 'decrease') {
        item.quantity -= 1;
        
        // Remove item if quantity is 0
        if (item.quantity <= 0) {
          removeCartItem(itemId);
          return;
        }
      }
      
      updateCartUI();
    }

    function removeCartItem(itemId) {
      cartItems = cartItems.filter(item => item.id !== itemId);
      updateCartUI();
    }

    function clearCart() {
      cartItems = [];
      updateCartUI();
    }

    function placeOrder() {
      if (cartItems.length === 0 || !selectedTable) return;
      
      const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // Create order object
      const order = {
        tableNumber: selectedTable,
        status: 'pending',
        items: cartItems,
        totalPrice: total,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add to Firestore
      db.collection('orders').add(order)
        .then(docRef => {
          console.log("Order created with ID:", docRef.id);
          
          // Set current order
          currentOrder = {
            id: docRef.id,
            ...order
          };
          
          // Analytics event
          try {
            analytics.logEvent('purchase', {
              transaction_id: docRef.id,
              value: total / 100,
              currency: 'USD',
              items: cartItems.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price / 100,
                quantity: item.quantity
              }))
            });
          } catch (error) {
            console.error("Analytics error:", error);
          }
          
          // Show order status button
          orderStatusBtn.classList.remove('hidden');
          
          // Show order status
          hideCartModal();
          showOrderStatusModal();
          
          // Clear cart
          clearCart();
          
          // Start the cancel timer
          startCancelTimer();
        })
        .catch(error => {
          console.error("Error placing order:", error);
          
          // Fallback for offline mode
          const orderId = 'local-' + Date.now();
          currentOrder = {
            id: orderId,
            ...order,
            createdAt: new Date(),
            updatedAt: new Date()
          };
          
          orderStatusBtn.classList.remove('hidden');
          hideCartModal();
          showOrderStatusModal();
          clearCart();
          startCancelTimer();
        });
    }

    function selectTable(tableNum) {
      selectedTable = parseInt(tableNum);
      tableNumber.textContent = tableNum;
      tableModal.classList.add('hidden');
      
      // Update place order button
      if (cartItems.length > 0) {
        placeOrderBtn.disabled = false;
      }
    }

    function showTableModal() {
      tableModal.classList.remove('hidden');
    }

    function showCartModal() {
      cartModal.classList.remove('hidden');
    }

    function hideCartModal() {
      cartModal.classList.add('hidden');
    }

    function showOrderStatusModal() {
      if (!currentOrder) return;
      
      // Update the order UI
      orderNumber_el.textContent = `Order #${currentOrder.id.substring(0, 8)}`;
      
      // Set status text and color
      let statusText = currentOrder.status.charAt(0).toUpperCase() + currentOrder.status.slice(1);
      let statusColor = getStatusColor(currentOrder.status);
      
      orderStatus_el.innerHTML = `
        <span class="px-3 py-1 ${statusColor} rounded-full text-sm font-medium order-status">
          ${statusText}
        </span>
      `;
      
      // Set estimated time based on status
      let timeText = '';
      switch (currentOrder.status) {
        case 'pending':
          timeText = '10-15 minutes';
          break;
        case 'preparing':
          timeText = '10-15 minutes';
          break;
        case 'ready':
          timeText = 'Ready for pickup!';
          break;
        case 'completed':
          timeText = 'Completed';
          break;
        case 'cancelled':
          timeText = 'Cancelled';
          break;
      }
      
      estimatedTime.textContent = timeText;
      
      // Update order items
      orderItems_el.innerHTML = '';
      currentOrder.items.forEach(item => {
        const orderItem = document.createElement('li');
        orderItem.className = 'flex justify-between';
        orderItem.innerHTML = `
          <span>${item.quantity}x ${item.name}</span>
          <span>$${((item.price * item.quantity) / 100).toFixed(2)}</span>
        `;
        orderItems_el.appendChild(orderItem);
      });
      
      // Show/hide cancel button based on order status
      if (currentOrder.status === 'pending') {
        cancelOrderContainer.classList.remove('hidden');
      } else {
        cancelOrderContainer.classList.add('hidden');
      }
      
      orderStatusModal.classList.remove('hidden');
    }

    function hideOrderStatusModal() {
      orderStatusModal.classList.add('hidden');
    }

    function cancelOrder() {
      if (!currentOrder) return;
      
      // Update order status
      db.collection('orders').doc(currentOrder.id).update({
        status: 'cancelled',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        currentOrder.status = 'cancelled';
        showOrderStatusModal(); // Refresh the modal
      })
      .catch(error => {
        console.error("Error cancelling order:", error);
        
        // Fallback for offline mode
        currentOrder.status = 'cancelled';
        showOrderStatusModal();
      });
      
      // Clear the cancel timer
      if (cancelTimerId) {
        clearTimeout(cancelTimerId);
        cancelTimerId = null;
      }
    }

    function startCancelTimer() {
      // Allow cancellation for 3 minutes (180,000 ms)
      if (cancelTimerId) {
        clearTimeout(cancelTimerId);
      }
      
      cancelTimerId = setTimeout(() => {
        if (currentOrder && currentOrder.status === 'pending') {
          cancelOrderContainer.classList.add('hidden');
        }
      }, 180000); // 3 minutes
    }

    function getStatusColor(status) {
      switch (status) {
        case 'pending':
          return 'bg-yellow-100 text-yellow-800';
        case 'preparing':
          return 'bg-orange-100 text-orange-800';
        case 'ready':
          return 'bg-green-100 text-green-800';
        case 'completed':
          return 'bg-blue-100 text-blue-800';
        case 'cancelled':
          return 'bg-red-100 text-red-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    function showNotification(message) {
      notification.textContent = message;
      notification.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
  </script>
</body>
</html>
