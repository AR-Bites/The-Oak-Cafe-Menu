<!DOCTYPE html>
<html>
<head>
  <title>The Oak Cafe - Premium AR Dining</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --gold: #D4AF37;
      --dark-green: #1A3A2F;
      --light-cream: #F5F5DC;
      --red: #B22222;
      --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
    }
    
    body {
      font-family: 'Playfair Display', serif;
      background: url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: white;
      text-align: center;
      overflow-x: hidden;
    }
    
    .overlay {
      background-color: rgba(26, 58, 47, 0.92);
      min-height: 100vh;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 20px 0;
    }
    
    .logo {
      height: 80px;
      margin-bottom: 15px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    h1 {
      font-size: 2.8rem;
      color: var(--gold);
      margin: 10px 0 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 1px;
    }
    
    .tagline {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.2rem;
      color: var(--light-cream);
      margin-bottom: 30px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }
    
    .food-container {
      max-width: 650px;
      margin: 0 auto;
      background: rgba(245, 245, 220, 0.15);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.25);
      border: 2px solid var(--gold);
      flex-grow: 1;
    }
    
    model-viewer {
      width: 100%;
      height: 380px;
      margin: 25px 0;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0 20px;
    }
    
    button {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      border: none;
      padding: 14px 28px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      letter-spacing: 1px;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
    }
    
    .ar-button {
      background: linear-gradient(135deg, var(--red) 0%, #D63B3B 100%) !important;
      color: white !important;
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    .footer {
      margin-top: 40px;
      padding: 30px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 20px 20px 0 0;
      border-top: 3px solid var(--gold);
      position: relative;
    }
    
    .footer::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: var(--gold);
      border-radius: 2px;
    }
    
    .footer-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .branding-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .powered-by {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .ar-bites-logo {
      height: 50px;
      transition: var(--transition);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .social-links {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .social-link {
      color: var(--gold);
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 1.1rem;
    }
    
    .instagram-icon {
      width: 28px;
      height: 28px;
    }
    
    .copyright {
      font-size: 0.9rem;
      margin-top: 25px;
      color: rgba(255,255,255,0.7);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: rgba(26, 58, 47, 0.95);
      padding: 30px;
      border-radius: 15px;
      border: 2px solid var(--gold);
      max-width: 400px;
      width: 90%;
    }
    
    .modal-title {
      color: var(--gold);
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--light-cream);
      text-align: left;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--gold);
      background: rgba(245, 245, 220, 0.1);
      color: white;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .staff-dashboard {
      display: none;
      padding: 30px;
    }
    
    .orders-list {
      margin-top: 30px;
    }
    
    .order-card {
      background: rgba(245, 245, 220, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--gold);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .order-id {
      color: var(--gold);
      font-weight: bold;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }
    
    .status-preparing {
      background: rgba(33, 150, 243, 0.2);
      color: #2196F3;
    }
    
    .status-ready {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .status-completed {
      background: rgba(158, 158, 158, 0.2);
      color: #9E9E9E;
    }
    
    .order-items {
      margin-bottom: 15px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    
    .user-type {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .user-btn {
      background: rgba(245, 245, 220, 0.1);
      color: white;
      border: 2px solid var(--gold);
      padding: 12px 25px;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .user-btn.active {
      background: var(--gold);
      color: var(--dark-green);
    }
    
    .add-to-cart {
      background: linear-gradient(135deg, #2e7d32 0%, #4CAF50 100%);
      color: white;
      padding: 14px;
      border-radius: 50px;
      font-weight: bold;
      display: block;
      width: 100%;
      margin-top: 20px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
    }
    
    .add-to-cart:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
    }
    
    .cart-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      background: rgba(26, 58, 47, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border: 2px solid var(--gold);
      z-index: 900;
      transform: translateX(120%);
      transition: var(--transition);
    }
    
    .cart-panel.active {
      transform: translateX(0);
    }
    
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .cart-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .item-name {
      flex: 2;
      text-align: left;
    }
    
    .item-price {
      flex: 1;
      text-align: right;
      color: var(--gold);
    }
    
    .remove-item {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1rem;
    }
    
    .cart-total {
      font-weight: bold;
      font-size: 1.1rem;
      text-align: right;
      margin: 15px 0;
      color: var(--gold);
    }
    
    .checkout-btn {
      background: linear-gradient(135deg, var(--gold) 0%, #E8C547 100%);
      color: var(--dark-green);
      width: 100%;
      padding: 14px;
      border-radius: 50px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    .checkout-btn:disabled {
      opacity: 0.8;
      cursor: not-allowed;
    }
    
    .checkout-loading .checkout-text {
      visibility: hidden;
    }
    
    .checkout-loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 3px solid rgba(0,0,0,0.1);
      border-top: 3px solid var(--dark-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .cart-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--gold);
      color: var(--dark-green);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 800;
      transition: var(--transition);
    }
    
    .cart-toggle:hover {
      transform: scale(1.1);
    }
    
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--red);
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .order-status-notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: white;
      color: var(--dark-green);
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateX(-120%);
      transition: var(--transition);
      border-left: 5px solid var(--gold);
    }
    
    .order-status-notification.active {
      transform: translateX(0);
    }
    
    .status-icon {
      width: 30px;
      height: 30px;
    }
    
    .status-content {
      flex: 1;
      text-align: left;
    }
    
    .status-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--dark-green);
    }
    
    .status-message {
      font-size: 0.9rem;
      color: #555;
    }
    
    .close-status {
      background: none;
      border: none;
      color: #999;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 10px;
    }

    .client-orders {
      display: none;
      margin-top: 30px;
      background: rgba(245, 245, 220, 0.1);
      border-radius: 15px;
      padding: 20px;
    }

    .client-orders.active {
      display: block;
    }

    .client-order {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .client-order:last-child {
      border-bottom: none;
    }

    .client-order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .client-order-id {
      color: var(--gold);
      font-weight: bold;
    }

    .client-order-status {
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }

    .client-order-items {
      margin-bottom: 10px;
    }

    .client-order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .client-order-total {
      text-align: right;
      font-weight: bold;
      color: var(--gold);
    }

    .view-orders-btn {
      margin-top: 20px;
      background: rgba(245, 245, 220, 0.1);
      color: white;
      border: 2px solid var(--gold);
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      transition: var(--transition);
    }

    .view-orders-btn:hover {
      background: var(--gold);
      color: var(--dark-green);
    }

    .delete-order {
      background: var(--red) !important;
      color: white !important;
      margin-top: 10px;
      width: 100%;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Login Modal -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <h2 class="modal-title">STAFF LOGIN</h2>
      <div class="input-group">
        <label for="password">Enter Password:</label>
        <input type="password" id="password" placeholder="Your secure password">
      </div>
      <div class="modal-buttons">
        <button onclick="checkPassword()" style="flex: 1;">ENTER</button>
        <button onclick="closeModal()" style="background: var(--red); flex: 1;">CANCEL</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="overlay" id="main-content">
    <!-- User Type Selection -->
    <div class="user-type">
      <button class="user-btn active" id="guest-btn">GUEST</button>
      <button class="user-btn" id="staff-btn">STAFF</button>
    </div>

    <!-- Guest View -->
    <div id="guest-view">
      <div class="header">
        <img src="images-removebg-preview (1).png" alt="The Oak Cafe Logo" class="logo">
        <h1>TASTE ITALY IN 3D</h1>
        <p class="tagline">SCAN • TAP • SAVOR</p>
      </div>

      <div class="food-container">
        <h2 class="food-title" id="food-title">Margherita Pizza</h2>
        <p class="food-desc" id="food-desc">San Marzano tomato sauce, fresh mozzarella, basil</p>
        <model-viewer
          id="model-viewer"
          src="models/Margherita Pizza.glb"
          ar
          ar-modes="quick-look scene-viewer webxr"
          camera-controls
          auto-rotate
          shadow-intensity="1.2"
          exposure="1.1"
        >
          <button slot="ar-button" class="ar-button">VIEW IN YOUR SPACE</button>
        </model-viewer>

        <button class="add-to-cart" id="add-to-cart">ADD TO ORDER - 5.99 JD</button>

        <div class="nav-buttons">
          <button id="prev-btn">← PREVIOUS</button>
          <span id="counter" style="color: var(--gold); font-weight: bold;">1/6</span>
          <button id="next-btn">NEXT →</button>
        </div>

        <!-- Client Order Status Section -->
        <button class="view-orders-btn" id="view-orders-btn">VIEW MY ORDERS</button>
        <div class="client-orders" id="client-orders">
          <h3 style="color: var(--gold); margin-top: 0;">YOUR ORDERS</h3>
          <div id="client-orders-list">
            <!-- Client orders will appear here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Staff Dashboard -->
    <div class="staff-dashboard" id="staff-dashboard">
      <h2 style="color: var(--gold);">ORDERS DASHBOARD</h2>
      <div class="orders-list" id="orders-list">
        <!-- Orders will appear here -->
      </div>
    </div>

    <div class="footer">
      <div class="footer-grid">
        <div class="branding-section">
          <div class="powered-by">
            <span style="color: var(--light-cream);">Powered by</span>
            <img src="ar-bites-logo.png" alt="AR Bites Logo" class="ar-bites-logo">
          </div>
          <p class="copyright">© 2025 AR BITES. ALL RIGHTS RESERVED</p>
        </div>
        
        <div class="social-links">
          <a href="https://www.instagram.com/ar.bitesjo?igsh=ajhmd3ZvbjJhamJh" class="social-link" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Instagram_icon.png/2048px-Instagram_icon.png" alt="Instagram" class="instagram-icon">
            @ar.bitesjo
          </a>
          <a href="tel:+962790753376" class="social-link">
            <img src="https://cdn-icons-png.flaticon.com/512/455/455705.png" alt="Phone" class="instagram-icon">
            +962 790 753 376
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Panel -->
  <div class="cart-panel" id="cart-panel">
    <div class="cart-header">
      <h3 style="margin: 0; color: var(--gold);">YOUR ORDER</h3>
      <button id="close-cart" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer;">×</button>
    </div>
    <div class="cart-items" id="cart-items"></div>
    <div class="cart-total" id="cart-total">Total: 0.00 JD</div>
    <button class="checkout-btn" id="checkout-btn">
      <span class="checkout-text">CONFIRM ORDER</span>
    </button>
  </div>

  <!-- Cart Toggle Button -->
  <div class="cart-toggle" id="cart-toggle">
    <span class="cart-count" id="cart-count">0</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="9" cy="21" r="1"></circle>
      <circle cx="20" cy="21" r="1"></circle>
      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
  </div>

  <!-- Order Status Notification -->
  <div class="order-status-notification" id="order-status">
    <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Status" class="status-icon">
    <div class="status-content">
      <div class="status-title">ORDER RECEIVED</div>
      <div class="status-message">Your order is being prepared</div>
    </div>
    <button class="close-status" id="close-status">×</button>
  </div>

  <script>
    // ==================== FIREBASE CONFIG ====================
    // REPLACE WITH YOUR FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyABC123...",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abc123def456"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==================== APP DATA ====================
    const foods = [
      {
        title: "Margherita Pizza",
        description: "San Marzano tomato sauce, fresh mozzarella, basil",
        model: "models/Margherita Pizza.glb",
        price: 5.99
      },
      {
        title: "Pepperoni Pizza",
        description: "Spicy pepperoni, mozzarella, tomato sauce",
        model: "models/Pepperoni Pizza.glb",
        price: 6.99
      },
      {
        title: "Truffle Fettuccine",
        description: "Handmade pasta, black truffle, parmesan cream",
        model: "models/Fettuccine Alfredo.glb",
        price: 7.99
      },
      {
        title: "Genovese Pesto",
        description: "Basil pesto, pine nuts, aged parmesan",
        model: "models/Pesto Pasta.glb",
        price: 7.49
      },
      {
        title: "Rosa Pasta",
        description: "Creamy tomato sauce, pancetta, pecorino",
        model: "models/Rose Pasta.glb",
        price: 7.99
      },
      {
        title: "Frutti Di Mare",
        description: "Clams, mussels, shrimp in white wine sauce",
        model: "models/Sea Food Pasta.glb",
        price: 8.99
      }
    ];

    // ==================== GLOBAL VARIABLES ====================
    let currentIndex = 0;
    let cart = [];
    let orders = [];
    let isStaff = false;
    let clientId = localStorage.getItem('clientId') || 
                  'CL-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    let firestoreListener = null;

    // DOM Elements
    const modelViewer = document.getElementById("model-viewer");
    const foodTitle = document.getElementById("food-title");
    const foodDesc = document.getElementById("food-desc");
    const counter = document.getElementById("counter");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const addToCartBtn = document.getElementById("add-to-cart");
    const guestBtn = document.getElementById("guest-btn");
    const staffBtn = document.getElementById("staff-btn");
    const guestView = document.getElementById("guest-view");
    const staffDashboard = document.getElementById("staff-dashboard");
    const loginModal = document.getElementById("login-modal");
    const ordersList = document.getElementById("orders-list");
    const cartPanel = document.getElementById("cart-panel");
    const cartItemsEl = document.getElementById("cart-items");
    const cartTotalEl = document.getElementById("cart-total");
    const checkoutBtn = document.getElementById("checkout-btn");
    const cartToggle = document.getElementById("cart-toggle");
    const cartCount = document.getElementById("cart-count");
    const closeCartBtn = document.getElementById("close-cart");
    const orderStatus = document.getElementById("order-status");
    const closeStatusBtn = document.getElementById("close-status");
    const viewOrdersBtn = document.getElementById("view-orders-btn");
    const clientOrders = document.getElementById("client-orders");
    const clientOrdersList = document.getElementById("client-orders-list");
    const checkoutText = document.querySelector('.checkout-text');

    // Password - CHANGE THIS TO YOUR SECURE PASSWORD
    const STAFF_PASSWORD = "OakCafe2025";
    const STAFF_TOKEN = "staff-auth-token";

    // ==================== OPTIMIZED CHECKOUT FUNCTION ====================
    async function checkout() {
      if (cart.length === 0) return;
      
      // Set loading state
      checkoutBtn.disabled = true;
      checkoutBtn.classList.add('checkout-loading');
      checkoutText.textContent = "PROCESSING...";
      
      // Create order object
      const order = {
        id: 'ORD-' + Date.now().toString().substr(-6),
        items: [...cart],
        total: cart.reduce((sum, item) => sum + item.price, 0),
        status: 'pending',
        clientId: clientId,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        // Add timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Order timeout')), 8000); // 8 second timeout
        });
        
        // Try to add order with timeout protection
        const orderPromise = db.collection("orders").add(order);
        await Promise.race([orderPromise, timeoutPromise]);
        
        // Success - clear cart and update UI
        cart = [];
        updateCart();
        cartPanel.classList.remove('active');
        showOrderStatus(`Order #${order.id} confirmed!`, "ORDER CONFIRMED");
        
      } catch (error) {
        console.error("Checkout error:", error);
        showOrderStatus(
          error.message === 'Order timeout' 
            ? "Order taking longer than expected. Please check your connection." 
            : "Failed to place order. Please try again.",
          "ORDER ERROR"
        );
      } finally {
        // Reset button state
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('checkout-loading');
        checkoutText.textContent = "CONFIRM ORDER";
      }
    }

    // ==================== FIREBASE FUNCTIONS ====================
    function setupRealTimeListener() {
      // Remove existing listener if any
      if (firestoreListener) {
        firestoreListener();
      }
      
      firestoreListener = db.collection("orders")
        .orderBy("timestamp", "desc")
        .onSnapshot(
          (snapshot) => {
            const updatedOrders = [];
            snapshot.forEach((doc) => {
              updatedOrders.push({ id: doc.id, ...doc.data() });
            });
            
            orders = updatedOrders;
            
            if (isStaff) {
              renderOrders();
            }
            
            // Only show client's own orders
            renderClientOrders(orders.filter(o => o.clientId === clientId));
          }, 
          (error) => {
            console.error("Firestore listener error:", error);
            showOrderStatus("Connection issue. Trying to reconnect...", "NETWORK ERROR");
            // Reconnect after delay
            setTimeout(setupRealTimeListener, 2000);
          }
        );
    }

    async function updateOrderStatus(orderId, status) {
      try {
        await db.collection("orders").doc(orderId).update({ status });
      } catch (error) {
        console.error("Error updating order:", error);
        showOrderStatus("Failed to update order status", "SYSTEM ERROR");
      }
    }

    async function deleteOrder(orderId) {
      if (confirm("Are you sure you want to delete this order?")) {
        try {
          await db.collection("orders").doc(orderId).delete();
        } catch (error) {
          console.error("Error deleting order:", error);
          showOrderStatus("Failed to delete order", "SYSTEM ERROR");
        }
      }
    }

    // ==================== CORE FUNCTIONS ====================
    function updateModel() {
      const food = foods[currentIndex];
      modelViewer.src = food.model;
      foodTitle.textContent = food.title;
      foodDesc.textContent = food.description;
      counter.textContent = `${currentIndex + 1}/${foods.length}`;
      addToCartBtn.textContent = `ADD TO ORDER - ${food.price.toFixed(2)} JD`;
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === foods.length - 1;
    }

    function addToCart() {
      const currentFood = foods[currentIndex];
      cart.push({
        ...currentFood,
        id: Date.now() + Math.random().toString(36).substr(2, 9)
      });
      updateCart();
      showOrderStatus(`${currentFood.title} added to order`, "ORDER UPDATED");
      cartPanel.classList.add("active");
    }

    function removeFromCart(itemId) {
      cart = cart.filter(item => item.id !== itemId);
      updateCart();
    }

    function updateCart() {
      cartItemsEl.innerHTML = '';
      let total = 0;
      
      cart.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'cart-item';
        itemEl.innerHTML = `
          <span class="item-name">${item.title}</span>
          <span class="item-price">${item.price.toFixed(2)} JD</span>
          <button class="remove-item" data-id="${item.id}">×</button>
        `;
        cartItemsEl.appendChild(itemEl);
        total += item.price;
      });
      
      cartTotalEl.textContent = `Total: ${total.toFixed(2)} JD`;
      cartCount.textContent = cart.length;
      
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeFromCart(e.target.dataset.id);
        });
      });
    }

    function renderOrders() {
      ordersList.innerHTML = '';
      
      if (orders.length === 0) {
        ordersList.innerHTML = '<p style="color: var(--light-cream);">No orders yet</p>';
        return;
      }
      
      // Sort by newest first and then by status
      const sortedOrders = [...orders].sort((a, b) => {
        // First sort by status (pending first)
        const statusOrder = {pending: 0, preparing: 1, ready: 2, completed: 3};
        if (statusOrder[a.status] !== statusOrder[b.status]) {
          return statusOrder[a.status] - statusOrder[b.status];
        }
        // Then by timestamp (newest first)
        return b.timestamp?.seconds - a.timestamp?.seconds;
      });
      
      sortedOrders.forEach(order => {
        const orderEl = document.createElement('div');
        orderEl.className = 'order-card';
        orderEl.innerHTML = `
          <div class="order-header">
            <div class="order-id">Order #${order.id} (${order.clientId})</div>
            <div class="order-status status-${order.status}">${order.status.toUpperCase()}</div>
          </div>
          <div class="order-items">
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.title}</span>
                <span>${item.price.toFixed(2)} JD</span>
              </div>
            `).join('')}
          </div>
          <div style="text-align: right; font-weight: bold; color: var(--gold);">
            Total: ${order.total.toFixed(2)} JD
          </div>
          <div class="order-actions">
            <button class="action-btn" onclick="updateOrderStatus('${order.id}', 'preparing')" style="background: #2196F3; color: white;">Preparing</button>
            <button class="action-btn" onclick="updateOrderStatus('${order.id}', 'ready')" style="background: #4CAF50; color: white;">Ready</button>
            <button class="action-btn" onclick="updateOrderStatus('${order.id}', 'completed')" style="background: #9E9E9E; color: white;">Complete</button>
          </div>
          <button class="action-btn delete-order" onclick="deleteOrder('${order.id}')">DELETE ORDER</button>
        `;
        ordersList.appendChild(orderEl);
      });
    }

    function renderClientOrders(clientOrdersData) {
      clientOrdersList.innerHTML = '';
      
      if (clientOrdersData.length === 0) {
        clientOrdersList.innerHTML = '<p style="color: var(--light-cream);">No orders yet</p>';
        return;
      }
      
      // Sort by newest first
      const sortedOrders = [...clientOrdersData].sort((a, b) => 
        b.timestamp?.seconds - a.timestamp?.seconds
      );
      
      sortedOrders.forEach(order => {
        const orderEl = document.createElement('div');
        orderEl.className = 'client-order';
        orderEl.innerHTML = `
          <div class="client-order-header">
            <div class="client-order-id">#${order.id}</div>
            <div class="client-order-status status-${order.status}">${order.status.toUpperCase()}</div>
          </div>
          <div class="client-order-items">
            ${order.items.map(item => `
              <div class="client-order-item">
                <span>${item.title}</span>
                <span>${item.price.toFixed(2)} JD</span>
              </div>
            `).join('')}
          </div>
          <div class="client-order-total">Total: ${order.total.toFixed(2)} JD</div>
        `;
        clientOrdersList.appendChild(orderEl);
      });
    }

    function showOrderStatus(message, title = "ORDER RECEIVED") {
      const statusTitle = orderStatus.querySelector(".status-title");
      const statusMessage = orderStatus.querySelector(".status-message");
      
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      orderStatus.classList.add("active");
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (orderStatus.classList.contains("active")) {
          orderStatus.classList.remove("active");
        }
      }, 5000);
    }

    function checkPassword() {
      const passwordInput = document.getElementById("password");
      if (passwordInput.value === STAFF_PASSWORD) {
        isStaff = true;
        localStorage.setItem(STAFF_TOKEN, 'true');
        checkAuthState();
        closeModal();
      } else {
        alert("Incorrect password. Please try again.");
        passwordInput.value = "";
      }
    }

    function checkAuthState() {
      if (isStaff) {
        guestBtn.classList.remove("active");
        staffBtn.classList.add("active");
        guestView.style.display = "none";
        staffDashboard.style.display = "block";
        renderOrders();
      } else {
        guestBtn.classList.add("active");
        staffBtn.classList.remove("active");
        guestView.style.display = "block";
        staffDashboard.style.display = "none";
      }
    }

    function closeModal() {
      loginModal.style.display = "none";
      document.getElementById("password").value = "";
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Initialize client ID
        if (!localStorage.getItem('clientId')) {
          clientId = 'CL-' + Math.random().toString(36).substr(2, 6).toUpperCase();
          localStorage.setItem('clientId', clientId);
        }
        
        // Check if staff
        isStaff = localStorage.getItem(STAFF_TOKEN) === 'true';
        checkAuthState();
        
        // Setup real-time listener
        setupRealTimeListener();
        updateModel();
        updateCart();
      } catch (error) {
        console.error("Initialization error:", error);
        showOrderStatus("System loading... Please wait", "LOADING");
        // Try to recover
        setTimeout(() => window.location.reload(), 3000);
      }
    });

    // Navigation buttons
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateModel();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < foods.length - 1) {
        currentIndex++;
        updateModel();
      }
    });

    // Cart interactions
    addToCartBtn.addEventListener('click', addToCart);
    checkoutBtn.addEventListener('click', checkout);
    cartToggle.addEventListener('click', () => cartPanel.classList.toggle('active'));
    closeCartBtn.addEventListener('click', () => cartPanel.classList.remove('active'));

    // Order status
    closeStatusBtn.addEventListener('click', () => orderStatus.classList.remove('active'));

    // View orders toggle
    viewOrdersBtn.addEventListener('click', () => {
      clientOrders.classList.toggle('active');
      viewOrdersBtn.textContent = clientOrders.classList.contains('active') ? 
        'HIDE MY ORDERS' : 'VIEW MY ORDERS';
    });

    // User type switching
    guestBtn.addEventListener('click', () => {
      isStaff = false;
      localStorage.removeItem(STAFF_TOKEN);
      checkAuthState();
    });

    staffBtn.addEventListener('click', () => {
      if (isStaff) {
        checkAuthState();
      } else {
        loginModal.style.display = 'flex';
      }
    });
  </script>
</body>
</html>